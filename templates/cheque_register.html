{% extends "base.html" %}

{% block title %}Cheque Register{% endblock %}

{% block extra_css %}
<style>
.cheque-register-page .book-section-title { margin-bottom: 1rem; }
.cheque-register-page .book-heading-meta { color: #6c757d; font-size: 0.85em; font-weight: normal; }
.cheque-register-page .book-section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    user-select: none;
    padding: 0.25rem 0;
    margin-bottom: 0;
}
.cheque-register-page .book-heading-serial-range { margin-left: auto; color: #6c757d; font-size: 0.98em; font-weight: normal; }
.cheque-register-page .book-section-header .btn-edit-book { margin-left: 0.5rem; }
.cheque-register-page .book-section-header .btn-edit-book:disabled,
.cheque-register-page .book-section-header .btn-edit-book.btn-edit-book-disabled {
    opacity: 0.65;
    cursor: not-allowed;
    pointer-events: none;
}
.cheque-register-page .book-section-header:hover { opacity: 0.85; }
.cheque-register-page .book-section-header .book-section-chevron {
    transition: transform 0.2s ease;
    width: 1rem;
    text-align: center;
    color: var(--secondary-color, #6c757d);
}
.cheque-register-page .book-section.collapsed .book-section-header .book-section-chevron i { transform: rotate(-90deg); }
.cheque-register-page .book-section:not(.collapsed) .book-section-header .book-section-chevron i { transform: rotate(0deg); }
.cheque-register-page .book-section.collapsed .book-section-content { display: none !important; }
.cheque-register-page .book-section .book-section-content { margin-top: 1rem; }
.cheque-register-page .upload-cell-td { text-align: center; }
.cheque-register-page .upload-cell {
    display: inline-flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}
.cheque-register-page .upload-cell .upload-cell-buttons { display: inline-flex; align-items: center; gap: 0.35rem; }
.cheque-register-page .upload-cell .upload-path-text {
    font-size: 0.75rem;
    color: #6c757d;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.cheque-register-page .book-section .pagination-container { margin-top: 8px; }
.cheque-register-page .book-section .pagination-container .pagination { flex-wrap: wrap; gap: 6px; }
/* Active page number: same element (button) as others = same size; gold color only */
.cheque-register-page .pagination .btn.btn-sm.cheque-pagination-current {
    background: #D9BD7D !important;
    color: #1a1a1a !important;
    border: 1px solid #D9BD7D !important;
}
.cheque-register-page .cheque-book-card { margin-bottom: 1.5rem; }
.cheque-register-page .cheque-book-card:last-child { margin-bottom: 0; }
/* Actions column buttons: match dashboard action column style */
.cheque-register-page .btn-view-outline {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    padding: 0;
    background: transparent !important;
    border: 1px solid #D9BD7D !important;
    color: #D9BD7D !important;
    border-radius: 6px;
    font-size: 12px;
}
.cheque-register-page .btn-view-outline i {
    color: inherit;
    font-size: 12px;
}
.cheque-register-page .btn-view-outline:hover {
    background: #D9BD7D !important;
    color: #ffffff !important;
}
.cheque-register-page .upload-btn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
    border-color: #9ca3af !important;
    color: #9ca3af !important;
}
.cheque-register-page .upload-btn:disabled i {
    color: #9ca3af !important;
}
.cheque-register-page .upload-cell .cheque-remove-image-btn {
    margin-left: 0.35rem;
    font-size: 0.8rem;
    color: #6c757d !important;
    border-color: #6c757d !important;
    background: transparent !important;
}
.cheque-register-page .upload-cell .cheque-remove-image-btn:hover {
    color: #495057 !important;
    border-color: #495057 !important;
    background: #f8f9fa !important;
}
.cheque-register-page .upload-cell .remove-image-icon {
    position: relative;
    display: inline-block;
    width: 14px;
    height: 14px;
    line-height: 14px;
}
.cheque-register-page .upload-cell .remove-image-icon .fa-image {
    font-size: 14px;
}
.cheque-register-page .upload-cell .remove-image-icon .fa-times {
    position: absolute;
    right: -5px;
    top: -6px;
    font-size: 10px;
    background: #fff;
    border-radius: 50%;
    line-height: 1;
    padding: 1px;
}
.cheque-register-page .cheque-book-toolbar {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}
.cheque-register-page .cheque-book-toolbar .btn-delete-selected {
    padding: 0.35rem 0.75rem;
    font-size: 0.875rem;
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: #fff !important;
}
.cheque-register-page .cheque-book-toolbar .btn-delete-selected:hover {
    background-color: transparent !important;
    border-color: #dc3545 !important;
    color: #dc3545 !important;
}
.cheque-register-page .cheque-book-toolbar .btn-delete-selected:hover i {
    color: #dc3545 !important;
}
.cheque-register-page .cheque-book-toolbar .btn-reserve-only,
.cheque-register-page .cheque-book-toolbar .btn-reserve-write {
    padding: 0.35rem 0.75rem;
    font-size: 0.875rem;
}
.cheque-register-page .cheque-book-toolbar .btn-reserve-only {
    background-color: #D9BD7D !important;
    border-color: #D9BD7D !important;
    color: #fff !important;
}
.cheque-register-page .cheque-book-toolbar .btn-reserve-only:hover {
    background-color: transparent !important;
    border-color: #D9BD7D !important;
    color: #D9BD7D !important;
}
.cheque-register-page .cheque-book-toolbar .btn-reserve-write {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    color: #fff !important;
}
.cheque-register-page .cheque-book-toolbar .btn-reserve-write:hover {
    background-color: transparent !important;
    border-color: #28a745 !important;
    color: #28a745 !important;
}
.cheque-register-page .badge-used {
    background-color: #ffc107 !important;
    color: #212529 !important;
}
</style>
{% endblock %}

{% block content %}
{% set show_select_it = current_user.department == 'IT' %}
{% set show_select_ceo_gm_op = current_user.role in ['CEO', 'GM', 'Operation Manager'] %}
{% set show_cheque_select = show_select_it or show_select_ceo_gm_op %}
<div class="dashboard-container cheque-register-page">
    <div class="dashboard-header">
        <h2 class="dashboard-title" style="margin:0; display:inline-flex; align-items:center; gap:8px; font-size:1.6rem; font-weight:700;"><i class="fas fa-book"></i> Cheque Register</h2>
        <p>View and manage cheque books and serial numbers</p>
    </div>

    <div class="dashboard-actions">
        {% if current_user.department != 'Auditing' %}
        <a href="{{ url_for('write_cheque') }}" class="btn btn-success">
            <i class="fas fa-file-invoice"></i> Write Cheque
        </a>
        {% endif %}
        <a href="{{ url_for('new_book') }}" class="btn btn-success">
            <i class="fas fa-plus-circle"></i> New Book
        </a>
    </div>

    <!-- Search and filters (same structure and classes as dashboard – styles from style.css) -->
    <div class="filters-container" style="margin: 0 0 8px 0;">
        <div class="filters-left">
            <div class="assign-search-field" style="position:relative; min-width:280px;">
                <img src="{{ url_for('static', filename='css/icons/search.svg') }}" class="assign-search-icon" alt="Search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%);" onclick="document.getElementById('chequeSearchInput').focus();">
                <input type="search" id="chequeSearchInput" class="form-control assign-search-input" placeholder="Search by serial #, payee, amount..." aria-label="Search cheque records" style="padding-left:44px; width:100%;">
            </div>
        </div>
        <div class="filters-right" style="margin-left:auto;">
            <div class="filter-controls">
                <select id="bookFilter" onchange="applyFilters()" class="form-select">
                    <option value="">All Books</option>
                    {% for book_no in book_numbers %}
                    <option value="{{ book_no }}" {% if book_filter == book_no|string %}selected{% endif %}>Book {{ book_no }}</option>
                    {% endfor %}
                </select>
                <select id="statusFilter" onchange="applyFilters()" class="form-select">
                    <option value="">All Statuses</option>
                    <option value="Available" {% if status_filter == 'Available' %}selected{% endif %}>Available</option>
                    <option value="Reserved" {% if status_filter == 'Reserved' %}selected{% endif %}>Reserved</option>
                    <option value="Used" {% if status_filter == 'Used' %}selected{% endif %}>Used</option>
                    <option value="Cancelled" {% if status_filter == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
                <select id="bookHolderFilter" onchange="applyFilters()" class="form-select">
                    <option value="">All Book Holders</option>
                    {% for holder in book_holders %}
                    <option value="{{ holder.user_id }}" {% if book_holder_filter == holder.user_id|string %}selected{% endif %}>{{ holder.name }}</option>
                    {% endfor %}
                </select>
                <select id="bankFilter" onchange="applyFilters()" class="form-select">
                    <option value="">All Banks</option>
                    {% for bank in bank_names %}
                    <option value="{{ bank }}" {% if bank_filter == bank %}selected{% endif %}>{{ bank }}</option>
                    {% endfor %}
                </select>
                {% if book_filter or status_filter or book_holder_filter or bank_filter %}
                <a href="{{ url_for('cheque_register') }}" class="btn btn-sm btn-outline" onclick="saveChequeExpandedBooks();">
                    <i class="fas fa-times"></i> Clear filters
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    {% if cheque_serials %}
        {% for group in cheque_serials | groupby('book.book_no') %}
        <div class="card cheque-book-card" style="border: 1px solid #dee2e6; border-radius: 8px; background: #fff;">
            <div class="card-body">
                <div class="book-section collapsed" data-book-no="{{ group.grouper }}">
                    <div class="book-section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="book-content-{{ group.grouper }}" id="book-header-{{ group.grouper }}">
                        <span class="book-section-chevron" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
                        <h3 class="book-section-title" style="margin:0;">Book No. {{ group.grouper }}{% if group.list %}{% set book = group.list[0].book %}{% if book and (book.book_holder or book.bank_name) %}<span class="book-heading-meta"> — {{ book.book_holder.name if book.book_holder else '' }}{% if book.book_holder and book.bank_name %}, {% endif %}{{ book.bank_name or '' }}</span>{% endif %}{% endif %}</h3>
                        {% if group.list %}<span class="book-heading-serial-range">Serial No: {{ group.list[0].serial_no }} - {{ group.list[-1].serial_no }}</span>{% endif %}
                        {% set has_non_available = group.list | selectattr('status', 'ne', 'Available') | list | length > 0 %}
                        {% if has_non_available %}
                        <span class="btn btn-sm btn-outline btn-edit-book btn-edit-book-disabled" title="Edit book (disabled: book has cheques that are not Available)">Edit</span>
                        {% else %}
                        <a href="{{ url_for('edit_book', book_no=group.grouper) }}" class="btn btn-sm btn-outline btn-edit-book" onclick="event.stopPropagation();" title="Edit book">Edit</a>
                        {% endif %}
                    </div>
                    <div class="book-section-content" id="book-content-{{ group.grouper }}">
                    {% if show_select_it %}
                    <div class="cheque-book-toolbar cheque-toolbar-it" data-book-no="{{ group.grouper }}" style="display: none;">
                        <button type="button" class="btn btn-danger btn-sm btn-delete-selected" data-book-no="{{ group.grouper }}">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                    {% endif %}
                    {% if show_select_ceo_gm_op %}
                    <div class="cheque-book-toolbar cheque-toolbar-reserve" data-book-no="{{ group.grouper }}" style="display: none;">
                        <span class="toolbar-reserve-actions" style="display: none;">
                            <button type="button" class="btn btn-sm btn-reserve-only" data-book-no="{{ group.grouper }}">
                                <i class="fas fa-bookmark"></i> Reserve Only
                            </button>
                            <button type="button" class="btn btn-sm btn-reserve-write" data-book-no="{{ group.grouper }}">
                                <i class="fas fa-file-invoice"></i> Reserve & Write
                            </button>
                        </span>
                        <span class="toolbar-write-only" style="display: none;">
                            <button type="button" class="btn btn-sm btn-reserve-write btn-write-cheque" data-book-no="{{ group.grouper }}">
                                <i class="fas fa-file-invoice"></i> Write Cheque
                            </button>
                        </span>
                        <span class="toolbar-print-only" style="display: none;">
                            <button type="button" class="btn btn-sm btn-reserve-write btn-print-cheque" data-book-no="{{ group.grouper }}">
                                <i class="fas fa-print"></i> Print Cheque
                            </button>
                        </span>
                    </div>
                    {% endif %}
                    <div class="table-responsive cheque-register-table-wrap">
                        <table class="data-table cheque-book-table">
                            <thead>
                                <tr>
                                    {% if show_cheque_select %}
                                    <th class="cheque-th-select">
                                        <input type="checkbox" class="cheque-select-all" data-book-no="{{ group.grouper }}" aria-label="Select all">
                                    </th>
                                    {% endif %}
                                    <th>Book No.</th>
                                    <th>Serial No.</th>
                                    <th>Status</th>
                                    <th>Payee Name</th>
                                    <th>Cheque's Date</th>
                                    <th>Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for serial in group.list %}
                                <tr data-book-no="{{ group.grouper }}" data-serial-id="{{ serial.id }}" data-status="{{ serial.status }}">
                                    {% if show_cheque_select %}
                                    <td class="cheque-td-select">
                                        <input type="checkbox" class="cheque-row-select" data-serial-id="{{ serial.id }}" data-book-no="{{ group.grouper }}" aria-label="Select serial {{ serial.serial_no }}" {% if show_select_ceo_gm_op and serial.status == 'Cancelled' %}disabled{% endif %}>
                                    </td>
                                    {% endif %}
                                    <td>{{ serial.book.book_no }}</td>
                                    <td>{{ serial.serial_no }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if serial.status == 'Available' %}badge-success
                                            {% elif serial.status == 'Reserved' %}badge-reserved
                                            {% elif serial.status == 'Used' %}badge-used
                                            {% elif serial.status == 'Cancelled' %}badge-danger
                                            {% else %}badge-secondary{% endif %}">
                                            {{ serial.status }}
                                        </span>
                                    </td>
                                    <td>{{ serial.payee_name or '-' }}</td>
                                    <td>{{ serial.cheque_date.strftime('%Y-%m-%d') if serial.cheque_date else '-' }}</td>
                                    <td>{{ "%.3f"|format(serial.amount) if serial.amount else '-' }}</td>
                                    <td class="upload-cell-td">
                                        <div class="upload-cell" data-serial-id="{{ serial.id }}" data-status="{{ serial.status }}">
                                            {% if serial.upload_path %}
                                                {% set filename = serial.upload_path.split('/')[-1] if '/' in serial.upload_path else serial.upload_path %}
                                                <div class="upload-cell-buttons">
                                                    <a href="/uploads/cheque/{{ filename }}" target="_blank" class="btn btn-sm btn-view-outline upload-view-btn" title="View uploaded file">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <button type="button" class="btn btn-sm cheque-remove-image-btn cheque-delete-upload-btn" title="Remove this image only so you can upload a different one" aria-label="Remove uploaded image">
                                                        <span class="remove-image-icon" aria-hidden="true">
                                                            <i class="fas fa-image"></i>
                                                            <i class="fas fa-times"></i>
                                                        </span>
                                                    </button>
                                                </div>
                                                <span class="upload-path-text" title="{{ filename }}">{{ filename }}</span>
                                            {% else %}
                                                <div class="upload-cell-buttons">
                                                    <input type="file" 
                                                           id="upload_{{ serial.id }}" 
                                                           class="cheque-upload-input" 
                                                           accept="image/*,.pdf" 
                                                           style="display: none;"
                                                           data-serial-id="{{ serial.id }}">
                                                    <button type="button" 
                                                            class="btn btn-sm btn-view-outline upload-btn" 
                                                            {% if serial.status == 'Available' %}disabled{% endif %}
                                                            onclick="{% if serial.status != 'Available' %}document.getElementById('upload_{{ serial.id }}').click(){% endif %}"
                                                            title="{% if serial.status == 'Available' %}Upload available after reserving or using the cheque{% else %}Upload image{% endif %}">
                                                        <i class="fas fa-upload"></i>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination-container cheque-book-pagination" data-book-no="{{ group.grouper }}">
                        <div class="pagination-left">
                            <div class="pagination-info">
                                <span class="cheque-pagination-info-text">Showing 1 to 0 of 0 cheques</span>
                            </div>
                            <div class="items-per-page">
                                <label>Show:</label>
                                <select class="cheque-per-page-select" data-book-no="{{ group.grouper }}">
                                    <option value="10" selected>10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                                <span>per page</span>
                            </div>
                        </div>
                        <div class="pagination cheque-pagination-buttons" data-book-no="{{ group.grouper }}">
                            <!-- Prev / page numbers / Next filled by JS -->
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="card" style="border: 1px solid #dee2e6; border-radius: 8px; background: #fff;">
            <div class="card-body">
                <div class="empty-state">
                    <i class="fas fa-book-open"></i>
                    <p style="margin-bottom: 0;">No cheque books yet.</p>
                    <p style="margin-top: 0.5rem; font-size: 1rem; opacity: 0.9;">Create a new book to start registering cheques.</p>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<script>
var chequePaginationState = {};

function getVisibleRowsForBook(bookNo) {
    var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
    if (!section) return [];
    var rows = section.querySelectorAll('.data-table tbody tr[data-book-no="' + bookNo + '"]');
    return Array.from(rows).filter(function(tr) { return tr.getAttribute('data-search-visible') !== 'false'; });
}

function renderBookPagination(bookNo) {
    var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
    if (!section) return;
    var state = chequePaginationState[bookNo] || { page: 1, per_page: 10 };
    chequePaginationState[bookNo] = state;
    var visible = getVisibleRowsForBook(bookNo);
    var total = visible.length;
    var perPage = Math.max(1, parseInt(state.per_page, 10) || 10);
    var pages = total === 0 ? 1 : Math.ceil(total / perPage);
    var page = Math.max(1, Math.min(state.page, pages));

    visible.forEach(function(tr, idx) {
        var start = (page - 1) * perPage;
        var end = start + perPage;
        tr.style.display = (idx >= start && idx < end) ? '' : 'none';
    });
    var allRows = section.querySelectorAll('.data-table tbody tr[data-book-no="' + bookNo + '"]');
    allRows.forEach(function(tr) {
        if (tr.getAttribute('data-search-visible') === 'false') tr.style.display = 'none';
    });

    var startIdx = total === 0 ? 0 : (page - 1) * perPage + 1;
    var endIdx = Math.min(page * perPage, total);
    var infoEl = document.querySelector('.cheque-book-pagination[data-book-no="' + bookNo + '"] .cheque-pagination-info-text');
    if (infoEl) infoEl.textContent = 'Showing ' + startIdx + ' to ' + endIdx + ' of ' + total + ' cheques';

    var btnContainer = document.querySelector('.cheque-book-pagination[data-book-no="' + bookNo + '"] .cheque-pagination-buttons');
    if (!btnContainer) return;
    btnContainer.innerHTML = '';
    btnContainer.style.display = pages <= 1 ? 'none' : 'flex';
    if (pages <= 1) return;

    if (page > 1) {
        var prevBtn = document.createElement('button');
        prevBtn.type = 'button';
        prevBtn.className = 'btn btn-sm btn-secondary';
        prevBtn.setAttribute('data-book-no', bookNo);
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
        prevBtn.addEventListener('click', function() { state.page = page - 1; renderBookPagination(bookNo); });
        btnContainer.appendChild(prevBtn);
    }

    function iterPages(leftEdge, rightEdge, leftCurrent, rightCurrent) {
        var result = [];
        var last = 0;
        for (var num = 1; num <= pages; num++) {
            var show = num <= leftEdge ||
                (num > page - leftCurrent - 1 && num < page + rightCurrent) ||
                num > pages - rightEdge;
            if (show) {
                if (last + 1 !== num) result.push(null);
                result.push(num);
                last = num;
            }
        }
        return result;
    }
    var pageNums = iterPages(2, 2, 2, 5);
    pageNums.forEach(function(p) {
        if (p === null) {
            var ellipsis = document.createElement('span');
            ellipsis.className = 'pagination-ellipsis';
            ellipsis.textContent = '...';
            btnContainer.appendChild(ellipsis);
        } else {
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = p === page ? 'btn btn-sm btn-primary cheque-pagination-current' : 'btn btn-sm btn-outline';
            btn.setAttribute('data-book-no', bookNo);
            btn.setAttribute('data-page', p);
            btn.textContent = p;
            if (p !== page) {
                btn.addEventListener('click', function() {
                    var b = this.getAttribute('data-book-no');
                    var pg = parseInt(this.getAttribute('data-page'), 10);
                    chequePaginationState[b].page = pg;
                    renderBookPagination(b);
                });
            }
            btnContainer.appendChild(btn);
        }
    });

    if (page < pages) {
        var nextBtn = document.createElement('button');
        nextBtn.type = 'button';
        nextBtn.className = 'btn btn-sm btn-secondary';
        nextBtn.setAttribute('data-book-no', bookNo);
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.addEventListener('click', function() { state.page = page + 1; renderBookPagination(bookNo); });
        btnContainer.appendChild(nextBtn);
    }
}

function refreshAllChequePagination() {
    document.querySelectorAll('.cheque-register-page .book-section[data-book-no]').forEach(function(section) {
        var bookNo = section.getAttribute('data-book-no');
        if (bookNo) renderBookPagination(bookNo);
    });
}

var CHEQUE_EXPANDED_STORAGE_KEY = 'cheque_register_expanded_books';
function saveChequeExpandedBooks() {
    var expanded = [];
    document.querySelectorAll('.cheque-register-page .book-section[data-book-no]').forEach(function(section) {
        if (!section.classList.contains('collapsed')) {
            var bookNo = section.getAttribute('data-book-no');
            if (bookNo) expanded.push(bookNo);
        }
    });
    try { sessionStorage.setItem(CHEQUE_EXPANDED_STORAGE_KEY, JSON.stringify(expanded)); } catch (e) {}
}
function restoreChequeExpandedBooks() {
    try {
        var raw = sessionStorage.getItem(CHEQUE_EXPANDED_STORAGE_KEY);
        if (!raw) return;
        var expanded = JSON.parse(raw);
        if (!Array.isArray(expanded) || expanded.length === 0) return;
        expanded.forEach(function(bookNo) {
            var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
            if (section) {
                section.classList.remove('collapsed');
                var header = section.querySelector('.book-section-header');
                if (header) header.setAttribute('aria-expanded', 'true');
            }
        });
    } catch (e) {}
}

document.addEventListener('DOMContentLoaded', function() {
    // Collapsible book section headers
    document.querySelectorAll('.cheque-register-page .book-section-header').forEach(function(header) {
        var section = header.closest('.book-section');
        if (!section) return;
        function toggleSection() {
            section.classList.toggle('collapsed');
            var expanded = !section.classList.contains('collapsed');
            header.setAttribute('aria-expanded', expanded);
        }
        header.addEventListener('click', toggleSection);
        header.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSection(); }
        });
    });
    restoreChequeExpandedBooks();

    // Per-book pagination state and render
    document.querySelectorAll('.cheque-register-page .book-section[data-book-no]').forEach(function(section) {
        var bookNo = section.getAttribute('data-book-no');
        if (!chequePaginationState[bookNo]) chequePaginationState[bookNo] = { page: 1, per_page: 10 };
        renderBookPagination(bookNo);
    });
    document.querySelectorAll('.cheque-per-page-select').forEach(function(sel) {
        sel.addEventListener('change', function() {
            var bookNo = this.getAttribute('data-book-no');
            chequePaginationState[bookNo].per_page = parseInt(this.value, 10);
            chequePaginationState[bookNo].page = 1;
            renderBookPagination(bookNo);
        });
    });

    // Client-side search: filter table rows by serial #, payee, amount, date, book
    const searchInput = document.getElementById('chequeSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const q = (this.value || '').trim().toLowerCase();
            document.querySelectorAll('.cheque-register-page .book-section').forEach(function(section) {
                let visibleCount = 0;
                section.querySelectorAll('.data-table tbody tr').forEach(function(tr) {
                    const cells = tr.querySelectorAll('td');
                    const rowText = Array.from(cells).map(function(c) { return (c.textContent || '').trim(); }).join(' ').toLowerCase();
                    const show = !q || rowText.indexOf(q) !== -1;
                    tr.setAttribute('data-search-visible', show ? 'true' : 'false');
                    tr.style.display = show ? '' : 'none';
                    if (show) visibleCount++;
                });
                var card = section.closest('.cheque-book-card');
                if (card) card.style.display = visibleCount > 0 ? '' : 'none';
            });
            refreshAllChequePagination();
        });
    }

    // Delete existing upload so user can upload a different image
    document.addEventListener('click', function(e) {
        const deleteBtn = e.target.closest('.cheque-delete-upload-btn');
        if (!deleteBtn) return;
        const uploadCell = deleteBtn.closest('.upload-cell');
        if (!uploadCell) return;
        const serialId = uploadCell.getAttribute('data-serial-id');
        const status = uploadCell.getAttribute('data-status') || '';
        if (!confirm('Remove this uploaded image? You can then upload a different one.')) return;
        deleteBtn.disabled = true;
        const formData = new FormData();
        formData.append('serial_id', serialId);
        fetch('/cheque-register/delete-upload', { method: 'POST', body: formData })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    uploadCell.innerHTML = '';
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'upload-cell-buttons';
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.id = 'upload_' + serialId;
                    input.className = 'cheque-upload-input';
                    input.setAttribute('accept', 'image/*,.pdf');
                    input.style.display = 'none';
                    input.setAttribute('data-serial-id', serialId);
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm btn-view-outline upload-btn';
                    if (status === 'Available') btn.disabled = true;
                    btn.title = status === 'Available' ? 'Upload available after reserving or using the cheque' : 'Upload image';
                    btn.innerHTML = '<i class="fas fa-upload"></i>';
                    btn.onclick = function() { if (status !== 'Available') input.click(); };
                    buttonsDiv.appendChild(input);
                    buttonsDiv.appendChild(btn);
                    uploadCell.appendChild(buttonsDiv);
                } else {
                    alert(data.error || 'Could not remove upload.');
                    deleteBtn.disabled = false;
                }
            })
            .catch(function(err) {
                console.error('Delete upload error:', err);
                alert('An error occurred. Please try again.');
                deleteBtn.disabled = false;
            });
    });

    // Handle file upload for cheque serials (delegated so dynamically added inputs work)
    document.addEventListener('change', function(e) {
        if (!e.target.matches('.cheque-upload-input')) return;
        const input = e.target;
        const file = input.files[0];
        if (!file) return;
        
        const serialId = input.getAttribute('data-serial-id');
        const uploadCell = input.closest('.upload-cell');
        const uploadBtn = uploadCell.querySelector('.upload-btn');
        
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
        if (!allowedTypes.includes(file.type)) {
            alert('Please upload an image file (JPG, PNG, GIF) or PDF.');
            input.value = '';
            return;
        }
        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File size exceeds 50MB limit. Please choose a smaller file.');
            input.value = '';
            return;
        }
        if (!confirm('Are you sure you want to upload "' + file.name + '" for this cheque? This will replace any existing upload.')) {
            input.value = '';
            return;
        }
        
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        const formData = new FormData();
        formData.append('file', file);
        formData.append('serial_id', serialId);
        fetch('/cheque-register/upload', { method: 'POST', body: formData })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    uploadBtn.remove();
                    input.remove();
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.className = 'upload-cell-buttons';
                    const viewBtn = document.createElement('a');
                    viewBtn.href = '/uploads/cheque/' + data.filename;
                    viewBtn.target = '_blank';
                    viewBtn.className = 'btn btn-sm btn-view-outline upload-view-btn';
                    viewBtn.title = 'View uploaded file';
                    viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                    buttonsDiv.appendChild(viewBtn);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.type = 'button';
                    deleteBtn.className = 'btn btn-sm cheque-remove-image-btn cheque-delete-upload-btn';
                    deleteBtn.title = 'Remove this image only so you can upload a different one';
                    deleteBtn.setAttribute('aria-label', 'Remove uploaded image');
                    deleteBtn.innerHTML = '<span class="remove-image-icon" aria-hidden="true"><i class="fas fa-image"></i><i class="fas fa-times"></i></span>';
                    buttonsDiv.appendChild(deleteBtn);
                    uploadCell.appendChild(buttonsDiv);
                    const pathSpan = document.createElement('span');
                    pathSpan.className = 'upload-path-text';
                    pathSpan.title = data.filename;
                    pathSpan.textContent = data.filename;
                    uploadCell.appendChild(pathSpan);
                } else {
                    alert(data.error || 'Upload failed. Please try again.');
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="fas fa-upload"></i>';
                    input.value = '';
                }
            })
            .catch(function(error) {
                console.error('Upload error:', error);
                alert('An error occurred during upload. Please try again.');
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload"></i>';
                input.value = '';
            });
    });

    // Checkbox column: IT (Delete) or CEO/GM/Operation Manager (Reserve toolbar)
    function updateSelectToolbarForBook(bookNo) {
        var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
        if (!section) return;
        var checked = section.querySelectorAll('.cheque-row-select:checked');
        var toolbarIt = section.querySelector('.cheque-toolbar-it');
        var toolbarReserve = section.querySelector('.cheque-toolbar-reserve');
        if (toolbarIt) toolbarIt.style.display = checked.length > 0 ? 'flex' : 'none';
        if (toolbarReserve) {
            toolbarReserve.style.display = checked.length > 0 ? 'flex' : 'none';
            if (checked.length > 0) {
                var allReserved = true;
                var allUsed = true;
                checked.forEach(function(cb) {
                    var row = cb.closest('tr');
                    var status = row ? row.getAttribute('data-status') : '';
                    if (status !== 'Reserved') allReserved = false;
                    if (status !== 'Used') allUsed = false;
                });
                var reserveActions = toolbarReserve.querySelector('.toolbar-reserve-actions');
                var writeOnly = toolbarReserve.querySelector('.toolbar-write-only');
                var printOnly = toolbarReserve.querySelector('.toolbar-print-only');
                if (allUsed) {
                    if (reserveActions) reserveActions.style.display = 'none';
                    if (writeOnly) writeOnly.style.display = 'none';
                    if (printOnly) printOnly.style.display = 'inline';
                } else {
                    if (printOnly) printOnly.style.display = 'none';
                    if (reserveActions) reserveActions.style.display = allReserved ? 'none' : 'inline';
                    if (writeOnly) writeOnly.style.display = allReserved ? 'inline' : 'none';
                }
            }
        }
        var selectAll = section.querySelector('.cheque-select-all');
        if (selectAll) {
            var allEnabled = section.querySelectorAll('.cheque-row-select:not([disabled])');
            selectAll.checked = allEnabled.length > 0 && checked.length === allEnabled.length;
            selectAll.indeterminate = checked.length > 0 && checked.length < allEnabled.length;
        }
    }
    // Enforce only one status selected per book (no mixing Available / Reserved / Used)
    function enforceSingleStatusPerBook(bookNo, allowedStatus) {
        var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
        if (!section || !allowedStatus) return;
        section.querySelectorAll('.cheque-row-select:checked').forEach(function(cb) {
            var row = cb.closest('tr');
            if (row && row.getAttribute('data-status') !== allowedStatus) cb.checked = false;
        });
    }
    // Enforce only one Used cheque selected per book
    function enforceSingleUsedPerBook(bookNo) {
        var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
        if (!section) return;
        var usedChecked = [];
        section.querySelectorAll('.cheque-row-select:checked').forEach(function(cb) {
            var row = cb.closest('tr');
            if (row && row.getAttribute('data-status') === 'Used') usedChecked.push(cb);
        });
        if (usedChecked.length <= 1) return;
        usedChecked.slice(1).forEach(function(cb) { cb.checked = false; });
    }
    document.querySelectorAll('.cheque-row-select').forEach(function(cb) {
        cb.addEventListener('change', function() {
            var bookNo = this.getAttribute('data-book-no');
            var row = this.closest('tr');
            var status = row ? row.getAttribute('data-status') : null;
            if (this.checked && status) {
                enforceSingleStatusPerBook(bookNo, status);
                if (status === 'Used') enforceSingleUsedPerBook(bookNo);
            }
            updateSelectToolbarForBook(bookNo);
        });
    });
    document.querySelectorAll('.cheque-select-all').forEach(function(cb) {
        cb.addEventListener('change', function() {
            var bookNo = this.getAttribute('data-book-no');
            var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
            if (!section) return;
            if (cb.checked) {
                var firstCb = section.querySelector('.cheque-row-select:not([disabled])');
                var firstStatus = firstCb && firstCb.closest('tr') ? firstCb.closest('tr').getAttribute('data-status') : null;
                section.querySelectorAll('.cheque-row-select:not([disabled])').forEach(function(rowCb) {
                    var r = rowCb.closest('tr');
                    rowCb.checked = r && r.getAttribute('data-status') === firstStatus;
                });
                if (firstStatus === 'Used') enforceSingleUsedPerBook(bookNo);
            } else {
                section.querySelectorAll('.cheque-row-select:not([disabled])').forEach(function(rowCb) {
                    rowCb.checked = false;
                });
            }
            updateSelectToolbarForBook(bookNo);
        });
    });
    document.querySelectorAll('.btn-delete-selected').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var bookNo = this.getAttribute('data-book-no');
            var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
            if (!section) return;
            var checked = section.querySelectorAll('.cheque-row-select:checked');
            if (checked.length === 0) return;
            var serialIds = Array.from(checked).map(function(c) { return parseInt(c.getAttribute('data-serial-id'), 10); });
            var totalInBook = section.querySelectorAll('.cheque-row-select').length;
            var msg = totalInBook === checked.length
                ? 'Delete all ' + totalInBook + ' cheque(s) in this book? The entire book will be removed.'
                : 'Delete ' + checked.length + ' selected cheque(s)?';
            if (!confirm(msg)) return;
            btn.disabled = true;
            fetch('{{ url_for("delete_cheque_serials") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({ serial_ids: serialIds })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    if (data.deleted_books && data.deleted_books.indexOf(parseInt(bookNo, 10)) !== -1) {
                        var card = section.closest('.cheque-book-card');
                        if (card) card.remove();
                    } else {
                        (data.deleted_serial_ids || []).forEach(function(id) {
                            var row = section.querySelector('tr[data-serial-id="' + id + '"]');
                            if (row) row.remove();
                        });
                        updateSelectToolbarForBook(bookNo);
                        renderBookPagination(bookNo);
                    }
                } else {
                    alert(data.error || 'Delete failed.');
                }
            })
            .catch(function(err) {
                console.error(err);
                alert('An error occurred. Please try again.');
            })
            .finally(function() { btn.disabled = false; });
        });
    });

    // CEO/GM/Operation Manager: Reserve Only (only sets status to "Reserved") or Reserve & Write (reserve then go to write-cheque)
    function doReserveSelected(bookNo, redirectToWrite) {
        var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
        if (!section) return;
        var checked = section.querySelectorAll('.cheque-row-select:checked');
        if (checked.length === 0) return;
        var serialIds = Array.from(checked).map(function(c) { return parseInt(c.getAttribute('data-serial-id'), 10); });
        var btn = section.querySelector(redirectToWrite ? '.btn-reserve-write' : '.btn-reserve-only');
        if (btn) btn.disabled = true;
        fetch('{{ url_for("reserve_cheque") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
            body: JSON.stringify({ serial_ids: serialIds })
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                saveChequeExpandedBooks();
                if (redirectToWrite) {
                    window.location.href = '{{ url_for("write_cheque") }}?serial_ids=' + serialIds.join(',');
                } else {
                    window.location.reload();
                }
            } else {
                alert(data.error || 'Reserve failed.');
            }
        })
        .catch(function(err) {
            console.error(err);
            alert('An error occurred. Please try again.');
        })
        .finally(function() {
            if (btn) btn.disabled = false;
        });
    }
    document.querySelectorAll('.btn-reserve-only').forEach(function(btn) {
        btn.addEventListener('click', function() {
            doReserveSelected(this.getAttribute('data-book-no'), false);
        });
    });
    document.querySelectorAll('.btn-reserve-write').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var bookNo = this.getAttribute('data-book-no');
            if (this.classList.contains('btn-write-cheque')) {
                saveChequeExpandedBooks();
                var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
                if (!section) return;
                var checked = section.querySelectorAll('.cheque-row-select:checked');
                if (checked.length === 0) return;
                var serialIds = Array.from(checked).map(function(c) { return parseInt(c.getAttribute('data-serial-id'), 10); });
                window.location.href = '{{ url_for("write_cheque") }}?serial_ids=' + serialIds.join(',');
            } else {
                doReserveSelected(bookNo, true);
            }
        });
    });
    document.querySelectorAll('.btn-print-cheque').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var bookNo = this.getAttribute('data-book-no');
            saveChequeExpandedBooks();
            var section = document.querySelector('.book-section[data-book-no="' + bookNo + '"]');
            if (!section) return;
            var checked = section.querySelectorAll('.cheque-row-select:checked');
            if (checked.length === 0) return;
            var serialIds = Array.from(checked).map(function(c) { return parseInt(c.getAttribute('data-serial-id'), 10); });
            window.location.href = '{{ url_for("write_cheque") }}?serial_ids=' + serialIds.join(',') + '&print=1';
        });
    });
});

function applyFilters() {
    const bookFilter = document.getElementById('bookFilter');
    const statusFilter = document.getElementById('statusFilter');
    const bookHolderFilter = document.getElementById('bookHolderFilter');
    const bankFilter = document.getElementById('bankFilter');
    const bookValue = bookFilter.value;
    const statusValue = statusFilter.value;
    const bookHolderValue = bookHolderFilter ? bookHolderFilter.value : '';
    const bankValue = bankFilter ? bankFilter.value : '';
    
    const url = new URL(window.location);
    
    if (bookValue) url.searchParams.set('book', bookValue);
    else url.searchParams.delete('book');
    
    if (statusValue) url.searchParams.set('status', statusValue);
    else url.searchParams.delete('status');
    
    if (bookHolderValue) url.searchParams.set('book_holder', bookHolderValue);
    else url.searchParams.delete('book_holder');
    
    if (bankValue) url.searchParams.set('bank', bankValue);
    else url.searchParams.delete('bank');
    
    saveChequeExpandedBooks();
    window.location.href = url.toString();
}
</script>
{% endblock %}

