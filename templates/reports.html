{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<style>
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
        width: 150px;
        min-width: 150px;
    }
    
    .data-table th:nth-child(7),
    .data-table td:nth-child(7) {
        text-align: left;
        width: 180px;
        min-width: 180px;
        max-width: 180px;
    }
    
    .data-table td:nth-child(7) {
        padding: 4px 8px !important;
        line-height: 1.4 !important;
        vertical-align: middle !important;
    }
    
    .data-table td:nth-child(7) br {
        line-height: 1.4;
    }
    
    .scheduled-date-col {
        width: 180px !important;
        min-width: 180px !important;
        max-width: 180px !important;
        padding: 4px 8px !important;
    }

    /* Filter Button and Active Filters */
    .filters-container {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .filters-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 28px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        color: #495057;
        transition: all 0.2s;
    }

    .filters-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
    }

    .filters-btn i {
        font-size: 18px;
    }

    .active-filters {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        flex: 1;
    }

    .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #000;
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }

    .filter-pill .remove-filter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        transition: background 0.2s;
    }

    .filter-pill .remove-filter:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .clear-all-btn {
        color: #007bff;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        padding: 0;
        text-decoration: underline;
        transition: color 0.2s;
    }

    .clear-all-btn:hover {
        color: #0056b3;
    }

    /* Side Panel */
    .filter-side-panel {
        position: fixed;
        top: 0;
        right: -450px;
        width: 450px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: right 0.3s ease;
        overflow-y: auto;
    }

    .filter-side-panel.open {
        right: 0;
    }

    .filter-panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .filter-panel-overlay.show {
        display: block;
        opacity: 1;
    }

    .filter-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
    }

    .filter-panel-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #212529;
    }

    .filter-panel-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .filter-panel-close:hover {
        background: #e9ecef;
    }

    .filter-panel-body {
        padding: 20px;
    }

    .filter-panel-body .form-group {
        margin-bottom: 20px;
    }

    .filter-panel-body label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }

    .filter-panel-body select,
    .filter-panel-body input[type="date"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    /* Checkbox Groups for Multi-Select Filters */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        margin-top: 8px;
    }

    .checkbox-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .checkbox-option:hover {
        background-color: #f8f9fa;
    }

    .checkbox-option input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
    }

    .checkbox-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        flex: 1;
        user-select: none;
    }
    
    /* Make entire checkbox option clickable */
    .checkbox-option:has(input[type="checkbox"]:not(:checked)):hover {
        background-color: #f8f9fa;
    }
    
    .checkbox-option:has(input[type="checkbox"]:checked) {
        background-color: #e7f3ff;
    }

    .filter-panel-body small {
        display: block;
        margin-top: 4px;
        color: #6c757d;
        font-size: 12px;
    }

    .filter-panel-actions {
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
        display: flex;
        gap: 10px;
        position: sticky;
        bottom: 0;
    }

    .filter-panel-actions .btn {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        font-weight: 500;
    }

    /* Payment Method Selectable Boxes */
    .payment-method-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .payment-method-option {
        padding: 10px 20px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background: white;
        color: #495057;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        user-select: none;
    }

    .payment-method-option:hover {
        border-color: #adb5bd;
        background: #f8f9fa;
    }

    .payment-method-option.selected {
        background: #000;
        color: white;
        border-color: #000;
    }

    .payment-method-option input[type="checkbox"] {
        display: none;
    }
</style>
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-chart-bar"></i> Payment Reports</h1>
        <p>Filter and analyze payment requests</p>
    </div>

    <!-- Filters Button and Active Filters -->
    <div class="filters-container">
        <button type="button" class="filters-btn" onclick="openFilterPanel()">
            <i class="fas fa-filter"></i>
            Filters
        </button>
        <div class="active-filters" id="active-filters">
            {% set has_filters = False %}
            {% if request.args.getlist('department') %}
                <span class="filter-pill">
                    Department: {{ request.args.getlist('department') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('department')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('request_type') %}
                <span class="filter-pill">
                    Type: {{ request.args.getlist('request_type') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('request_type')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('company') %}
                <span class="filter-pill">
                    Company: {{ request.args.getlist('company') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('company')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('branch') %}
                <span class="filter-pill">
                    Branch: {{ request.args.getlist('branch') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('branch')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('payment_type') %}
                <span class="filter-pill">
                    Payment Type: {{ request.args.getlist('payment_type') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('payment_type')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('payment_method') %}
                <span class="filter-pill">
                    Payment Method: {{ request.args.getlist('payment_method') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('payment_method')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('status') %}
                <span class="filter-pill">
                    Status: {{ request.args.getlist('status') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('status')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.get('date_from') %}
                <span class="filter-pill">
                    From: {{ request.args.get('date_from') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('date_from')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.get('date_to') %}
                <span class="filter-pill">
                    To: {{ request.args.get('date_to') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('date_to')" title="Remove filter">√ó</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if has_filters %}
                <button type="button" class="clear-all-btn" onclick="clearAllFilters()">Clear all</button>
            {% endif %}
        </div>
    </div>

    <!-- Filter Side Panel -->
    <div class="filter-panel-overlay" id="filter-overlay" onclick="closeFilterPanel()"></div>
    <div class="filter-side-panel" id="filter-panel">
        <div class="filter-panel-header">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <button type="button" class="filter-panel-close" onclick="closeFilterPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-panel-body">
            <form method="GET" action="{{ url_for('reports') }}" id="filter-form">
                <div class="form-group">
                    <label>Department</label>
                    <div class="checkbox-group" id="department-group">
                        {% for dept in departments %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="department" id="dept_{{ loop.index }}" value="{{ dept }}" {% if dept in request.args.getlist('department') %}checked{% endif %}>
                            <label for="dept_{{ loop.index }}">{{ dept }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Request Type</label>
                    <div class="checkbox-group" id="request_type-group">
                        {# Non-"Others" first #}
                        {% for request_type in request_types | reject('equalto', 'Others') %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="request_type" id="rt_{{ loop.index }}" value="{{ request_type }}" {% if request_type in request.args.getlist('request_type') %}checked{% endif %}>
                            <label for="rt_{{ loop.index }}">{{ request_type }}</label>
                        </div>
                        {% endfor %}
                        {# Ensure "Others" is always last if present #}
                        {% for request_type in request_types | select('equalto', 'Others') %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="request_type" id="rt_others_{{ loop.index }}" value="{{ request_type }}" {% if request_type in request.args.getlist('request_type') %}checked{% endif %}>
                            <label for="rt_others_{{ loop.index }}">{{ request_type }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Company Name</label>
                    <div class="checkbox-group" id="company-group">
                        {% for company in companies %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="company" id="company_{{ loop.index }}" value="{{ company }}" {% if company in request.args.getlist('company') %}checked{% endif %}>
                            <label for="company_{{ loop.index }}">{{ company }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <small class="form-text text-muted">Only available for approved requests</small>
                </div>

                <div class="form-group">
                    <label>Branch Name</label>
                    <div class="checkbox-group" id="branch-group">
                        {% for branch in branches %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="branch" id="branch_{{ loop.index }}" value="{{ branch.name }}" {% if branch.name in request.args.getlist('branch') %}checked{% endif %}>
                            <label for="branch_{{ loop.index }}">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Payment Type</label>
                    <div class="checkbox-group" id="payment_type-group">
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_onetime" value="One-Time" {% if 'One-Time' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_onetime">One-Time</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_scheduled" value="Scheduled One-Time" {% if 'Scheduled One-Time' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_scheduled">Scheduled One-Time</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_recurring" value="Recurring" {% if 'Recurring' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_recurring">Recurring</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Payment Method</label>
                    <div class="payment-method-options">
                        <label class="payment-method-option {% if 'Card' in request.args.getlist('payment_method') %}selected{% endif %}" onclick="togglePaymentMethod(event, 'Card')">
                            <input type="checkbox" name="payment_method" value="Card" {% if 'Card' in request.args.getlist('payment_method') %}checked{% endif %}>
                            Card
                        </label>
                        <label class="payment-method-option {% if 'Cheque' in request.args.getlist('payment_method') %}selected{% endif %}" onclick="togglePaymentMethod(event, 'Cheque')">
                            <input type="checkbox" name="payment_method" value="Cheque" {% if 'Cheque' in request.args.getlist('payment_method') %}checked{% endif %}>
                            Cheque
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <div class="checkbox-group" id="status-group">
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_allpending" value="All Pending" {% if 'All Pending' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_allpending">All Pending</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_pendingmgr" value="Pending Manager Approval" {% if 'Pending Manager Approval' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_pendingmgr">Pending Manager Approval</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_pendingfin" value="Pending Finance Approval" {% if 'Pending Finance Approval' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_pendingfin">Pending Finance Approval</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_rejectedmgr" value="Rejected by Manager" {% if 'Rejected by Manager' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_rejectedmgr">Rejected by Manager</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofpending" value="Proof Pending" {% if 'Proof Pending' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofpending">Proof Pending</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofsent" value="Proof Sent" {% if 'Proof Sent' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofsent">Proof Sent</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofrejected" value="Proof Rejected" {% if 'Proof Rejected' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofrejected">Proof Rejected</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_recurring" value="Recurring" {% if 'Recurring' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_recurring">Recurring</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_completed" value="Completed" {% if 'Completed' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_completed">Completed</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="date_from">Date From</label>
                    <input type="date" name="date_from" id="date_from" value="{{ request.args.get('date_from', '') }}">
                </div>

                <div class="form-group">
                    <label for="date_to">Date To</label>
                    <input type="date" name="date_to" id="date_to" value="{{ request.args.get('date_to', '') }}">
                </div>
            </form>
        </div>
        <div class="filter-panel-actions">
            <button type="button" class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search"></i> Apply Filters
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                <i class="fas fa-redo"></i> Clear All
            </button>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #2196F3;">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_requests }}</h3>
                <p>Total Results</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #4CAF50;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ completed_count }}</h3>
                <p>Completed</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #FF9800;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ pending_count }}</h3>
                <p>Pending</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #9C27B0;">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-info">
                {% if user.role == 'IT Staff' or (user.role == 'Department Manager' and user.department == 'IT') %}
                    {% if it_amount is not none and it_amount > 0 %}
                        <h3>OMR {{ it_amount|format_currency }}</h3>
                        <small style="color: #666;">(IT Department Only)</small>
                    {% else %}
                        <h3 style="color: #999;">OMR 0.000</h3>
                    {% endif %}
                {% else %}
                    <h3>OMR {{ total_amount|format_currency }}</h3>
                {% endif %}
                <p>Total Amount</p>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2><i class="fas fa-table"></i> Report Results</h2>
            {% if requests and requests|length > 0 %}
            <div class="header-actions">
                <a class="btn btn-success" id="export-excel-btn" href="{{ url_for('export_reports_excel') }}{{ '?' + request.query_string.decode('utf-8') if request.query_string else '' }}" onclick="return showExportLoading(event)">
                    <i class="fas fa-file-excel"></i> <span id="export-excel-text">Export Excel</span>
                </a>
                <a class="btn btn-secondary" id="export-pdf-btn" href="{{ url_for('export_reports_pdf') }}{{ '?' + request.query_string.decode('utf-8') if request.query_string else '' }}" onclick="return showExportLoading(event)">
                    <i class="fas fa-file-pdf"></i> <span id="export-text">Export PDF</span>
                </a>
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            {% if requests %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Requestor</th>
                                <th>Department</th>
                                <th>Payment Type</th>
                                <th>Payment Method</th>
                                <th class="scheduled-date-col">Scheduled Date</th>
                                <th>Branch Name</th>
                                <th>Person/Company</th>
                                <th>Submitted</th>
                                <th>Approved</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Approver</th>
                                <th>Manager Duration</th>
                                <th>Finance Duration</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in requests %}
                            {% set manager_duration = '' %}
                            {% set finance_duration = '' %}
                            {% if req.manager_approval_duration_minutes %}
                                {% set hours = req.manager_approval_duration_minutes // 3600 %}
                                {% set minutes = (req.manager_approval_duration_minutes % 3600) // 60 %}
                                {% set seconds = req.manager_approval_duration_minutes % 60 %}
                                {% set manager_duration = hours ~ ':' ~ '%02d'|format(minutes) ~ ':' ~ '%02d'|format(seconds) %}
                            {% endif %}
                            {% if req.finance_approval_duration_minutes %}
                                {% set hours = req.finance_approval_duration_minutes // 3600 %}
                                {% set minutes = (req.finance_approval_duration_minutes % 3600) // 60 %}
                                {% set seconds = req.finance_approval_duration_minutes % 60 %}
                                {% set finance_duration = hours ~ ':' ~ '%02d'|format(minutes) ~ ':' ~ '%02d'|format(seconds) %}
                            {% endif %}
                            <tr>
                                <td>#{{ req.request_id }}</td>
                                <td><span class="badge badge-info">{{ req.request_type }}</span></td>
                                <td>{{ req.requestor_name }}</td>
                                <td>{{ req.department }}</td>
                                <td>
                                    {% if req.recurring == 'Recurring' %}
                                        Recurring
                                    {% elif req.payment_date or req.recurring == 'Scheduled One-Time' %}
                                        Scheduled One-Time
                                    {% else %}
                                        {{ req.recurring or 'One-Time' }}
                                    {% endif %}
                                </td>
                                <td>{{ req.payment_method or 'Card' }}</td>
                                <td class="scheduled-date-col">
                                    {% if req.recurring == 'Recurring' %}
                                        {% set recurring_dates = req|get_recurring_dates %}
                                        {% if recurring_dates %}
                                            {% for date_line in recurring_dates.strip().split('\n') %}
                                                {% if date_line.strip() %}
                                                    {{ date_line.strip() }}{% if not loop.last %}<br>{% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span style="color: #999;">-</span>
                                        {% endif %}
                                    {% elif req.payment_date %}
                                        {{ req.payment_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.branch_name %}
                                        {% set branch_list = req.branch_name.split(',') %}
                                        {% for branch in branch_list %}
                                            {% set branch_trimmed = branch.strip() %}
                                            {% if branch_trimmed %}
                                                <span class="filter-pill" style="margin-right: 4px; margin-bottom: 4px; display: inline-block;">{{ branch_trimmed }}</span>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.person_company %}
                                        {{ req.person_company }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if req.approval_date %}
                                        {{ req.approval_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if (user.role == 'IT Staff' or (user.role == 'Department Manager' and user.department == 'IT')) and req.department != 'IT' %}
                                        <span style="color: #999;">***</span>
                                    {% else %}
                                        OMR {{ "%.3f"|format(req.amount) }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.status == 'Approved' %}
                                        <span class="badge badge-success">‚úì {{ req.status }}</span>
                                    {% elif req.status == 'Completed' %}
                                        <span class="badge" style="background: #28a745; color: white;">‚úì {{ req.status }}</span>
                                    {% elif req.status in ['Pending Manager Approval', 'Pending Finance Approval'] %}
                                        <span class="badge" style="background: #6c757d; color: white;">‚è≥ {{ req.status }}</span>
                                    {% elif req.status == 'Payment Pending' %}
                                        <span class="badge" style="background: #FF9800; color: white;">‚è≥ {{ req.status }}</span>
                                    {% elif req.status in ['Proof Pending', 'Proof Sent'] %}
                                        <span class="badge" style="background: #2196F3; color: white;">üìÑ {{ req.status }}</span>
                                    {% elif req.status == 'Paid' %}
                                        <span class="badge" style="background: #6f42c1; color: white;">üí∞ {{ req.status }}</span>
                                    {% elif req.status == 'Recurring' %}
                                        <span class="badge" style="background: #ffc107; color: #212529;">‚Üª {{ req.status }}</span>
                                    {% elif req.status in ['Rejected by Manager', 'Rejected by Finance', 'Proof Rejected'] or 'Rejected' in req.status %}
                                        <span class="badge" style="background: #dc3545; color: white;">‚úó {{ req.status }}</span>
                                    {% else %}
                                        <span class="badge badge-warning">‚è≥ {{ req.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ req.approver or 'N/A' }}</td>
                                <td>
                                    {% if manager_duration %}
                                        <span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">{{ manager_duration }}</span>
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if finance_duration %}
                                        <span style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px; font-size: 0.9em;">{{ finance_duration }}</span>
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                        <i class="fas fa-eye"></i> View
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                {% if pagination %}
                <div class="pagination-container">
                    <div class="pagination-left">
                        <div class="pagination-info">
                            Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} to 
                            {{ pagination.per_page * (pagination.page - 1) + pagination.items|length }} 
                            of {{ pagination.total }} requests
                        </div>
                        <div class="items-per-page">
                            <label for="per_page">Show:</label>
                            <select id="per_page" onchange="changeItemsPerPage(this.value)">
                                <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                                <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    {% if pagination.pages > 1 %}
                    <div class="pagination">
                        {% if pagination.has_prev %}
                            <a href="#" class="btn btn-sm btn-secondary pagination-link" data-page="{{ pagination.prev_num }}">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <a href="#" class="btn btn-sm btn-outline pagination-link" data-page="{{ page_num }}">{{ page_num }}</a>
                                {% else %}
                                    <span class="btn btn-sm btn-primary">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                            <a href="#" class="btn btn-sm btn-secondary pagination-link" data-page="{{ pagination.next_num }}">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>No results found for the selected filters.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let exportTimeout;
let isExporting = false;
let exportingType = null; // 'pdf' or 'excel'
let windowBlurred = false;
let downloadStartTime = null;
let loaderCheckInterval = null;

// Helper function to hide global loader if it exists
function hideGlobalLoader() {
    const globalLoader = document.getElementById('global-loader');
    if (globalLoader) {
        globalLoader.remove();
    }
    // Also try calling hideLoading if it exists
    if (typeof hideLoading === 'function') {
        hideLoading();
    }
}

function showExportLoading(event) {
    if (isExporting) {
        event.preventDefault();
        return false; // Prevent multiple clicks
    }
    
    // IMPORTANT: Hide any global loader that might have been triggered
    hideGlobalLoader();
    
    // Safety check: if event is not provided, try to determine from context
    if (!event || !event.target) {
        console.warn('showExportLoading called without event object');
        return false;
    }
    
    // Determine which button was clicked
    const clickedElement = event.target;
    let targetBtn, targetText, exportType;
    
    if (clickedElement.id === 'export-pdf-btn' || clickedElement.closest('#export-pdf-btn')) {
        targetBtn = document.getElementById('export-pdf-btn');
        targetText = document.getElementById('export-text');
        exportType = 'pdf';
    } else if (clickedElement.id === 'export-excel-btn' || clickedElement.closest('#export-excel-btn')) {
        targetBtn = document.getElementById('export-excel-btn');
        targetText = document.getElementById('export-excel-text');
        exportType = 'excel';
    } else {
        // Fallback: check which button triggered this
        const pdfBtn = document.getElementById('export-pdf-btn');
        const excelBtn = document.getElementById('export-excel-btn');
        if (event.target === pdfBtn || (pdfBtn && pdfBtn.contains(event.target))) {
            targetBtn = pdfBtn;
            targetText = document.getElementById('export-text');
            exportType = 'pdf';
        } else if (event.target === excelBtn || (excelBtn && excelBtn.contains(event.target))) {
            targetBtn = excelBtn;
            targetText = document.getElementById('export-excel-text');
            exportType = 'excel';
        } else {
            return true; // Allow normal link behavior
        }
    }
    
    if (!targetBtn || !targetText) {
        return true; // Allow normal link behavior if we can't find elements
    }
    
    // Set exporting state
    isExporting = true;
    exportingType = exportType;
    downloadStartTime = Date.now();
    
    // Disable both buttons to prevent multiple exports
    const pdfBtn = document.getElementById('export-pdf-btn');
    const excelBtn = document.getElementById('export-excel-btn');
    if (pdfBtn) {
        pdfBtn.style.pointerEvents = 'none';
        pdfBtn.style.opacity = '0.6';
    }
    if (excelBtn) {
        excelBtn.style.pointerEvents = 'none';
        excelBtn.style.opacity = '0.6';
    }
    
    // Update the clicked button's text
    if (exportType === 'pdf') {
        targetText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    } else {
        targetText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Excel...';
    }
    
    // Track window blur (user might switch tabs/windows for download)
    windowBlurred = false;
    
    // Clear any existing timeout
    if (exportTimeout) {
        clearTimeout(exportTimeout);
    }
    
    // IMPORTANT: Continuously monitor and hide global loader
    if (loaderCheckInterval) {
        clearInterval(loaderCheckInterval);
    }
    loaderCheckInterval = setInterval(function() {
        hideGlobalLoader();
        if (!isExporting) {
            clearInterval(loaderCheckInterval);
            loaderCheckInterval = null;
        }
    }, 100);
    
    // Multiple detection methods for download completion:
    
    // 1. Reset after short initial delay (download likely started)
    setTimeout(function() {
        if (isExporting) {
            resetExportButtons();
        }
    }, 2500);
    
    // 2. Safety timeout: Reset after 8 seconds if still exporting
    exportTimeout = setTimeout(function() {
        resetExportButtons();
    }, 8000);
    
    // Allow the download to proceed normally (don't prevent default)
    // The global loader will be continuously hidden
    return true;
}

function resetExportButtons() {
    // Hide global loader first
    hideGlobalLoader();
    
    // Clear loader check interval
    if (loaderCheckInterval) {
        clearInterval(loaderCheckInterval);
        loaderCheckInterval = null;
    }
    
    const pdfBtn = document.getElementById('export-pdf-btn');
    const pdfText = document.getElementById('export-text');
    const excelBtn = document.getElementById('export-excel-btn');
    const excelText = document.getElementById('export-excel-text');
    
    if (pdfBtn && pdfText) {
        pdfBtn.style.pointerEvents = 'auto';
        pdfBtn.style.opacity = '1';
        pdfText.innerHTML = 'Export PDF';
    }
    
    if (excelBtn && excelText) {
        excelBtn.style.pointerEvents = 'auto';
        excelBtn.style.opacity = '1';
        excelText.innerHTML = 'Export Excel';
    }
    
    isExporting = false;
    exportingType = null;
    downloadStartTime = null;
    
    if (exportTimeout) {
        clearTimeout(exportTimeout);
        exportTimeout = null;
    }
}

// Reset button state when page becomes visible again (user likely returned after download)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && isExporting) {
        // Check if enough time has passed (at least 2 seconds)
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
});

// Reset when window regains focus (user clicked back to the tab)
window.addEventListener('focus', function() {
    if (isExporting && windowBlurred) {
        // Check if enough time has passed
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 500);
        }
    }
    windowBlurred = false;
});

// Track when window loses focus (user might be saving/downloading file)
window.addEventListener('blur', function() {
    if (isExporting) {
        windowBlurred = true;
    }
});

// Reset button state when user clicks anywhere on the page (except the export buttons)
document.addEventListener('click', function(e) {
    const isPdfBtn = e.target.id === 'export-pdf-btn' || e.target.closest('#export-pdf-btn');
    const isExcelBtn = e.target.id === 'export-excel-btn' || e.target.closest('#export-excel-btn');
    
    if (!isPdfBtn && !isExcelBtn && isExporting) {
        // Only reset if enough time has passed since download started
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
});

// Reset button state when user presses Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (isExporting) {
            resetExportButtons();
        }
        // Also close filter panel if open
        const panel = document.getElementById('filter-panel');
        if (panel && panel.classList.contains('open')) {
            closeFilterPanel();
        }
    }
});

// Reset button state when the page loads (in case of refresh)
document.addEventListener('DOMContentLoaded', function() {
    resetExportButtons();
    
    // Also hide any global loader that might be stuck
    hideGlobalLoader();
    
    // Make entire checkbox option clickable
    document.querySelectorAll('.checkbox-option').forEach(option => {
        option.addEventListener('click', function(e) {
            // Don't toggle if clicking directly on the checkbox (to avoid double-toggle)
            if (e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    // Trigger change event for any listeners
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                }
            }
        });
    });
});

// Monitor for mouse movement - user interaction indicates they're back
let lastMouseMove = Date.now();
document.addEventListener('mousemove', function() {
    if (isExporting && (Date.now() - lastMouseMove) > 1000) {
        lastMouseMove = Date.now();
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
    lastMouseMove = Date.now();
});

// Update request types when department checkboxes change (handle multiple selections)
document.addEventListener('DOMContentLoaded', function() {
    const departmentGroup = document.getElementById('department-group');
    if (departmentGroup) {
        const departmentCheckboxes = departmentGroup.querySelectorAll('input[type="checkbox"][name="department"]');
        const requestTypeGroup = document.getElementById('request_type-group');
        
        if (!requestTypeGroup) return;
        
        function updateRequestTypes() {
            // Get selected departments
            const selectedDepartments = Array.from(departmentCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Get currently selected request types to preserve them
            const currentRequestTypes = Array.from(requestTypeGroup.querySelectorAll('input[type="checkbox"]'))
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            // Clear existing checkboxes
            requestTypeGroup.innerHTML = '';
            
            // If no departments selected, show all request types
            if (selectedDepartments.length === 0) {
                // Fetch all request types
                fetch('/api/request-types')
                    .then(response => response.json())
                    .then(data => {
                        data.request_types.forEach((requestType, index) => {
                            const optionDiv = document.createElement('div');
                            optionDiv.className = 'checkbox-option';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'request_type';
                            checkbox.id = `rt_${index}`;
                            checkbox.value = requestType;
                            // Preserve checked state if it was previously selected
                            if (currentRequestTypes.includes(requestType)) {
                                checkbox.checked = true;
                            }
                            
                            const label = document.createElement('label');
                            label.htmlFor = `rt_${index}`;
                            label.textContent = requestType;
                            
                            optionDiv.appendChild(checkbox);
                            optionDiv.appendChild(label);
                            requestTypeGroup.appendChild(optionDiv);
                            
                            // Make the entire option clickable
                            optionDiv.addEventListener('click', function(e) {
                                if (e.target.tagName !== 'INPUT') {
                                    checkbox.checked = !checkbox.checked;
                                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching request types:', error);
                    });
            } else {
                // Fetch request types for all selected departments
                const promises = selectedDepartments.map(dept => 
                    fetch(`/api/request-types?department=${encodeURIComponent(dept)}`)
                        .then(response => response.json())
                );
                
                Promise.all(promises)
                    .then(results => {
                        // Combine and deduplicate request types
                        const allRequestTypes = new Set();
                        results.forEach(data => {
                            data.request_types.forEach(rt => allRequestTypes.add(rt));
                        });
                        
                        // Sort and add checkboxes
                        Array.from(allRequestTypes).sort().forEach((requestType, index) => {
                            const optionDiv = document.createElement('div');
                            optionDiv.className = 'checkbox-option';
                            
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'request_type';
                            checkbox.id = `rt_${index}`;
                            checkbox.value = requestType;
                            // Preserve checked state if it was previously selected
                            if (currentRequestTypes.includes(requestType)) {
                                checkbox.checked = true;
                            }
                            
                            const label = document.createElement('label');
                            label.htmlFor = `rt_${index}`;
                            label.textContent = requestType;
                            
                            optionDiv.appendChild(checkbox);
                            optionDiv.appendChild(label);
                            requestTypeGroup.appendChild(optionDiv);
                            
                            // Make the entire option clickable
                            optionDiv.addEventListener('click', function(e) {
                                if (e.target.tagName !== 'INPUT') {
                                    checkbox.checked = !checkbox.checked;
                                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching request types:', error);
                    });
            }
        }
        
        // Add change listeners to all department checkboxes
        departmentCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateRequestTypes);
        });
        
        // Initialize request types on page load if departments are already selected
        const hasSelectedDepartments = Array.from(departmentCheckboxes).some(cb => cb.checked);
        if (hasSelectedDepartments) {
            updateRequestTypes();
        }
    }
});

function changeItemsPerPage(perPage) {
    // Redirect to page 1 with new per_page value, preserving all filters
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Handle pagination links - preserve all query parameters including multiple values
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.pagination-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const pageNum = this.getAttribute('data-page');
            
            // Build URL preserving all query parameters (including multiple values)
            const currentUrl = new URL(window.location);
            const baseUrl = currentUrl.origin + currentUrl.pathname;
            const paramParts = [];
            
            // Add page number first
            paramParts.push('page=' + encodeURIComponent(pageNum));
            
            // Preserve all existing query parameters (including multiple values)
            const originalSearch = window.location.search;
            if (originalSearch) {
                // Parse the original search string manually to preserve multiple values
                const pairs = originalSearch.substring(1).split('&');
                
                pairs.forEach(pair => {
                    const [key, value] = pair.split('=');
                    if (key && key !== 'page') {
                        // Preserve each parameter (including multiple values for same key)
                        paramParts.push(key + '=' + (value || ''));
                    }
                });
            }
            
            // Navigate to new URL
            window.location.href = baseUrl + '?' + paramParts.join('&');
        });
    });
});

// Filter Panel Functions
function openFilterPanel() {
    const panel = document.getElementById('filter-panel');
    const overlay = document.getElementById('filter-overlay');
    if (panel && overlay) {
        panel.classList.add('open');
        overlay.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeFilterPanel() {
    const panel = document.getElementById('filter-panel');
    const overlay = document.getElementById('filter-overlay');
    if (panel && overlay) {
        panel.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function applyFilters() {
    const form = document.getElementById('filter-form');
    if (form) {
        // Reset to page 1 when applying filters
        const url = new URL(form.action, window.location.origin);
        const formData = new FormData(form);
        
        // Handle multiple values for multi-select fields
        const multiSelectFields = ['department', 'request_type', 'company', 'branch', 'status', 'payment_type', 'payment_method'];
        const processedKeys = new Set();
        
        for (const [key, value] of formData.entries()) {
            if (value) {
                if (multiSelectFields.includes(key)) {
                    // For multi-select fields, append each value
                    if (!processedKeys.has(key)) {
                        // Remove existing params for this key
                        url.searchParams.delete(key);
                        processedKeys.add(key);
                    }
                    url.searchParams.append(key, value);
                } else {
                    // For single-value fields, use set
                    url.searchParams.set(key, value);
                }
            }
        }
        
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
}

function removeFilter(filterName) {
    const url = new URL(window.location);
    url.searchParams.delete(filterName);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function clearAllFilters() {
    window.location.href = "{{ url_for('reports') }}";
}


// Prevent panel from closing when clicking inside it
document.addEventListener('DOMContentLoaded', function() {
    const filterPanel = document.getElementById('filter-panel');
    if (filterPanel) {
        filterPanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
});

// Payment Method Selection (now supports multiple selections with checkboxes)
function togglePaymentMethod(event, value) {
    event.preventDefault();
    event.stopPropagation();
    
    const clickedOption = event.currentTarget;
    if (!clickedOption) return;
    
    const checkbox = clickedOption.querySelector('input[type="checkbox"]');
    if (!checkbox) return;
    
    // Toggle checkbox
    checkbox.checked = !checkbox.checked;
    
    // Update visual state
    if (checkbox.checked) {
        clickedOption.classList.add('selected');
    } else {
        clickedOption.classList.remove('selected');
    }
}
</script>
{% endblock %}

