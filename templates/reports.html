{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block content %}
<style>
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) {
        width: 150px;
        min-width: 150px;
    }
    
    .data-table th:nth-child(7),
    .data-table td:nth-child(7) {
        text-align: left;
        /* Make Payment Method column a little tighter */
        width: 120px;
        min-width: 100px;
        max-width: 140px;
    }
    
    .data-table td:nth-child(7) {
        padding: 3px 6px !important;
        line-height: 1.35 !important;
        vertical-align: middle !important;
    }
    
    .data-table td:nth-child(7) br {
        line-height: 1.4;
    }
    
    .scheduled-date-col {
        width: 180px !important;
        min-width: 180px !important;
        max-width: 180px !important;
        padding: 4px 8px !important;
    }
    /* Ensure Scheduled Date uses the target font size */
    .scheduled-date-col {
        font-size: 14px;
    }

    /* Make table text match Scheduled Date column */
    .data-table th,
    .data-table td {
        font-size: 14px;
    }
    /* Center-align all cells and headers in report tables */
    .data-table th,
    .data-table td {
        text-align: center !important;
        vertical-align: middle !important;
    }

    /* Status column chips and text (use .status-col for stable targeting) */
    .status-col {
        font-size: 13px;
    }
    .status-col .badge,
    .status-col .status-chip,
    .status-col .badge-warning,
    .status-col .badge-success,
    .status-col .badge-info {
        font-size: 12px !important;
        padding: 8px 14px !important;
        line-height: 1.3 !important;
    }

    /* Filter Button and Active Filters */
    .filters-container {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 8px;
        margin-bottom: 12px;
        /* removed grey background to make quick filters flush with page */
        padding: 0;
        background: transparent;
        border-radius: 0;
        box-shadow: none;
        border: none;
    }

    .filters-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        /* Match Apply Filters button sizing */
        padding: 10px 20px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        transition: all 0.2s;
    }

    .filters-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
    }

    .filters-btn i {
        font-size: 18px;
    }
    /* Auditing reports search should match settings page assign-search styles */
    .reports-auditing-search .assign-search-field {
        width: 100%;
    }
    .reports-auditing-search .assign-search-input {
        border-radius: 999px !important;
        border: 1px solid #ced4da !important;
        transition: border-color 0.12s ease, box-shadow 0.12s ease;
        height: 38px;
        padding-left: 44px;
    }
    .reports-auditing-search .assign-search-input:focus {
        outline: none !important;
        border-color: #D9BD7D !important;
        box-shadow: 0 0 0 0.18rem rgba(217,189,125,0.15) !important;
    }
    .reports-auditing-search .assign-search-icon {
        width: 20px !important;
        height: 20px !important;
        background: #ffffff;
        border-radius: 50%;
        padding: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        cursor: pointer;
    }
    .reports-auditing-search .assign-search-clear {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 28px;
        height: 28px;
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: #ffffff;
        border: 1px solid #e9ecef;
        box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        cursor: pointer;
        font-size: 14px;
        color: #333;
        padding: 0;
    }
    .reports-auditing-search.has-value .assign-search-clear {
        display: inline-flex;
    }
    /* Hide native browser 'x' clear button (WebKit/Edge/IE) so only our custom clear is visible */
    .reports-auditing-search .assign-search-input::-webkit-search-decoration,
    .reports-auditing-search .assign-search-input::-webkit-search-cancel-button,
    .reports-auditing-search .assign-search-input::-webkit-clear-button {
        display: none !important;
        -webkit-appearance: none !important;
    }
    .reports-auditing-search .assign-search-input::-ms-clear,
    .reports-auditing-search .assign-search-input::-ms-reveal {
        display: none !important;
        width: 0;
        height: 0;
    }
    .reports-auditing-search .assign-search-input {
        -webkit-appearance: none;
        appearance: none;
    }
    /* Outline view button (icon-only) */
    .btn-view-outline {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        padding: 0;
        background: transparent !important;
        border: 1px solid #D9BD7D !important;
        color: #D9BD7D !important;
        border-radius: 6px;
        font-size: 12px;
    }
    .btn-view-outline i {
        color: inherit;
        font-size: 12px;
    }
    .btn-view-outline:hover {
        background: #D9BD7D !important;
        color: #ffffff !important;
    }
    /* Make Export buttons match Apply Filters button (size and color) */
    .header-actions .btn,
    #export-excel-btn,
    #export-pdf-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px !important;
        font-size: 14px !important;
        border-radius: 6px !important;
        background: #D9BD7D !important;
        border: 1px solid #D9BD7D !important;
        color: #ffffff !important;
        text-decoration: none !important;
    }
    .header-actions .btn:hover,
    #export-excel-btn:hover,
    #export-pdf-btn:hover {
        background: #c8ac65 !important;
        border-color: #c8ac65 !important;
        color: #ffffff !important;
    }

    .active-filters {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
        flex: 1;
    }

    .filter-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        line-height: 1.3;
        background: #000;
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }

    .filter-pill .remove-filter {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        transition: background 0.2s;
    }

    .filter-pill .remove-filter:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .clear-all-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: #495057;
        transition: all 0.2s;
    }

    .clear-all-btn:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
    }

    /* Side Panel */
    .filter-side-panel {
        position: fixed;
        top: 0;
        right: -450px;
        width: 450px;
        height: 100vh;
        background: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: right 0.3s ease;
        overflow-y: auto;
    }

    .filter-side-panel.open {
        right: 0;
    }

    .filter-panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .filter-panel-overlay.show {
        display: block;
        opacity: 1;
    }

    .filter-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
        background: #f8f9fa;
    }

    .filter-panel-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #212529;
    }

    .filter-panel-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

    .filter-panel-close:hover {
        background: #e9ecef;
    }

    .filter-panel-body {
        padding: 20px;
    }

    .filter-panel-body .form-group {
        margin-bottom: 20px;
    }

    .filter-panel-body label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #495057;
        font-size: 14px;
    }

    .filter-panel-body select,
    .filter-panel-body input[type="date"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    /* Checkbox Groups for Multi-Select Filters */
    .checkbox-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: white;
        margin-top: 8px;
    }

    .checkbox-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    .checkbox-option:hover {
        background-color: #f8f9fa;
    }

    .checkbox-option input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
    }

    .checkbox-option label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        flex: 1;
        user-select: none;
    }
    
    /* Make entire checkbox option clickable */
    .checkbox-option:has(input[type="checkbox"]:not(:checked)):hover {
        background-color: #f8f9fa;
    }
    
    .checkbox-option:has(input[type="checkbox"]:checked) {
        background-color: #e7f3ff;
    }

    .filter-panel-body small {
        display: block;
        margin-top: 4px;
        color: #6c757d;
        font-size: 12px;
    }

    .filter-panel-actions {
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
        display: flex;
        gap: 10px;
        position: sticky;
        bottom: 0;
    }

    .filter-panel-actions .btn {
        flex: 1;
        padding: 10px;
        font-size: 14px;
        font-weight: 500;
    }

    /* Apply Filters primary button color (page-scoped override) */
    .filter-panel-actions .btn.btn-primary,
    .inline-filters-actions .btn.btn-primary {
        background: #D9BD7D !important;
        border-color: #D9BD7D !important;
        color: #ffffff !important;
    }
    .filter-panel-actions .btn.btn-primary i,
    .inline-filters-actions .btn.btn-primary i {
        color: #ffffff !important;
    }
    .filter-panel-actions .btn.btn-primary:hover,
    .inline-filters-actions .btn.btn-primary:hover {
        background: #c8ac65 !important;
        border-color: #c8ac65 !important;
        color: #ffffff !important;
    }
    /* Make secondary clear buttons match Advanced Filters look */
    .filter-panel-actions .btn.btn-secondary,
    .inline-filters-actions .btn.btn-secondary,
    button[onclick="clearAllFilters()"] {
        background: white !important;
        border: 1px solid #dee2e6 !important;
        color: #495057 !important;
        padding: 10px 20px !important;
        border-radius: 6px !important;
    }
    .filter-panel-actions .btn.btn-secondary:hover,
    .inline-filters-actions .btn.btn-secondary:hover,
    button[onclick="clearAllFilters()"]:hover {
        background: #f8f9fa !important;
        border-color: #adb5bd !important;
    }

    /* Payment Method Selectable Boxes */
    .payment-method-options {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .payment-method-option {
        padding: 10px 20px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        background: white;
        color: #495057;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        user-select: none;
    }

    .payment-method-option:hover {
        border-color: #adb5bd;
        background: #f8f9fa;
    }

    .payment-method-option.selected {
        background: #000;
        color: white;
        border-color: #000;
    }

    .payment-method-option input[type="checkbox"] {
        display: none;
    }

    /* Inline Filters Section */
    .inline-filters-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .inline-filters-header {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f8f9fa;
    }

    .inline-filters-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: #212529;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .inline-filters-form {
        width: 100%;
    }

    /* Make quick/inline filters text slightly smaller for compact display */
    .inline-filters-section,
    .inline-filters-section label,
    .inline-filters-section .inline-filter-group,
    .inline-filters-section .filter-select-container,
    .inline-filters-section .filter-search-input,
    .inline-filters-section .filter-chips-container,
    .inline-filters-section .filter-chip {
        font-size: 13px;
    }

    .inline-filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Ensure date range spans 2 columns on larger screens */
    @media (min-width: 768px) {
        .inline-filter-group:has(.date-range-inputs) {
            grid-column: span 2;
        }
    }

    .inline-filter-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .inline-filter-group > label {
        font-weight: 600;
        color: #495057;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .checkbox-group-inline {
        display: flex;
        flex-direction: column;
        gap: 6px;
        max-height: 150px;
        overflow-y: auto;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: #f8f9fa;
    }

    .checkbox-option-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 6px;
        cursor: pointer;
        border-radius: 3px;
        transition: background-color 0.2s;
    }

    .checkbox-option-inline:hover {
        background-color: #e9ecef;
    }

    .checkbox-option-inline:has(input[type="checkbox"]:checked) {
        background-color: #d1ecf1;
    }

    .checkbox-option-inline input[type="checkbox"] {
        margin: 0;
        cursor: pointer;
        flex-shrink: 0;
    }

    .checkbox-option-inline label {
        margin: 0;
        cursor: pointer;
        font-weight: normal;
        font-size: 13px;
        flex: 1;
        user-select: none;
    }

    .payment-method-options-inline {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .date-range-inputs {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: nowrap;
    }

    .date-range-inputs input[type="date"] {
        flex: 1;
        min-width: 150px;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .date-range-inputs span {
        color: #6c757d;
        font-size: 14px;
        white-space: nowrap;
    }

    /* Make date range filter group wider in inline filters */
    .inline-filter-group:has(.date-range-inputs) {
        grid-column: span 2;
    }

    /* For side panel date range */
    .filter-panel-body .form-group:has(.date-range-inputs) {
        width: 100%;
    }

    .inline-filters-actions {
        display: flex;
        gap: 10px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }

    .inline-filters-actions .btn {
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
    }

    /* Filter Dropdown with Chips (like branch selector) */
    .filter-select-container {
        position: relative;
        width: 100%;
    }

    .filter-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 0;
        min-height: 0;
    }

    .filter-chips-container:not(:empty) {
        margin-bottom: 8px;
    }

    .filter-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        line-height: 1.3;
        background: #000;
        color: white;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
    }

    .filter-chip .remove-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        background: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        transition: background 0.2s;
        line-height: 1;
    }

    .filter-chip .remove-chip:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    .filter-search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
        margin-top: 4px;
    }

    .filter-option {
        padding: 10px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #f8f9fa;
        -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile/trackpad */
        touch-action: manipulation; /* Optimize for touch/trackpad */
        user-select: none; /* Prevent text selection */
    }

    /* Make filter option contents align horizontally so we can show an info icon beside the name */
    .filter-option {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-start;
    }

    /* Tooltip styling (match new_request.html) */
    .tooltip-wrapper {
        position: relative;
        display: inline-block;
    }

    .tooltip-wrapper .tooltip-icon {
        color: #6c757d;
        margin-left: 6px;
        cursor: help;
        font-size: 0.95rem;
        vertical-align: middle;
    }

    .tooltip-wrapper .tooltip-text {
        visibility: hidden;
        width: auto;
        max-width: 320px;
        background-color: #333;
        color: #fff;
        text-align: left;
        border-radius: 6px;
        padding: 8px 12px;
        position: fixed !important;
        z-index: 99999 !important;
        bottom: auto;
        left: auto;
        margin-left: 0;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 0.875rem;
        font-weight: normal;
        line-height: 1.4;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        pointer-events: none;
        white-space: normal;
        word-wrap: break-word;
        display: inline-block;
    }

    .tooltip-wrapper .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 8px;
        margin-left: 0;
        border-width: 5px;
        border-style: solid;
        border-color: #333 transparent transparent transparent;
    }

    .tooltip-wrapper:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* Show tooltip when wrapper has tooltip-visible (used for tap on mobile) */
    .tooltip-wrapper.tooltip-visible .tooltip-text {
        visibility: visible;
        opacity: 1;
        pointer-events: auto;
    }

    .filter-option:last-child {
        border-bottom: none;
    }

    .filter-option:hover {
        background-color: #f8f9fa;
    }

    .filter-option:active {
        background-color: #dee2e6; /* Visual feedback for soft touches */
    }

    .filter-option.selected {
        background-color: #e7f3ff;
        font-weight: 500;
    }

    .filter-option.hidden {
        display: none;
    }
    /* Page-specific header adjustments */
    .dashboard-header {
        padding-left: 16px;
    }
    .dashboard-header .dashboard-title {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    /* Remove dark background from card headers on this page */
    .dashboard-container .card .card-header {
        background: transparent !important;
        color: inherit !important;
        border-bottom: 1px solid #e9ecef;
    }
    .dashboard-container .card .card-header h2,
    .dashboard-container .card .card-header h3,
    .dashboard-container .card .card-header h4 {
        color: inherit !important;
        margin: 0;
    }
</style>
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2 class="dashboard-title" style="margin:0;"><i class="fas fa-chart-bar"></i> Payment Reports</h2>
    </div>
    

    <!-- Active Filters -->
    <div class="filters-container">
        <div class="active-filters" id="active-filters">
            {% set has_filters = False %}
            {% if request.args.getlist('department') %}
                <span class="filter-pill">
                    Department: {{ request.args.getlist('department') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('department')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('request_type') %}
                <span class="filter-pill">
                    Type: {{ request.args.getlist('request_type') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('request_type')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('company') %}
                <span class="filter-pill">
                    Company: {{ request.args.getlist('company') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('company')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('branch') %}
                <span class="filter-pill">
                    Branch: {{ request.args.getlist('branch') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('branch')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('payment_type') %}
                <span class="filter-pill">
                    Payment Type: {{ request.args.getlist('payment_type') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('payment_type')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('payment_method') %}
                <span class="filter-pill">
                    Payment Method: {{ request.args.getlist('payment_method') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('payment_method')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.getlist('status') %}
                <span class="filter-pill">
                    Status: {{ request.args.getlist('status') | join(', ') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('status')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.get('date_from') %}
                <span class="filter-pill">
                    From: {{ request.args.get('date_from') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('date_from')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if request.args.get('date_to') %}
                <span class="filter-pill">
                    To: {{ request.args.get('date_to') }}
                    <button type="button" class="remove-filter" onclick="removeFilter('date_to')" title="Remove filter">×</button>
                </span>
                {% set has_filters = True %}
            {% endif %}
            {% if has_filters %}
                <button type="button" class="clear-all-btn" onclick="clearAllFilters()">Clear all</button>
            {% endif %}
        </div>
    </div>

    <!-- Filter Side Panel -->
    <div class="filter-panel-overlay" id="filter-overlay" onclick="closeFilterPanel()"></div>
    <div class="filter-side-panel" id="filter-panel">
        <div class="filter-panel-header">
            <h3><i class="fas fa-filter"></i> Filters</h3>
            <button type="button" class="filter-panel-close" onclick="closeFilterPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filter-panel-body">
            <form method="GET" action="{{ url_for('reports') }}" id="filter-form">
                <!-- Global Search Bar -->
                <div class="form-group" style="margin-bottom: 20px;">
                    <label for="filter-global-search" style="margin-bottom: 8px; display: block;">
                        <i class="fas fa-search"></i> Search Filters
                    </label>
                    <input type="text" id="filter-global-search" class="form-control" placeholder="Search all filters..." autocomplete="off" style="width: 100%; padding: 10px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                </div>
                
                <div class="form-group">
                    <label>Department</label>
                    <div id="department_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="department-group">
                        {% for dept in departments %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="department" id="dept_{{ loop.index }}" value="{{ dept }}" {% if dept in request.args.getlist('department') %}checked{% endif %}>
                            <label for="dept_{{ loop.index }}">{{ dept }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Request Type</label>
                    <div id="request_type_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="request_type-group">
                        {# Non-"Others" first #}
                        {% for request_type in request_types | reject('equalto', 'Others') %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="request_type" id="rt_{{ loop.index }}" value="{{ request_type }}" {% if request_type in request.args.getlist('request_type') %}checked{% endif %}>
                            <label for="rt_{{ loop.index }}">{{ request_type }}</label>
                        </div>
                        {% endfor %}
                        {# Ensure "Others" is always last if present #}
                        {% for request_type in request_types | select('equalto', 'Others') %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="request_type" id="rt_others_{{ loop.index }}" value="{{ request_type }}" {% if request_type in request.args.getlist('request_type') %}checked{% endif %}>
                            <label for="rt_others_{{ loop.index }}">{{ request_type }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Company Name</label>
                    <div id="company_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="company-group">
                        {% for company in companies %}
                        {% set company_value = company.value if company is mapping else company %}
                        {% set company_text = company.text if company is mapping else company_value %}
                        {% set company_description = company.description if company is mapping else '' %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="company" id="company_{{ loop.index }}" value="{{ company_value }}" {% if company_value in request.args.getlist('company') %}checked{% endif %}>
                            <label for="company_{{ loop.index }}">
                                {{ company_text }}
                                {% if company_description %}
                                <span class="tooltip-wrapper">
                                    <i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>
                                    <span class="tooltip-text">{{ company_description }}</span>
                                </span>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                    <small class="form-text text-muted">Only available for approved requests</small>
                </div>

                <div class="form-group">
                    <label>Branch Name</label>
                    <div id="branch_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="branch-group">
                        {% for branch in branches %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="branch" id="branch_{{ loop.index }}" value="{{ branch.name }}" {% if branch.name in request.args.getlist('branch') %}checked{% endif %}>
                            <label for="branch_{{ loop.index }}">{{ branch.name }}</label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Payment Type</label>
                    <div id="payment_type_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="payment_type-group">
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_onetime" value="One-Time" {% if 'One-Time' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_onetime">One-Time</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_scheduled" value="Scheduled One-Time" {% if 'Scheduled One-Time' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_scheduled">Scheduled One-Time</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="payment_type" id="pt_recurring" value="Recurring" {% if 'Recurring' in request.args.getlist('payment_type') %}checked{% endif %}>
                            <label for="pt_recurring">Recurring</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Payment Method</label>
                    <div id="payment_method_chips_container" class="filter-chips-container"></div>
                    <div class="payment-method-options">
                        <label class="payment-method-option {% if 'Card' in request.args.getlist('payment_method') %}selected{% endif %}" onclick="togglePaymentMethod(event, 'Card')">
                            <input type="checkbox" name="payment_method" value="Card" {% if 'Card' in request.args.getlist('payment_method') %}checked{% endif %}>
                            Card
                        </label>
                        <label class="payment-method-option {% if 'Cheque' in request.args.getlist('payment_method') %}selected{% endif %}" onclick="togglePaymentMethod(event, 'Cheque')">
                            <input type="checkbox" name="payment_method" value="Cheque" {% if 'Cheque' in request.args.getlist('payment_method') %}checked{% endif %}>
                            Cheque
                        </label>
                        <label class="payment-method-option {% if 'Cash' in request.args.getlist('payment_method') %}selected{% endif %}" onclick="togglePaymentMethod(event, 'Cash')">
                            <input type="checkbox" name="payment_method" value="Cash" {% if 'Cash' in request.args.getlist('payment_method') %}checked{% endif %}>
                            Cash
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <div id="status_chips_container" class="filter-chips-container"></div>
                    <div class="checkbox-group" id="status-group">
                        {% if current_user.role == 'Auditing Staff' %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_recurring" value="Recurring" {% if 'Recurring' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_recurring">Recurring</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_completed" value="Completed" {% if 'Completed' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_completed">Completed</label>
                        </div>
                        {% else %}
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_allpending" value="All Pending" {% if 'All Pending' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_allpending">All Pending</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_pendingmgr" value="Pending Manager Approval" {% if 'Pending Manager Approval' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_pendingmgr">Pending Manager Approval</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_pendingfin" value="Pending Finance Approval" {% if 'Pending Finance Approval' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_pendingfin">Pending Finance Approval</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_returnedmgr" value="Returned to Manager" {% if 'Returned to Manager' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_returnedmgr">Returned to Manager</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_rejectedmgr" value="Rejected by Manager" {% if 'Rejected by Manager' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_rejectedmgr">Rejected by Manager</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofpending" value="Proof Pending" {% if 'Proof Pending' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofpending">Proof Pending</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofsent" value="Proof Sent" {% if 'Proof Sent' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofsent">Proof Sent</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_proofrejected" value="Proof Rejected" {% if 'Proof Rejected' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_proofrejected">Proof Rejected</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_recurring" value="Recurring" {% if 'Recurring' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_recurring">Recurring</label>
                        </div>
                        <div class="checkbox-option">
                            <input type="checkbox" name="status" id="status_completed" value="Completed" {% if 'Completed' in request.args.getlist('status') %}checked{% endif %}>
                            <label for="status_completed">Completed</label>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label>Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" name="date_from" id="date_from" value="{{ request.args.get('date_from', '') }}" placeholder="From">
                        <span>to</span>
                        <input type="date" name="date_to" id="date_to" value="{{ request.args.get('date_to', '') }}" placeholder="To">
                    </div>
                </div>
            </form>
        </div>
        <div class="filter-panel-actions">
            <button type="button" class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search"></i> Apply Filters
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                <i class="fas fa-redo"></i> Clear All
            </button>
        </div>
    </div>

    <!-- Inline Filters Section -->
    <div class="inline-filters-section">
        <div class="inline-filters-header">
            <h3><i class="fas fa-filter"></i> Quick Filters</h3>
        </div>
        <form method="GET" action="{{ url_for('reports') }}" id="inline-filter-form" class="inline-filters-form">
            <div class="inline-filters-grid">
                <div class="inline-filter-group">
                    <label>Department</label>
                    <div class="filter-select-container">
                        <div id="inline_department_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_department_search" class="filter-search-input" placeholder="Search departments..." autocomplete="off">
                        <div id="inline_department_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="department" id="inline_department_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Request Type</label>
                    <div class="filter-select-container">
                        <div id="inline_request_type_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_request_type_search" class="filter-search-input" placeholder="Search request types..." autocomplete="off">
                        <div id="inline_request_type_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="request_type" id="inline_request_type_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Company Name</label>
                    <div class="filter-select-container">
                        <div id="inline_company_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_company_search" class="filter-search-input" placeholder="Search companies..." autocomplete="off">
                        <div id="inline_company_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="company" id="inline_company_hidden" value="">
                    </div>
                    <small class="form-text text-muted">Only available for approved requests</small>
                </div>

                <div class="inline-filter-group">
                    <label>Branch Name</label>
                    <div class="filter-select-container">
                        <div id="inline_branch_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_branch_search" class="filter-search-input" placeholder="Search branches..." autocomplete="off">
                        <div id="inline_branch_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="branch" id="inline_branch_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Status</label>
                    <div class="filter-select-container">
                        <div id="inline_status_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_status_search" class="filter-search-input" placeholder="Search statuses..." autocomplete="off">
                        <div id="inline_status_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="status" id="inline_status_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Payment Type</label>
                    <div class="filter-select-container">
                        <div id="inline_payment_type_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_payment_type_search" class="filter-search-input" placeholder="Search payment types..." autocomplete="off">
                        <div id="inline_payment_type_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="payment_type" id="inline_payment_type_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Payment Method</label>
                    <div class="filter-select-container">
                        <div id="inline_payment_method_chips_container" class="filter-chips-container"></div>
                        <input type="text" id="inline_payment_method_search" class="filter-search-input" placeholder="Search payment methods..." autocomplete="off">
                        <div id="inline_payment_method_dropdown" class="filter-dropdown"></div>
                        <input type="hidden" name="payment_method" id="inline_payment_method_hidden" value="">
                    </div>
                </div>

                <div class="inline-filter-group">
                    <label>Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" name="date_from" id="inline_date_from" value="{{ request.args.get('date_from', '') }}" placeholder="From">
                        <span>to</span>
                        <input type="date" name="date_to" id="inline_date_to" value="{{ request.args.get('date_to', '') }}" placeholder="To">
                    </div>
                </div>
            </div>
            <div class="inline-filters-actions">
                <button type="button" class="btn btn-primary" onclick="applyInlineFilters()">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearAllFilters()">
                    <i class="fas fa-redo"></i> Clear All
                </button>
            </div>
        </form>
    </div>

    <!-- Advanced Filters Button -->
    <div style="margin-bottom: 20px;">
        <button type="button" class="filters-btn" onclick="openFilterPanel()">
            <i class="fas fa-filter"></i>
            Advanced Filters
        </button>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #2196F3;">
                <i class="fas fa-file-invoice"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_requests }}</h3>
                <p>Total Results</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #4CAF50;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ completed_count }}</h3>
                <p>Completed</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #FF9800;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ pending_count }}</h3>
                <p>Pending</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon" style="background: #9C27B0;">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stat-info">
                <h3>OMR {{ total_amount|format_currency }}</h3>
                <p>Total Amount</p>
            </div>
        </div>
    </div>

    <div class="card" id="report-results-card">
        <div class="card-header">
            <h2><i class="fas fa-table"></i> Report Results</h2>
            {% if requests and requests|length > 0 %}
            <div class="header-actions">
                <a class="btn btn-success" id="export-excel-btn" href="{{ url_for('export_reports_excel') }}{{ '?' + request.query_string.decode('utf-8') if request.query_string else '' }}" onclick="return showExportLoading(event)">
                    <i class="fas fa-file-excel"></i> <span id="export-excel-text">Export Excel</span>
                </a>
                <a class="btn btn-secondary" id="export-pdf-btn" href="{{ url_for('export_reports_pdf') }}{{ '?' + request.query_string.decode('utf-8') if request.query_string else '' }}" onclick="return showExportLoading(event)">
                    <i class="fas fa-file-pdf"></i> <span id="export-text">Export PDF</span>
                </a>
                {# Auditing search moved into the results card body above the table #}
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            {% if user.department == 'Auditing' %}
            <div class="reports-auditing-search" style="margin-bottom:12px; width:100%; display:flex; gap:8px; align-items:center;">
                <div class="assign-search-field" style="position:relative; width:100%;">
                    <img src="{{ url_for('static', filename='css/icons/search.svg') }}" class="assign-search-icon" alt="Search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%);" onclick="document.getElementById('auditing-ref-search').focus();" >
                    <input type="search" id="auditing-ref-search" class="form-control assign-search-input" placeholder="Search reference number..." aria-label="Search reference number" value="{{ request.args.get('reference_number','') }}" autocomplete="off" style="padding-left:44px; padding-right:48px; width:100%;">
                    <button type="button" class="assign-search-clear" id="auditing-ref-clear" title="Clear search">×</button>
                </div>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    function attachAuditingSearchHandlers() {
                        const input = document.getElementById('auditing-ref-search');
                        if (!input) return;
                        // Remove any existing listener to avoid duplicates
                        input.replaceWith(input.cloneNode(true));
                        const wrapper = document.querySelector('.reports-auditing-search');
                        const freshInput = wrapper && wrapper.querySelector('#auditing-ref-search');
                        const clearBtn = wrapper && wrapper.querySelector('#auditing-ref-clear');
                        if (!freshInput) return;

                        // Ensure wrapper reflects current value state
                        function refreshClearVisibility() {
                            if (!wrapper) return;
                            if (freshInput.value && freshInput.value.trim() !== '') {
                                wrapper.classList.add('has-value');
                            } else {
                                wrapper.classList.remove('has-value');
                            }
                        }

                        // Replace input to remove duplicate listeners, then re-select
                        freshInput.replaceWith(freshInput.cloneNode(true));
                        const inputEl = wrapper.querySelector('#auditing-ref-search');

                        inputEl.addEventListener('input', refreshClearVisibility);
                        inputEl.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                const val = inputEl.value.trim();
                                updateQueryParamAndGo('reference_number', val);
                            }
                        });

                        if (clearBtn) {
                            clearBtn.addEventListener('click', function() {
                                inputEl.value = '';
                                refreshClearVisibility();
                                updateQueryParamAndGo('reference_number', '');
                            });
                        }

                        // Initialize visibility on load
                        refreshClearVisibility();
                    }

                    // Make reloadResultsViaAjax globally accessible for pagination
                    window.reloadResultsViaAjax = async function(urlStr, scrollToTop = false) {
                        try {
                            const scrollY = window.scrollY;
                            const res = await fetch(urlStr, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                            if (!res.ok) {
                                // fallback to full navigation if AJAX fails
                                window.location.href = urlStr;
                                return;
                            }
                            const text = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            const newCard = doc.getElementById('report-results-card');
                            const currentCard = document.getElementById('report-results-card');
                            if (newCard && currentCard) {
                                currentCard.innerHTML = newCard.innerHTML;
                                // Re-attach handlers for the replaced content
                                attachAuditingSearchHandlers();
                                // Re-attach pagination handlers after AJAX reload
                                if (typeof attachPaginationHandlers === 'function') {
                                    try { attachPaginationHandlers(); } catch (e) { console.warn(e); }
                                }
                                if (typeof attachRowClickHandlersForPaymentReports === 'function') {
                                    try { attachRowClickHandlersForPaymentReports(); } catch (e) { console.warn(e); }
                                }
                                // Scroll to top if requested (for pagination), otherwise restore scroll position
                                if (scrollToTop) {
                                    window.scrollTo({ top: 0, behavior: 'smooth' });
                                } else {
                                    window.scrollTo(0, scrollY);
                                }
                            } else {
                                // If we couldn't find the fragment, do a full navigation
                                window.location.href = urlStr;
                            }
                        } catch (err) {
                            console.error('AJAX reload failed, falling back to full reload', err);
                            window.location.href = urlStr;
                        }
                    };

                    function updateQueryParamAndGo(key, value) {
                        const url = new URL(window.location.href);
                        if (value) {
                            url.searchParams.set(key, value);
                        } else {
                            url.searchParams.delete(key);
                        }
                        // Reset to first page when searching
                        url.searchParams.delete('page');
                        // Update the address bar without navigating
                        history.replaceState(null, '', url.toString());
                        // Reload only the results card via AJAX
                        window.reloadResultsViaAjax(url.toString());
                    }

                    // Initialize handlers
                    attachAuditingSearchHandlers();
                });
            </script>
            {% endif %}
            {% if requests %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                {% if current_user.department == 'Auditing' or current_user.role == 'Auditing Staff' %}
                                <th>Ref. No.</th>
                                {% endif %}
                                <th class="expand-col"></th>
                                <th>Type</th>
                                <th>Requestor</th>
                                <th>Department</th>
                                <th>Payment Type</th>
                                <th>Payment Method</th>
                                {# Scheduled Date column removed in frontend reports view #}
                                <th>Branch Name</th>
                                <th>Person/Company</th>
                                <th>Submitted</th>
                                <th>Approved</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Approver</th>
                                {# Manager/Finance Duration columns removed in frontend reports view #}
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in requests %}
                            {% set manager_duration = '' %}
                            {% set finance_duration = '' %}
                            {% if req.manager_approval_duration_minutes %}
                                {% set hours = req.manager_approval_duration_minutes // 3600 %}
                                {% set minutes = (req.manager_approval_duration_minutes % 3600) // 60 %}
                                {% set seconds = req.manager_approval_duration_minutes % 60 %}
                                {% set manager_duration = hours ~ ':' ~ '%02d'|format(minutes) ~ ':' ~ '%02d'|format(seconds) %}
                            {% endif %}
                            {% if req.finance_approval_duration_minutes %}
                                {% set hours = req.finance_approval_duration_minutes // 3600 %}
                                {% set minutes = (req.finance_approval_duration_minutes % 3600) // 60 %}
                                {% set seconds = req.finance_approval_duration_minutes % 60 %}
                                {% set finance_duration = hours ~ ':' ~ '%02d'|format(minutes) ~ ':' ~ '%02d'|format(seconds) %}
                            {% endif %}
                            <tr data-href="{{ url_for('view_request', request_id=req.request_id) }}">
                                <td>#{{ req.request_id }}</td>
                                {% if current_user.department == 'Auditing' or current_user.role == 'Auditing Staff' %}
                                <td>{{ req.reference_number or '-' }}</td>
                                {% endif %}
                                <td class="expand-cell">
                                    {% if req.recurring == 'Recurring' %}
                                        <img src="{{ url_for('static', filename='css/icons/chevron-right.svg') }}" class="chevron-toggle" data-request-id="{{ req.request_id }}" alt="expand" />
                                    {% endif %}
                                </td>
                                <td>{{ req.request_type }}</td>
                                <td>{{ req.requestor_name }}</td>
                                <td>{{ req.department }}</td>
                                <td>
                                    {% if req.recurring == 'Recurring' %}
                                        Recurring
                                    {% elif req.payment_date or req.recurring == 'Scheduled One-Time' %}
                                        Scheduled One-Time
                                    {% else %}
                                        {{ req.recurring or 'One-Time' }}
                                    {% endif %}
                                </td>
                                <td>{{ req.payment_method or 'Card' }}</td>
                                {# Scheduled Date cell removed in frontend reports view #}
                                <td>
                                    {% if req.branch_name %}
                                        {% set branch_list = req.branch_name.split(',') %}
                                        {% for branch in branch_list %}
                                            {% set branch_trimmed = branch.strip() %}
                                            {% if branch_trimmed %}
                                                <div style="margin-bottom: 4px;">{{ branch_trimmed }}</div>
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if req.person_company %}
                                        {{ req.person_company }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                <td>
                                    {% if req.approval_date %}
                                        {{ req.approval_date.strftime('%Y-%m-%d') }}
                                    {% else %}
                                        <span style="color: #999;">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    OMR {{ "%.3f"|format(req.amount) }}
                                </td>
                                <td class="status-col">
                                    {% if req.status == 'Approved' %}
                                        <span class="badge badge-success">✓ {{ req.status }}</span>
                                    {% elif req.status == 'Completed' %}
                                        <span class="badge" style="background: #28a745; color: white;">✓ {{ req.status }}</span>
                                    {% elif req.status == 'On Hold' %}
                                        <span class="badge" style="background: #ffc107; color: #212529;">⏸ On Hold</span>
                                    {% elif req.status in ['Pending Manager Approval', 'Pending Finance Approval'] %}
                                        <span class="badge" style="background: #6c757d; color: white;">⏳ {{ req.status }}</span>
                                    {% elif req.status == 'Returned to Manager' %}
                                        <span class="badge" style="background: #2196F3; color: white;">↩ {{ req.status }}</span>
                                    {% elif req.status == 'Payment Pending' %}
                                        <span class="badge" style="background: #FF9800; color: white;">⏳ {{ req.status }}</span>
                                    {% elif req.status in ['Proof Pending', 'Proof Sent'] %}
                                        <span class="badge" style="background: #2196F3; color: white;">📄 {{ req.status }}</span>
                                    {% elif req.status == 'Paid' %}
                                        <span class="badge" style="background: #6f42c1; color: white;">💰 {{ req.status }}</span>
                                    {% elif req.status == 'Recurring' %}
                                        <span class="badge" style="background: #ffc107; color: #212529;">↻ {{ req.status }}</span>
                                    {% elif req.status in ['Rejected by Manager', 'Rejected by Finance', 'Proof Rejected'] or 'Rejected' in req.status %}
                                        <span class="badge" style="background: #dc3545; color: white;">✗ {{ req.status }}</span>
                                    {% else %}
                                        <span class="badge badge-warning">⏳ {{ req.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ req.approver or 'N/A' }}</td>
                                {# Manager and Finance duration cells removed in frontend reports view #}
                                <td>
                                    <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-view-outline" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% if req.recurring == 'Recurring' %}
                            {% set schedules = req.payment_schedules | sort(attribute='payment_order') %}
                            <tr class="nested-row" data-parent="{{ req.request_id }}" style="display:none;">
                                <td colspan="20" class="nested-container">
                                    <div class="nested-inner">
                                        <table class="nested-schedule-table">
                                            <thead>
                                                <tr>
                                                    <th class="col-schedule-id">Schedule ID</th>
                                                    <th class="col-date">Date</th>
                                                    <th class="col-amount">Amount</th>
                                                    <th class="col-status">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' %}
                                                {% if schedules %}
                                                    {% for item in schedules %}
                                                    {% set letter = letters[loop.index0] if loop.index0 < letters|length else letters[loop.index0 % letters|length] %}
                                                    <tr>
                                                        <td class="col-schedule-id">#{{ req.request_id }}-{{ letter }}</td>
                                                        <td class="col-date">{{ item.payment_date.strftime('%Y-%m-%d') if item.payment_date else '-' }}</td>
                                                        <td class="col-amount">OMR {{ '%.3f'|format(item.amount) }}</td>
                                                        <td class="col-status">
                                                            {% if item.is_paid %}
                                                                <span class="status-chip status-chip--paid">Paid</span>
                                                            {% else %}
                                                                <span class="status-chip status-chip--pending">Pending</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr><td colspan="4" style="color:#666;">No schedule</td></tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                {% if pagination %}
                <div class="pagination-container">
                    <div class="pagination-left">
                        <div class="pagination-info">
                            Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} to 
                            {{ pagination.per_page * (pagination.page - 1) + pagination.items|length }} 
                            of {{ pagination.total }} requests
                        </div>
                        <div class="items-per-page">
                            <label for="per_page">Show:</label>
                            <select id="per_page" onchange="changeItemsPerPage(this.value)">
                                <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                                <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    {% if pagination.pages > 1 %}
                    <div class="pagination">
                        {% if pagination.has_prev %}
                            <a href="#" class="btn btn-sm btn-secondary pagination-link" data-page="{{ pagination.prev_num }}">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <a href="#" class="btn btn-sm btn-outline pagination-link" data-page="{{ page_num }}">{{ page_num }}</a>
                                {% else %}
                                    <span class="btn btn-sm btn-primary">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                            <a href="#" class="btn btn-sm btn-secondary pagination-link" data-page="{{ pagination.next_num }}">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-search"></i>
                    <p>No results found for the selected filters.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let exportTimeout;
let isExporting = false;
let exportingType = null; // 'pdf' or 'excel'
let windowBlurred = false;
let downloadStartTime = null;
let loaderCheckInterval = null;

// Helper function to hide global loader if it exists
function hideGlobalLoader() {
    const globalLoader = document.getElementById('global-loader');
    if (globalLoader) {
        globalLoader.remove();
    }
    // Also try calling hideLoading if it exists
    if (typeof hideLoading === 'function') {
        hideLoading();
    }
}

function showExportLoading(event) {
    if (isExporting) {
        event.preventDefault();
        return false; // Prevent multiple clicks
    }
    
    // IMPORTANT: Hide any global loader that might have been triggered
    hideGlobalLoader();
    
    // Safety check: if event is not provided, try to determine from context
    if (!event || !event.target) {
        console.warn('showExportLoading called without event object');
        return false;
    }
    
    // Determine which button was clicked
    const clickedElement = event.target;
    let targetBtn, targetText, exportType;
    
    if (clickedElement.id === 'export-pdf-btn' || clickedElement.closest('#export-pdf-btn')) {
        targetBtn = document.getElementById('export-pdf-btn');
        targetText = document.getElementById('export-text');
        exportType = 'pdf';
    } else if (clickedElement.id === 'export-excel-btn' || clickedElement.closest('#export-excel-btn')) {
        targetBtn = document.getElementById('export-excel-btn');
        targetText = document.getElementById('export-excel-text');
        exportType = 'excel';
    } else {
        // Fallback: check which button triggered this
        const pdfBtn = document.getElementById('export-pdf-btn');
        const excelBtn = document.getElementById('export-excel-btn');
        if (event.target === pdfBtn || (pdfBtn && pdfBtn.contains(event.target))) {
            targetBtn = pdfBtn;
            targetText = document.getElementById('export-text');
            exportType = 'pdf';
        } else if (event.target === excelBtn || (excelBtn && excelBtn.contains(event.target))) {
            targetBtn = excelBtn;
            targetText = document.getElementById('export-excel-text');
            exportType = 'excel';
        } else {
            return true; // Allow normal link behavior
        }
    }
    
    if (!targetBtn || !targetText) {
        return true; // Allow normal link behavior if we can't find elements
    }
    
    // Set exporting state
    isExporting = true;
    exportingType = exportType;
    downloadStartTime = Date.now();
    
    // Disable both buttons to prevent multiple exports
    const pdfBtn = document.getElementById('export-pdf-btn');
    const excelBtn = document.getElementById('export-excel-btn');
    if (pdfBtn) {
        pdfBtn.style.pointerEvents = 'none';
        pdfBtn.style.opacity = '0.6';
    }
    if (excelBtn) {
        excelBtn.style.pointerEvents = 'none';
        excelBtn.style.opacity = '0.6';
    }
    
    // Update the clicked button's text
    if (exportType === 'pdf') {
        targetText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
    } else {
        targetText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Excel...';
    }
    
    // Track window blur (user might switch tabs/windows for download)
    windowBlurred = false;
    
    // Clear any existing timeout
    if (exportTimeout) {
        clearTimeout(exportTimeout);
    }
    
    // IMPORTANT: Continuously monitor and hide global loader
    if (loaderCheckInterval) {
        clearInterval(loaderCheckInterval);
    }
    loaderCheckInterval = setInterval(function() {
        hideGlobalLoader();
        if (!isExporting) {
            clearInterval(loaderCheckInterval);
            loaderCheckInterval = null;
        }
    }, 100);
    
    // Multiple detection methods for download completion:
    
    // 1. Reset after short initial delay (download likely started)
    setTimeout(function() {
        if (isExporting) {
            resetExportButtons();
        }
    }, 2500);
    
    // 2. Safety timeout: Reset after 8 seconds if still exporting
    exportTimeout = setTimeout(function() {
        resetExportButtons();
    }, 8000);
    
    // Allow the download to proceed normally (don't prevent default)
    // The global loader will be continuously hidden
    return true;
}

function resetExportButtons() {
    // Hide global loader first
    hideGlobalLoader();
    
    // Clear loader check interval
    if (loaderCheckInterval) {
        clearInterval(loaderCheckInterval);
        loaderCheckInterval = null;
    }
    
    const pdfBtn = document.getElementById('export-pdf-btn');
    const pdfText = document.getElementById('export-text');
    const excelBtn = document.getElementById('export-excel-btn');
    const excelText = document.getElementById('export-excel-text');
    
    if (pdfBtn && pdfText) {
        pdfBtn.style.pointerEvents = 'auto';
        pdfBtn.style.opacity = '1';
        pdfText.innerHTML = 'Export PDF';
    }
    
    if (excelBtn && excelText) {
        excelBtn.style.pointerEvents = 'auto';
        excelBtn.style.opacity = '1';
        excelText.innerHTML = 'Export Excel';
    }
    
    isExporting = false;
    exportingType = null;
    downloadStartTime = null;
    
    if (exportTimeout) {
        clearTimeout(exportTimeout);
        exportTimeout = null;
    }
}

// Reset button state when page becomes visible again (user likely returned after download)
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && isExporting) {
        // Check if enough time has passed (at least 2 seconds)
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
});

// Reset when window regains focus (user clicked back to the tab)
window.addEventListener('focus', function() {
    if (isExporting && windowBlurred) {
        // Check if enough time has passed
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 500);
        }
    }
    windowBlurred = false;
});

// Track when window loses focus (user might be saving/downloading file)
window.addEventListener('blur', function() {
    if (isExporting) {
        windowBlurred = true;
    }
});

// Reset button state when user clicks anywhere on the page (except the export buttons)
document.addEventListener('click', function(e) {
    const isPdfBtn = e.target.id === 'export-pdf-btn' || e.target.closest('#export-pdf-btn');
    const isExcelBtn = e.target.id === 'export-excel-btn' || e.target.closest('#export-excel-btn');
    
    if (!isPdfBtn && !isExcelBtn && isExporting) {
        // Only reset if enough time has passed since download started
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
});

// Reset button state when user presses Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (isExporting) {
            resetExportButtons();
        }
        // Also close filter panel if open
        const panel = document.getElementById('filter-panel');
        if (panel && panel.classList.contains('open')) {
            closeFilterPanel();
        }
    }
});

// Reset button state when the page loads (in case of refresh)
document.addEventListener('DOMContentLoaded', function() {
    resetExportButtons();
    
    // Also hide any global loader that might be stuck
    hideGlobalLoader();
    
    // Make entire checkbox option clickable (for both side panel and inline filters)
    document.querySelectorAll('.checkbox-option, .checkbox-option-inline').forEach(option => {
        option.addEventListener('click', function(e) {
            // Don't toggle if clicking directly on the checkbox (to avoid double-toggle)
            if (e.target.tagName !== 'INPUT') {
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    // Trigger change event for any listeners
                    checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    // Sync between side panel and inline filters
                    syncCheckboxes(checkbox);
                }
            }
        });
    });
    
    
    
    // Sync checkboxes between side panel and inline filters when changed
    function syncCheckboxes(changedCheckbox) {
        const name = changedCheckbox.name;
        const value = changedCheckbox.value;
        const isChecked = changedCheckbox.checked;
        
        // Find all checkboxes with the same name and value
        document.querySelectorAll(`input[type="checkbox"][name="${name}"][value="${value}"]`).forEach(cb => {
            if (cb !== changedCheckbox) {
                cb.checked = isChecked;
            }
        });
    }
    
    // Add change listeners to sync checkboxes
    document.querySelectorAll('input[type="checkbox"][name="department"], input[type="checkbox"][name="status"], input[type="checkbox"][name="payment_type"], input[type="checkbox"][name="payment_method"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            syncCheckboxes(this);
        });
    });
});

// Monitor for mouse movement - user interaction indicates they're back
let lastMouseMove = Date.now();
document.addEventListener('mousemove', function() {
    if (isExporting && (Date.now() - lastMouseMove) > 1000) {
        lastMouseMove = Date.now();
        if (downloadStartTime && (Date.now() - downloadStartTime) > 2000) {
            setTimeout(function() {
                resetExportButtons();
            }, 300);
        }
    }
    lastMouseMove = Date.now();
});

// Update request types when departments change (for checkboxes in side panel)
function updateRequestTypesForDepartments() {
    const requestTypeGroup = document.getElementById('request_type-group');
    if (!requestTypeGroup) return;
    
    // Get selected departments from checkboxes
    const selectedDeptValues = Array.from(document.querySelectorAll('input[type="checkbox"][name="department"]:checked'))
        .map(cb => cb.value);
    
    // Get currently selected request types to preserve them
    const currentRequestTypes = Array.from(requestTypeGroup.querySelectorAll('input[type="checkbox"]:checked'))
        .map(cb => cb.value);
    
    // Clear existing checkboxes
    requestTypeGroup.innerHTML = '';
    
    // If no departments selected, show all request types
    if (selectedDeptValues.length === 0) {
        fetch('/api/request-types')
            .then(response => response.json())
            .then(data => {
                data.request_types.forEach((requestType, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'checkbox-option';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'request_type';
                    checkbox.id = `rt_${index}`;
                    checkbox.value = requestType;
                    // Preserve checked state if it was previously selected
                    if (currentRequestTypes.includes(requestType)) {
                        checkbox.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = `rt_${index}`;
                    label.textContent = requestType;
                    
                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(label);
                    requestTypeGroup.appendChild(optionDiv);
                    
                    // Make the entire option clickable
                    optionDiv.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    
                    // Add change listener to update chips
                    checkbox.addEventListener('change', function() {
                        updateChipsFromCheckboxes('request_type', 'request_type_chips_container');
                    });
                });
                
                // Update chips after rebuilding
                updateChipsFromCheckboxes('request_type', 'request_type_chips_container');
            })
            .catch(error => console.error('Error fetching request types:', error));
    } else {
        // Fetch request types for all selected departments
        const promises = selectedDeptValues.map(dept => 
            fetch(`/api/request-types?department=${encodeURIComponent(dept)}`)
                .then(response => response.json())
        );
        
        Promise.all(promises)
            .then(results => {
                // Combine and deduplicate request types
                const allRequestTypes = new Set();
                results.forEach(data => {
                    data.request_types.forEach(rt => allRequestTypes.add(rt));
                });
                
                // Sort and add checkboxes
                Array.from(allRequestTypes).sort().forEach((requestType, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'checkbox-option';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'request_type';
                    checkbox.id = `rt_${index}`;
                    checkbox.value = requestType;
                    // Preserve checked state if it was previously selected
                    if (currentRequestTypes.includes(requestType)) {
                        checkbox.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = `rt_${index}`;
                    label.textContent = requestType;
                    
                    optionDiv.appendChild(checkbox);
                    optionDiv.appendChild(label);
                    requestTypeGroup.appendChild(optionDiv);
                    
                    // Make the entire option clickable
                    optionDiv.addEventListener('click', function(e) {
                        if (e.target.tagName !== 'INPUT') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    });
                    
                    // Add change listener to update chips
                    checkbox.addEventListener('change', function() {
                        updateChipsFromCheckboxes('request_type', 'request_type_chips_container');
                    });
                });
                
                // Update chips after rebuilding
                updateChipsFromCheckboxes('request_type', 'request_type_chips_container');
            })
            .catch(error => console.error('Error fetching request types:', error));
    }
}

// Monitor department checkbox changes to update request types
document.addEventListener('DOMContentLoaded', function() {
    // Add change listeners to all department checkboxes
    document.querySelectorAll('input[type="checkbox"][name="department"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateRequestTypesForDepartments();
        });
    });
    
    // Initialize request types on page load if departments are already selected
    const hasSelectedDepartments = Array.from(document.querySelectorAll('input[type="checkbox"][name="department"]'))
        .some(cb => cb.checked);
    if (hasSelectedDepartments) {
        updateRequestTypesForDepartments();
    }
});

function changeItemsPerPage(perPage) {
    // Redirect to page 1 with new per_page value, preserving all filters
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Handle pagination links - preserve all query parameters including multiple values
// Use AJAX reload if reference_number is present (for Auditing search), otherwise full page reload
function attachPaginationHandlers() {
    document.querySelectorAll('.pagination-link').forEach(link => {
        // Remove any existing listeners to avoid duplicates
        const newLink = link.cloneNode(true);
        link.parentNode.replaceChild(newLink, link);
        
        newLink.addEventListener('click', function(e) {
            e.preventDefault();
            const pageNum = this.getAttribute('data-page');
            
            // Build URL preserving all query parameters (including multiple values)
            const currentUrl = new URL(window.location);
            
            // Set the page number
            currentUrl.searchParams.set('page', pageNum);
            
            // Check if reference_number is in URL - if so, use AJAX reload
            const referenceNumber = currentUrl.searchParams.get('reference_number');
            if (referenceNumber && typeof window.reloadResultsViaAjax === 'function') {
                // Update URL in address bar
                history.replaceState(null, '', currentUrl.toString());
                // Reload via AJAX and scroll to top for pagination
                window.reloadResultsViaAjax(currentUrl.toString(), true);
            } else {
                // Full page navigation for normal pagination
                window.location.href = currentUrl.toString();
            }
        });
    });
}

// Attach handlers on page load
document.addEventListener('DOMContentLoaded', function() {
    attachPaginationHandlers();
});

// Initialize filter dropdown with chips (reusable function)
function initializeFilterDropdown(config) {
    const { 
        searchInputId, 
        dropdownId, 
        chipsContainerId, 
        hiddenInputId, 
        options, 
        selectedValues,
        placeholder = "Search..."
    } = config;
    
    const searchInput = document.getElementById(searchInputId);
    const dropdown = document.getElementById(dropdownId);
    const chipsContainer = document.getElementById(chipsContainerId);
    const hiddenInput = document.getElementById(hiddenInputId);
    
    if (!searchInput || !dropdown || !chipsContainer || !hiddenInput) return;
    
    let selectedItems = [];
    let clickingOnOption = false;
    let blurTimeout = null;
    
    // Initialize with selected values from URL
    if (selectedValues && selectedValues.length > 0) {
        selectedValues.forEach(value => {
            const option = options.find(opt => opt.value === value);
            if (option) {
                selectedItems.push({ value: option.value, text: option.text });
            }
        });
        updateChips();
    }
    
    // Function to update chips display
    function updateChips() {
        chipsContainer.innerHTML = '';
        selectedItems.forEach((item, index) => {
            const chip = document.createElement('div');
            chip.className = 'filter-chip';
            chip.innerHTML = `
                <span>${item.text}</span>
                <button type="button" class="remove-chip" onclick="removeFilterChip('${config.filterName}', ${index})" title="Remove">×</button>
            `;
            chipsContainer.appendChild(chip);
        });
        
        // Update hidden input - we'll handle multiple values in form submission
        updateHiddenInput();
    }
    
    // Update hidden input for form submission
    function updateHiddenInput() {
        // Clear existing hidden inputs with this name (except the main one)
        const container = hiddenInput.parentNode;
        const existingInputs = container.querySelectorAll(`input[type="hidden"][name="${config.filterName}"]`);
        existingInputs.forEach(input => {
            if (input !== hiddenInput) input.remove();
        });
        
        // Create multiple hidden inputs for each selected value
        selectedItems.forEach((item, index) => {
            if (index === 0) {
                hiddenInput.value = item.value;
            } else {
                const newInput = document.createElement('input');
                newInput.type = 'hidden';
                newInput.name = config.filterName;
                newInput.value = item.value;
                container.insertBefore(newInput, hiddenInput.nextSibling);
            }
        });
        
        if (selectedItems.length === 0) {
            hiddenInput.value = '';
        }
        
        // Trigger request type update if this is a department filter
        if (config.filterName === 'department' && typeof updateRequestTypesForDepartments === 'function') {
            setTimeout(updateRequestTypesForDepartments, 100);
        }
    }
    
    // Store remove function globally
    if (!window.filterChipRemovers) window.filterChipRemovers = {};
    window.filterChipRemovers[config.filterName] = function(index) {
        selectedItems.splice(index, 1);
        updateChips();
        updateDropdownSelection();
    };
    
    // Function to update dropdown to show selected items
    function updateDropdownSelection() {
        const optionDivs = dropdown.querySelectorAll('.filter-option');
        optionDivs.forEach(optionDiv => {
            const value = optionDiv.getAttribute('data-value');
            const isSelected = selectedItems.some(item => item.value === value);
            if (isSelected) {
                optionDiv.classList.add('selected');
            } else {
                optionDiv.classList.remove('selected');
            }
        });
    }
    
    // Build dropdown from options
    function buildDropdown(opts = options) {
        dropdown.innerHTML = '';
        opts.forEach(option => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'filter-option';
            // Build option content with a text span so we can add an info icon when available
            const textSpan = document.createElement('span');
            textSpan.textContent = option.text;
            optionDiv.appendChild(textSpan);
            // If option has a description, add styled tooltip wrapper (matches new_request)
            if (option.description) {
                const tooltipWrapper = document.createElement('span');
                tooltipWrapper.className = 'tooltip-wrapper';
                const descText = option.description || '';
                const escapeHtml = (s) => String(s || '').replace(/[&<>"]/g, function(c) {
                    return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
                });
                tooltipWrapper.innerHTML = '<i class="fas fa-info-circle tooltip-icon" aria-hidden="true"></i>' +
                                           '<span class="tooltip-text">' + escapeHtml(descText) + '</span>';
                // Prevent icon clicks from selecting the option and toggle persistent tooltip on click
                tooltipWrapper.addEventListener('click', function(e){
                    e.preventDefault();
                    e.stopPropagation();
                    const currentlyVisible = tooltipWrapper.classList.contains('tooltip-visible');
                    document.querySelectorAll('.tooltip-wrapper.tooltip-visible').forEach(w => {
                        if (w !== tooltipWrapper) w.classList.remove('tooltip-visible');
                    });
                    if (currentlyVisible) {
                        tooltipWrapper.classList.remove('tooltip-visible');
                    } else {
                        tooltipWrapper.classList.add('tooltip-visible');
                        positionTooltip(tooltipWrapper);
                    }
                }, { passive: false });
                bindTooltipPositioning(tooltipWrapper);
                optionDiv.appendChild(tooltipWrapper);
            }
            optionDiv.setAttribute('data-value', option.value);
            
            let optionHandled = false;
            let optionTimeout = null;
            
            // Function to handle option selection with debouncing
            function handleOptionSelection(e) {
                if (optionHandled) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                clickingOnOption = true;
                optionHandled = true;
                selectOption(option.value, option.text);
                
                // Clear any existing timeout
                if (optionTimeout) {
                    clearTimeout(optionTimeout);
                }
                
                // Reset flag after a delay to allow for soft touches
                optionTimeout = setTimeout(() => {
                    optionHandled = false;
                }, 400);
            }
            
            // Use mousedown for better trackpad support (fires before blur)
            // This works for both mouse and most trackpad interactions
            optionDiv.addEventListener('mousedown', handleOptionSelection, { passive: false });
            
            // Support for touch devices and trackpads (soft touches)
            optionDiv.addEventListener('touchstart', handleOptionSelection, { passive: false });
            
            // Pointer events for better cross-device support (including soft trackpad touches)
            optionDiv.addEventListener('pointerdown', function(e) {
                // Handle all pointer types, including soft touches
                handleOptionSelection(e);
            }, { passive: false });
            
            // Mouseup as additional fallback for soft trackpad touches
            // Some soft touches might not trigger mousedown but will trigger mouseup
            optionDiv.addEventListener('mouseup', function(e) {
                // Only handle if mousedown didn't already handle it
                setTimeout(() => {
                    if (!optionHandled) {
                        handleOptionSelection(e);
                    }
                }, 10);
            }, { passive: false });
            
            // Touchend as fallback for soft touches
            optionDiv.addEventListener('touchend', function(e) {
                // Only handle if touchstart didn't already handle it
                setTimeout(() => {
                    if (!optionHandled) {
                        handleOptionSelection(e);
                    }
                }, 10);
            }, { passive: false });
            
            // Keep click as final fallback for accessibility and edge cases
            optionDiv.addEventListener('click', function(e) {
                // Only handle if no other event handled it
                setTimeout(() => {
                    if (!optionHandled && !clickingOnOption) {
                        handleOptionSelection(e);
                    }
                }, 50);
            }, { passive: false });
            
            dropdown.appendChild(optionDiv);
        });
        
        updateDropdownSelection();
    }
    
    // Function to rebuild dropdown with new options
    function rebuildDropdown(newOptions) {
        options = newOptions;
        buildDropdown(newOptions);
    }
    
    function selectOption(value, text) {
        // Clear any pending blur timeout
        if (blurTimeout) {
            clearTimeout(blurTimeout);
            blurTimeout = null;
        }
        
        // Check if already selected - toggle behavior
        const existingIndex = selectedItems.findIndex(item => item.value === value);
        if (existingIndex !== -1) {
            // Item already selected, remove it
            selectedItems.splice(existingIndex, 1);
            updateChips();
            updateDropdownSelection();
            
            // Clear search input but keep dropdown open so user can continue selecting
            searchInput.value = '';
            dropdown.style.display = 'block';
            // Re-focus after a small delay to ensure it works with soft touches
            setTimeout(() => {
                searchInput.focus();
            }, 50);
            
            // Reset flag after a delay to allow for soft trackpad touches
            setTimeout(() => {
                clickingOnOption = false;
            }, 200);
            return;
        }
        
        // Add to selected items
        selectedItems.push({ value: value, text: text });
        updateChips();
        updateDropdownSelection();
        
        // Clear search input but keep dropdown open so user can continue selecting
        searchInput.value = '';
        dropdown.style.display = 'block';
        // Re-focus after a small delay to ensure it works with soft touches
        setTimeout(() => {
            searchInput.focus();
        }, 50);
        
        // Reset flag after a delay to allow for soft trackpad touches
        setTimeout(() => {
            clickingOnOption = false;
        }, 200);
    }
    
    function filterOptions(searchTerm) {
        const optionDivs = dropdown.querySelectorAll('.filter-option');
        let hasVisible = false;
        
        optionDivs.forEach(optionDiv => {
            const text = optionDiv.textContent.toLowerCase();
            const matches = text.includes(searchTerm.toLowerCase());
            if (matches) {
                optionDiv.classList.remove('hidden');
                hasVisible = true;
            } else {
                optionDiv.classList.add('hidden');
            }
        });
        
        dropdown.style.display = hasVisible ? 'block' : 'none';
    }
    
    // Event listeners
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        if (searchTerm.length > 0) {
            filterOptions(searchTerm);
        } else {
            dropdown.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('hidden'));
            dropdown.style.display = 'block';
        }
    });
    
    // Tooltip positioning helpers (copy from new_request.html)
    function positionTooltip(tooltipWrapper) {
        var icon = tooltipWrapper.querySelector('.tooltip-icon');
        var tooltip = tooltipWrapper.querySelector('.tooltip-text');
        if (icon && tooltip) {
            var iconRect = icon.getBoundingClientRect();
            var iconCenter = iconRect.left + (iconRect.width / 2);
            var arrowOffset = 8; // arrow sits at 8px from tooltip left edge
            tooltip.style.left = (iconCenter - arrowOffset) + 'px';
            // Keep tooltip slightly above icon for desktop; if visible via tap, move slightly closer
            var isMobileViewport = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
            var isTapVisible = tooltipWrapper.classList && tooltipWrapper.classList.contains('tooltip-visible');
            if (isMobileViewport || isTapVisible) {
                tooltip.style.top = (iconRect.top - tooltip.offsetHeight + 4) + 'px';
            } else {
                tooltip.style.top = (iconRect.top - tooltip.offsetHeight - 8) + 'px';
            }
        }
    }

    function bindTooltipPositioning(wrapper) {
        if (!wrapper || wrapper.dataset.tooltipBound === 'true') return;
        wrapper.dataset.tooltipBound = 'true';
        ['mouseenter', 'touchstart'].forEach(evt => {
            wrapper.addEventListener(evt, function() { positionTooltip(wrapper); }, { passive: true });
        });
        ['scroll', 'resize'].forEach(evt => {
            window.addEventListener(evt, function() {
                var tooltip = wrapper.querySelector('.tooltip-text');
                if (tooltip && tooltip.style.visibility === 'visible') {
                    positionTooltip(wrapper);
                }
            });
        });
    }
    
    // Enable tap-to-open behavior on mobile for tooltips
    function enableTapTooltipsOnMobile() {
        const supportsTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const isMobileViewport = window.matchMedia && window.matchMedia('(max-width: 768px)').matches;
        const enableTap = supportsTouch || isMobileViewport;
        if (!enableTap) return;
        document.querySelectorAll('.tooltip-wrapper').forEach(wrapper => {
            if (wrapper._tapHandlerBound) return;
            wrapper._tapHandlerBound = true;
            wrapper.addEventListener('click', function(e) {
                e.stopPropagation();
                const currentlyVisible = wrapper.classList.contains('tooltip-visible');
                document.querySelectorAll('.tooltip-wrapper.tooltip-visible').forEach(w => {
                    if (w !== wrapper) w.classList.remove('tooltip-visible');
                });
                if (currentlyVisible) {
                    wrapper.classList.remove('tooltip-visible');
                } else {
                    wrapper.classList.add('tooltip-visible');
                    positionTooltip(wrapper);
                }
            }, { passive: false });
        });
        document.addEventListener('click', function() {
            document.querySelectorAll('.tooltip-wrapper.tooltip-visible').forEach(w => w.classList.remove('tooltip-visible'));
        });
    }
    
    searchInput.addEventListener('focus', function() {
        if (this.value.trim() === '') {
            dropdown.style.display = 'block';
        } else {
            filterOptions(this.value.trim());
        }
    });
    
    searchInput.addEventListener('blur', function() {
        // Delay hiding to allow clicks on options (especially for soft trackpad touches)
        // Clear any existing timeout first
        if (blurTimeout) {
            clearTimeout(blurTimeout);
        }
        blurTimeout = setTimeout(() => {
            // Only hide if not clicking on an option
            // Give extra time for soft touches that might have delayed event firing
            if (!clickingOnOption) {
                dropdown.style.display = 'none';
            }
            blurTimeout = null;
        }, 300); // Increased timeout for better soft trackpad support
    });
    
    // Also prevent blur on mousedown/touchstart on dropdown options
    dropdown.addEventListener('mousedown', function(e) {
        e.preventDefault();
    });
    
    dropdown.addEventListener('touchstart', function(e) {
        e.preventDefault();
    });
    
    dropdown.addEventListener('pointerdown', function(e) {
        e.preventDefault();
    });
    
    // Close dropdown when clicking outside (but not on chips)
    document.addEventListener('click', function(e) {
        const chipsContainer = document.getElementById(config.chipsContainerId);
        if (!searchInput.contains(e.target) && 
            !dropdown.contains(e.target) && 
            !(chipsContainer && chipsContainer.contains(e.target))) {
            dropdown.style.display = 'none';
        }
    });
    
    // Also handle touch events for better mobile/trackpad support
    document.addEventListener('touchend', function(e) {
        const chipsContainer = document.getElementById(config.chipsContainerId);
        if (!searchInput.contains(e.target) && 
            !dropdown.contains(e.target) && 
            !(chipsContainer && chipsContainer.contains(e.target))) {
            dropdown.style.display = 'none';
        }
    });
    
    // Initialize
    buildDropdown();
    // Enable tooltips tap behavior after build
    setTimeout(enableTapTooltipsOnMobile, 100);
    
    // Return the selectedItems array for external access
    return {
        getSelectedItems: () => selectedItems,
        setSelectedItems: (items) => {
            selectedItems = items;
            updateChips();
            updateDropdownSelection();
        },
        rebuildDropdown: rebuildDropdown,
        updateChips: updateChips,
        updateDropdownSelection: updateDropdownSelection
    };
}

// Global function to remove filter chips
function removeFilterChip(filterName, index) {
    if (window.filterChipRemovers && window.filterChipRemovers[filterName]) {
        window.filterChipRemovers[filterName](index);
    }
}

// Initialize all filter dropdowns on page load
// Function to update chips from checkboxes (for side panel)
function updateChipsFromCheckboxes(filterName, chipsContainerId) {
    const chipsContainer = document.getElementById(chipsContainerId);
    if (!chipsContainer) return;
    
    // Get all checked checkboxes with this name
    const checkboxes = document.querySelectorAll(`input[type="checkbox"][name="${filterName}"]:checked`);
    const selectedItems = Array.from(checkboxes).map(cb => ({
        value: cb.value,
        text: cb.nextElementSibling ? cb.nextElementSibling.textContent.trim() : cb.value
    }));
    
    // Update chips display
    chipsContainer.innerHTML = '';
    selectedItems.forEach((item, index) => {
        const chip = document.createElement('div');
        chip.className = 'filter-chip';
        chip.innerHTML = `
            <span>${item.text}</span>
            <button type="button" class="remove-chip" onclick="removeFilterChipFromCheckbox('${filterName}', '${item.value.replace(/'/g, "\\'")}')" title="Remove">×</button>
        `;
        chipsContainer.appendChild(chip);
    });
}

// Function to remove chip and uncheck corresponding checkbox
function removeFilterChipFromCheckbox(filterName, value) {
    const checkbox = document.querySelector(`input[type="checkbox"][name="${filterName}"][value="${value}"]`);
    if (checkbox) {
        checkbox.checked = false;
        // Trigger change event to update chips
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
    }
}

// Initialize chips for side panel checkboxes
document.addEventListener('DOMContentLoaded', function() {
    // Update chips for all filter types in side panel
    const filterConfigs = [
        { name: 'department', chipsId: 'department_chips_container' },
        { name: 'request_type', chipsId: 'request_type_chips_container' },
        { name: 'company', chipsId: 'company_chips_container' },
        { name: 'branch', chipsId: 'branch_chips_container' },
        { name: 'payment_type', chipsId: 'payment_type_chips_container' },
        { name: 'payment_method', chipsId: 'payment_method_chips_container' },
        { name: 'status', chipsId: 'status_chips_container' }
    ];
    
    // Initialize chips on page load
    filterConfigs.forEach(config => {
        updateChipsFromCheckboxes(config.name, config.chipsId);
        
        // Add change listeners to all checkboxes
        document.querySelectorAll(`input[type="checkbox"][name="${config.name}"]`).forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateChipsFromCheckboxes(config.name, config.chipsId);
            });
        });
    });
    
    // Global search for filters in side panel
    const globalSearchInput = document.getElementById('filter-global-search');
    if (globalSearchInput) {
        globalSearchInput.addEventListener('input', function() {
            filterAllFilters(this.value);
        });
        
        // Clear search when panel closes
        const filterPanel = document.getElementById('filter-panel');
        if (filterPanel) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.attributeName === 'class') {
                        if (!filterPanel.classList.contains('open')) {
                            globalSearchInput.value = '';
                            filterAllFilters('');
                        }
                    }
                });
            });
            observer.observe(filterPanel, { attributes: true });
        }
    }
    
    // Function to filter all filters based on search term
    function filterAllFilters(searchTerm) {
        const searchLower = searchTerm.toLowerCase().trim();
        
        // If search is empty, show all filters
        if (searchLower === '') {
            document.querySelectorAll('.filter-panel-body .form-group').forEach(group => {
                // Skip the search bar group itself
                if (group.querySelector('#filter-global-search')) {
                    return;
                }
                group.style.display = '';
            });
            document.querySelectorAll('.filter-panel-body .checkbox-option, .filter-panel-body .payment-method-option').forEach(option => {
                option.style.display = '';
            });
            return;
        }
        
        // Hide all form groups first
        document.querySelectorAll('.filter-panel-body .form-group').forEach(group => {
            const label = group.querySelector('label');
            // Skip the search bar group itself
            if (group.querySelector('#filter-global-search')) {
                return;
            }
            group.style.display = 'none';
        });
        
        // Search through all checkbox options and payment method options
        let hasMatches = false;
        
        document.querySelectorAll('.filter-panel-body .checkbox-option, .filter-panel-body .payment-method-option').forEach(option => {
            const label = option.querySelector('label');
            const checkbox = option.querySelector('input[type="checkbox"]');
            const text = label ? label.textContent.toLowerCase() : '';
            const value = checkbox ? checkbox.value.toLowerCase() : '';
            
            const matches = text.includes(searchLower) || value.includes(searchLower);
            
            if (matches) {
                option.style.display = '';
                hasMatches = true;
                
                // Show the parent form group
                let formGroup = option.closest('.form-group');
                if (formGroup) {
                    formGroup.style.display = '';
                }
            } else {
                option.style.display = 'none';
            }
        });
        
        // If no matches found, show a message
        const filterPanelBody = document.querySelector('.filter-panel-body');
        let noResultsMsg = document.getElementById('no-filter-results');
        if (!hasMatches && searchLower !== '') {
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.id = 'no-filter-results';
                noResultsMsg.className = 'form-group';
                noResultsMsg.style.padding = '20px';
                noResultsMsg.style.textAlign = 'center';
                noResultsMsg.style.color = '#6c757d';
                filterPanelBody.appendChild(noResultsMsg);
            }
            noResultsMsg.innerHTML = '<i class="fas fa-search"></i> No filters found matching "' + searchTerm + '"';
            noResultsMsg.style.display = '';
        } else if (noResultsMsg) {
            noResultsMsg.style.display = 'none';
        }
    }
    
    // Inline filters initialization
    const departments = [
        {% for dept in departments %}
        { value: '{{ dept }}', text: '{{ dept }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const selectedDepartments = {{ request.args.getlist('department') | tojson }};
    initializeFilterDropdown({
        searchInputId: 'inline_department_search',
        dropdownId: 'inline_department_dropdown',
        chipsContainerId: 'inline_department_chips_container',
        hiddenInputId: 'inline_department_hidden',
        options: departments,
        selectedValues: selectedDepartments,
        filterName: 'department',
        placeholder: 'Search departments...'
    });
    
    const requestTypes = [
        {% for rt in request_types %}
        { value: '{{ rt }}', text: '{{ rt }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const selectedRequestTypes = {{ request.args.getlist('request_type') | tojson }};
    // Helper to decode HTML entities (e.g. "&amp;" -> "&") in option values/texts
    function decodeHtmlEntities(str) {
        const txt = document.createElement('textarea');
        txt.innerHTML = String(str || '');
        return txt.value;
    }
    // Decode any HTML entities that may have been HTML-escaped when rendered server-side
    for (let i = 0; i < requestTypes.length; i++) {
        requestTypes[i].value = decodeHtmlEntities(requestTypes[i].value);
        requestTypes[i].text = decodeHtmlEntities(requestTypes[i].text);
    }
    initializeFilterDropdown({
        searchInputId: 'inline_request_type_search',
        dropdownId: 'inline_request_type_dropdown',
        chipsContainerId: 'inline_request_type_chips_container',
        hiddenInputId: 'inline_request_type_hidden',
        options: requestTypes,
        selectedValues: selectedRequestTypes,
        filterName: 'request_type',
        placeholder: 'Search request types...'
    });
    
    const companies = {{ companies | tojson }};
    const selectedCompanies = {{ request.args.getlist('company') | tojson }};
    // Ensure company option fields are not HTML-escaped strings
    if (Array.isArray(companies)) {
        for (let i = 0; i < companies.length; i++) {
            companies[i].value = decodeHtmlEntities(companies[i].value);
            companies[i].text = decodeHtmlEntities(companies[i].text);
            if (companies[i].description) companies[i].description = decodeHtmlEntities(companies[i].description);
        }
    }
    initializeFilterDropdown({
        searchInputId: 'inline_company_search',
        dropdownId: 'inline_company_dropdown',
        chipsContainerId: 'inline_company_chips_container',
        hiddenInputId: 'inline_company_hidden',
        options: companies,
        selectedValues: selectedCompanies,
        filterName: 'company',
        placeholder: 'Search companies...'
    });
    
    const branches = [
        {% for branch in branches %}
        { value: '{{ branch.name }}', text: '{{ branch.name }}' }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const selectedBranches = {{ request.args.getlist('branch') | tojson }};
    // Decode branch names in case they were escaped in the template
    for (let i = 0; i < branches.length; i++) {
        branches[i].value = decodeHtmlEntities(branches[i].value);
        branches[i].text = decodeHtmlEntities(branches[i].text);
    }
    initializeFilterDropdown({
        searchInputId: 'inline_branch_search',
        dropdownId: 'inline_branch_dropdown',
        chipsContainerId: 'inline_branch_chips_container',
        hiddenInputId: 'inline_branch_hidden',
        options: branches,
        selectedValues: selectedBranches,
        filterName: 'branch',
        placeholder: 'Search branches...'
    });
    
    {% if current_user.role == 'Auditing Staff' %}
    const statuses = [
        { value: 'Recurring', text: 'Recurring' },
        { value: 'Completed', text: 'Completed' }
    ];
    {% else %}
    const statuses = [
        { value: 'All Pending', text: 'All Pending' },
        { value: 'Pending Manager Approval', text: 'Pending Manager Approval' },
        { value: 'On Hold', text: 'On Hold' },
        { value: 'Pending Finance Approval', text: 'Pending Finance Approval' },
        { value: 'Returned to Manager', text: 'Returned to Manager' },
        { value: 'Rejected by Manager', text: 'Rejected by Manager' },
        { value: 'Proof Pending', text: 'Proof Pending' },
        { value: 'Proof Sent', text: 'Proof Sent' },
        { value: 'Proof Rejected', text: 'Proof Rejected' },
        { value: 'Recurring', text: 'Recurring' },
        { value: 'Completed', text: 'Completed' }
    ];
    {% endif %}
    const selectedStatuses = {{ request.args.getlist('status') | tojson }};
    initializeFilterDropdown({
        searchInputId: 'inline_status_search',
        dropdownId: 'inline_status_dropdown',
        chipsContainerId: 'inline_status_chips_container',
        hiddenInputId: 'inline_status_hidden',
        options: statuses,
        selectedValues: selectedStatuses,
        filterName: 'status',
        placeholder: 'Search statuses...'
    });
    
    const paymentTypes = [
        { value: 'One-Time', text: 'One-Time' },
        { value: 'Scheduled One-Time', text: 'Scheduled One-Time' },
        { value: 'Recurring', text: 'Recurring' }
    ];
    const selectedPaymentTypes = {{ request.args.getlist('payment_type') | tojson }};
    initializeFilterDropdown({
        searchInputId: 'inline_payment_type_search',
        dropdownId: 'inline_payment_type_dropdown',
        chipsContainerId: 'inline_payment_type_chips_container',
        hiddenInputId: 'inline_payment_type_hidden',
        options: paymentTypes,
        selectedValues: selectedPaymentTypes,
        filterName: 'payment_type',
        placeholder: 'Search payment types...'
    });
    
    const paymentMethods = [
        { value: 'Card', text: 'Card' },
        { value: 'Cheque', text: 'Cheque' },
        { value: 'Cash', text: 'Cash' }
    ];
    const selectedPaymentMethods = {{ request.args.getlist('payment_method') | tojson }};
    initializeFilterDropdown({
        searchInputId: 'inline_payment_method_search',
        dropdownId: 'inline_payment_method_dropdown',
        chipsContainerId: 'inline_payment_method_chips_container',
        hiddenInputId: 'inline_payment_method_hidden',
        options: paymentMethods,
        selectedValues: selectedPaymentMethods,
        filterName: 'payment_method',
        placeholder: 'Search payment methods...'
    });
});

// Filter Panel Functions
function openFilterPanel() {
    const panel = document.getElementById('filter-panel');
    const overlay = document.getElementById('filter-overlay');
    if (panel && overlay) {
        panel.classList.add('open');
        overlay.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeFilterPanel() {
    const panel = document.getElementById('filter-panel');
    const overlay = document.getElementById('filter-overlay');
    if (panel && overlay) {
        panel.classList.remove('open');
        overlay.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function applyFilters() {
    const form = document.getElementById('filter-form');
    const inlineForm = document.getElementById('inline-filter-form');
    
    if (form) {
        // Reset to page 1 when applying filters
        const url = new URL(form.action, window.location.origin);
        
        // Collect filters from both forms
        const filterData = {
            department: [],
            request_type: [],
            company: [],
            branch: [],
            status: [],
            payment_type: [],
            payment_method: [],
            date_from: '',
            date_to: ''
        };
        
        // Get filters from advanced filters form (side panel)
        const formData = new FormData(form);
        for (const [key, value] of formData.entries()) {
            if (value) {
                if (['department', 'request_type', 'company', 'branch', 'status', 'payment_type', 'payment_method'].includes(key)) {
                    if (!filterData[key].includes(value)) {
                        filterData[key].push(value);
                    }
                } else if (key === 'date_from' || key === 'date_to') {
                    filterData[key] = value;
                }
            }
        }
        
        // Get filters from inline quick filters form and combine
        if (inlineForm) {
            const inlineFormData = new FormData(inlineForm);
            for (const [key, value] of inlineFormData.entries()) {
                if (value) {
                    if (['department', 'request_type', 'company', 'branch', 'status', 'payment_type', 'payment_method'].includes(key)) {
                        if (!filterData[key].includes(value)) {
                            filterData[key].push(value);
                        }
                    } else if (key === 'date_from' || key === 'date_to') {
                        // Use inline filter date if advanced filter doesn't have one, otherwise prefer advanced filter
                        if (!filterData[key]) {
                            filterData[key] = value;
                        }
                    }
                }
            }
        }
        
        // Build URL with combined filters
        const multiSelectFields = ['department', 'request_type', 'company', 'branch', 'status', 'payment_type', 'payment_method'];
        
        for (const key of multiSelectFields) {
            url.searchParams.delete(key);
            filterData[key].forEach(value => {
                url.searchParams.append(key, value);
            });
        }
        
        // Add date filters
        if (filterData.date_from) {
            url.searchParams.set('date_from', filterData.date_from);
        }
        if (filterData.date_to) {
            url.searchParams.set('date_to', filterData.date_to);
        }
        
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
}

function applyInlineFilters() {
    const form = document.getElementById('inline-filter-form');
    if (form) {
        // Reset to page 1 when applying filters
        const url = new URL(form.action, window.location.origin);
        const formData = new FormData(form);
        
        // Handle multiple values for multi-select fields (from hidden inputs)
        const multiSelectFields = ['department', 'request_type', 'company', 'branch', 'status', 'payment_type', 'payment_method'];
        const processedKeys = new Set();
        
        for (const [key, value] of formData.entries()) {
            if (value) {
                if (multiSelectFields.includes(key)) {
                    // For multi-select fields, append each value
                    if (!processedKeys.has(key)) {
                        // Remove existing params for this key
                        url.searchParams.delete(key);
                        processedKeys.add(key);
                    }
                    url.searchParams.append(key, value);
                } else {
                    // For single-value fields, use set
                    url.searchParams.set(key, value);
                }
            }
        }
        
        url.searchParams.set('page', '1');
        window.location.href = url.toString();
    }
}

function removeFilter(filterName) {
    const url = new URL(window.location);
    url.searchParams.delete(filterName);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

function clearAllFilters() {
    window.location.href = "{{ url_for('reports') }}";
}


// Prevent panel from closing when clicking inside it
document.addEventListener('DOMContentLoaded', function() {
    const filterPanel = document.getElementById('filter-panel');
    if (filterPanel) {
        filterPanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
});

// Payment Method Selection (now supports multiple selections with checkboxes)
function togglePaymentMethod(event, value) {
    event.preventDefault();
    event.stopPropagation();
    
    const clickedOption = event.currentTarget;
    if (!clickedOption) return;
    
    const checkbox = clickedOption.querySelector('input[type="checkbox"]');
    if (!checkbox) return;
    
    // Toggle checkbox
    checkbox.checked = !checkbox.checked;
    
    // Update visual state
    if (checkbox.checked) {
        clickedOption.classList.add('selected');
    } else {
        clickedOption.classList.remove('selected');
    }
}
</script>
<style>
    .data-table tbody tr.clickable-row:hover { background: #f8f9fa; }
</style>
<script>
// Make table rows behave like clicking the View button (payment reports)
function attachRowClickHandlersForPaymentReports() {
    const rows = document.querySelectorAll('.data-table tbody tr[data-href]');
    rows.forEach(row => {
        // Skip nested rows
        if (row.classList.contains('nested-row')) return;
        const href = row.getAttribute('data-href');
        if (!href) return;
        row.classList.add('clickable-row');
        row.style.cursor = 'pointer';
        row.addEventListener('click', function(e) {
            // Ignore clicks on interactive elements and the expand chevron/expand cell
            if (e.target.closest('a, button, input, select, textarea') || e.target.closest('.chevron-toggle') || e.target.closest('.expand-cell')) return;
            window.location.href = href;
        });
    });
}

document.addEventListener('DOMContentLoaded', attachRowClickHandlersForPaymentReports);
</script>
{% endblock %}


