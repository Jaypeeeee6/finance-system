{% extends "base.html" %}

{% block title %}My Drafts{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-file-alt"></i> My Drafts</h1>
        {% if current_user.department == 'Branch' %}
        <p>Manage your saved item request drafts</p>
        {% else %}
        <p>Manage your saved payment and item request drafts</p>
        {% endif %}
    </div>

    <div class="dashboard-actions">
        {% if current_user.department != 'Branch' %}
        <div class="new-request-dropdown">
            <button type="button" class="btn btn-primary new-request-toggle">
                <i class="fas fa-plus-circle"></i> New Request
                <i class="fas fa-caret-down dropdown-caret"></i>
            </button>
            <div class="new-request-menu">
                <a href="{{ url_for('new_request') }}">
                    <i class="fas fa-credit-card"></i> Payment Request for Finance
                </a>
                <a href="{{ url_for('procurement_request_item') }}">
                    <i class="fas fa-boxes"></i> Item Request for Procurement
                </a>
            </div>
        </div>
        {% endif %}
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <div class="card">
        <div class="card-body">
            <!-- Tab Navigation -->
            <div class="draft-tabs">
                {% if current_user.department != 'Branch' %}
                <button class="tab-button active" data-tab="payment-requests">
                    <i class="fas fa-file-invoice-dollar"></i> Payment Requests
                </button>
                <button class="tab-button" data-tab="item-requests">
                    <i class="fas fa-shopping-cart"></i> Item Requests
                </button>
                {% else %}
                <button class="tab-button active" data-tab="item-requests">
                    <i class="fas fa-shopping-cart"></i> Item Requests
                </button>
                {% endif %}
            </div>

            <!-- Payment Requests Tab -->
            {% if current_user.department != 'Branch' %}
            <div id="payment-requests" class="tab-content active">
                {% if drafts %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>Request Type</th>
                                    <th>Person/Company Name</th>
                                    <th>Branch</th>
                                    <th>Amount (OMR)</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for draft in drafts %}
                                <tr>
                                    <td><strong>#{{ draft.request_id }}</strong></td>
                                    <td>{{ draft.request_type or 'Draft' }}</td>
                                    <td>{{ draft.person_company or 'Not specified' }}</td>
                                    <td>{{ (draft.branch_name or 'Not specified')|replace(',', ', ') }}</td>
                                    <td>
                                        {% if draft.amount %}
                                            {{ "%.3f"|format(draft.amount|float) }}
                                        {% else %}
                                            <span style="color: #999;">Not specified</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ draft.updated_at.strftime('%Y-%m-%d %H:%M') if draft.updated_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <a href="{{ url_for('edit_draft', draft_id=draft.request_id) }}" title="Edit Draft" style="color: #007bff; font-size: 1.2rem; cursor: pointer;">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('delete_draft', draft_id=draft.request_id) }}" style="display: inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this draft? This action cannot be undone.');">
                                                <button type="submit" title="Delete Draft" style="border: none; background: none; color: #dc3545; font-size: 1.2rem; cursor: pointer; padding: 0;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file-invoice-dollar" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">No payment request drafts found</h3>
                        <p style="color: #999;">You haven't saved any payment request drafts yet.</p>
                        <a href="{{ url_for('new_request') }}" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus-circle"></i> Create New Payment Request
                        </a>
                    </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Item Requests Tab -->
            <div id="item-requests" class="tab-content {% if current_user.department == 'Branch' %}active{% endif %}">
                {% if item_drafts %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Request ID</th>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Branch</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for draft in item_drafts %}
                                <tr>
                                    <td><strong>#{{ draft.id }}</strong></td>
                                    <td>{{ (draft.item_name or 'Not specified')|replace(',', ', ') }}</td>
                                    <td>{{ draft.category or 'Not specified' }}</td>
                                    <td>{{ (draft.branch_name or 'Not specified')|replace(',', ', ') }}</td>
                                    <td>
                                        <small>{{ draft.updated_at.strftime('%Y-%m-%d %H:%M') if draft.updated_at else 'N/A' }}</small>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <a href="{{ url_for('edit_item_draft', draft_id=draft.id) }}" title="Edit Draft" style="color: #007bff; font-size: 1.2rem; cursor: pointer;">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('delete_item_draft', draft_id=draft.id) }}" style="display: inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this draft? This action cannot be undone.');">
                                                <button type="submit" title="Delete Draft" style="border: none; background: none; color: #dc3545; font-size: 1.2rem; cursor: pointer; padding: 0;">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-shopping-cart" style="font-size: 4rem; color: #ccc; margin-bottom: 20px;"></i>
                        <h3 style="color: #666;">No item request drafts found</h3>
                        <p style="color: #999;">You haven't saved any item request drafts yet.</p>
                        <a href="{{ url_for('procurement_request_item') }}" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus-circle"></i> Create New Item Request
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
/* Tab Styles */
.draft-tabs {
    display: flex;
    border-bottom: 2px solid #dee2e6;
    margin-bottom: 20px;
    gap: 0;
}

.tab-button {
    flex: 1;
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    color: #666;
    transition: all 0.3s ease;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.tab-button:hover {
    color: #333;
    background-color: #f8f9fa;
}

.tab-button.active {
    color: #007bff;
    border-bottom-color: #007bff;
    background-color: transparent;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    padding: 12px;
    text-align: left;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.875rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get all tab buttons
    const tabButtons = document.querySelectorAll('.tab-button');
    
    // Function to switch to a specific tab
    function switchToTab(tabId) {
        // Remove active class from all buttons and contents
        tabButtons.forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Find and activate the button for this tab
        const targetButton = document.querySelector(`[data-tab="${tabId}"]`);
        if (targetButton) {
            targetButton.classList.add('active');
        }
        
        // Activate the tab content
        const tabContent = document.getElementById(tabId);
        if (tabContent) {
            tabContent.classList.add('active');
        }
    }
    
    // Check for hash on page load to open the correct tab
    const hash = window.location.hash.substring(1); // Remove the # character
    if (hash && document.getElementById(hash)) {
        switchToTab(hash);
        // Ensure page is scrolled to the activated tab content for anchor navigation
        setTimeout(function() {
            try {
                const el = document.getElementById(hash);
                if (el) {
                    // Scroll the element into view at the top of the viewport
                    el.scrollIntoView(true);
                    // Slight upward offset in case a fixed header overlaps
                    window.scrollBy(0, -10);
                }
            } catch (e) {
                // ignore
            }
        }, 60);
    }
    
    // Add click event to each tab button
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            switchToTab(tabId);
            // Update URL hash
            window.history.replaceState(null, null, `#${tabId}`);
        });
    });
});
</script>

{% endblock %}

