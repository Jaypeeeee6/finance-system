{% extends "base.html" %}

{% block title %}Edit Book{% endblock %}

{% block extra_css %}
<style>
.edit-book-note {
    margin-bottom: 1.5rem;
    padding: 0.5rem 0.75rem;
    background-color: #e7f1ff;
    border: 1px solid #b8daff;
    border-radius: 8px;
    color: #004085;
}
.edit-book-note strong { color: inherit; }
.form-preview-section { margin-top: 1.5rem; padding: 1rem; background-color: var(--light-bg, #f8f9fa); border-radius: 8px; }
.preview-text { margin: 0.5rem 0; }
.form-actions { margin-top: 2rem; }
.form-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    font-size: 14px;
}
.form-actions .btn.btn-save-book { background-color: #28a745; border-color: #28a745; color: #fff; }

.edit-book-page.card { overflow: visible; }
.edit-book-page .card-body { overflow: visible; }
.edit-book-page .form-row,
.edit-book-page .form-group { overflow: visible; }

.bank-name-dropdown { position: relative; width: 100%; }
.bank-name-dropdown .bank-dropdown-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    color: var(--dark-color, #333);
    background: #fff;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 5px;
    cursor: pointer;
    min-height: 38px;
    text-align: left;
}
.bank-name-dropdown .bank-dropdown-trigger:hover { border-color: #868e96; }
.bank-name-dropdown .bank-dropdown-trigger .bank-dropdown-label {
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;
}
.bank-name-dropdown .bank-dropdown-trigger .placeholder { color: #6c757d; }
.bank-name-dropdown .bank-dropdown-trigger i { margin-left: 8px; transition: transform 0.2s; color: #6c757d; }
.bank-name-dropdown.open .bank-dropdown-trigger i { transform: rotate(180deg); }
.bank-name-dropdown .bank-dropdown-panel {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    margin-top: 2px;
    max-height: min(280px, 50vh);
    overflow-y: auto;
    background: #fff;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    display: none;
}
.bank-name-dropdown.open .bank-dropdown-panel { display: block; }
.bank-name-dropdown .bank-dropdown-option {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.95rem;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.bank-name-dropdown .bank-dropdown-option:last-child { border-bottom: none; }
.bank-name-dropdown .bank-dropdown-option:hover { background: #f8f9fa; }
.bank-name-dropdown .bank-dropdown-option.selected { background: #e7f1ff; font-weight: 500; }

.book-holder-dropdown { position: relative; width: 100%; }
.book-holder-dropdown .custom-dropdown-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    color: var(--dark-color, #333);
    background: #fff;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 5px;
    cursor: pointer;
    min-height: 38px;
    text-align: left;
}
.book-holder-dropdown .custom-dropdown-trigger:hover { border-color: #868e96; }
.book-holder-dropdown .custom-dropdown-trigger .custom-dropdown-label {
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;
}
.book-holder-dropdown .custom-dropdown-trigger .placeholder { color: #6c757d; }
.book-holder-dropdown .custom-dropdown-trigger i { margin-left: 8px; transition: transform 0.2s; color: #6c757d; }
.book-holder-dropdown.open .custom-dropdown-trigger i { transform: rotate(180deg); }
.book-holder-dropdown .custom-dropdown-panel {
    position: absolute;
    left: 0;
    right: 0;
    top: 100%;
    margin-top: 2px;
    max-height: min(280px, 50vh);
    overflow-y: auto;
    background: #fff;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 5px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    display: none;
}
.book-holder-dropdown.open .custom-dropdown-panel { display: block; }
.book-holder-dropdown .custom-dropdown-option {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    font-size: 0.95rem;
    border-bottom: 1px solid #f0f0f0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.book-holder-dropdown .custom-dropdown-option:last-child { border-bottom: none; }
.book-holder-dropdown .custom-dropdown-option:hover { background: #f8f9fa; }
.book-holder-dropdown .custom-dropdown-option.selected { background: #e7f1ff; font-weight: 500; }

.edit-book-page .form-group input.edit-book-field {
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-size: 1rem;
    color: var(--dark-color, #333);
    background: #fff;
    border: 1px solid var(--border-color, #ced4da);
    border-radius: 5px;
    min-height: 38px;
    box-sizing: border-box;
}
.edit-book-page .form-group input.edit-book-field:hover { border-color: #868e96; }
.edit-book-page .form-group input.edit-book-field:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
}
.edit-book-page .required-star { color: #dc3545; }
.edit-book-page .edit-book-field.error { border-color: #dc3545 !important; }
.edit-book-page .serial-range-error { color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem; display: block; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h2 class="dashboard-title" style="margin:0; display:inline-flex; align-items:center; gap:8px; font-size:1.6rem; font-weight:700;"><i class="fas fa-edit"></i> Edit Book</h2>
        <p>Update book details. Serial range must include all existing serial numbers (you may only expand the range).</p>
    </div>

    <div class="dashboard-actions">
        <a href="{{ url_for('cheque_register') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Cheque Register
        </a>
    </div>

    <div class="edit-book-note" role="note">
        <strong>Note:</strong> Change any details and click Save. The serial number range must include all existing serials in this book; you can expand the range to add more serials (max 50 per book).
    </div>

    <div class="card edit-book-page">
        <div class="card-body">
            <form method="POST" action="{{ url_for('edit_book', book_no=book.book_no) }}" id="editBookForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="book_no">Book No. <span class="required-star">*</span></label>
                        <input type="number" name="book_no" id="book_no" class="edit-book-field" required min="1" value="{{ book.book_no }}" placeholder="e.g., 1">
                        <small>Enter the book number</small>
                    </div>

                    <div class="form-group">
                        <label for="book_holder_input">Book Holder <span class="required-star">*</span></label>
                        <div class="book-holder-dropdown" id="book_holder_dropdown">
                            <input type="hidden" name="book_holder_user_id" id="book_holder_input" value="{{ book.book_holder_user_id or '' }}" required>
                            <button type="button" class="custom-dropdown-trigger" id="book_holder_trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Select book holder">
                                <span class="custom-dropdown-label {% if not book.book_holder %}placeholder{% endif %}">{% if book.book_holder %}{{ book.book_holder.name }} ({{ book.book_holder.role }}){% else %}-- Select Book Holder --{% endif %}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="custom-dropdown-panel" id="book_holder_panel" role="listbox">
                                <div class="custom-dropdown-option" data-value="">-- Select Book Holder --</div>
                                {% for u in book_holders %}
                                <div class="custom-dropdown-option {% if book.book_holder_user_id == u.user_id %}selected{% endif %}" data-value="{{ u.user_id }}">{{ u.name }} ({{ u.role }})</div>
                                {% endfor %}
                            </div>
                        </div>
                        <small>CEO, GM, or Operation Manager</small>
                    </div>

                    <div class="form-group">
                        <label for="bank_name_input">Bank Name <span class="required-star">*</span></label>
                        <div class="bank-name-dropdown" id="bank_name_dropdown">
                            <input type="hidden" name="bank_name" id="bank_name_input" value="{{ book.bank_name or '' }}" required>
                            <button type="button" class="bank-dropdown-trigger" id="bank_name_trigger" aria-haspopup="listbox" aria-expanded="false" aria-label="Select bank">
                                <span class="bank-dropdown-label {% if not book.bank_name %}placeholder{% endif %}">{{ book.bank_name or '-- Select Bank --' }}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="bank-dropdown-panel" id="bank_name_panel" role="listbox">
                                <div class="bank-dropdown-option {% if not book.bank_name %}selected{% endif %}" data-value="">-- Select Bank --</div>
                                {% for bank in bank_names %}
                                <div class="bank-dropdown-option {% if book.bank_name == bank %}selected{% endif %}" data-value="{{ bank }}">{{ bank }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_serial_no">Starting Serial No. <span class="required-star">*</span></label>
                        <input type="number" name="start_serial_no" id="start_serial_no" class="edit-book-field" required min="1" value="{{ book.start_serial_no }}" placeholder="e.g., 100">
                        <small>First serial number in the range</small>
                    </div>

                    <div class="form-group">
                        <label for="last_serial_no">Last Serial No. <span class="required-star">*</span></label>
                        <input type="number" name="last_serial_no" id="last_serial_no" class="edit-book-field" required min="1" value="{{ book.last_serial_no }}" placeholder="e.g., 150">
                        <small>Last serial number (inclusive). Must include all existing serials. Maximum 50 cheques per book.</small>
                        <p id="serialRangeError" class="serial-range-error" style="display: none;" role="alert">Maximum 50 serial numbers allowed. This range would generate more than 50.</p>
                    </div>
                </div>

                <div class="form-group form-preview-section" id="previewSection" style="display: none;">
                    <label><strong>Preview:</strong></label>
                    <p id="previewText" class="preview-text"></p>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-save-book">
                        <i class="fas fa-save"></i> Save changes
                    </button>
                    <a href="{{ url_for('cheque_register') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bankDropdown = document.getElementById('bank_name_dropdown');
    const bankTrigger = document.getElementById('bank_name_trigger');
    const bankPanel = document.getElementById('bank_name_panel');
    const bankInput = document.getElementById('bank_name_input');
    const bankLabel = bankTrigger && bankTrigger.querySelector('.bank-dropdown-label');
    if (bankTrigger && bankPanel && bankInput) {
        bankTrigger.addEventListener('click', function(e) {
            e.preventDefault();
            const open = bankDropdown.classList.toggle('open');
            bankTrigger.setAttribute('aria-expanded', open);
        });
        bankPanel.querySelectorAll('.bank-dropdown-option').forEach(function(opt) {
            opt.addEventListener('click', function() {
                const value = this.getAttribute('data-value') || '';
                const text = (this.textContent || '').trim();
                bankInput.value = value;
                if (bankLabel) {
                    bankLabel.textContent = text || '-- Select Bank --';
                    bankLabel.classList.toggle('placeholder', !text);
                }
                bankPanel.querySelectorAll('.bank-dropdown-option').forEach(function(o) { o.classList.remove('selected'); });
                this.classList.add('selected');
                bankDropdown.classList.remove('open');
                bankTrigger.setAttribute('aria-expanded', 'false');
            });
        });
        document.addEventListener('click', function(e) {
            if (bankDropdown && !bankDropdown.contains(e.target)) {
                bankDropdown.classList.remove('open');
                bankTrigger.setAttribute('aria-expanded', 'false');
            }
        });
    }

    const holderDropdown = document.getElementById('book_holder_dropdown');
    const holderTrigger = document.getElementById('book_holder_trigger');
    const holderPanel = document.getElementById('book_holder_panel');
    const holderInput = document.getElementById('book_holder_input');
    const holderLabel = holderTrigger && holderTrigger.querySelector('.custom-dropdown-label');
    if (holderTrigger && holderPanel && holderInput) {
        holderTrigger.addEventListener('click', function(e) {
            e.preventDefault();
            const open = holderDropdown.classList.toggle('open');
            holderTrigger.setAttribute('aria-expanded', open);
        });
        holderPanel.querySelectorAll('.custom-dropdown-option').forEach(function(opt) {
            opt.addEventListener('click', function() {
                const value = this.getAttribute('data-value') || '';
                const text = (this.textContent || '').trim();
                holderInput.value = value;
                if (holderLabel) {
                    holderLabel.textContent = text || '-- Select Book Holder --';
                    holderLabel.classList.toggle('placeholder', !text);
                }
                holderPanel.querySelectorAll('.custom-dropdown-option').forEach(function(o) { o.classList.remove('selected'); });
                this.classList.add('selected');
                holderDropdown.classList.remove('open');
                holderTrigger.setAttribute('aria-expanded', 'false');
            });
        });
        document.addEventListener('click', function(e) {
            if (holderDropdown && !holderDropdown.contains(e.target)) {
                holderDropdown.classList.remove('open');
                holderTrigger.setAttribute('aria-expanded', 'false');
            }
        });
    }

    const startSerialInput = document.getElementById('start_serial_no');
    const lastSerialInput = document.getElementById('last_serial_no');
    const previewSection = document.getElementById('previewSection');
    const previewText = document.getElementById('previewText');
    const serialRangeError = document.getElementById('serialRangeError');
    const MAX_SERIALS = 50;

    function updatePreview() {
        const start = parseInt(startSerialInput.value) || 0;
        const last = parseInt(lastSerialInput.value) || 0;
        const count = start && last && start <= last ? last - start + 1 : 0;
        const overLimit = count > MAX_SERIALS;
        startSerialInput.classList.toggle('error', overLimit);
        lastSerialInput.classList.toggle('error', overLimit);
        if (serialRangeError) serialRangeError.style.display = overLimit ? 'block' : 'none';
        if (start && last && start <= last) {
            previewSection.style.display = 'block';
            if (overLimit) {
                previewText.textContent = 'This range would generate ' + count + ' serial number(s). Maximum is ' + MAX_SERIALS + '.';
                previewText.style.color = '#dc3545';
            } else {
                previewText.textContent = 'Serial range: ' + start + ' to ' + last + ' (inclusive) â€” ' + count + ' serial(s)';
                previewText.style.color = '';
            }
        } else if (start && last && start > last) {
            previewSection.style.display = 'block';
            previewText.textContent = 'Starting serial number must be less than or equal to last serial number';
            previewText.style.color = '#dc3545';
        } else {
            previewSection.style.display = 'none';
        }
    }

    startSerialInput.addEventListener('input', updatePreview);
    lastSerialInput.addEventListener('input', updatePreview);
    updatePreview();

    document.getElementById('editBookForm').addEventListener('submit', function(e) {
        const start = parseInt(startSerialInput.value);
        const last = parseInt(lastSerialInput.value);
        const count = start && last && start <= last ? last - start + 1 : 0;
        if (start > last) {
            e.preventDefault();
            alert('Starting serial number must be less than or equal to last serial number');
            return false;
        }
        if (count > MAX_SERIALS) {
            e.preventDefault();
            startSerialInput.classList.add('error');
            lastSerialInput.classList.add('error');
            if (serialRangeError) serialRangeError.style.display = 'block';
            lastSerialInput.focus();
            return false;
        }
    });
});
</script>
{% endblock %}
