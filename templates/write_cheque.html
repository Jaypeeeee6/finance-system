{% extends "base.html" %}

{% block title %}Write Cheque{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/write_cheque.css') }}">
{% endblock %}

{% block content %}
<div class="cheque-container">
    <div class="cheque-header">
        <h1><i class="fas fa-file-invoice"></i> Write Cheque</h1>
        <p>Fill in the fields and preview the cheque</p>
    </div>

    <div class="cheque-layout">
        <!-- Left Panel: Form Fields -->
        <div class="cheque-form-panel">
            <div class="form-section">
                <h3><i class="fas fa-edit"></i> Fill in the fields and print</h3>
                
                <form id="chequeForm">
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <label for="chequeDate">Cheque's date</label>
                            <button type="button" id="toggleDateBtn" class="btn btn-sm" style="padding: 5px 8px; min-width: auto; width: auto;">
                                <i class="fas fa-eye" id="toggleDateIcon"></i>
                            </button>
                        </div>
                        <input type="date" id="chequeDate" name="chequeDate" class="form-control" required>
                        <input type="checkbox" id="showDate" checked style="display: none;">
                    </div>

                    <div class="form-group">
                        <label for="payeeName">Payee Name</label>
                        <input type="text" id="payeeName" name="payeeName" class="form-control" placeholder="Enter payee name" required>
                    </div>

                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <div class="amount-input-group">
                            <input type="number" id="amount" name="amount" class="form-control" placeholder="0.000" step="0.001" required>
                            <select id="currency" name="currency" class="form-control">
                                <option value="OMR">OMR</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="crossing">Crossing</label>
                        <select id="crossing" name="crossing" class="form-control">
                            <option value="">Select an option</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="A/C Payee">A/C Payee</option>
                            <option value="Not Negotiable">Not Negotiable</option>
                            <option value="Cash Only">Cash Only</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="amountWordsLanguage">Amount in Words Language</label>
                        <select id="amountWordsLanguage" name="amountWordsLanguage" class="form-control">
                            <option value="english">English</option>
                            <option value="arabic">Arabic (العربية)</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-success" id="printBtn">
                            <i class="fas fa-print"></i> Print Cheque
                        </button>
                        <button type="button" class="btn btn-primary" id="saveChequeBtn">
                            <i class="fas fa-save"></i> Save Cheque
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Panel: Cheque Preview -->
        <div class="cheque-preview-panel">
            <div class="preview-section">
                <div class="bank-selection">
                    <div class="form-group">
                        <label for="bankSelect">Bank</label>
                        <select id="bankSelect" name="bankSelect" class="form-control">
                            <option value="dhofar_islamic">Dhofar Islamic Bank</option>
                            <option value="oman_arab">Oman Arab Bank</option>
                            <option value="sohar">Sohar Bank</option>
                        </select>
                    </div>
                </div>

                <div class="cheque-preview">
                    <div class="cheque-image-container">
                        <img id="chequeTemplate" src="{{ url_for('static', filename='cheque_templates/DHOFAR-ISLAMIC-BANK.png') }}" alt="Cheque Template" class="cheque-template">
                        
                        <!-- Overlay fields that will be positioned over the cheque -->
                        <div class="cheque-overlay">
                            <div class="field-overlay" id="dateOverlay" style="position: absolute; top: 53px; left: 363px; font-size: 17px;"></div>
                            <div class="field-overlay" id="payeeOverlay" style="position: absolute; top: 127px; left: 250px; font-size: 16px; max-width: 400px; text-align: center;"></div>
                            <div class="field-overlay" id="amountOverlay" style="position: absolute; top: 183px; left: 613px; font-size: 17px; text-align: center;"></div>
                            <div class="field-overlay" id="amountWordsOverlay" style="position: absolute; top: 160px; left: 98px; font-size: 16px; max-width: 300px; line-height: 2.0; text-align: center;"></div>
                            <div class="field-overlay" id="crossingOverlay" style="position: absolute; top: 20px; left: 60px; font-size: 18px; font-weight: 700; text-transform: uppercase; transform: rotate(-25deg); color: rgba(200, 0, 0, 0.6);"></div>
                            <div class="field-overlay" id="purposeOverlay" style="position: absolute; top: 200px; left: 50px; font-size: 12px; max-width: 300px; line-height: 1.2;"></div>
                        </div>
                    </div>
                </div>

                <div class="preview-actions">
                    <button type="button" class="btn btn-primary btn-lg" id="printChequeBtn">
                        <i class="fas fa-print"></i> Print the cheque
                    </button>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i>
                        Any field can be set and moved by double clicking on it
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden print container - only visible when printing (outside cheque-container to avoid being hidden) -->
<div class="cheque-print-container" style="display: none;">
    <div class="cheque-print-overlay">
        <div class="print-field-overlay print-date-overlay" id="printDateOverlay"></div>
        <div class="print-field-overlay print-payee-overlay" id="printPayeeOverlay"></div>
        <div class="print-field-overlay print-amount-overlay" id="printAmountOverlay"></div>
            <div class="print-field-overlay print-amount-words-overlay" id="printAmountWordsOverlay"></div>
            <div class="print-field-overlay print-crossing-overlay" id="printCrossingOverlay"></div>
    </div>
</div>

<!-- Cheque Preview Modal -->
<div id="chequePreviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-eye"></i> Cheque Preview</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="cheque-modal-container">
                <div class="cheque-modal-image-container">
                    <img id="modalChequeTemplate" src="{{ url_for('static', filename='cheque_templates/DHOFAR-ISLAMIC-BANK.png') }}" alt="Cheque Template" class="modal-cheque-template">
                    
                    <!-- Modal overlay fields -->
                    <div class="modal-cheque-overlay">
                        <div class="modal-field-overlay" id="modalDateOverlay"></div>
                        <div class="modal-field-overlay" id="modalPayeeOverlay"></div>
                        <div class="modal-field-overlay" id="modalAmountOverlay"></div>
                        <div class="modal-field-overlay" id="modalAmountWordsOverlay"></div>
                        <div class="modal-field-overlay" id="modalCrossingOverlay"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="printFromModal">
                <i class="fas fa-print"></i> Print Cheque
            </button>
            <button type="button" class="btn btn-secondary" id="closeModal">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Ensure on-screen amount overlay is never tilted
(function() {
    const el = document.getElementById('amountOverlay');
    if (el) {
        el.style.transform = 'none';
        el.style.transformOrigin = 'left center';
        el.style.fontStyle = 'normal';
    }
})();
// Cheque field mapping for different banks
const bankFieldPositions = {
    'dhofar_islamic': {
        date: { top: '53px', left: '363px' }, // Moved slightly more to the right
        payee: { top: '127px', left: '185px' }, // Moved 15px to the left (200->185)
        amount: { top: '183px', left: '613px' }, // Moved 3px lower and 3px right
        amountWords: { top: '160px', left: '95px' }, // Moved 3px left (98->95)
        crossing: { top: '20px', left: '60px' },
        purpose: { top: '200px', left: '50px' }
    },
    'oman_arab': {
        date: { top: '13px', left: '610px' },  // Moved 10px to the right (580->590)
        payee: { top: '125px', left: '90px' },  // Moved 5px lower (120->125) and 30px to the right (150->180)
        amount: { top: '135px', left: '645px' },  // Moved 10px to the right (617->627)
        amountWords: { top: '165px', left: '82px' },  // Moved 7px to the right (95->102)
        crossing: { top: '15px', left: '40px' },
        purpose: { top: '210px', left: '60px' }
    },
    'sohar': {
        date: { top: '52px', left: '560px' },
        payee: { top: '116px', left: '115px' },
        amount: { top: '172px', left: '605px' },
        amountWords: { top: '153px', left: '80px' },
        crossing: { top: '25px', left: '70px' },
        purpose: { top: '205px', left: '55px' }
    }
};

// Function to update field positions based on selected bank
function updateFieldPositions(bank) {
    const positions = bankFieldPositions[bank];
    if (!positions) return;
    
    Object.keys(positions).forEach(field => {
        const overlay = document.getElementById(field + 'Overlay');
        if (overlay) {
            overlay.style.top = positions[field].top;
            overlay.style.left = positions[field].left;
        }
    });
    
    // Set line-height for amount in words based on bank
    const amountWordsOverlay = document.getElementById('amountWordsOverlay');
    if (amountWordsOverlay) {
        if (bank === 'oman_arab') {
            amountWordsOverlay.style.lineHeight = '2.3'; // Bigger line height for Oman Arab Bank
        } else {
            amountWordsOverlay.style.lineHeight = '2.0'; // Default line height for other banks
        }
        // Bank-specific width for on-screen overlay (cheque overlay only)
        amountWordsOverlay.style.display = 'block';
        amountWordsOverlay.style.textAlign = 'center';
        if (bank === 'dhofar_islamic') {
            amountWordsOverlay.style.maxWidth = '400px';
            amountWordsOverlay.style.width = '400px';
        } else if (bank === 'oman_arab') {
            amountWordsOverlay.style.maxWidth = '420px';
            amountWordsOverlay.style.width = '420px';
        } else if (bank === 'sohar') {
            amountWordsOverlay.style.maxWidth = '400px';
            amountWordsOverlay.style.width = '400px';
        } else {
            amountWordsOverlay.style.maxWidth = '300px';
            amountWordsOverlay.style.width = '300px';
        }
    }
    
    // Set font size for payee name based on bank (Dhofar only - bigger)
    const payeeOverlay = document.getElementById('payeeOverlay');
    if (payeeOverlay) {
        if (bank === 'dhofar_islamic') {
            payeeOverlay.style.fontSize = '18px'; // Bigger font size for Dhofar
        } else {
            payeeOverlay.style.fontSize = '16px'; // Default font size for other banks
        }
    }
    
    // Set text alignment for amount field (centered for all banks)
    const amountOverlay = document.getElementById('amountOverlay');
    if (amountOverlay) {
        amountOverlay.style.textAlign = 'center';
        amountOverlay.style.display = 'block';
        // Set width for proper centering
        if (bank === 'dhofar_islamic') {
            amountOverlay.style.maxWidth = '120px';
            amountOverlay.style.width = '120px';
        } else if (bank === 'oman_arab') {
            amountOverlay.style.maxWidth = '120px';
            amountOverlay.style.width = '120px';
        } else {
            amountOverlay.style.maxWidth = '120px';
            amountOverlay.style.width = '120px';
        }
    }
    
    // Print positions will be updated dynamically based on actual screen positions
    // when print is called or bank is changed
}

// Function to update cheque template image
function updateChequeTemplate(bank) {
    const templateImg = document.getElementById('chequeTemplate');
    const bankImageMap = {
        'dhofar_islamic': 'DHOFAR-ISLAMIC-BANK.png',
        'oman_arab': 'OMAN-ARAB-BANK.png',
        'sohar': 'SOHAR-BANK.png'
    };
    templateImg.src = `{{ url_for('static', filename='cheque_templates/') }}${bankImageMap[bank]}`;
}

// Function to format date for display
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
}

// Function to format amount
function formatAmount(amount, currency) {
    if (!amount) return '';
    const numeric = Number(amount);
    const formatted = isNaN(numeric)
        ? ''
        : numeric.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    // Do not show currency in cheque overlay
    return formatted;
}

// Convert integers to Arabic words (supports up to trillions)
function numberToWordsArabic(n) {
    const ones = ['صفر', 'واحد', 'اثنان', 'ثلاثة', 'أربعة', 'خمسة', 'ستة', 'سبعة', 'ثمانية', 'تسعة', 
                  'عشرة', 'أحد عشر', 'اثنى عشر', 'ثلاثة عشر', 'أربعة عشر', 'خمسة عشر', 'ستة عشر', 
                  'سبعة عشر', 'ثمانية عشر', 'تسعة عشر'];
    const tens = ['', '', 'عشرون', 'ثلاثون', 'أربعون', 'خمسون', 'ستون', 'سبعون', 'ثمانون', 'تسعون'];
    
    if (n < 20) return ones[n];
    if (n < 100) {
        const t = Math.floor(n / 10);
        const r = n % 10;
        if (r === 0) return tens[t];
        if (r === 1) return 'واحد وعشرون';
        if (r === 2) return 'اثنان وعشرون';
        return `${ones[r]} و${tens[t]}`;
    }
    if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        if (h === 1) {
            return r ? `مائة و${numberToWordsArabic(r)}` : 'مائة';
        } else if (h === 2) {
            return r ? `مائتان و${numberToWordsArabic(r)}` : 'مائتان';
        } else {
            return r ? `${ones[h]}مائة و${numberToWordsArabic(r)}` : `${ones[h]}مائة`;
        }
    }
    const units = [
        { v: 1_000_000_000_000, w: 'تريليون', wAccusative: 'تريليونًا', wPlural: 'تريليونات' },
        { v: 1_000_000_000, w: 'مليار', wAccusative: 'مليارًا', wPlural: 'مليارات' },
        { v: 1_000_000, w: 'مليون', wAccusative: 'مليونًا', wPlural: 'ملايين' },
        { v: 1_000, w: 'ألف', wAccusative: 'ألفًا', wPlural: 'آلاف' }
    ];
    for (const u of units) {
        if (n >= u.v) {
            const q = Math.floor(n / u.v);
            const r = n % u.v;
            if (r === 0) {
                // When remainder is 0, if q is 1, return just the unit word (e.g., "ألف" not "واحد ألف")
                return q === 1 ? u.w : `${numberToWordsArabic(q)} ${u.wPlural}`;
            } else {
                // When there's a remainder, if q is 1, use accusative form with tanween (e.g., "ألفًا")
                if (q === 1) {
                    return `${u.wAccusative} و${numberToWordsArabic(r)}`;
                } else {
                    const unitWord = (q === 2) ? u.wAccusative : (q < 11) ? u.wPlural : u.wAccusative;
                    return `${numberToWordsArabic(q)} ${unitWord} و${numberToWordsArabic(r)}`;
                }
            }
        }
    }
    return '';
}

// Convert integers to English words (supports up to trillions)
function numberToWords(n) {
    const ones = ['zero','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
    const tens = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
    if (n < 20) return ones[n];
    if (n < 100) {
        const t = Math.floor(n / 10);
        const r = n % 10;
        return r ? `${tens[t]}-${ones[r]}` : tens[t];
    }
    if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        return r ? `${ones[h]} hundred ${numberToWords(r)}` : `${ones[h]} hundred`;
    }
    const units = [
        { v: 1_000_000_000_000, w: 'trillion' },
        { v: 1_000_000_000, w: 'billion' },
        { v: 1_000_000, w: 'million' },
        { v: 1_000, w: 'thousand' }
    ];
    for (const u of units) {
        if (n >= u.v) {
            const q = Math.floor(n / u.v);
            const r = n % u.v;
            // Add comma after unit word if there's a remainder
            return r ? `${numberToWords(q)} ${u.w}, ${numberToWords(r)}` : `${numberToWords(q)} ${u.w}`;
        }
    }
    return '';
}

// Get currency name in words based on currency code
function getCurrencyName(currency, language = 'english') {
    if (language === 'arabic') {
        // For Arabic, keep OMR as is for now (can be extended later)
        return 'ريالاً عمانياً';
    } else {
        // English currency names
        switch(currency) {
            case 'USD':
                return 'US Dollar';
            case 'EUR':
                return 'Euro';
            case 'OMR':
            default:
                return 'Rial Omani';
        }
    }
}

// Convert numeric amount to words (simple generic format)
function amountToWords(amount, language = 'english', currency = 'OMR') {
    if (!amount && amount !== 0) return '';
    const numeric = Number(amount);
    if (!isFinite(numeric)) return '';
    const fixed = numeric.toFixed(3); // keep three decimals to match input precision
    const [intStr, decStr] = fixed.split('.');
    const intNum = parseInt(intStr, 10);
    
    const currencyName = getCurrencyName(currency, language);
    
    if (language === 'arabic') {
        let words = numberToWordsArabic(Math.abs(intNum));
        if (intNum === 0) words = 'صفر';
        if (numeric < 0) words = `ناقص ${words}`;
        
        // Format: "فقط [amount in words] [currency] و #[decimal digits]# بيسة لاغير"
        if (decStr && Number(decStr) > 0) {
            return `فقط ${words} ${currencyName} و #${decStr}# بيسة لاغير`;
        } else {
            return `فقط ${words} ${currencyName} لاغير`;
        }
    } else {
        // English format
        let words = numberToWords(Math.abs(intNum));
        if (intNum === 0) words = 'zero';
        if (numeric < 0) words = `minus ${words}`;
        // Capitalize first letter of each word (including words with dashes)
        const capitalizedWords = words.split(' ').map(word => {
            // Skip commas, just capitalize the word parts
            if (word === ',') return ',';
            // Split by dash and capitalize each part, then join back with dash
            return word.split('-').map(part => 
                part.charAt(0).toUpperCase() + part.slice(1)
            ).join('-');
        }).join(' ');
        
        // Format: if there's a decimal, use "[currency] & #[decimal digits]# Baisa Only", otherwise "[currency] Only"
        // Note: For non-OMR currencies, we might want to change "Baisa" to "Cents" or similar
        if (decStr && Number(decStr) > 0) {
            if (currency === 'OMR') {
                return capitalizedWords + ' ' + currencyName + ' & #' + decStr + '# Baisa Only';
            } else {
                // For other currencies, use "Cents" instead of "Baisa"
                return capitalizedWords + ' ' + currencyName + ' & #' + decStr + '# Cents Only';
            }
        } else {
            return capitalizedWords + ' ' + currencyName + ' Only';
        }
    }
}

// Conversion constants
// Cheque size: 7.5" × 3.5" = 190.5mm × 88.9mm
const CHEQUE_WIDTH_MM = 190.5;
const CHEQUE_HEIGHT_MM = 88.9;

// Offset to move all print text to the right (in mm)
// This only affects print preview, not the on-screen preview
const PRINT_RIGHT_OFFSET_MM = 5; // Adjust this value to move text more/less to the right

// Offset to move DATE field to the LEFT for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the date field in print preview for Dhofar Islamic Bank
// IMPORTANT: This ONLY affects horizontal (left) position, NEVER vertical (top) position
const DHOFAR_DATE_LEFT_OFFSET_MM = -188; // Adjusted to move date much more to the left (was -88, now -128 for additional 40mm left)

// Offset to move DATE field LOWER (down) for Dhofar Islamic Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the date field in print preview for Dhofar Islamic Bank
const DHOFAR_DATE_TOP_OFFSET_MM = 9.3; // Moved slightly higher (was 9.8mm)

// Offset to move PAYEE NAME field to the LEFT for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the payee field in print preview for Dhofar Islamic Bank
const DHOFAR_PAYEE_LEFT_OFFSET_MM = -205; // Adjust this value to move payee more/less to the left

// Offset to move PAYEE NAME field LOWER (down) for Dhofar Islamic Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the payee field in print preview for Dhofar Islamic Bank
const DHOFAR_PAYEE_TOP_OFFSET_MM = 1.3; // Move payee 5px (≈1.3mm) lower (down)

// Offset to move AMOUNT IN WORDS field to the LEFT for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amountWords field in print preview for Dhofar Islamic Bank
// IMPORTANT: This ONLY affects horizontal (left) position, NEVER vertical (top) position
// ADDED 25mm SAFETY MARGIN to prevent printer from cutting off text on the left edge
const DHOFAR_AMOUNT_WORDS_LEFT_OFFSET_MM = -61.2; // Shifted ~3px right (≈0.8mm): -62 -> -61.2

// Offset to move AMOUNT IN WORDS field HIGHER (up) for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amountWords field in print preview for Dhofar Islamic Bank
const DHOFAR_AMOUNT_WORDS_TOP_OFFSET_MM = -0.8; // Adjusted to move amount in words 5px (≈1.3mm) lower (was -2.1mm, now -0.8mm)

// Offset to move AMOUNT field to the LEFT for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amount field in print preview for Dhofar Islamic Bank
const DHOFAR_AMOUNT_LEFT_OFFSET_MM = -142.8; // Moved additional ~3px left (≈0.8mm): -142 -> -142.8

// Offset to move AMOUNT field HIGHER (up) for Dhofar Islamic Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amount field in print preview for Dhofar Islamic Bank
const DHOFAR_AMOUNT_TOP_OFFSET_MM = -3.3; // Moved slightly higher (was -2.8mm)

// ========== OMAN ARAB BANK OFFSETS (Same values as Dhofar for testing) ==========

// Offset to move DATE field to the LEFT for Oman Arab Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the date field in print preview for Oman Arab Bank
// IMPORTANT: This ONLY affects horizontal (left) position, NEVER vertical (top) position
const OMAN_ARAB_DATE_LEFT_OFFSET_MM = -149.6; // +20px right (≈+5.3mm): -154.9 + 5.3 = -149.6

// Offset to move DATE field LOWER (down) for Oman Arab Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the date field in print preview for Oman Arab Bank
const OMAN_ARAB_DATE_TOP_OFFSET_MM = 1.9; // Additional 10px up (≈-2.6mm): 4.5 - 2.6 = 1.9

// Offset to move PAYEE NAME field to the LEFT for Oman Arab Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the payee field in print preview for Oman Arab Bank
const OMAN_ARAB_PAYEE_LEFT_OFFSET_MM = -222.1; // Moved 5px more to the left (≈-1.3mm): -220.8 - 1.3 = -222.1

// Offset to move PAYEE NAME field LOWER (down) for Oman Arab Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the payee field in print preview for Oman Arab Bank
const OMAN_ARAB_PAYEE_TOP_OFFSET_MM = 0.8; // Slightly lower (~+0.3mm more)

// Offset to move AMOUNT IN WORDS field to the LEFT for Oman Arab Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amountWords field in print preview for Oman Arab Bank
// IMPORTANT: This ONLY affects horizontal (left) position, NEVER vertical (top) position
// ADDED 25mm SAFETY MARGIN to prevent printer from cutting off text on the left edge
const OMAN_ARAB_AMOUNT_WORDS_LEFT_OFFSET_MM = -57.2; // Move a little more right (~+3px ≈ +0.8mm)

// Offset to move AMOUNT IN WORDS field HIGHER (up) for Oman Arab Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amountWords field in print preview for Oman Arab Bank
const OMAN_ARAB_AMOUNT_WORDS_TOP_OFFSET_MM = -0.2; // 5px up (≈-1.3mm): 1.1 - 1.3 = -0.2

// Offset to move AMOUNT field to the LEFT for Oman Arab Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amount field in print preview for Oman Arab Bank
const OMAN_ARAB_AMOUNT_LEFT_OFFSET_MM = -138.6; // +3px right (≈+0.8mm): -139.4 + 0.8 = -138.6

// Offset to move AMOUNT field HIGHER (up) for Oman Arab Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amount field in print preview for Oman Arab Bank
const OMAN_ARAB_AMOUNT_TOP_OFFSET_MM = -11.3; // 8px down (≈+2.1mm): -13.4 + 2.1 = -11.3

// Offset to move DATE field to the LEFT for Sohar Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the date field in print preview for Sohar Bank
const SOHAR_DATE_LEFT_OFFSET_MM = -157.8; // Moved 30px left (≈-7.8mm): -149.6 - 7.8 = -157.8

// Offset to move DATE field LOWER (down) for Sohar Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the date field in print preview for Sohar Bank
const SOHAR_DATE_TOP_OFFSET_MM = 9.4; // Moved 28px lower (≈+7.5mm): 1.9 + 7.5 = 9.4

// Offset to move PAYEE NAME field to the LEFT for Sohar Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the payee field in print preview for Sohar Bank
const SOHAR_PAYEE_LEFT_OFFSET_MM = -222.1; // Same as Oman Arab Bank

// Offset to move PAYEE NAME field LOWER (down) for Sohar Bank print preview only (in mm)
// Positive value moves down, negative moves up
// This ONLY affects the payee field in print preview for Sohar Bank
const SOHAR_PAYEE_TOP_OFFSET_MM = 0.8; // Same as Oman Arab Bank

// Offset to move AMOUNT IN WORDS field to the LEFT for Sohar Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amountWords field in print preview for Sohar Bank
// IMPORTANT: This ONLY affects horizontal (left) position, NEVER vertical (top) position
// ADDED 25mm SAFETY MARGIN to prevent printer from cutting off text on the left edge
const SOHAR_AMOUNT_WORDS_LEFT_OFFSET_MM = -62.5; // Moved 20px left (≈-5.3mm): -57.2 - 5.3 = -62.5

// Offset to move AMOUNT IN WORDS field HIGHER (up) for Sohar Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amountWords field in print preview for Sohar Bank
const SOHAR_AMOUNT_WORDS_TOP_OFFSET_MM = -1.4; // Moved 5px higher (≈-1.2mm): -0.2 - 1.2 = -1.4

// Offset to move AMOUNT field to the LEFT for Sohar Bank print preview only (in mm)
// Negative value moves left, positive moves right
// This ONLY affects the amount field in print preview for Sohar Bank
const SOHAR_AMOUNT_LEFT_OFFSET_MM = -151.3; // Moved 48px left (≈-12.7mm): -138.6 - 12.7 = -151.3

// Offset to move AMOUNT field HIGHER (up) for Sohar Bank print preview only (in mm)
// Negative value moves up, positive moves down
// This ONLY affects the amount field in print preview for Sohar Bank
const SOHAR_AMOUNT_TOP_OFFSET_MM = -4.2; // Moved 3px higher (≈-0.8mm): -3.4 - 0.8 = -4.2

// Update print field positions based on ACTUAL screen positions
// This ensures print matches exactly what's shown on screen
function updatePrintPositions() {
    const templateImg = document.getElementById('chequeTemplate');
    if (!templateImg) return;
    
    // Get selected bank - needed to apply Dhofar-specific date offset
    const bankSelect = document.getElementById('bankSelect');
    const selectedBank = bankSelect ? bankSelect.value : 'dhofar_islamic';
    
    // Get actual displayed image dimensions
    const displayedWidth = templateImg.offsetWidth;
    const displayedHeight = templateImg.offsetHeight;
    
    // Get natural image dimensions
    const naturalWidth = templateImg.naturalWidth || 893;
    const naturalHeight = templateImg.naturalHeight || 418;
    
    // Calculate scale factors (how much the image is scaled on screen)
    const scaleX = displayedWidth / naturalWidth;
    const scaleY = displayedHeight / naturalHeight;
    
    // Get screen overlay positions (actual positions on displayed image)
    const screenOverlays = {
        date: document.getElementById('dateOverlay'),
        payee: document.getElementById('payeeOverlay'),
        amount: document.getElementById('amountOverlay'),
        amountWords: document.getElementById('amountWordsOverlay'),
        crossing: document.getElementById('crossingOverlay')
    };
    
    // Get print overlays
    const printOverlays = {
        date: document.getElementById('printDateOverlay'),
        payee: document.getElementById('printPayeeOverlay'),
        amount: document.getElementById('printAmountOverlay'),
        amountWords: document.getElementById('printAmountWordsOverlay'),
        crossing: document.getElementById('printCrossingOverlay')
    };
    
    // Convert each screen position to print position
    Object.keys(screenOverlays).forEach(field => {
        const screenOverlay = screenOverlays[field];
        const printOverlay = printOverlays[field];
        
        if (screenOverlay && printOverlay) {
            // Get actual screen position relative to displayed image
            const screenRect = screenOverlay.getBoundingClientRect();
            const imageRect = templateImg.getBoundingClientRect();
            
            // Calculate position relative to image (0,0 is top-left of image)
            const relativeLeft = screenRect.left - imageRect.left;
            const relativeTop = screenRect.top - imageRect.top;
            
            // Convert to natural image coordinates (undo the scale)
            const naturalLeft = relativeLeft / scaleX;
            const naturalTop = relativeTop / scaleY;
            
            // Convert natural coordinates to mm for print
            // Ratio: natural image size to cheque size
            const printLeft = (naturalLeft / naturalWidth) * CHEQUE_WIDTH_MM;
            const printTop = (naturalTop / naturalHeight) * CHEQUE_HEIGHT_MM;
            
            // Apply offsets based on field and bank
            let adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM;
            let finalPrintTop = printTop; // Start with calculated top position
            
            // SPECIAL CASE: Move date field to the LEFT and LOWER for Dhofar Islamic Bank print preview only
            if (field === 'date' && selectedBank === 'dhofar_islamic') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + DHOFAR_DATE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + DHOFAR_DATE_TOP_OFFSET_MM; // Move date lower (down)
            }
            
            // SPECIAL CASE: Move date field to the LEFT and LOWER for Oman Arab Bank print preview only
            if (field === 'date' && selectedBank === 'oman_arab') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + OMAN_ARAB_DATE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + OMAN_ARAB_DATE_TOP_OFFSET_MM; // Move date lower (down)
            }
            
            // SPECIAL CASE: Move date field to the LEFT and LOWER for Sohar Bank print preview only
            if (field === 'date' && selectedBank === 'sohar') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + SOHAR_DATE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + SOHAR_DATE_TOP_OFFSET_MM; // Move date lower (down)
            }
            
            // SPECIAL CASE: Move payee field to the LEFT and LOWER for Dhofar Islamic Bank print preview only
            if (field === 'payee' && selectedBank === 'dhofar_islamic') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + DHOFAR_PAYEE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + DHOFAR_PAYEE_TOP_OFFSET_MM; // Move payee lower (down)
            }
            
            // SPECIAL CASE: Move payee field to the LEFT and LOWER for Oman Arab Bank print preview only
            if (field === 'payee' && selectedBank === 'oman_arab') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + OMAN_ARAB_PAYEE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + OMAN_ARAB_PAYEE_TOP_OFFSET_MM; // Move payee lower (down)
            }
            
            // SPECIAL CASE: Move payee field to the LEFT and LOWER for Sohar Bank print preview only
            if (field === 'payee' && selectedBank === 'sohar') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + SOHAR_PAYEE_LEFT_OFFSET_MM;
                finalPrintTop = printTop + SOHAR_PAYEE_TOP_OFFSET_MM; // Move payee lower (down)
            }
            
            // SPECIAL CASE: Move amount in words field to the LEFT and HIGHER for Dhofar Islamic Bank print preview only
            if (field === 'amountWords' && selectedBank === 'dhofar_islamic') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + DHOFAR_AMOUNT_WORDS_LEFT_OFFSET_MM;
                finalPrintTop = printTop + DHOFAR_AMOUNT_WORDS_TOP_OFFSET_MM; // Move amount in words higher (up)
            }
            
            // SPECIAL CASE: Move amount in words field to the LEFT and HIGHER for Oman Arab Bank print preview only
            if (field === 'amountWords' && selectedBank === 'oman_arab') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + OMAN_ARAB_AMOUNT_WORDS_LEFT_OFFSET_MM;
                finalPrintTop = printTop + OMAN_ARAB_AMOUNT_WORDS_TOP_OFFSET_MM; // Move amount in words higher (up)
            }
            
            // SPECIAL CASE: Move amount in words field to the LEFT and HIGHER for Sohar Bank print preview only
            if (field === 'amountWords' && selectedBank === 'sohar') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + SOHAR_AMOUNT_WORDS_LEFT_OFFSET_MM;
                finalPrintTop = printTop + SOHAR_AMOUNT_WORDS_TOP_OFFSET_MM; // Move amount in words higher (up)
            }
            
            // SPECIAL CASE: Move amount field to the LEFT and HIGHER for Dhofar Islamic Bank print preview only
            if (field === 'amount' && selectedBank === 'dhofar_islamic') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + DHOFAR_AMOUNT_LEFT_OFFSET_MM;
                finalPrintTop = printTop + DHOFAR_AMOUNT_TOP_OFFSET_MM; // Move amount higher (up)
                // CRITICAL: Ensure no rotation or tilt - explicitly set rotation to 0
                printOverlay.style.transform = 'rotate(0deg) scale(1)';
                printOverlay.style.webkitTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.mozTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.msTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.oTransform = 'rotate(0deg) scale(1)';
            }
            
            // SPECIAL CASE: Move amount field to the LEFT and HIGHER for Oman Arab Bank print preview only
            if (field === 'amount' && selectedBank === 'oman_arab') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + OMAN_ARAB_AMOUNT_LEFT_OFFSET_MM;
                finalPrintTop = printTop + OMAN_ARAB_AMOUNT_TOP_OFFSET_MM; // Move amount higher (up)
                // CRITICAL: Ensure no rotation or tilt - explicitly set rotation to 0
                printOverlay.style.transform = 'rotate(0deg) scale(1)';
                printOverlay.style.webkitTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.mozTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.msTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.oTransform = 'rotate(0deg) scale(1)';
            }
            
            // SPECIAL CASE: Move amount field to the LEFT and HIGHER for Sohar Bank print preview only
            if (field === 'amount' && selectedBank === 'sohar') {
                adjustedPrintLeft = printLeft + PRINT_RIGHT_OFFSET_MM + SOHAR_AMOUNT_LEFT_OFFSET_MM;
                finalPrintTop = printTop + SOHAR_AMOUNT_TOP_OFFSET_MM; // Move amount higher (up)
                // CRITICAL: Ensure no rotation or tilt - explicitly set rotation to 0
                printOverlay.style.transform = 'rotate(0deg) scale(1)';
                printOverlay.style.webkitTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.mozTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.msTransform = 'rotate(0deg) scale(1)';
                printOverlay.style.oTransform = 'rotate(0deg) scale(1)';
            }
            
            // Bank-specific font sizes (Oman Arab only - slightly smaller)
            if (selectedBank === 'oman_arab') {
                if (field === 'date') {
                    printOverlay.style.fontSize = '3.4mm';
                }
                if (field === 'payee') {
                    printOverlay.style.fontSize = '4.0mm';
                }
                if (field === 'amount') {
                    printOverlay.style.fontSize = '4.0mm';
                    printOverlay.style.textAlign = 'center';
                }
                if (field === 'amountWords') {
                    // Reduce width slightly for Oman Arab amount in words
                    printOverlay.style.maxWidth = '39.0mm'; // ~230px
                    printOverlay.style.width = '39.0mm';
                    // Increase line-height more
                    printOverlay.style.lineHeight = '2.5';
                    printOverlay.style.textAlign = 'center';
                }
            }
            
            // Bank-specific font sizes (Sohar Bank - same as Oman Arab Bank)
            if (selectedBank === 'sohar') {
                if (field === 'date') {
                    printOverlay.style.fontSize = '3.4mm';
                }
                if (field === 'payee') {
                    printOverlay.style.fontSize = '4.0mm';
                }
                if (field === 'amount') {
                    printOverlay.style.fontSize = '4.0mm';
                    printOverlay.style.textAlign = 'center';
                }
                if (field === 'amountWords') {
                    // Reduce width slightly for Sohar Bank amount in words
                    printOverlay.style.maxWidth = '39.0mm'; // ~230px
                    printOverlay.style.width = '39.0mm';
                    // Line-height slightly smaller
                    printOverlay.style.lineHeight = '2.3';
                    printOverlay.style.textAlign = 'center';
                }
            }
            
            // Set print position
            // Left: may be adjusted for date/payee/amountWords/amount fields in Dhofar Islamic Bank
            // Top: ALWAYS the original calculated value, NEVER modified
            printOverlay.style.left = adjustedPrintLeft.toFixed(2) + 'mm';
            printOverlay.style.top = finalPrintTop.toFixed(2) + 'mm';
        }
    });
}

// Real-time field updates
function updateChequePreview() {
    // Update date
    const dateInput = document.getElementById('chequeDate');
    const showDateCheckbox = document.getElementById('showDate');
    const dateOverlay = document.getElementById('dateOverlay');
    const printDateOverlay = document.getElementById('printDateOverlay');
    const modalDateOverlay = document.getElementById('modalDateOverlay');
    const isDateVisible = showDateCheckbox ? showDateCheckbox.checked : true;
    
    if (dateInput && dateOverlay) {
        if (isDateVisible) {
            const dateText = formatDate(dateInput.value);
            dateOverlay.textContent = dateText;
            dateOverlay.style.display = 'block';
            if (printDateOverlay) {
                printDateOverlay.textContent = dateText;
                printDateOverlay.style.display = 'block';
            }
            if (modalDateOverlay) {
                modalDateOverlay.textContent = dateText;
                modalDateOverlay.style.display = 'block';
            }
        } else {
            dateOverlay.textContent = '';
            dateOverlay.style.display = 'none';
            if (printDateOverlay) {
                printDateOverlay.textContent = '';
                printDateOverlay.style.display = 'none';
            }
            if (modalDateOverlay) {
                modalDateOverlay.textContent = '';
                modalDateOverlay.style.display = 'none';
            }
        }
    }
    
    // Update payee
    const payeeInput = document.getElementById('payeeName');
    const payeeOverlay = document.getElementById('payeeOverlay');
    const printPayeeOverlay = document.getElementById('printPayeeOverlay');
    if (payeeInput && payeeOverlay) {
        const payeeText = payeeInput.value;
        payeeOverlay.textContent = payeeText;
        if (printPayeeOverlay) printPayeeOverlay.textContent = payeeText;
    }
    
    // Update amount
    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');
    const amountOverlay = document.getElementById('amountOverlay');
    const printAmountOverlay = document.getElementById('printAmountOverlay');
    if (amountInput && currencySelect && amountOverlay) {
        const amountText = formatAmount(amountInput.value, currencySelect.value);
        amountOverlay.textContent = amountText;
        if (printAmountOverlay) printAmountOverlay.textContent = amountText;
    }
    
    // Update amount in words (overlay only)
    const amountWordsOverlay = document.getElementById('amountWordsOverlay');
    const printAmountWordsOverlay = document.getElementById('printAmountWordsOverlay');
    const languageSelect = document.getElementById('amountWordsLanguage');
    if (amountInput && amountWordsOverlay) {
        const language = languageSelect ? languageSelect.value : 'english';
        const currency = currencySelect ? currencySelect.value : 'OMR';
        const words = amountToWords(amountInput.value, language, currency);
        amountWordsOverlay.textContent = words;
        if (printAmountWordsOverlay) {
            printAmountWordsOverlay.textContent = words;
            // Set RTL for Arabic
            if (language === 'arabic') {
                printAmountWordsOverlay.setAttribute('dir', 'rtl');
                printAmountWordsOverlay.style.direction = 'rtl';
                printAmountWordsOverlay.style.textAlign = 'center';
                printAmountWordsOverlay.style.fontFamily = 'Arial Unicode MS, Tahoma, Segoe UI, Arial, sans-serif';
            } else {
                printAmountWordsOverlay.setAttribute('dir', 'ltr');
                printAmountWordsOverlay.style.direction = 'ltr';
                printAmountWordsOverlay.style.textAlign = 'center';
            }
        }
        // Set RTL for Arabic in overlay
        // Container stays centered (via absolute positioning), text flows RTL but is centered
        if (language === 'arabic') {
            amountWordsOverlay.style.direction = 'rtl';
            amountWordsOverlay.style.textAlign = 'center';
            amountWordsOverlay.style.fontFamily = 'Arial Unicode MS, Tahoma, Segoe UI, Arial, sans-serif';
        } else {
            amountWordsOverlay.style.direction = 'ltr';
            amountWordsOverlay.style.textAlign = 'center';
        }
    }

    // Update crossing (slanted stamp on upper-left)
    const crossingSelect = document.getElementById('crossing');
    const crossingOverlay = document.getElementById('crossingOverlay');
    const printCrossingOverlay = document.getElementById('printCrossingOverlay');
    if (crossingSelect && crossingOverlay) {
        const text = crossingSelect.value ? crossingSelect.value.toUpperCase() : '';
        crossingOverlay.textContent = text;
        if (printCrossingOverlay) {
            printCrossingOverlay.textContent = text;
            printCrossingOverlay.style.transform = 'rotate(-25deg)';
            printCrossingOverlay.style.fontWeight = '700';
            printCrossingOverlay.style.color = 'rgba(200, 0, 0, 0.6)';
        }
    }
    
    // Purpose input removed; overlay is static for now
    
    // Print positions will be updated dynamically when print is called
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('chequeDate');
    if (dateInput) {
        dateInput.value = today;
    }
    
    // Add event listeners to all form fields
    const formFields = [
        'chequeDate', 'payeeName', 'amount', 'currency', 'crossing', 'amountWordsLanguage'
    ];
    
    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateChequePreview);
            field.addEventListener('change', updateChequePreview);
        }
    });

    // No amount-in-words input; overlay is auto-generated from amount
    
    // Date visibility toggle button
    const toggleDateBtn = document.getElementById('toggleDateBtn');
    const toggleDateIcon = document.getElementById('toggleDateIcon');
    const showDateCheckbox = document.getElementById('showDate');
    
    if (toggleDateBtn && showDateCheckbox) {
        toggleDateBtn.addEventListener('click', function() {
            const isCurrentlyVisible = showDateCheckbox.checked;
            showDateCheckbox.checked = !isCurrentlyVisible;
            
            // Update button appearance
            if (showDateCheckbox.checked) {
                toggleDateIcon.className = 'fas fa-eye';
                toggleDateBtn.classList.remove('btn-secondary');
                toggleDateBtn.classList.add('btn-primary');
            } else {
                toggleDateIcon.className = 'fas fa-eye-slash';
                toggleDateBtn.classList.remove('btn-primary');
                toggleDateBtn.classList.add('btn-secondary');
            }
            
            // Update cheque preview
            updateChequePreview();
        });
        
        // Initialize button state
        if (showDateCheckbox.checked) {
            toggleDateIcon.className = 'fas fa-eye';
            toggleDateBtn.classList.add('btn-primary');
        } else {
            toggleDateIcon.className = 'fas fa-eye-slash';
            toggleDateBtn.classList.add('btn-secondary');
        }
    }
    
    // Bank selection handler
    const bankSelect = document.getElementById('bankSelect');
    if (bankSelect) {
        bankSelect.addEventListener('change', function() {
            const selectedBank = this.value;
            updateFieldPositions(selectedBank);
            updateChequeTemplate(selectedBank);
            // Update print positions after screen positions are updated
            setTimeout(() => {
                updatePrintPositions();
            }, 100);
        });
    }
    
    // Print function - generates PDF and automatically opens print dialog
    function printCheque() {
        // Collect all cheque data
        const chequeDate = document.getElementById('chequeDate').value;
        const payeeName = document.getElementById('payeeName').value;
        const amount = document.getElementById('amount').value;
        const currency = document.getElementById('currency').value;
        const crossing = document.getElementById('crossing').value;
        const bankSelect = document.getElementById('bankSelect').value;
        const languageSelect = document.getElementById('amountWordsLanguage');
        const amountWordsLanguage = languageSelect ? languageSelect.value : 'english';
        const showDateCheckbox = document.getElementById('showDate');
        const showDate = showDateCheckbox ? showDateCheckbox.checked : true;
        
        // Prepare data to send
        const chequeData = {
            chequeDate: chequeDate,
            payeeName: payeeName,
            amount: amount,
            currency: currency,
            crossing: crossing,
            bank: bankSelect,
            amountWordsLanguage: amountWordsLanguage,
            showDate: showDate
        };
        
        // Show loading indicator (optional)
        const printBtn = document.getElementById('printBtn') || document.getElementById('printChequeBtn');
        if (printBtn) {
            const originalText = printBtn.innerHTML;
            printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            printBtn.disabled = true;
            
            // Reset button after a delay (in case of error)
            setTimeout(() => {
                printBtn.innerHTML = originalText;
                printBtn.disabled = false;
            }, 5000);
        }
        
        // Send data to server to generate PDF
        fetch('/generate-cheque-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(chequeData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate PDF');
            }
            return response.blob();
        })
        .then(pdfBlob => {
            // Create blob URL
            const pdfUrl = URL.createObjectURL(pdfBlob);
            
            // Create a hidden iframe to load the PDF
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.right = '0';
            iframe.style.bottom = '0';
            iframe.style.width = '1px';
            iframe.style.height = '1px';
            iframe.style.border = 'none';
            iframe.style.opacity = '0';
            iframe.src = pdfUrl;
            document.body.appendChild(iframe);
            
            // Wait for PDF to load, then trigger print
            const attemptPrint = () => {
                try {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                        
                        // Clean up after printing
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                            URL.revokeObjectURL(pdfUrl);
                        }, 1000);
                        
                        // Reset button
                        if (printBtn) {
                            printBtn.innerHTML = originalText;
                            printBtn.disabled = false;
                        }
                        return true;
                    }
                } catch (e) {
                    // Cross-origin or other error, try alternative method
                    return false;
                }
            };
            
            // Try printing after a short delay to allow PDF to load
            setTimeout(() => {
                if (!attemptPrint()) {
                    // Fallback: open in new window
                    const printWindow = window.open(pdfUrl, '_blank');
                    if (printWindow) {
                        setTimeout(() => {
                            printWindow.print();
                            setTimeout(() => {
                                URL.revokeObjectURL(pdfUrl);
                            }, 1000);
                        }, 1000);
                    }
                    
                    // Clean up iframe
                    document.body.removeChild(iframe);
                    URL.revokeObjectURL(pdfUrl);
                    
                    // Reset button
                    if (printBtn) {
                        printBtn.innerHTML = originalText;
                        printBtn.disabled = false;
                    }
                }
            }, 500);
        })
        .catch(error => {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
            
            // Reset button
            if (printBtn) {
                printBtn.innerHTML = originalText;
                printBtn.disabled = false;
            }
        });
    }
    
    // Old print function (kept for reference but not used)
    function printChequeOld() {
        // Update all print fields before printing
        updateChequePreview();
        
        // Get the print container
        const printContainer = document.querySelector('.cheque-print-container');
        if (printContainer) {
            // Move print container to body level if it's not already there
            if (printContainer.parentElement.tagName !== 'BODY') {
                document.body.appendChild(printContainer);
            }
            
            // Ensure print container is visible and properly styled
            // CRITICAL: Fixed dimensions - will NOT scale regardless of paper size selection
            // Using absolute positioning to prevent scaling issues
            printContainer.style.display = 'block';
            printContainer.style.visibility = 'visible';
            printContainer.style.position = 'absolute';
            printContainer.style.top = '0';
            printContainer.style.left = '0';
            printContainer.style.width = '190.5mm';
            printContainer.style.height = '88.9mm';
            printContainer.style.margin = '0';
            printContainer.style.padding = '0';
            printContainer.style.zIndex = '9999';
            printContainer.style.background = 'transparent';
            printContainer.style.overflow = 'visible';
            // CRITICAL: Force no scaling - these are absolute physical dimensions
            printContainer.style.transform = 'scale(1)';
            printContainer.style.zoom = '1';
            printContainer.style.webkitTransform = 'scale(1)';
            printContainer.style.mozTransform = 'scale(1)';
            printContainer.style.msTransform = 'scale(1)';
            printContainer.style.oTransform = 'scale(1)';
            printContainer.style.boxSizing = 'border-box';
            // Force exact dimensions - prevent any scaling
            printContainer.style.maxWidth = '190.5mm';
            printContainer.style.maxHeight = '88.9mm';
            printContainer.style.minWidth = '190.5mm';
            printContainer.style.minHeight = '88.9mm';
            
            // Ensure print overlay is properly styled
            const printOverlay = printContainer.querySelector('.cheque-print-overlay');
            if (printOverlay) {
                printOverlay.style.position = 'absolute';
                printOverlay.style.top = '0';
                printOverlay.style.left = '0';
                printOverlay.style.width = '190.5mm';
                printOverlay.style.height = '88.9mm';
                printOverlay.style.margin = '0';
                printOverlay.style.padding = '0';
                printOverlay.style.display = 'block';
                printOverlay.style.visibility = 'visible';
                // CRITICAL: Force no scaling
                printOverlay.style.transform = 'scale(1)';
                printOverlay.style.zoom = '1';
                printOverlay.style.webkitTransform = 'scale(1)';
                printOverlay.style.mozTransform = 'scale(1)';
                printOverlay.style.msTransform = 'scale(1)';
                printOverlay.style.oTransform = 'scale(1)';
                printOverlay.style.boxSizing = 'border-box';
                // Force exact dimensions
                printOverlay.style.maxWidth = '190.5mm';
                printOverlay.style.maxHeight = '88.9mm';
                printOverlay.style.minWidth = '190.5mm';
                printOverlay.style.minHeight = '88.9mm';
            }
            
            // Ensure all print fields are visible and properly styled to match screen exactly
            // Positions are in mm and will NOT scale regardless of paper size selection
            const printFields = printContainer.querySelectorAll('.print-field-overlay');
            printFields.forEach(field => {
                field.style.visibility = 'visible';
                field.style.display = 'block';
                field.style.position = 'absolute';
                field.style.color = '#000000';
                field.style.opacity = '1';
                field.style.background = 'transparent';
                field.style.fontFamily = 'Arial, sans-serif';
                field.style.padding = '2px 4px';
                field.style.lineHeight = '1.2';
                field.style.fontWeight = '600'; // Make all print text bolder
                // CRITICAL: Prevent any scaling - these are absolute physical positions in mm
                // These positions will NOT change regardless of paper size selection
                field.style.transform = 'scale(1)';
                field.style.zoom = '1';
                field.style.webkitTransform = 'scale(1)';
                field.style.mozTransform = 'scale(1)';
                field.style.msTransform = 'scale(1)';
                field.style.oTransform = 'scale(1)';
                field.style.boxSizing = 'border-box';
                // Positions are in mm - these are physical units that maintain absolute size
                
                // Match screen styles for specific fields - copy exact computed styles
                if (field.id === 'printAmountOverlay' || field.id === 'printAmountWordsOverlay') {
                    // Get Payee Name font size as reference to match
                    const payeeOverlay = document.getElementById('payeeOverlay');
                    const screenOverlay = field.id === 'printAmountOverlay' 
                        ? document.getElementById('amountOverlay')
                        : document.getElementById('amountWordsOverlay');
                    
                    if (screenOverlay && payeeOverlay) {
                        const payeeStyle = window.getComputedStyle(payeeOverlay);
                        const screenStyle = window.getComputedStyle(screenOverlay);
                        const templateImg = document.getElementById('chequeTemplate');
                        if (templateImg) {
                            const naturalWidth = templateImg.naturalWidth || 893;
                            const naturalHeight = templateImg.naturalHeight || 418;
                            const displayedWidth = templateImg.offsetWidth;
                            const displayedHeight = templateImg.offsetHeight;
                            
                            // Use Payee Name font size (16px) instead of the field's own font size
                            const payeeFontSizePx = parseFloat(payeeStyle.fontSize);
                            
                            if (field.id === 'printAmountOverlay') {
                                field.style.whiteSpace = 'nowrap'; // Prevent amount from wrapping
                                field.style.lineHeight = screenStyle.lineHeight;
                                
                                // Convert Payee Name font size to mm for print (increased for bigger text)
                                if (!isNaN(payeeFontSizePx)) {
                                    const scaleFactor = naturalHeight / displayedHeight;
                                    const naturalFontSize = payeeFontSizePx * scaleFactor;
                                    const fontSizeMm = (naturalFontSize / naturalHeight) * CHEQUE_HEIGHT_MM;
                                    // Increase font size by ~13% to make it bigger
                                    const increasedFontSize = fontSizeMm * 1.13;
                                    field.style.fontSize = increasedFontSize.toFixed(2) + 'mm';
                                    field.style.fontWeight = '600'; // Make bolder
                                }
                            } else if (field.id === 'printAmountWordsOverlay') {
                                // Get the inline style line-height (which is "2.0") instead of computed (which is "28px")
                                const inlineStyle = screenOverlay.getAttribute('style') || '';
                                const lineHeightMatch = inlineStyle.match(/line-height:\s*([^;]+)/i);
                                const lineHeightValue = lineHeightMatch ? lineHeightMatch[1].trim() : screenStyle.lineHeight;
                                
                                // Use relative line-height if available, otherwise use computed
                                field.style.lineHeight = lineHeightValue.includes('px') ? 
                                    ((parseFloat(lineHeightValue) / payeeFontSizePx).toFixed(1)) : 
                                    lineHeightValue;
                                
                                field.style.whiteSpace = screenStyle.whiteSpace; // Match screen white-space
                                field.style.wordWrap = screenStyle.wordWrap; // Match screen word-wrap
                                
                                // Convert Payee Name font size to mm for print (same as amount)
                                if (!isNaN(payeeFontSizePx)) {
                                    const scaleFactor = naturalHeight / displayedHeight;
                                    const naturalFontSize = payeeFontSizePx * scaleFactor;
                                    const fontSizeMm = (naturalFontSize / naturalHeight) * CHEQUE_HEIGHT_MM;
                                    field.style.fontSize = fontSizeMm.toFixed(2) + 'mm';
                                }
                                
                                // Convert max-width from pixels to mm for print
                                const maxWidthPx = screenStyle.maxWidth;
                                if (maxWidthPx && maxWidthPx !== 'none') {
                                    const pxValue = parseFloat(maxWidthPx);
                                    if (!isNaN(pxValue)) {
                                        // Convert pixels to mm using the same ratio as position conversion
                                        const scaleFactor = naturalWidth / displayedWidth;
                                        const naturalMaxWidth = pxValue * scaleFactor;
                                        const mmValue = (naturalMaxWidth / naturalWidth) * CHEQUE_WIDTH_MM;
                                        field.style.maxWidth = mmValue.toFixed(2) + 'mm';
                                    }
                                } else {
                                    // Convert default 300px to mm
                                    const scaleFactor = naturalWidth / displayedWidth;
                                    const naturalMaxWidth = 300 * scaleFactor;
                                    const mmValue = (naturalMaxWidth / naturalWidth) * CHEQUE_WIDTH_MM;
                                    field.style.maxWidth = mmValue.toFixed(2) + 'mm';
                                }
                            }
                        }
                    } else {
                        // Fallback if screen overlay not found
                        if (field.id === 'printAmountOverlay') {
                            field.style.whiteSpace = 'nowrap';
                            field.style.lineHeight = '1.2';
                            field.style.fontWeight = '600'; // Make bolder
                        } else {
                            field.style.lineHeight = '2.0';
                            field.style.maxWidth = '51.2mm'; // 300px converted to mm
                            field.style.whiteSpace = 'normal';
                            field.style.fontSize = '4.3mm'; // Increased from 4.4mm, made bigger
                            field.style.fontWeight = '600'; // Make bolder
                        }
                    }
                } else if (field.id === 'printCrossingOverlay') {
                    field.style.whiteSpace = 'nowrap'; // Prevent crossing from wrapping
                }
                
                // Ensure font size is set (use px as fallback if mm doesn't work)
                if (!field.style.fontSize || field.style.fontSize === '') {
                    field.style.fontSize = '14px';
                }
            });
        }
        
        // Small delay to ensure screen overlays are positioned, then update print positions
        setTimeout(() => {
            // Update print positions based on actual screen positions
            updatePrintPositions();
            
            // Small delay to ensure DOM is updated before print
            setTimeout(() => {
                // Trigger print dialog
                window.print();
                
                // Hide print container after printing (in case user cancels)
                setTimeout(() => {
                    if (printContainer) {
                        printContainer.style.display = 'none';
                    }
                }, 100);
            }, 50);
        }, 100);
    }
    
    // Print button handlers
    const printBtn = document.getElementById('printBtn');
    const printChequeBtn = document.getElementById('printChequeBtn');
    const saveChequeBtn = document.getElementById('saveChequeBtn');
    
    if (printBtn) {
        printBtn.addEventListener('click', printCheque);
    }
    
    if (printChequeBtn) {
        printChequeBtn.addEventListener('click', printCheque);
    }
    
    if (saveChequeBtn) {
        saveChequeBtn.addEventListener('click', function() {
            alert('Save functionality will be implemented later.');
        });
    }
    
    // Modal functionality
    const modal = document.getElementById('chequePreviewModal');
    const closeBtn = document.querySelector('.close');
    const closeModalBtn = document.getElementById('closeModal');
    const printFromModalBtn = document.getElementById('printFromModal');
    
    // Open modal function
    function openChequeModal() {
        if (modal) {
            modal.style.display = 'block';
            updateModalChequePreview();
        }
    }
    
    // Close modal function
    function closeChequeModal() {
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Update modal cheque preview
    function updateModalChequePreview() {
        // Update modal template image
        const bankSelect = document.getElementById('bankSelect');
        const modalTemplate = document.getElementById('modalChequeTemplate');
        if (bankSelect && modalTemplate) {
            const bankImageMap = {
                'dhofar_islamic': 'DHOFAR-ISLAMIC-BANK.png',
                'oman_arab': 'OMAN-ARAB-BANK.png',
                'sohar': 'SOHAR-BANK.png'
            };
            modalTemplate.src = `{{ url_for('static', filename='cheque_templates/') }}${bankImageMap[bankSelect.value]}`;
        }
        
        // Update modal field positions
        const selectedBank = bankSelect ? bankSelect.value : 'dhofar_islamic';
        const positions = bankFieldPositions[selectedBank];
        if (positions) {
            Object.keys(positions).forEach(field => {
                const modalOverlay = document.getElementById('modal' + field.charAt(0).toUpperCase() + field.slice(1) + 'Overlay');
                if (modalOverlay) {
                    modalOverlay.style.top = positions[field].top;
                    modalOverlay.style.left = positions[field].left;
                }
            });
        }
        
        // Update modal field content
        const dateInput = document.getElementById('chequeDate');
        const payeeInput = document.getElementById('payeeName');
        const amountInput = document.getElementById('amount');
        const currencySelect = document.getElementById('currency');
        const crossingSelect = document.getElementById('crossing');
        
        // Date
        const showDateCheckbox = document.getElementById('showDate');
        const isDateVisible = showDateCheckbox ? showDateCheckbox.checked : true;
        const modalDateOverlay = document.getElementById('modalDateOverlay');
        if (dateInput && modalDateOverlay) {
            if (isDateVisible) {
                modalDateOverlay.textContent = formatDate(dateInput.value);
                modalDateOverlay.style.display = 'block';
            } else {
                modalDateOverlay.textContent = '';
                modalDateOverlay.style.display = 'none';
            }
        }
        
        // Payee
        const modalPayeeOverlay = document.getElementById('modalPayeeOverlay');
        if (payeeInput && modalPayeeOverlay) {
            modalPayeeOverlay.textContent = payeeInput.value;
        }
        
        // Amount
        const modalAmountOverlay = document.getElementById('modalAmountOverlay');
        if (amountInput && currencySelect && modalAmountOverlay) {
            modalAmountOverlay.textContent = formatAmount(amountInput.value, currencySelect.value);
        }
        
        // Amount in words
        const modalAmountWordsOverlay = document.getElementById('modalAmountWordsOverlay');
        const languageSelect = document.getElementById('amountWordsLanguage');
        if (amountInput && modalAmountWordsOverlay) {
            const language = languageSelect ? languageSelect.value : 'english';
            const currency = currencySelect ? currencySelect.value : 'OMR';
            const words = amountToWords(amountInput.value, language, currency);
            modalAmountWordsOverlay.textContent = words;
            // Set RTL for Arabic
            if (language === 'arabic') {
                modalAmountWordsOverlay.style.direction = 'rtl';
                modalAmountWordsOverlay.style.textAlign = 'center';
                modalAmountWordsOverlay.style.fontFamily = 'Arial Unicode MS, Tahoma, Segoe UI, Arial, sans-serif';
            } else {
                modalAmountWordsOverlay.style.direction = 'ltr';
                modalAmountWordsOverlay.style.textAlign = 'center';
            }
        }
        
        // Crossing
        const modalCrossingOverlay = document.getElementById('modalCrossingOverlay');
        if (crossingSelect && modalCrossingOverlay) {
            const text = crossingSelect.value ? crossingSelect.value.toUpperCase() : '';
            modalCrossingOverlay.textContent = text;
            modalCrossingOverlay.style.transform = 'rotate(-25deg)';
            modalCrossingOverlay.style.fontWeight = '700';
            modalCrossingOverlay.style.color = 'rgba(200, 0, 0, 0.6)';
        }
    }
    
    // Modal event listeners
    if (closeBtn) {
        closeBtn.addEventListener('click', closeChequeModal);
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeChequeModal);
    }
    
    if (printFromModalBtn) {
        printFromModalBtn.addEventListener('click', function() {
            closeChequeModal();
            // Small delay to ensure modal is closed before printing
            setTimeout(printCheque, 100);
        });
    }
    
    // Close modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeChequeModal();
            }
        });
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
            closeChequeModal();
        }
    });
    
    // Initial field positions for default bank
    updateFieldPositions('dhofar_islamic');
    
    // Initial preview update
    updateChequePreview();
    
    // Initial print positions - wait for image to load
    const templateImg = document.getElementById('chequeTemplate');
    if (templateImg.complete) {
        setTimeout(() => updatePrintPositions(), 100);
    } else {
        templateImg.addEventListener('load', () => {
            setTimeout(() => updatePrintPositions(), 100);
        });
    }
});
</script>
{% endblock %}

