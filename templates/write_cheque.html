{% extends "base.html" %}

{% block title %}Write Cheque{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/write_cheque.css') }}">
{% endblock %}

{% block content %}
<div class="cheque-container">
    <div class="cheque-header">
        <h1><i class="fas fa-file-invoice"></i> Write Cheque</h1>
        <p>Fill in the fields and preview the cheque</p>
    </div>

    <div class="cheque-layout">
        <!-- Left Panel: Form Fields -->
        <div class="cheque-form-panel">
            <div class="form-section">
                <h3><i class="fas fa-edit"></i> Fill in the fields and print</h3>
                
                <form id="chequeForm">
                    <div class="form-group">
                        <label for="chequeDate">Cheque's date</label>
                        <input type="date" id="chequeDate" name="chequeDate" class="form-control" required>
                    </div>

                    <div class="form-group">
                        <label for="payeeName">Payee Name</label>
                        <input type="text" id="payeeName" name="payeeName" class="form-control" placeholder="Enter payee name" required>
                    </div>

                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <div class="amount-input-group">
                            <input type="number" id="amount" name="amount" class="form-control" placeholder="0.000" step="0.001" required>
                            <select id="currency" name="currency" class="form-control">
                                <option value="OMR">OMR</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="crossing">Crossing</label>
                        <select id="crossing" name="crossing" class="form-control">
                            <option value="">Select an option</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="A/C Payee">A/C Payee</option>
                            <option value="Not Negotiable">Not Negotiable</option>
                            <option value="Cash Only">Cash Only</option>
                        </select>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-success" id="printBtn">
                            <i class="fas fa-print"></i> Print Cheque
                        </button>
                        <button type="button" class="btn btn-primary" id="saveChequeBtn">
                            <i class="fas fa-save"></i> Save Cheque
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Right Panel: Cheque Preview -->
        <div class="cheque-preview-panel">
            <div class="preview-section">
                <div class="bank-selection">
                    <div class="form-group">
                        <label for="bankSelect">Bank</label>
                        <select id="bankSelect" name="bankSelect" class="form-control">
                            <option value="dhofar_islamic">Dhofar Islamic Bank</option>
                            <option value="oman_arab">Oman Arab Bank</option>
                            <option value="sohar">Sohar Bank</option>
                        </select>
                    </div>
                </div>

                <div class="cheque-preview">
                    <div class="cheque-image-container">
                        <img id="chequeTemplate" src="{{ url_for('static', filename='cheque_templates/DHOFAR-ISLAMIC-BANK.png') }}" alt="Cheque Template" class="cheque-template">
                        
                        <!-- Overlay fields that will be positioned over the cheque -->
                        <div class="cheque-overlay">
                            <div class="field-overlay" id="dateOverlay" style="position: absolute; top: 50px; left: 355px; font-size: 14px;"></div>
                            <div class="field-overlay" id="payeeOverlay" style="position: absolute; top: 127px; left: 280px; font-size: 16px; max-width: 400px;"></div>
                            <div class="field-overlay" id="amountOverlay" style="position: absolute; top: 180px; left: 610px; font-size: 16px;"></div>
                            <div class="field-overlay" id="amountWordsOverlay" style="position: absolute; top: 160px; left: 98px; font-size: 16px; max-width: 300px; line-height: 2.0;"></div>
                            <div class="field-overlay" id="crossingOverlay" style="position: absolute; top: 20px; left: 60px; font-size: 18px; font-weight: 700; text-transform: uppercase; transform: rotate(-25deg); color: rgba(200, 0, 0, 0.6);"></div>
                            <div class="field-overlay" id="purposeOverlay" style="position: absolute; top: 200px; left: 50px; font-size: 12px; max-width: 300px; line-height: 1.2;"></div>
                        </div>
                    </div>
                </div>

                <div class="preview-actions">
                    <button type="button" class="btn btn-primary btn-lg" id="printChequeBtn">
                        <i class="fas fa-print"></i> Print the cheque
                    </button>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i>
                        Any field can be set and moved by double clicking on it
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden print container - only visible when printing (outside cheque-container to avoid being hidden) -->
<div class="cheque-print-container" style="display: none;">
    <div class="cheque-print-overlay">
        <div class="print-field-overlay print-date-overlay" id="printDateOverlay"></div>
        <div class="print-field-overlay print-payee-overlay" id="printPayeeOverlay"></div>
        <div class="print-field-overlay print-amount-overlay" id="printAmountOverlay"></div>
            <div class="print-field-overlay print-amount-words-overlay" id="printAmountWordsOverlay"></div>
            <div class="print-field-overlay print-crossing-overlay" id="printCrossingOverlay"></div>
    </div>
</div>

<!-- Cheque Preview Modal -->
<div id="chequePreviewModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-eye"></i> Cheque Preview</h2>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="cheque-modal-container">
                <div class="cheque-modal-image-container">
                    <img id="modalChequeTemplate" src="{{ url_for('static', filename='cheque_templates/DHOFAR-ISLAMIC-BANK.png') }}" alt="Cheque Template" class="modal-cheque-template">
                    
                    <!-- Modal overlay fields -->
                    <div class="modal-cheque-overlay">
                        <div class="modal-field-overlay" id="modalDateOverlay"></div>
                        <div class="modal-field-overlay" id="modalPayeeOverlay"></div>
                        <div class="modal-field-overlay" id="modalAmountOverlay"></div>
                        <div class="modal-field-overlay" id="modalAmountWordsOverlay"></div>
                        <div class="modal-field-overlay" id="modalCrossingOverlay"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="printFromModal">
                <i class="fas fa-print"></i> Print Cheque
            </button>
            <button type="button" class="btn btn-secondary" id="closeModal">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cheque field mapping for different banks
const bankFieldPositions = {
    'dhofar_islamic': {
        date: { top: '50px', left: '355px' },
        payee: { top: '127px', left: '280px' },
        amount: { top: '180px', left: '610px' },
        amountWords: { top: '160px', left: '98px' },
        crossing: { top: '20px', left: '60px' },
        purpose: { top: '200px', left: '50px' }
    },
    'oman_arab': {
        date: { top: '13px', left: '580px' },
        payee: { top: '120px', left: '150px' },
        amount: { top: '130px', left: '617px' },
        amountWords: { top: '160px', left: '95px' },
        crossing: { top: '15px', left: '40px' },
        purpose: { top: '210px', left: '60px' }
    },
    'sohar': {
        date: { top: '52px', left: '555px' },
        payee: { top: '116px', left: '115px' },
        amount: { top: '163px', left: '568px' },
        amountWords: { top: '153px', left: '80px' },
        crossing: { top: '25px', left: '70px' },
        purpose: { top: '205px', left: '55px' }
    }
};

// Function to update field positions based on selected bank
function updateFieldPositions(bank) {
    const positions = bankFieldPositions[bank];
    if (!positions) return;
    
    Object.keys(positions).forEach(field => {
        const overlay = document.getElementById(field + 'Overlay');
        if (overlay) {
            overlay.style.top = positions[field].top;
            overlay.style.left = positions[field].left;
        }
    });
    
    // Print positions will be updated dynamically based on actual screen positions
    // when print is called or bank is changed
}

// Function to update cheque template image
function updateChequeTemplate(bank) {
    const templateImg = document.getElementById('chequeTemplate');
    const bankImageMap = {
        'dhofar_islamic': 'DHOFAR-ISLAMIC-BANK.png',
        'oman_arab': 'OMAN-ARAB-BANK.png',
        'sohar': 'SOHAR-BANK.png'
    };
    templateImg.src = `{{ url_for('static', filename='cheque_templates/') }}${bankImageMap[bank]}`;
}

// Function to format date for display
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
}

// Function to format amount
function formatAmount(amount, currency) {
    if (!amount) return '';
    const numeric = Number(amount);
    const formatted = isNaN(numeric)
        ? ''
        : numeric.toLocaleString('en-US', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    // Show currency only when it's not OMR per requirements
    return currency && currency !== 'OMR' ? `${formatted} ${currency}` : formatted;
}

// Convert integers to English words (supports up to trillions)
function numberToWords(n) {
    const ones = ['zero','one','two','three','four','five','six','seven','eight','nine','ten','eleven','twelve','thirteen','fourteen','fifteen','sixteen','seventeen','eighteen','nineteen'];
    const tens = ['','','twenty','thirty','forty','fifty','sixty','seventy','eighty','ninety'];
    if (n < 20) return ones[n];
    if (n < 100) {
        const t = Math.floor(n / 10);
        const r = n % 10;
        return r ? `${tens[t]}-${ones[r]}` : tens[t];
    }
    if (n < 1000) {
        const h = Math.floor(n / 100);
        const r = n % 100;
        return r ? `${ones[h]} hundred ${numberToWords(r)}` : `${ones[h]} hundred`;
    }
    const units = [
        { v: 1_000_000_000_000, w: 'trillion' },
        { v: 1_000_000_000, w: 'billion' },
        { v: 1_000_000, w: 'million' },
        { v: 1_000, w: 'thousand' }
    ];
    for (const u of units) {
        if (n >= u.v) {
            const q = Math.floor(n / u.v);
            const r = n % u.v;
            return r ? `${numberToWords(q)} ${u.w} ${numberToWords(r)}` : `${numberToWords(q)} ${u.w}`;
        }
    }
    return '';
}

// Convert numeric amount to words (simple generic format)
function amountToWords(amount) {
    if (!amount && amount !== 0) return '';
    const numeric = Number(amount);
    if (!isFinite(numeric)) return '';
    const fixed = numeric.toFixed(3); // keep three decimals to match input precision
    const [intStr, decStr] = fixed.split('.');
    const intNum = parseInt(intStr, 10);
    let words = numberToWords(Math.abs(intNum));
    if (intNum === 0) words = 'zero';
    if (decStr && Number(decStr) > 0) {
        const decWords = decStr.split('').map(d => numberToWords(parseInt(d, 10))).join(' ');
        words = `${words} point ${decWords}`;
    }
    if (numeric < 0) words = `minus ${words}`;
    // Capitalize first letter of each word and append "Omani Rials Only"
    const capitalizedWords = words.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
    return capitalizedWords + ' Omani Rials Only';
}

// Conversion constants
// Standard Oman cheque: 152.4mm Ã— 76.2mm
const CHEQUE_WIDTH_MM = 152.4;
const CHEQUE_HEIGHT_MM = 76.2;

// Update print field positions based on ACTUAL screen positions
// This ensures print matches exactly what's shown on screen
function updatePrintPositions() {
    const templateImg = document.getElementById('chequeTemplate');
    if (!templateImg) return;
    
    // Get actual displayed image dimensions
    const displayedWidth = templateImg.offsetWidth;
    const displayedHeight = templateImg.offsetHeight;
    
    // Get natural image dimensions
    const naturalWidth = templateImg.naturalWidth || 893;
    const naturalHeight = templateImg.naturalHeight || 418;
    
    // Calculate scale factors (how much the image is scaled on screen)
    const scaleX = displayedWidth / naturalWidth;
    const scaleY = displayedHeight / naturalHeight;
    
    // Get screen overlay positions (actual positions on displayed image)
    const screenOverlays = {
        date: document.getElementById('dateOverlay'),
        payee: document.getElementById('payeeOverlay'),
        amount: document.getElementById('amountOverlay'),
        amountWords: document.getElementById('amountWordsOverlay'),
        crossing: document.getElementById('crossingOverlay')
    };
    
    // Get print overlays
    const printOverlays = {
        date: document.getElementById('printDateOverlay'),
        payee: document.getElementById('printPayeeOverlay'),
        amount: document.getElementById('printAmountOverlay'),
        amountWords: document.getElementById('printAmountWordsOverlay'),
        crossing: document.getElementById('printCrossingOverlay')
    };
    
    // Convert each screen position to print position
    Object.keys(screenOverlays).forEach(field => {
        const screenOverlay = screenOverlays[field];
        const printOverlay = printOverlays[field];
        
        if (screenOverlay && printOverlay) {
            // Get actual screen position relative to displayed image
            const screenRect = screenOverlay.getBoundingClientRect();
            const imageRect = templateImg.getBoundingClientRect();
            
            // Calculate position relative to image (0,0 is top-left of image)
            const relativeLeft = screenRect.left - imageRect.left;
            const relativeTop = screenRect.top - imageRect.top;
            
            // Convert to natural image coordinates (undo the scale)
            const naturalLeft = relativeLeft / scaleX;
            const naturalTop = relativeTop / scaleY;
            
            // Convert natural coordinates to mm for print
            // Ratio: natural image size to cheque size
            const printLeft = (naturalLeft / naturalWidth) * CHEQUE_WIDTH_MM;
            const printTop = (naturalTop / naturalHeight) * CHEQUE_HEIGHT_MM;
            
            // Set print position
            printOverlay.style.left = printLeft.toFixed(2) + 'mm';
            printOverlay.style.top = printTop.toFixed(2) + 'mm';
        }
    });
}

// Real-time field updates
function updateChequePreview() {
    // Update date
    const dateInput = document.getElementById('chequeDate');
    const dateOverlay = document.getElementById('dateOverlay');
    const printDateOverlay = document.getElementById('printDateOverlay');
    if (dateInput && dateOverlay) {
        const dateText = formatDate(dateInput.value);
        dateOverlay.textContent = dateText;
        if (printDateOverlay) printDateOverlay.textContent = dateText;
    }
    
    // Update payee
    const payeeInput = document.getElementById('payeeName');
    const payeeOverlay = document.getElementById('payeeOverlay');
    const printPayeeOverlay = document.getElementById('printPayeeOverlay');
    if (payeeInput && payeeOverlay) {
        const payeeText = payeeInput.value;
        payeeOverlay.textContent = payeeText;
        if (printPayeeOverlay) printPayeeOverlay.textContent = payeeText;
    }
    
    // Update amount
    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');
    const amountOverlay = document.getElementById('amountOverlay');
    const printAmountOverlay = document.getElementById('printAmountOverlay');
    if (amountInput && currencySelect && amountOverlay) {
        const amountText = formatAmount(amountInput.value, currencySelect.value);
        amountOverlay.textContent = amountText;
        if (printAmountOverlay) printAmountOverlay.textContent = amountText;
    }
    
    // Update amount in words (overlay only)
    const amountWordsOverlay = document.getElementById('amountWordsOverlay');
    const printAmountWordsOverlay = document.getElementById('printAmountWordsOverlay');
    if (amountInput && amountWordsOverlay) {
        const words = amountToWords(amountInput.value);
        amountWordsOverlay.textContent = words;
        if (printAmountWordsOverlay) printAmountWordsOverlay.textContent = words;
    }

    // Update crossing (slanted stamp on upper-left)
    const crossingSelect = document.getElementById('crossing');
    const crossingOverlay = document.getElementById('crossingOverlay');
    const printCrossingOverlay = document.getElementById('printCrossingOverlay');
    if (crossingSelect && crossingOverlay) {
        const text = crossingSelect.value ? crossingSelect.value.toUpperCase() : '';
        crossingOverlay.textContent = text;
        if (printCrossingOverlay) {
            printCrossingOverlay.textContent = text;
            printCrossingOverlay.style.transform = 'rotate(-25deg)';
            printCrossingOverlay.style.fontWeight = '700';
            printCrossingOverlay.style.color = 'rgba(200, 0, 0, 0.6)';
        }
    }
    
    // Purpose input removed; overlay is static for now
    
    // Print positions will be updated dynamically when print is called
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('chequeDate');
    if (dateInput) {
        dateInput.value = today;
    }
    
    // Add event listeners to all form fields
    const formFields = [
        'chequeDate', 'payeeName', 'amount', 'currency', 'crossing'
    ];
    
    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updateChequePreview);
            field.addEventListener('change', updateChequePreview);
        }
    });

    // No amount-in-words input; overlay is auto-generated from amount
    
    // Bank selection handler
    const bankSelect = document.getElementById('bankSelect');
    if (bankSelect) {
        bankSelect.addEventListener('change', function() {
            const selectedBank = this.value;
            updateFieldPositions(selectedBank);
            updateChequeTemplate(selectedBank);
            // Update print positions after screen positions are updated
            setTimeout(() => {
                updatePrintPositions();
            }, 100);
        });
    }
    
    // Print function - shows print container and triggers print dialog
    function printCheque() {
        // Update all print fields before printing
        updateChequePreview();
        
        // Get the print container
        const printContainer = document.querySelector('.cheque-print-container');
        if (printContainer) {
            // Move print container to body level if it's not already there
            if (printContainer.parentElement.tagName !== 'BODY') {
                document.body.appendChild(printContainer);
            }
            
            // Ensure print container is visible and properly styled
            printContainer.style.display = 'block';
            printContainer.style.visibility = 'visible';
            printContainer.style.position = 'fixed';
            printContainer.style.top = '0';
            printContainer.style.left = '0';
            printContainer.style.width = '152.4mm';
            printContainer.style.height = '76.2mm';
            printContainer.style.margin = '0';
            printContainer.style.padding = '0';
            printContainer.style.zIndex = '9999';
            printContainer.style.background = 'transparent';
            printContainer.style.overflow = 'visible';
            
            // Ensure print overlay is properly styled
            const printOverlay = printContainer.querySelector('.cheque-print-overlay');
            if (printOverlay) {
                printOverlay.style.position = 'relative';
                printOverlay.style.width = '152.4mm';
                printOverlay.style.height = '76.2mm';
                printOverlay.style.margin = '0';
                printOverlay.style.padding = '0';
                printOverlay.style.display = 'block';
                printOverlay.style.visibility = 'visible';
            }
            
            // Ensure all print fields are visible and properly styled to match screen exactly
            const printFields = printContainer.querySelectorAll('.print-field-overlay');
            printFields.forEach(field => {
                field.style.visibility = 'visible';
                field.style.display = 'block';
                field.style.position = 'absolute';
                field.style.color = '#000000';
                field.style.opacity = '1';
                field.style.background = 'transparent';
                field.style.fontFamily = 'Arial, sans-serif';
                field.style.padding = '2px 4px';
                field.style.lineHeight = '1.2';
                
                // Match screen styles for specific fields - copy exact computed styles
                if (field.id === 'printAmountOverlay' || field.id === 'printAmountWordsOverlay') {
                    // Get Payee Name font size as reference to match
                    const payeeOverlay = document.getElementById('payeeOverlay');
                    const screenOverlay = field.id === 'printAmountOverlay' 
                        ? document.getElementById('amountOverlay')
                        : document.getElementById('amountWordsOverlay');
                    
                    if (screenOverlay && payeeOverlay) {
                        const payeeStyle = window.getComputedStyle(payeeOverlay);
                        const screenStyle = window.getComputedStyle(screenOverlay);
                        const templateImg = document.getElementById('chequeTemplate');
                        if (templateImg) {
                            const naturalWidth = templateImg.naturalWidth || 893;
                            const naturalHeight = templateImg.naturalHeight || 418;
                            const displayedWidth = templateImg.offsetWidth;
                            const displayedHeight = templateImg.offsetHeight;
                            
                            // Use Payee Name font size (16px) instead of the field's own font size
                            const payeeFontSizePx = parseFloat(payeeStyle.fontSize);
                            
                            if (field.id === 'printAmountOverlay') {
                                field.style.whiteSpace = 'nowrap'; // Prevent amount from wrapping
                                field.style.lineHeight = screenStyle.lineHeight;
                                
                                // Convert Payee Name font size to mm for print
                                if (!isNaN(payeeFontSizePx)) {
                                    const scaleFactor = naturalHeight / displayedHeight;
                                    const naturalFontSize = payeeFontSizePx * scaleFactor;
                                    const fontSizeMm = (naturalFontSize / naturalHeight) * CHEQUE_HEIGHT_MM;
                                    field.style.fontSize = fontSizeMm.toFixed(2) + 'mm';
                                }
                            } else if (field.id === 'printAmountWordsOverlay') {
                                // Get the inline style line-height (which is "2.0") instead of computed (which is "28px")
                                const inlineStyle = screenOverlay.getAttribute('style') || '';
                                const lineHeightMatch = inlineStyle.match(/line-height:\s*([^;]+)/i);
                                const lineHeightValue = lineHeightMatch ? lineHeightMatch[1].trim() : screenStyle.lineHeight;
                                
                                // Use relative line-height if available, otherwise use computed
                                field.style.lineHeight = lineHeightValue.includes('px') ? 
                                    ((parseFloat(lineHeightValue) / payeeFontSizePx).toFixed(1)) : 
                                    lineHeightValue;
                                
                                field.style.whiteSpace = screenStyle.whiteSpace; // Match screen white-space
                                field.style.wordWrap = screenStyle.wordWrap; // Match screen word-wrap
                                
                                // Convert Payee Name font size to mm for print (same as amount)
                                if (!isNaN(payeeFontSizePx)) {
                                    const scaleFactor = naturalHeight / displayedHeight;
                                    const naturalFontSize = payeeFontSizePx * scaleFactor;
                                    const fontSizeMm = (naturalFontSize / naturalHeight) * CHEQUE_HEIGHT_MM;
                                    field.style.fontSize = fontSizeMm.toFixed(2) + 'mm';
                                }
                                
                                // Convert max-width from pixels to mm for print
                                const maxWidthPx = screenStyle.maxWidth;
                                if (maxWidthPx && maxWidthPx !== 'none') {
                                    const pxValue = parseFloat(maxWidthPx);
                                    if (!isNaN(pxValue)) {
                                        // Convert pixels to mm using the same ratio as position conversion
                                        const scaleFactor = naturalWidth / displayedWidth;
                                        const naturalMaxWidth = pxValue * scaleFactor;
                                        const mmValue = (naturalMaxWidth / naturalWidth) * CHEQUE_WIDTH_MM;
                                        field.style.maxWidth = mmValue.toFixed(2) + 'mm';
                                    }
                                } else {
                                    // Convert default 300px to mm
                                    const scaleFactor = naturalWidth / displayedWidth;
                                    const naturalMaxWidth = 300 * scaleFactor;
                                    const mmValue = (naturalMaxWidth / naturalWidth) * CHEQUE_WIDTH_MM;
                                    field.style.maxWidth = mmValue.toFixed(2) + 'mm';
                                }
                            }
                        }
                    } else {
                        // Fallback if screen overlay not found
                        if (field.id === 'printAmountOverlay') {
                            field.style.whiteSpace = 'nowrap';
                            field.style.lineHeight = '1.2';
                        } else {
                            field.style.lineHeight = '2.0';
                            field.style.maxWidth = '51.2mm'; // 300px converted to mm
                            field.style.whiteSpace = 'normal';
                            field.style.fontSize = '4.4mm'; // 16px converted (matching Payee Name)
                        }
                    }
                } else if (field.id === 'printCrossingOverlay') {
                    field.style.whiteSpace = 'nowrap'; // Prevent crossing from wrapping
                }
                
                // Ensure font size is set (use px as fallback if mm doesn't work)
                if (!field.style.fontSize || field.style.fontSize === '') {
                    field.style.fontSize = '14px';
                }
            });
        }
        
        // Small delay to ensure screen overlays are positioned, then update print positions
        setTimeout(() => {
            // Update print positions based on actual screen positions
            updatePrintPositions();
            
            // Small delay to ensure DOM is updated before print
            setTimeout(() => {
                // Trigger print dialog
                window.print();
                
                // Hide print container after printing (in case user cancels)
                setTimeout(() => {
                    if (printContainer) {
                        printContainer.style.display = 'none';
                    }
                }, 100);
            }, 50);
        }, 100);
    }
    
    // Print button handlers
    const printBtn = document.getElementById('printBtn');
    const printChequeBtn = document.getElementById('printChequeBtn');
    const saveChequeBtn = document.getElementById('saveChequeBtn');
    
    if (printBtn) {
        printBtn.addEventListener('click', printCheque);
    }
    
    if (printChequeBtn) {
        printChequeBtn.addEventListener('click', printCheque);
    }
    
    if (saveChequeBtn) {
        saveChequeBtn.addEventListener('click', function() {
            alert('Save functionality will be implemented later.');
        });
    }
    
    // Modal functionality
    const modal = document.getElementById('chequePreviewModal');
    const closeBtn = document.querySelector('.close');
    const closeModalBtn = document.getElementById('closeModal');
    const printFromModalBtn = document.getElementById('printFromModal');
    
    // Open modal function
    function openChequeModal() {
        if (modal) {
            modal.style.display = 'block';
            updateModalChequePreview();
        }
    }
    
    // Close modal function
    function closeChequeModal() {
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Update modal cheque preview
    function updateModalChequePreview() {
        // Update modal template image
        const bankSelect = document.getElementById('bankSelect');
        const modalTemplate = document.getElementById('modalChequeTemplate');
        if (bankSelect && modalTemplate) {
            const bankImageMap = {
                'dhofar_islamic': 'DHOFAR-ISLAMIC-BANK.png',
                'oman_arab': 'OMAN-ARAB-BANK.png',
                'sohar': 'SOHAR-BANK.png'
            };
            modalTemplate.src = `{{ url_for('static', filename='cheque_templates/') }}${bankImageMap[bankSelect.value]}`;
        }
        
        // Update modal field positions
        const selectedBank = bankSelect ? bankSelect.value : 'dhofar_islamic';
        const positions = bankFieldPositions[selectedBank];
        if (positions) {
            Object.keys(positions).forEach(field => {
                const modalOverlay = document.getElementById('modal' + field.charAt(0).toUpperCase() + field.slice(1) + 'Overlay');
                if (modalOverlay) {
                    modalOverlay.style.top = positions[field].top;
                    modalOverlay.style.left = positions[field].left;
                }
            });
        }
        
        // Update modal field content
        const dateInput = document.getElementById('chequeDate');
        const payeeInput = document.getElementById('payeeName');
        const amountInput = document.getElementById('amount');
        const currencySelect = document.getElementById('currency');
        const crossingSelect = document.getElementById('crossing');
        
        // Date
        const modalDateOverlay = document.getElementById('modalDateOverlay');
        if (dateInput && modalDateOverlay) {
            modalDateOverlay.textContent = formatDate(dateInput.value);
        }
        
        // Payee
        const modalPayeeOverlay = document.getElementById('modalPayeeOverlay');
        if (payeeInput && modalPayeeOverlay) {
            modalPayeeOverlay.textContent = payeeInput.value;
        }
        
        // Amount
        const modalAmountOverlay = document.getElementById('modalAmountOverlay');
        if (amountInput && currencySelect && modalAmountOverlay) {
            modalAmountOverlay.textContent = formatAmount(amountInput.value, currencySelect.value);
        }
        
        // Amount in words
        const modalAmountWordsOverlay = document.getElementById('modalAmountWordsOverlay');
        if (amountInput && modalAmountWordsOverlay) {
            const words = amountToWords(amountInput.value);
            modalAmountWordsOverlay.textContent = words;
        }
        
        // Crossing
        const modalCrossingOverlay = document.getElementById('modalCrossingOverlay');
        if (crossingSelect && modalCrossingOverlay) {
            const text = crossingSelect.value ? crossingSelect.value.toUpperCase() : '';
            modalCrossingOverlay.textContent = text;
            modalCrossingOverlay.style.transform = 'rotate(-25deg)';
            modalCrossingOverlay.style.fontWeight = '700';
            modalCrossingOverlay.style.color = 'rgba(200, 0, 0, 0.6)';
        }
    }
    
    // Modal event listeners
    if (closeBtn) {
        closeBtn.addEventListener('click', closeChequeModal);
    }
    
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeChequeModal);
    }
    
    if (printFromModalBtn) {
        printFromModalBtn.addEventListener('click', function() {
            closeChequeModal();
            // Small delay to ensure modal is closed before printing
            setTimeout(printCheque, 100);
        });
    }
    
    // Close modal when clicking outside
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeChequeModal();
            }
        });
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal && modal.style.display === 'block') {
            closeChequeModal();
        }
    });
    
    // Initial field positions for default bank
    updateFieldPositions('dhofar_islamic');
    
    // Initial preview update
    updateChequePreview();
    
    // Initial print positions - wait for image to load
    const templateImg = document.getElementById('chequeTemplate');
    if (templateImg.complete) {
        setTimeout(() => updatePrintPositions(), 100);
    } else {
        templateImg.addEventListener('load', () => {
            setTimeout(() => updatePrintPositions(), 100);
        });
    }
});
</script>
{% endblock %}
