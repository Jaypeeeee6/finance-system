{% extends "base.html" %}
{% block title %}Settings{% endblock %}
{% block content %}
<div class="dashboard-container settings-page">
    <div class="dashboard-header">
        <h2 style="margin:0;"><i class="fas fa-cog"></i> Settings</h2>
    </div>
    <!-- Settings page tabs (Temporary Manager, Role Permissions) -->
    <div class="settings-tabs" style="margin-top: 12px;">
        <ul class="settings-nav-tabs" role="tablist" style="display:flex; gap:24px; list-style:none; padding:0; margin:0 0 16px 0; border-bottom:1px solid #e9ecef;">
            <li class="settings-tab active" role="presentation" style="padding-bottom:12px;">
                <a href="#temporary-manager" role="tab" aria-selected="true" style="text-decoration:none; color:#D9BD7D; font-weight:600; padding-bottom:6px; border-bottom:3px solid #D9BD7D; display:inline-block;">Temporary Manager</a>
            </li>
            <li class="settings-tab" role="presentation" style="padding-bottom:12px;">
                <a href="#users" role="tab" aria-selected="false" style="text-decoration:none; color:#6c757d; display:inline-block;">Users</a>
            </li>
        </ul>
    </div>
    <div class="settings-tab-panels">
        <div id="temporary-manager" role="tabpanel" aria-hidden="false">
    <style>
        /* Slightly smaller form controls for settings page */
        .settings-page .form-group label {
            font-size: 0.95rem;
        }
        .settings-page select,
        .settings-page input {
            font-size: 0.95rem;
            padding: 6px 8px;
            height: 34px;
        }
        .settings-page .btn {
            padding: 6px 10px;
            font-size: 0.95rem;
        }
        .settings-page .card-header h4 {
            font-size: 1rem;
        }
        .settings-page .card-body {
            overflow: visible;
        }
        .settings-page table {
            font-size: 0.95rem;
        }
        .settings-page .intro-paragraph {
            padding-bottom: 12px;
        }
        /* Header background color for cards - slightly lighter */
        .dashboard-container.settings-page div.card > .card-header,
        .dashboard-container.settings-page .card .card-header {
            background: #EFE9C6 !important;
            color: #1f1f1f !important;
            padding: 10px 12px !important;
            /* Ensure both upper corners are rounded for header containers */
            border-top-left-radius: 0.375rem !important;
            border-top-right-radius: 0.375rem !important;
        }
        /* Make Save button green and force override of global .btn-save */
        .settings-page .btn-save {
            background: #198754 !important;
            border-color: #198754 !important;
            color: #ffffff !important;
            background-image: none !important;
        }
        .settings-page .btn-save:hover {
            background: #157347 !important;
            border-color: #157347 !important;
        }
        /* Unassign button color to match brand */
        .settings-page .btn-unassign {
            background-color: #D9BD7D !important;
            border-color: #D9BD7D !important;
            color: #1f1f1f !important;
        }
        .settings-page .btn-unassign:hover {
            background-color: #c8ac65 !important;
            border-color: #c8ac65 !important;
            color: #1f1f1f !important;
        }
        /* Replicate Branch Name dropdown styles from new_request.html with high specificity */
        .settings-page .manager-select-container {
            position: relative;
        }
        .settings-page .manager-chips-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 0;
            min-height: 0;
        }
        .settings-page .manager-chips-container:not(:empty) {
            margin-bottom: 8px;
        }
        .settings-page .branch-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #000;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        .settings-page .branch-chip .remove-chip {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            transition: background 0.2s;
            line-height: 1;
        }
        .settings-page .branch-chip .remove-chip:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .settings-page .branch-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #ffffff !important;
            border: 1px solid #ced4da !important;
            border-top: none !important;
            border-radius: 0 0 0.375rem 0.375rem !important;
            max-height: 200px;
            overflow-y: auto;
            /* lowered z-index so the sidebar can overlay the dropdown when it opens */
            z-index: 1200 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        /* Assignment search input rounded styling */
        .settings-page .assign-search-field {
            width: 100%;
        }
        .settings-page .assign-search-input {
            border-radius: 999px !important;
            border: 1px solid #ced4da !important;
            transition: border-color 0.12s ease, box-shadow 0.12s ease;
            height: 38px;
        }
        .settings-page .assign-search-input:focus {
            outline: none !important;
            border-color: #D9BD7D !important;
            box-shadow: 0 0 0 0.18rem rgba(217,189,125,0.15) !important;
        }
        .settings-page .assign-search-icon {
            width: 20px !important;
            height: 20px !important;
            background: #ffffff;
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
            cursor: pointer;
        }
        .settings-page .branch-group {
            background-color: #f8f9fa !important;
            padding: 8px 12px !important;
            font-weight: bold !important;
            color: #495057 !important;
            border-bottom: 1px solid #dee2e6 !important;
            font-size: 12px !important;
            text-transform: uppercase !important;
        }
        .settings-page .branch-option {
            padding: 8px 20px !important;
            cursor: pointer !important;
            border-bottom: 1px solid #f1f3f4 !important;
            transition: background-color 0.15s !important;
            -webkit-tap-highlight-color: transparent !important;
            touch-action: manipulation !important;
            user-select: none !important;
            background: transparent !important;
            color: #212529 !important;
        }
        .settings-page .branch-option:hover {
            background-color: #e9ecef !important;
        }
        .settings-page .branch-option.selected {
            background-color: #007bff !important;
            color: white !important;
        }
        .settings-page .branch-option.hidden {
            display: none !important;
        }
        /* Ensure native select dropdowns are not clipped and appear below the field */
        .dashboard-container.settings-page .card {
            overflow: visible !important;
            /* Round bottom-left corner for card containers on settings page */
            border-bottom-left-radius: 0.375rem !important;
        }
        .dashboard-container.settings-page .card .card-body {
            overflow: visible !important;
        }
        .settings-page select {
            position: relative;
            z-index: auto;
        }
        /* ensure manager search input doesn't float above the sidebar */
        .settings-page #manager_search {
            position: relative;
            z-index: auto;
        }
        /* Table styling will reuse global dashboard .data-table styles for consistency */
        /* Make table columns equal width */
        .settings-page .data-table {
            table-layout: fixed !important;
        }
        .settings-page .data-table th,
        .settings-page .data-table td {
            width: 20% !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            text-align: left !important;
            padding: 12px 16px !important;
        }
        /* Narrow checkbox column in Users table */
        .user-management-settings .data-table th:first-child,
        .user-management-settings .data-table td:first-child {
            width: 40px !important;
            padding: 8px !important;
            text-align: center !important;
        }
        .user-management-settings .user-checkbox {
            width: 18px !important;
            height: 18px !important;
        }
        /* Narrow ID column (second column) */
        .user-management-settings .data-table th:nth-child(2),
        .user-management-settings .data-table td:nth-child(2) {
            width: 60px !important;
            padding: 8px !important;
            text-align: center !important;
        }
    </style>
    <style>
        /* Normalize dropdown item font/icon sizing so Edit User matches others */
        .user-management-settings .action-dropdown .dropdown-item {
            font-size: 13px !important;
            font-weight: 500 !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            padding: 10px 12px !important;
            color: #212529 !important;
        }
        .user-management-settings .action-dropdown .dropdown-item i {
            font-size: 12px !important;
            width: 16px !important;
            text-align: center !important;
        }
        /* Dropdown item hover */
        .user-management-settings .action-dropdown .dropdown-item:hover {
            background: #f8f9fa;
        }
    </style>
    <style>
        /* Users panel: make container background white and style Add New User button */
        .user-management-settings .card {
            background: #ffffff !important;
        }
        .user-management-settings .card-header .card-header-actions .btn-primary {
            background: #D9BD7D !important;
            border-color: #D9BD7D !important;
            color: #ffffff !important;
        }
        .user-management-settings .card-header .card-header-actions .btn-primary:hover {
            background: #c8ac65 !important;
            border-color: #c8ac65 !important;
            color: #ffffff !important;
        }
        /* Make the card header (heading container) white.
           Use a higher-specificity selector to override other settings-page rules. */
        .dashboard-container.settings-page .user-management-settings div.card > .card-header {
            background: #ffffff !important;
            color: #333333 !important;
            border-bottom: 1px solid #e9ecef !important;
        }
        .dashboard-container.settings-page .user-management-settings div.card > .card-header h2 {
            color: #333333 !important;
        }
    </style>
    <style>
        /* Make action buttons in Users table more compact and match dashboard table style */
        .user-management-settings .data-table .btn-sm {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            padding: 6px 8px !important;
            font-size: 12px !important;
            height: 32px !important;
            line-height: 1 !important;
            border-radius: 6px !important;
            white-space: nowrap !important;
        }
        .user-management-settings .data-table .btn-sm i {
            font-size: 12px !important;
            margin: 0 6px 0 0 !important;
        }
        /* Make delete button icon-sized and outlined like dashboard */
        .user-management-settings .data-table .btn-sm.btn-danger {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 32px !important;
            height: 32px !important;
            padding: 0 !important;
            background: transparent !important;
            border: 1px solid #dc3545 !important;
            color: #dc3545 !important;
            border-radius: 6px !important;
            font-size: 12px !important;
        }
        .user-management-settings .data-table .btn-sm.btn-danger i {
            margin: 0 !important;
            font-size: 12px !important;
        }
    </style>
    <style>
        /* Ensure table wrapper doesn't clip dropdowns in Users panel */
        .user-management-settings .table-responsive {
            overflow: visible !important;
        }
        /* Slightly raise dropdown z-index to appear above other elements */
        .user-management-settings .action-dropdown {
            z-index: 1400 !important;
        }
    </style>

    <div class="card" style="margin-top: 1rem;">
        <div class="card-header">
            <h4>Department-level Temporary Manager</h4>
        </div>
        <div class="card-body">
            <p class="intro-paragraph">This allows assigning a temporary manager responsible for approving all payment and item requests for a whole department.</p>
            <form method="POST" action="{{ url_for('settings') }}">
                <div class="form-row">
                    <div class="form-group" style="min-width: 240px;">
                        <label for="department">Department</label>
                        <select name="department" id="department" required>
                            <option value="">-- Select Department --</option>
                            {% for dept in departments %}
                            <option value="{{ dept }}">{{ dept }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-row" style="margin-top: 0.75rem;">
                    <div class="form-group" style="min-width: 280px;">
                        <label for="temporary_manager_id">Temporary Manager</label>
                        <div class="branch-select-container manager-select-container">
                            <div id="manager_chips_container" class="branch-chips-container"></div>
                            <input type="text" id="manager_search" class="form-control" placeholder="Search users..." autocomplete="off">
                            <select name="temporary_manager_id" id="temporary_manager_id" class="form-control" style="display: none;">
                                <option value="">-- Select Temporary Manager --</option>
                                {% set current_dept = None %}
                                {% for u in managers %}
                                    {% set dept = u.department or 'Unknown' %}
                                    {# Skip users belonging to the 'Branch' department #}
                                    {% if dept != 'Branch' %}
                                        {% if dept != current_dept %}
                                            {% if current_dept is not none %}
                                                </optgroup>
                                            {% endif %}
                                            <optgroup label="{{ dept }}" data-department="{{ dept }}">
                                            {% set current_dept = dept %}
                                        {% endif %}
                                        <option value="{{ u.user_id }}" data-department="{{ dept }}">{{ u.name }} ({{ u.role }})</option>
                                    {% endif %}
                                {% endfor %}
                                {% if current_dept is not none %}
                                    </optgroup>
                                {% endif %}
                            </select>
                            <div id="manager_dropdown" class="branch-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 12px;">
                    <button type="submit" class="btn btn-save"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card" style="margin-top: 1rem;">
        <div class="card-header">
            <h4>Current Department Temporary Manager Assignments</h4>
        </div>
        <div class="card-body">
            {% if assignments %}
            <div style="margin-bottom:10px; width:100%;">
                <div class="assign-search-field" style="position:relative; width:100%;">
                    <img src="{{ url_for('static', filename='css/icons/search.svg') }}" class="assign-search-icon" alt="Search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%);" onclick="document.getElementById('assignment_search').focus();" >
                    <input type="search" id="assignment_search" class="form-control assign-search-input" placeholder="Search by department or temporary manager name" aria-label="Search assignments" style="padding-left:44px; width:100%;">
                </div>
            </div>
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Department</th>
                            <th>Temporary Manager</th>
                            <th>Set By</th>
                            <th>Set At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dept, entry in assignments.items()|sort %}
                        <tr>
                            <td>{{ dept }}</td>
                            <td>{{ entry.temporary_manager.name if entry.temporary_manager else entry.temporary_manager_id }}</td>
                            <td>{{ entry.set_by_user.name if entry.set_by_user else '' }}</td>
                            <td>
                                {% if entry.set_at %}
                                    {{ utc_to_local(entry.set_at).strftime('%Y-%m-%d %H:%M:%S') }}
                                {% else %}
                                   
                                {% endif %}
                            </td>
                            <td>
                                <form method="POST" action="{{ url_for('unassign_temp_manager') }}" style="display:inline;">
                                    <input type="hidden" name="department" value="{{ dept }}">
                                    <button type="submit" class="btn btn-sm btn-unassign" onclick="return confirm('Unassign temporary manager for {{ dept }}?')">
                                        <i class="fas fa-user-slash"></i> Unassign
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p>No department-level temporary managers assigned.</p>
            {% endif %}
        </div>
    </div>
    <script>
    // Client-side search for Current Department Temporary Manager Assignments
    (function(){
        function normalizeText(s){ return (s||'').toString().toLowerCase().trim(); }
        document.addEventListener('DOMContentLoaded', function(){
            var input = document.getElementById('assignment_search');
            if(!input) return;
            var table = input.closest('.card-body').querySelector('table.data-table');
            if(!table) return;
            var tbody = table.tBodies[0];
            var rows = Array.from(tbody.querySelectorAll('tr'));
            input.addEventListener('input', function(){
                var q = normalizeText(this.value);
                var anyVisible = false;
                rows.forEach(function(r){
                    var dept = normalizeText(r.cells[0] && r.cells[0].textContent);
                    var mgr  = normalizeText(r.cells[1] && r.cells[1].textContent);
                    if(!q || dept.indexOf(q) !== -1 || mgr.indexOf(q) !== -1){
                        r.style.display = '';
                        anyVisible = true;
                    } else {
                        r.style.display = 'none';
                    }
                });
                // Optional: show "no results" message
                var noMsgId = 'assignments_no_results';
                var existing = document.getElementById(noMsgId);
                if(!anyVisible && q){
                    if(!existing){
                        var p = document.createElement('div');
                        p.id = noMsgId;
                        p.style.marginTop = '8px';
                        p.style.color = '#666';
                        p.textContent = 'No matching assignments.';
                        table.parentNode.appendChild(p);
                    }
                } else {
                    if(existing) existing.parentNode.removeChild(existing);
                }
            });
        });
    })();
    </script>
    <script>
    // Edit Permissions side panel frontend behavior (no backend yet)
    (function(){
        function closeAllDeptPanels() {
            document.querySelectorAll('.perm-dept-panel').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.perm-dept-toggle').forEach(t => t.setAttribute('aria-expanded','false'));
        }

        document.addEventListener('click', function(e){
            // noop
        });

        window.openEditPermissions = function(userId) {
            // Store the user ID being edited
            window.__editingUserId = userId;
            
            // Optionally populate header with user info if desired
            var userNameElem = document.getElementById('permPanelUserName');
            var userEmailElem = document.getElementById('permPanelUserEmail');
            if (userNameElem && userEmailElem) {
                // Try to find the user row in the table for display
                var row = document.querySelector('.user-checkbox[value="' + userId + '"]');
                if (row) {
                    var tr = row.closest('tr');
                    var nameCell = tr && tr.querySelectorAll('td')[2];
                    var deptCell = tr && tr.querySelectorAll('td')[3];
                    var emailCell = tr && tr.querySelectorAll('td')[5];
                    if (nameCell) userNameElem.textContent = nameCell.textContent.trim();
                    var deptText = deptCell ? deptCell.textContent.trim() : '';
                    var emailText = emailCell ? (emailCell.textContent || '').trim() : '';
                    userEmailElem.textContent = deptText + (deptText && emailText ? ' | ' + emailText : (emailText ? emailText : ''));
                } else {
                    userNameElem.textContent = 'User #' + userId;
                    userEmailElem.textContent = '';
                }
            }

            var backdrop = document.getElementById('permissionsBackdrop');
            var panel = document.getElementById('permissionsPanel');
            if (backdrop) backdrop.style.display = 'block';
            if (panel) panel.style.transform = 'translateX(0)';
            // close dept panels initially
            closeAllDeptPanels();
            // also close any open action dropdowns so they don't overlap the panel
            try {
                document.querySelectorAll('.action-dropdown').forEach(function(d){
                    // Blur any focused elements inside the dropdown before hiding
                    var activeEl = document.activeElement;
                    if (activeEl && d.contains(activeEl) && activeEl.blur) {
                        activeEl.blur();
                    }
                    // Also check for any focusable elements that might have focus
                    var focused = d.querySelector(':focus');
                    if (focused && focused.blur) focused.blur();
                    d.style.display = 'none';
                    d.setAttribute('aria-hidden','true');
                });
                document.querySelectorAll('.action-ellipsis-btn').forEach(function(b){
                    b.setAttribute('aria-expanded','false');
                });
            } catch(e){}
            // prevent background scrolling while panel is open
            try {
                window.__prevBodyOverflow = document.body.style.overflow;
                document.body.style.overflow = 'hidden';
                // Prevent touchmove on iOS
                window.__permissionsTouchHandler = function(ev){ ev.preventDefault(); };
                document.addEventListener('touchmove', window.__permissionsTouchHandler, { passive: false });
            } catch (e) {}
            
            // Fetch and populate permissions for this user
            if (window.fetchPermissionsForUser) {
                window.fetchPermissionsForUser(userId);
            }
        };

        window.closeEditPermissions = function() {
            var backdrop = document.getElementById('permissionsBackdrop');
            var panel = document.getElementById('permissionsPanel');
            if (backdrop) backdrop.style.display = 'none';
            if (panel) panel.style.transform = 'translateX(calc(100% + 32px))';
            // restore background scrolling
            try {
                if (window.__prevBodyOverflow !== undefined) {
                    document.body.style.overflow = window.__prevBodyOverflow;
                    delete window.__prevBodyOverflow;
                } else {
                    document.body.style.overflow = '';
                }
                if (window.__permissionsTouchHandler) {
                    document.removeEventListener('touchmove', window.__permissionsTouchHandler, { passive: false });
                    delete window.__permissionsTouchHandler;
                }
            } catch (e) {}
            // Clear the editing user ID
            window.__editingUserId = null;
        };

        document.addEventListener('DOMContentLoaded', function(){
            // backdrop click closes
            var backdrop = document.getElementById('permissionsBackdrop');
            if (backdrop) backdrop.addEventListener('click', closeEditPermissions);

            // dept toggles
            document.querySelectorAll('.perm-dept-toggle').forEach(function(btn){
                btn.addEventListener('click', function(){
                    var idx = btn.getAttribute('data-dept');
                    var panel = document.getElementById('perm-panel-' + idx);
                    if (!panel) return;
                    var expanded = btn.getAttribute('aria-expanded') === 'true';
                    if (expanded) {
                        panel.style.display = 'none';
                        btn.setAttribute('aria-expanded','false');
                        btn.querySelector('.perm-toggle-caret').style.transform = 'rotate(0deg)';
                    } else {
                        panel.style.display = 'block';
                        btn.setAttribute('aria-expanded','true');
                        btn.querySelector('.perm-toggle-caret').style.transform = 'rotate(180deg)';
                    }
                });
            });
        });
    })();
    </script>
    <script>
    // Improved action dropdown behavior: portal dropdowns to body and position absolutely
    (function(){
        function closeAllActionDropdowns() {
            document.querySelectorAll('.action-dropdown').forEach(function(d){
                // Blur any focused elements inside the dropdown before hiding
                var activeEl = document.activeElement;
                if (activeEl && d.contains(activeEl) && activeEl.blur) {
                    activeEl.blur();
                }
                // Also check for any focusable elements that might have focus
                var focused = d.querySelector(':focus');
                if (focused && focused.blur) focused.blur();
                d.style.display = 'none';
                d.setAttribute('aria-hidden','true');
            });
            document.querySelectorAll('.action-ellipsis-btn').forEach(function(b){
                b.setAttribute('aria-expanded','false');
            });
        }

        // Utility to portal a menu element to body and position it under the trigger button
        function openPortalMenu(btn, menu) {
            // Create placeholder if not already created
            if (!menu.__placeholder) {
                menu.__placeholder = document.createComment('action-dropdown-placeholder');
                menu.__originalParent = menu.parentNode;
                menu.__originalParent.insertBefore(menu.__placeholder, menu);
                document.body.appendChild(menu);
                menu.__ported = true;
            } else if (menu.__originalParent && !menu.__originalParent.contains(menu)) {
                document.body.appendChild(menu);
            }

            // Temporarily show to measure
            menu.style.position = 'absolute';
            menu.style.display = 'block';
            menu.style.visibility = 'hidden';
            menu.style.left = '0px';
            menu.style.top = '0px';
            menu.style.zIndex = 2000;

            var rect = btn.getBoundingClientRect();
            var mw = menu.offsetWidth;
            var left = rect.right + window.scrollX - mw;
            // prefer aligning right edge of menu with button, but avoid off-screen
            if (left < 8) left = rect.left + window.scrollX;
            var top = rect.bottom + window.scrollY + 6;

            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.visibility = 'visible';
            menu.setAttribute('aria-hidden','false');
            btn.setAttribute('aria-expanded','true');
        }

        document.addEventListener('click', function(ev){
            // Close dropdown if click outside any action-menu-container or any portaled menu
            if (!ev.target.closest('.action-menu-container') && !ev.target.closest('.action-dropdown')) {
                closeAllActionDropdowns();
            }
        }, true);

        document.addEventListener('keydown', function(ev){
            if (ev.key === 'Escape') closeAllActionDropdowns();
        });

        document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('.action-ellipsis-btn').forEach(function(btn){
                btn.addEventListener('click', function(e){
                    e.stopPropagation();
                    var userId = btn.getAttribute('data-user-id');
                    if (!userId) return;
                    // find the menu by data-user-id (works even after portaling to body)
                    var menu = document.querySelector('.action-dropdown[data-user-id="' + userId + '"]');
                    if (!menu) return;
                    var isOpen = menu.style.display === 'block' && menu.getAttribute('aria-hidden') === 'false';
                    if (isOpen) {
                        closeAllActionDropdowns();
                        return;
                    }
                    closeAllActionDropdowns();
                    openPortalMenu(btn, menu);
                });
            });
        });
    })();
    </script>
    <script>
    // Initialize a grouped searchable dropdown for managers (single selection)
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('manager_search');
        const hiddenSelect = document.getElementById('temporary_manager_id');
        const dropdown = document.getElementById('manager_dropdown');

        if (!searchInput || !hiddenSelect || !dropdown) return;

        function buildDropdown() {
            dropdown.innerHTML = '';
            const options = hiddenSelect.querySelectorAll('option');
            let currentGroup = null;
            options.forEach(option => {
                if (option.value === '') return;
                const dept = option.getAttribute('data-department') || 'Other';
                if (!currentGroup || currentGroup !== dept) {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'branch-group';
                    groupDiv.textContent = dept;
                    groupDiv.setAttribute('data-department', dept);
                    dropdown.appendChild(groupDiv);
                    currentGroup = dept;
                }
                const optionDiv = document.createElement('div');
                optionDiv.className = 'branch-option';
                optionDiv.textContent = option.textContent;
                optionDiv.setAttribute('data-value', option.value);
                optionDiv.setAttribute('data-department', dept);
                optionDiv.addEventListener('mousedown', function(e){
                    e.preventDefault();
                    selectManager(option.value, option.textContent);
                }, { passive: false });
                dropdown.appendChild(optionDiv);
            });
            // reset scroll to top whenever we rebuild the dropdown
            dropdown.scrollTop = 0;
        }

        function filterManagers(term) {
            const options = dropdown.querySelectorAll('.branch-option');
            const groups = dropdown.querySelectorAll('.branch-group');
            let hasVisible = false;
            options.forEach(opt => {
                const txt = opt.textContent.toLowerCase();
                if (txt.includes(term.toLowerCase())) {
                    opt.classList.remove('hidden');
                    hasVisible = true;
                } else {
                    opt.classList.add('hidden');
                }
            });
            groups.forEach(group => {
                const dept = group.getAttribute('data-department');
                const hasInGroup = Array.from(options).some(o => o.getAttribute('data-department') === dept && !o.classList.contains('hidden'));
                group.style.display = hasInGroup ? 'block' : 'none';
            });
            dropdown.style.display = hasVisible ? 'block' : 'none';
        }

        function selectManager(value, text) {
            hiddenSelect.value = value;
            searchInput.value = text;
            dropdown.style.display = 'none';
        }

        searchInput.addEventListener('input', function() {
            const term = this.value.trim();
            if (term.length === 0) {
                dropdown.querySelectorAll('.branch-option').forEach(o=>o.classList.remove('hidden'));
                dropdown.querySelectorAll('.branch-group').forEach(g=>g.style.display='block');
                dropdown.style.display = 'block';
                // reset scroll to top when reopening to default state
                dropdown.scrollTop = 0;
            } else {
                filterManagers(term);
            }
        });

        searchInput.addEventListener('focus', function() {
            dropdown.style.display = 'block';
            // always open at the top when focusing/opening
            dropdown.scrollTop = 0;
        });
        searchInput.addEventListener('blur', function() {
            setTimeout(()=> dropdown.style.display='none', 150);
        });
        buildDropdown();
        // Pre-fill search input if there is current value
        if (hiddenSelect.value) {
            const sel = hiddenSelect.querySelector(`option[value="${hiddenSelect.value}"]`);
            if (sel) searchInput.value = sel.textContent;
        }
    });
    </script>
        </div>
        <div id="users" role="tabpanel" aria-hidden="true" style="display:none; margin-top: 1rem;">
            {% set users_list = users if users is defined and users else managers if managers is defined else [] %}
            <div class="user-management-settings">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> All Users</h2>
                        <div class="card-header-actions">
                            <a href="{{ url_for('new_user') }}" class="btn btn-primary">
                                <i class="fas fa-user-plus"></i> Add New User
                            </a>
                        </div>
                    </div>
                    
                    <!-- Search Bar positioned below the header -->
                    <div class="search-bar-container" style="margin: 12px 0;">
                        <div class="search-form">
                            <div class="search-input-container" style="position:relative; display:flex; align-items:center;">
                                <i class="fas fa-search search-icon" style="position:absolute; left:12px; color:#6c757d;"></i>
                                <input type="text" class="form-control" id="userSearch" placeholder="Search users by name, department, or role..." style="padding-left:38px;">
                                <button type="button" class="clear-search-btn" id="clearSearch" style="display: none; margin-left:8px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="search-results-info" id="searchResultsInfo" style="display: none; margin-top:8px; color:#666;">
                            <i class="fas fa-info-circle"></i>
                            <span id="searchResultsText" style="margin-left:6px;"></span>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        {% if users_list %}
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes()"></th>
                                            <th>ID</th>
                                            <th>Full Name</th>
                                            <th>Department</th>
                                            <th>Role</th>
                                            <th>Email</th>
                                            <th>Account Status</th>
                                            <th>Created At</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for u in users_list %}
                                        <tr {% if u.account_locked %}class="locked-account" style="background-color: #fff3cd;"{% endif %}>
                                            <td><input type="checkbox" class="user-checkbox" value="{{ u.user_id }}" onchange="updateSelectAllState()" {% if u.user_id == current_user.user_id %}disabled{% endif %}></td>
                                            <td>{{ u.user_id }}</td>
                                            <td>{{ u.name }}</td>
                                            <td>{{ u.department }}</td>
                                            <td><span class="badge badge-primary">{{ u.role }}</span></td>
                                            <td>{{ u.email or 'N/A' }}</td>
                                            <td>
                                                {% if u.account_locked %}
                                                    <span class="badge badge-danger">
                                                        <i class="fas fa-lock"></i> LOCKED
                                                    </span>
                                                    <small style="display: block; margin-top: 0.25rem;">
                                                        Failed attempts: {{ u.failed_login_attempts or 0 }}
                                                    </small>
                                                {% else %}
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check-circle"></i> Active
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
                                            <td style="white-space: nowrap; position: relative;">
                                                <div class="action-menu-container" style="position: relative; display: inline-block;">
                                                    <button type="button" class="btn action-ellipsis-btn btn-view-outline" aria-haspopup="true" aria-expanded="false" data-user-id="{{ u.user_id }}" title="Actions">
                                                        <i class="fas fa-ellipsis-h"></i>
                                                    </button>

                                                    <div class="action-dropdown" data-user-id="{{ u.user_id }}" role="menu" aria-hidden="true" style="display:none; position: absolute; right: 0; top: 38px; min-width: 180px; background: #fff; border: 1px solid #e9ecef; border-radius: 6px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); z-index: 1200;">
                                                        <a class="dropdown-item" role="menuitem" href="{{ url_for('edit_user', user_id=u.user_id) }}" style="display:block; padding:10px 12px; color:#212529; text-decoration:none;">
                                                            <i class="fas fa-edit" style="margin-right:8px;"></i> Edit User
                                                        </a>
                                                        <button type="button" class="dropdown-item" role="menuitem" onclick="showResetPasswordModal({{ u.user_id }}, '{{ u.username }}', '{{ u.name }}')" style="display:block; width:100%; padding:10px 12px; background:none; border:none; text-align:left; color:#212529; cursor:pointer;">
                                                            <i class="fas fa-key" style="margin-right:8px;"></i> Reset Password
                                                        </button>
                                                        {% if u.user_id != current_user.user_id %}
                                                        <form method="POST" action="{{ url_for('delete_user', user_id=u.user_id) }}" class="dropdown-delete-form" onsubmit="return confirm('Are you sure you want to delete user {{ u.name }}?')" style="margin:0;">
                                                            <button type="submit" class="dropdown-item" role="menuitem" style="display:block; width:100%; padding:10px 12px; background:none; border:none; text-align:left; color:#dc3545; cursor:pointer;">
                                                                <i class="fas fa-trash" style="margin-right:8px;"></i> Delete User
                                                            </button>
                                                        </form>
                                                        {% else %}
                                                        <div class="dropdown-item" style="display:block; padding:10px 12px; color:#6c757d;">Current User</div>
                                                        {% endif %}
                                                        <button type="button" class="dropdown-item" role="menuitem" onclick="openEditPermissions({{ u.user_id }})" style="display:block; width:100%; padding:10px 12px; background:none; border:none; text-align:left; color:#212529; cursor:pointer;">
                                                            <i class="fas fa-user-shield" style="margin-right:8px;"></i> Edit Permissions
                                                        </button>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="empty-state" style="color:#666; text-align:center; padding:18px;">
                                <i class="fas fa-users" style="font-size:2rem;"></i>
                                <p>No users found.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Password Reset Modal -->
                <div id="resetPasswordModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5);">
                    <div style="background-color: #fefefe; margin: 6% auto; padding: 20px; border: 1px solid #888; width: 500px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;"><i class="fas fa-key"></i> Reset User Password</h3>
                            <button onclick="closeResetPasswordModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <form method="POST" id="resetPasswordForm" onsubmit="return validatePasswordReset()">
                            <div style="margin-bottom: 15px;">
                                <p><strong>User:</strong> <span id="modalUserName"></span> (<span id="modalUserEmail"></span>)</p>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="newPassword" style="display: block; margin-bottom: 5px; font-weight: 600;">New Password:</label>
                                <div class="password-input-container" style="position:relative;">
                                    <input type="password" id="newPassword" name="new_password" class="form-control" required minlength="6" placeholder="Enter new password (min. 6 characters)" style="padding-right: 3rem;">
                                    <button type="button" class="password-toggle-btn" id="newPassword-toggle" aria-label="Toggle password visibility" style="position:absolute; right:6px; top:6px; background:none; border:none;">
                                        <i class="fas fa-eye" id="newPassword-toggle-icon"></i>
                                    </button>
                                </div>
                                <small style="color: #666; display: block; margin-top: 5px;">Minimum 6 characters required</small>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label for="confirmPassword" style="display: block; margin-bottom: 5px; font-weight: 600;">Confirm Password:</label>
                                <div class="password-input-container" style="position:relative;">
                                    <input type="password" id="confirmPassword" class="form-control" required minlength="6" placeholder="Confirm new password" style="padding-right: 3rem;">
                                    <button type="button" class="password-toggle-btn" id="confirmPassword-toggle" aria-label="Toggle password visibility" style="position:absolute; right:6px; top:6px; background:none; border:none;">
                                        <i class="fas fa-eye" id="confirmPassword-toggle-icon"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 10px; margin-bottom: 15px;">
                                <p style="margin: 0; font-size: 0.9rem;"><i class="fas fa-exclamation-triangle"></i> <strong>Note:</strong> This will reset the user's password and unlock their account if it's locked. The user will be notified.</p>
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                <button type="button" onclick="closeResetPasswordModal()" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-key"></i> Reset Password
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Edit Permissions Side Panel (frontend only) -->
                <div id="permissionsBackdrop" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:1999;"></div>
                <style>
                    /* Permissions panel header button sizing and colors */
                    #permissionsPanel .permissions-header .btn {
                        padding: 6px 8px !important;
                        font-size: 0.95rem !important;
                        border-radius: 6px !important;
                    }
                    #permissionsPanel .permissions-header .btn-outline {
                        background: none !important;
                        border: 1px solid #e9ecef !important;
                        color: #222 !important;
                        padding: 6px 8px !important;
                    }
                    #permissionsPanel .permissions-header .btn-primary {
                        background: #28a745 !important;
                        border-color: #28a745 !important;
                        color: #ffffff !important;
                        padding: 6px 10px !important;
                    }
                    #permissionsPanel .permissions-header .btn-primary:hover {
                        background: #218838 !important;
                        border-color: #1e7e34 !important;
                    }
                </style>
                <style>
                    /* Reduce typography inside the permissions panel body (keep header intact) */
                    #permissionsPanel .permissions-body,
                    #permissionsPanel .permissions-body p,
                    #permissionsPanel .permissions-list,
                    #permissionsPanel .permissions-list .data-table,
                    #permissionsPanel .permissions-list .data-table th,
                    #permissionsPanel .permissions-list .data-table td,
                    #permissionsPanel .permissions-list .data-table thead th {
                        font-size: 0.92rem !important;
                        color: #333 !important;
                    }
                    /* Slightly reduce padding for table cells to fit more lines */
                    #permissionsPanel .permissions-list .data-table th,
                    #permissionsPanel .permissions-list .data-table td {
                        padding: 8px 10px !important;
                    }
                    /* Make radio inputs a bit smaller */
                    #permissionsPanel input[type="radio"] {
                        width: 16px !important;
                        height: 16px !important;
                    }
                </style>
                <style>
                    /* Left-align the Scope column header and cells in the permissions table */
                    #permissionsPanel .permissions-list .data-table th:first-child,
                    #permissionsPanel .permissions-list .data-table td:first-child {
                        text-align: left !important;
                        padding-left: 14px !important;
                    }
                </style>
                <div id="permissionsPanel" class="permissions-sidepanel" style="position:fixed; right:16px; top:16px; bottom:16px; width:720px; max-width:calc(100% - 32px); transform:translateX(calc(100% + 32px)); transition: transform 0.28s ease; background:#fff; z-index:2000; box-shadow: -8px 0 32px rgba(13,12,18,0.12); border-radius:12px; overflow:hidden;">
                    <div class="permissions-header" style="display:flex; align-items:center; justify-content:space-between; padding:18px; border-bottom:1px solid #e9ecef;">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <div>
                                <div id="permPanelUserName" style="font-weight:700; color:#222;">User</div>
                                <div id="permPanelUserEmail" style="color:#666; font-size:0.9rem;">Department | email@example.com</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button type="button" class="btn btn-outline" onclick="closeEditPermissions()" style="background:none; border:1px solid #e9ecef; padding:8px 10px; border-radius:6px;">Close</button>
                            <button type="button" class="btn btn-primary" onclick="savePermissions()" style="background:#28a745; border-color:#28a745; color:#fff; padding:6px 10px; border-radius:6px;">Save</button>
                        </div>
                    </div>

                    <div class="permissions-body" style="overflow:auto; height: calc(100% - 72px); padding: 16px 18px;">
                        <p style="color:#666; margin-bottom:12px;">Set this user's permissions across the system. Choose the level for each permission.</p>

                        {% set permission_groups = [
                            {'group':'Requests & Approvals', 'perms':[
                                'View Requests',
                                'Create Requests',
                                'Edit Own Requests',
                                'Approve as Manager',
                                'Approve as Procurement',
                                'Approve as Finance',
                                'Assign Temporary Manager'
                            ]},
                            {'group':'Payments & Finance', 'perms':[
                                'Schedule Payment',
                                'Mark Payment Completed',
                                'Upload Payment Proof',
                                'Issue Refunds',
                                'Access Financial Reports'
                            ]},
                            {'group':'Procurement & Items', 'perms':[
                                'Create Item Request',
                                'Assign to Procurement',
                                'Finalize Procurement',
                                'Manage Supplier Records'
                            ]},
                            {'group':'Users, Roles & Access', 'perms':[
                                'View Users',
                                'Create Users',
                                'Edit Users',
                                'Delete Users',
                                'Manage Roles',
                                'Manage Department Assignments'
                            ]},
                            {'group':'Notifications & Communication', 'perms':[
                                'View Notifications',
                                'Manage Notification Settings',
                                'Send System Announcements',
                                'Subscribe to Alerts'
                            ]},
                            {'group':'Profiles & Account', 'perms':[
                                'Edit Own Profile',
                                'Edit Other Profiles',
                                'Reset User Password',
                                'Unlock User Account'
                            ]},
                            {'group':'Settings & System', 'perms':[
                                'Manage System Settings',
                                'Manage API Keys',
                                'Manage Integrations',
                                'Configure Email/SMTP'
                            ]},
                            {'group':'Reporting & Export', 'perms':[
                                'View Reports',
                                'Export Data (CSV/XLS)',
                                'Access Audit Logs'
                            ]}
                        ] %}

                        <div class="permissions-list" style="display:flex; flex-direction:column; gap:12px;">
                            <div style="overflow:auto;">
                                <table class="data-table" style="width:100%; border-collapse:collapse;">
                                    <thead>
                                <tr>
                                    <th style="text-align:left; padding:10px 12px; min-width:220px;">Scope</th>
                                    <th style="text-align:center; padding:10px 12px; width:140px;">Full Access</th>
                                </tr>
                                    </thead>
                                    <tbody>
                                        {% for group in permission_groups %}
                                        <tr style="background:#f8f9fa;">
                                            <td colspan="2" style="padding:10px 12px; font-weight:700; text-align:left !important;">
                                                <span>{{ group.group }}</span>
                                                <a href="#" class="select-all-group" data-group="{{ loop.index0 }}" style="float:right; font-weight:600; color:#6c757d; text-decoration:none;">Select all</a>
                                            </td>
                                        </tr>
                                        {% set group_idx = loop.index0 %}
                                        {% for perm in group.perms %}
                                        <tr data-group="{{ group_idx }}">
                                            <td style="padding:10px 12px;">{{ perm }}</td>
                                            {% set key = perm|lower|replace(' ', '_') %}
                                            <td style="text-align:center; padding:8px 12px;">
                                                <label class="perm-toggle" style="display:inline-block; cursor:pointer;">
                                                    <input type="checkbox" name="perm_full_{{ key }}" style="display:none;" aria-label="Full access">
                                                    <span class="perm-switch" style="display:inline-block; width:44px; height:24px; background:#e9ecef; border-radius:999px; position:relative; vertical-align:middle;">
                                                        <span class="perm-knob" style="position:absolute; top:3px; left:3px; width:18px; height:18px; background:white; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,0.15); transition: left 0.18s;"></span>
                                                    </span>
                                                </label>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Role defaults and Overrides -->
                        <div style="margin-top:18px; border-top:1px solid #eef0f2; padding-top:14px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                <div style="font-weight:700;">Overrides</div>
                                <label style="display:flex; align-items:center; gap:8px; font-weight:600; color:#6c757d;">
                                    <input type="checkbox" id="inheritRoleCheckbox" checked>
                                    Inherit role permissions
                                </label>
                            </div>

                            {% set override_defs = [
                                {'key':'approve_above_amount','label':'Can approve payment requests above amount','type':'amount','placeholder':'100,000'},
                                {'key':'complete_above_amount','label':'Can complete payments above amount','type':'amount','placeholder':'500,000'},
                                {'key':'return_after_finance','label':'Can return requests after finance review','type':'boolean'},
                                {'key':'skip_second_level','label':'Can skip second-level approval','type':'boolean'},
                                {'key':'upload_receipts_only','label':'Can upload receipts only','type':'boolean'},
                                {'key':'edit_payment_amounts','label':'Can edit payment amounts','type':'boolean'},
                                {'key':'return_only_not_reject','label':'Can return to requestor but not reject','type':'boolean'}
                            ] %}

                            <div style="display:flex; flex-direction:column; gap:10px;">
                                {% for ov in override_defs %}
                                <div class="override-row" data-override="{{ ov.key }}" style="display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; border:1px solid #f1f3f5; border-radius:8px; background:#fff;">
                                    <div style="flex:1;">
                                        <div style="font-weight:600;">{{ ov.label }}</div>
                                        {% if ov.type == 'amount' %}
                                        <div style="color:#6c757d; font-size:0.9rem; margin-top:4px;">Specify minimum amount (leave empty to disable)</div>
                                        {% endif %}
                                    </div>
                                    <div style="min-width:210px; display:flex; align-items:center; gap:8px; justify-content:flex-end;">
                                        <label style="display:flex; align-items:center; gap:8px;">
                                            <input type="checkbox" class="override-enable" data-ov-key="{{ ov.key }}">
                                            <span style="color:#6c757d; font-size:0.95rem;">Enable</span>
                                        </label>
                                        {% if ov.type == 'amount' %}
                                        <input type="text" class="override-amount form-control" data-ov-key="{{ ov.key }}" placeholder="{{ ov.placeholder }}" style="width:120px; padding:6px 8px; border:1px solid #e9ecef; border-radius:6px; text-align:right; display:none;">
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <!-- Status Scope (per-action allowed statuses) -->
                        <div style="margin-top:18px; border-top:1px solid #eef0f2; padding-top:14px;">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                <div style="font-weight:700;">Status Scope (per action)</div>
                                <div style="color:#6c757d; font-size:0.95rem;">Use role defaults toggles turn off the custom scope</div>
                            </div>

                            {% set statuses = [
                                {'key':'draft','label':'Draft'},
                                {'key':'pending_manager_approval','label':'Submitted / Pending Manager Approval'},
                                {'key':'returned_to_requestor','label':'Returned to Requestor'},
                                {'key':'approved_by_manager','label':'Approved by Manager / Pending Finance'},
                                {'key':'returned_by_finance','label':'Returned by Finance'},
                                {'key':'completed','label':'Completed / Paid'},
                                {'key':'rejected','label':'Rejected / Cancelled'}
                            ] %}

                            {% set actions = [
                                {'key':'approve','label':'Approve'},
                                {'key':'return','label':'Return to Requestor'},
                                {'key':'reject','label':'Reject'},
                                {'key':'complete','label':'Complete (Mark as Paid)'},
                                {'key':'attach_receipt','label':'Attach Receipt'},
                                {'key':'verify_docs','label':'Verify Documents'},
                                {'key':'comment','label':'Comment/Note'}
                            ] %}

                            <div class="status-scope-list" style="display:flex; flex-direction:column; gap:12px;">
                                {% for action in actions %}
                                <div class="action-row" data-action="{{ action.key }}" style="border:1px solid #f1f3f5; border-radius:8px; overflow:hidden;">
                                    <button type="button" class="action-header" style="width:100%; text-align:left; padding:10px 12px; background:#fff; border:none; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
                                        <div style="font-weight:600;">{{ action.label }}</div>
                                        <div style="display:flex; align-items:center; gap:10px;">
                                            <label style="display:flex; align-items:center; gap:8px; font-weight:600; color:#6c757d;">
                                                <input type="checkbox" class="use-role-defaults" data-action="{{ action.key }}" checked> Use role defaults
                                            </label>
                                            <span class="action-caret"></span>
                                        </div>
                                    </button>
                                    <div class="action-body" style="display:none; padding:10px 12px; background:#fafafa;">
                                        <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                            {% for st in statuses %}
                                            <label style="display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:6px; background:#fff; border:1px solid #eef0f2;">
                                                <input type="checkbox" class="status-checkbox" data-action="{{ action.key }}" value="{{ st.key }}">
                                                <span style="font-size:0.95rem;">{{ st.label }}</span>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <style>
                    /* Toggle visuals for permission switches inside panel */
                    #permissionsPanel .perm-switch {
                        display: inline-block;
                        width: 44px;
                        height: 24px;
                        background: #e9ecef;
                        border-radius: 999px;
                        position: relative;
                        transition: background 0.18s ease;
                    }
                    #permissionsPanel .perm-switch .perm-knob {
                        position: absolute;
                        top: 3px;
                        left: 3px;
                        width: 18px;
                        height: 18px;
                        background: #ffffff;
                        border-radius: 50%;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
                        transition: left 0.18s ease, background 0.18s ease;
                    }
                    #permissionsPanel input[type="checkbox"]:checked + .perm-switch {
                        background: #28a745 !important;
                    }
                    #permissionsPanel input[type="checkbox"]:checked + .perm-switch .perm-knob {
                        left: calc(100% - 3px - 18px) !important;
                    }
                </style>
                <style>
                    /* Ensure knob position toggles even when inline styles exist */
                    #permissionsPanel label.perm-toggle input[type="checkbox"] + .perm-switch .perm-knob {
                        left: 3px !important;
                    }
                    #permissionsPanel label.perm-toggle input[type="checkbox"]:checked + .perm-switch .perm-knob {
                        left: calc(100% - 3px - 18px) !important;
                    }
                    #permissionsPanel label.perm-toggle input[type="checkbox"]:checked + .perm-switch {
                        background: #28a745 !important;
                    }
                </style>
                <script>
                let currentUserId = null;

                function showResetPasswordModal(userId, userEmail, userName) {
                    currentUserId = userId;
                    document.getElementById('modalUserName').textContent = userName;
                    document.getElementById('modalUserEmail').textContent = userEmail;
                    document.getElementById('resetPasswordForm').action = `/users/${userId}/reset_password`;
                    document.getElementById('resetPasswordModal').style.display = 'block';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    document.getElementById('newPassword').focus();
                }

                function closeResetPasswordModal() {
                    document.getElementById('resetPasswordModal').style.display = 'none';
                    currentUserId = null;
                }

                function validatePasswordReset() {
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;
                    
                    if (newPassword.length < 6) {
                        alert('Password must be at least 6 characters long.');
                        return false;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        alert('Passwords do not match. Please try again.');
                        return false;
                    }
                    
                    return confirm('Are you sure you want to reset this user\'s password? They will be notified of the change.');
                }

                // Close modal when clicking outside of it
                window.addEventListener('click', function(event) {
                    const modal = document.getElementById('resetPasswordModal');
                    if (event.target == modal) {
                        closeResetPasswordModal();
                    }
                });

                function toggleAllCheckboxes() {
                    const selectAllCheckbox = document.getElementById('selectAll');
                    const userCheckboxes = document.querySelectorAll('.user-checkbox:not(:disabled)');
                    
                    userCheckboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                }

                function updateSelectAllState() {
                    const selectAllCheckbox = document.getElementById('selectAll');
                    const userCheckboxes = document.querySelectorAll('.user-checkbox:not(:disabled)');
                    const checkedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                    
                    if (checkedCheckboxes.length === 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    } else if (checkedCheckboxes.length === userCheckboxes.length) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    }
                }

                // Get selected user IDs
                function getSelectedUserIds() {
                    const checkedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
                    return Array.from(checkedCheckboxes).map(checkbox => checkbox.value);
                }

                // Fetch current permissions for a user and populate the toggles
                window.fetchPermissionsForUser = function(userId) {
                    if (!userId) return;
                    fetch(`/api/users/${userId}/permissions`)
                        .then(res => res.json())
                        .then(data => {
                            const perms = data.permissions || {};
                            // Update each checkbox
                            document.querySelectorAll('#permissionsPanel input[type="checkbox"][name^="perm_full_"]').forEach(function(cb){
                                const name = cb.getAttribute('name').replace(/^perm_full_/, '');
                                const checked = !!perms[name];
                                cb.checked = checked;
                                // ensure visual state by toggling checked (CSS handles appearance), but force knob position fallback
                                const sw = cb.nextElementSibling;
                                if (sw && sw.querySelector('.perm-knob')) {
                                    if (checked) {
                                        sw.style.background = '#28a745';
                                        sw.querySelector('.perm-knob').style.left = 'calc(100% - 3px - 18px)';
                                    } else {
                                        sw.style.background = '#e9ecef';
                                        sw.querySelector('.perm-knob').style.left = '3px';
                                    }
                                }
                            });
                            // populate overrides if provided
                            const overrides = data.overrides || {};
                            document.querySelectorAll('.override-row').forEach(function(row){
                                var key = row.getAttribute('data-override');
                                if (!key) return;
                                var ov = overrides[key];
                                if (ov) {
                                    var enableCb = row.querySelector('.override-enable');
                                    if (enableCb) enableCb.checked = !!ov.enabled;
                                    var amountInput = row.querySelector('.override-amount');
                                    if (amountInput && ov.value !== null && ov.value !== undefined) {
                                        amountInput.value = ov.value;
                                        amountInput.style.display = ov.enabled ? 'inline-block' : 'none';
                                    }
                                }
                            });
                            // populate status scopes if provided
                            const statusScopes = data.status_scopes || data.statusScopes || {};
                            document.querySelectorAll('.action-row').forEach(function(row){
                                var action = row.getAttribute('data-action');
                                var sc = statusScopes[action];
                                var useDefaults = true;
                                if (sc && typeof sc.use_role_defaults !== 'undefined') useDefaults = !!sc.use_role_defaults;
                                var boxes = row.querySelectorAll('.status-checkbox');
                                boxes.forEach(function(b){
                                    if (sc && Array.isArray(sc.statuses)) {
                                        b.checked = sc.statuses.indexOf(b.value) !== -1;
                                    } else {
                                        b.checked = false;
                                    }
                                    b.disabled = useDefaults;
                                    b.style.opacity = useDefaults ? '0.5' : '1';
                                });
                                var useCb = row.querySelector('.use-role-defaults');
                                if (useCb) useCb.checked = useDefaults;
                            });
                        }).catch(err => {
                            console.error('Failed to load permissions', err);
                        });
                }

                // Save permissions for the currently editing user
                window.savePermissions = function() {
                    var userId = window.__editingUserId;
                    if (!userId) {
                        alert('No user selected.');
                        return;
                    }
                    const inputs = document.querySelectorAll('#permissionsPanel input[type="checkbox"][name^="perm_full_"]');
                    const perms = {};
                    inputs.forEach(function(i){
                        const name = i.getAttribute('name').replace(/^perm_full_/, '');
                        perms[name] = !!i.checked;
                    });
                    // collect overrides
                    const overrides = {};
                    document.querySelectorAll('.override-row').forEach(function(row){
                        var key = row.getAttribute('data-override');
                        if (!key) return;
                        var enableCb = row.querySelector('.override-enable');
                        if (!enableCb) return;
                        var enabled = !!enableCb.checked;
                        var amountInput = row.querySelector('.override-amount');
                        var value = null;
                        if (amountInput) {
                            var v = amountInput.value.trim().replace(/[^\d.-]/g,'');
                            if (v !== '') value = parseFloat(v);
                        }
                        overrides[key] = { enabled: enabled, value: value };
                    });
                    // collect status scopes per action
                    const status_scopes = {};
                    document.querySelectorAll('.action-row').forEach(function(row){
                        var action = row.getAttribute('data-action');
                        if (!action) return;
                        var useDefaultsEl = row.querySelector('.use-role-defaults');
                        var useDefaults = true;
                        if (useDefaultsEl) useDefaults = !!useDefaultsEl.checked;
                        var checkedStatuses = [];
                        row.querySelectorAll('.status-checkbox:checked').forEach(function(cb){
                            checkedStatuses.push(cb.value);
                        });
                        status_scopes[action] = { use_role_defaults: useDefaults, statuses: checkedStatuses };
                    });
                    fetch(`/api/users/${userId}/permissions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ permissions: perms, overrides: overrides, status_scopes: status_scopes })
                    }).then(res => res.json())
                    .then(data => {
                        if (data && (data.success || data.status === 'ok')) {
                            // small success feedback (could be flash) then close
                            closeEditPermissions();
                        } else {
                            alert('Failed to save permissions.');
                        }
                    }).catch(err => {
                        console.error(err);
                        alert('Failed to save permissions.');
                    });
                }

                // Apply current permissions to selected users in main users table
                function applyPermissionsToSelectedUsers() {
                    var sourceId = window.__editingUserId;
                    if (!sourceId) {
                        alert('No user open to copy from.');
                        return;
                    }
                    var targetIds = getSelectedUserIds();
                    if (!targetIds || targetIds.length === 0) {
                        alert('No target users selected in the table.');
                        return;
                    }
                    if (!confirm(`Apply these permissions to ${targetIds.length} selected user(s)?`)) return;
                    fetch('/api/users/apply_permissions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_user_id: sourceId, target_user_ids: targetIds })
                    }).then(res => res.json())
                    .then(data => {
                        if (data && (data.success || data.status === 'ok')) {
                            alert('Permissions applied successfully.');
                        } else {
                            alert('Failed to apply permissions.');
                        }
                    }).catch(err => {
                        console.error(err);
                        alert('Failed to apply permissions.');
                    });
                }

                // Search functionality
                document.addEventListener('DOMContentLoaded', function() {
                    const searchInput = document.getElementById('userSearch');
                    const clearSearchBtn = document.getElementById('clearSearch');
                    const searchResultsInfo = document.getElementById('searchResultsInfo');
                    const searchResultsText = document.getElementById('searchResultsText');
                    const tableRows = document.querySelectorAll('.data-table tbody tr');

                    const originalTableRows = Array.from(tableRows);

                    function filterUsers() {
                        const searchTerm = searchInput.value.toLowerCase().trim();
                        let visibleCount = 0;
                        
                        if (searchTerm === '') {
                            tableRows.forEach(row => {
                                row.style.display = '';
                                visibleCount++;
                            });
                            clearSearchBtn.style.display = 'none';
                            searchResultsInfo.style.display = 'none';
                        } else {
                            tableRows.forEach(row => {
                                const cells = row.querySelectorAll('td');
                                let isVisible = false;
                                
                                for (let i = 1; i < cells.length - 1; i++) {
                                    if (i === 5) continue;
                                    const cellText = cells[i].textContent.toLowerCase();
                                    if (cellText.includes(searchTerm)) {
                                        isVisible = true;
                                        break;
                                    }
                                }
                                
                                if (isVisible) {
                                    row.style.display = '';
                                    visibleCount++;
                                } else {
                                    row.style.display = 'none';
                                }
                            });
                            
                            clearSearchBtn.style.display = 'flex';
                            searchResultsInfo.style.display = 'flex';
                            searchResultsText.textContent = `Showing ${visibleCount} of ${originalTableRows.length} users`;
                        }
                        
                        updateSelectAllState();
                    }

                    searchInput.addEventListener('input', filterUsers);

                    clearSearchBtn.addEventListener('click', function() {
                        searchInput.value = '';
                        filterUsers();
                        searchInput.focus();
                    });

                    filterUsers();

                    // Password visibility toggles
                    const newPasswordInput = document.getElementById('newPassword');
                    const confirmPasswordInput = document.getElementById('confirmPassword');
                    const newPasswordToggleBtn = document.getElementById('newPassword-toggle');
                    const confirmPasswordToggleBtn = document.getElementById('confirmPassword-toggle');
                    const newPasswordToggleIcon = document.getElementById('newPassword-toggle-icon');
                    const confirmPasswordToggleIcon = document.getElementById('confirmPassword-toggle-icon');

                    if (newPasswordToggleBtn && newPasswordInput) {
                        newPasswordToggleBtn.addEventListener('click', function() {
                            if (newPasswordInput.type === 'password') {
                                newPasswordInput.type = 'text';
                                newPasswordToggleIcon.classList.remove('fa-eye');
                                newPasswordToggleIcon.classList.add('fa-eye-slash');
                                newPasswordToggleBtn.setAttribute('aria-label', 'Hide password');
                            } else {
                                newPasswordInput.type = 'password';
                                newPasswordToggleIcon.classList.remove('fa-eye-slash');
                                newPasswordToggleIcon.classList.add('fa-eye');
                                newPasswordToggleBtn.setAttribute('aria-label', 'Show password');
                            }
                        });
                    }

                    if (confirmPasswordToggleBtn && confirmPasswordInput) {
                        confirmPasswordToggleBtn.addEventListener('click', function() {
                            if (confirmPasswordInput.type === 'password') {
                                confirmPasswordInput.type = 'text';
                                confirmPasswordToggleIcon.classList.remove('fa-eye');
                                confirmPasswordToggleIcon.classList.add('fa-eye-slash');
                                confirmPasswordToggleBtn.setAttribute('aria-label', 'Hide password');
                            } else {
                                confirmPasswordInput.type = 'password';
                                confirmPasswordToggleIcon.classList.remove('fa-eye-slash');
                                confirmPasswordToggleIcon.classList.add('fa-eye');
                                confirmPasswordToggleBtn.setAttribute('aria-label', 'Show password');
                            }
                        });
                    }

                    // Select-all per group handler
                    document.querySelectorAll('.select-all-group').forEach(function(a){
                        a.addEventListener('click', function(ev){
                            ev.preventDefault();
                            ev.stopPropagation();
                            var idx = a.getAttribute('data-group');
                            if (idx === null || idx === undefined) return;
                            var boxes = document.querySelectorAll('#permissionsPanel tbody tr[data-group="' + idx + '"] input[type="checkbox"]');
                            if (!boxes || boxes.length === 0) return;
                            var anyUnchecked = Array.from(boxes).some(b => !b.checked);
                            boxes.forEach(function(b){
                                b.checked = !!anyUnchecked;
                                var sw = b.nextElementSibling;
                                if (sw && sw.querySelector('.perm-knob')) {
                                    if (anyUnchecked) {
                                        sw.style.background = '#28a745';
                                        sw.querySelector('.perm-knob').style.left = 'calc(100% - 3px - 18px)';
                                    } else {
                                        sw.style.background = '#e9ecef';
                                        sw.querySelector('.perm-knob').style.left = '3px';
                                    }
                                }
                            });
                        });
                    });

                    // Toggle visual state when clicking the switch label
                    document.querySelectorAll('label.perm-toggle input[type="checkbox"]').forEach(function(cb){
                        cb.addEventListener('change', function(){
                            var sw = cb.nextElementSibling;
                            if (sw && sw.querySelector('.perm-knob')) {
                                if (cb.checked) {
                                    sw.style.background = '#28a745';
                                    sw.querySelector('.perm-knob').style.left = 'calc(100% - 3px - 18px)';
                                } else {
                                    sw.style.background = '#e9ecef';
                                    sw.querySelector('.perm-knob').style.left = '3px';
                                }
                            }
                        });
                    });

                    // Overrides UI: show/hide amount inputs and collect values
                    document.querySelectorAll('.override-enable').forEach(function(cb){
                        cb.addEventListener('change', function(){
                            var key = cb.getAttribute('data-ov-key');
                            var amountInput = document.querySelector('.override-amount[data-ov-key="'+key+'"]');
                            if (amountInput) {
                                amountInput.style.display = cb.checked ? 'inline-block' : 'none';
                            }
                        });
                    });

                    // inherit role checkbox toggles enabling of overrides
                    var inheritCb = document.getElementById('inheritRoleCheckbox');
                    if (inheritCb) {
                        inheritCb.addEventListener('change', function(){
                            var disabled = inheritCb.checked;
                            document.querySelectorAll('.override-enable, .override-amount').forEach(function(el){
                                el.disabled = disabled;
                                el.style.opacity = disabled ? '0.6' : '1';
                            });
                        });
                    }

                    // Status-scope accordion behavior
                    document.querySelectorAll('.action-header').forEach(function(btn){
                        btn.addEventListener('click', function(e){
                            // ignore clicks on the use-role-defaults checkbox
                            if (e.target && e.target.classList && e.target.classList.contains('use-role-defaults')) return;
                            var parent = btn.parentElement;
                            var body = parent.querySelector('.action-body');
                            if (!body) return;
                            var isOpen = body.style.display === 'block';
                            // close all others
                            document.querySelectorAll('.action-body').forEach(function(b){ b.style.display = 'none'; });
                            if (!isOpen) body.style.display = 'block';
                        });
                    });

                    // Use role defaults toggles status checkbox enabling
                    document.querySelectorAll('.use-role-defaults').forEach(function(cb){
                        cb.addEventListener('change', function(){
                            var action = cb.getAttribute('data-action');
                            var parent = cb.closest('.action-row');
                            if (!parent) return;
                            var boxes = parent.querySelectorAll('.status-checkbox');
                            boxes.forEach(function(b){ b.disabled = cb.checked; b.style.opacity = cb.checked ? '0.5' : '1'; });
                        });
                    });
                });
                </script>
            </div>
        </div>
    </div>

    <script>
    // Tab switching behavior for settings page
    (function(){
        function activateTabById(targetId) {
            var tabs = document.querySelectorAll('.settings-nav-tabs .settings-tab');
            tabs.forEach(function(li){
                var a = li.querySelector('a');
                if (!a) return;
                var href = a.getAttribute('href') || '';
                var id = href.replace('#','');
                if (id === targetId) {
                    li.classList.add('active');
                    a.setAttribute('aria-selected','true');
                    a.style.color = '#D9BD7D';
                    a.style.borderBottom = '3px solid #D9BD7D';
                } else {
                    li.classList.remove('active');
                    a.setAttribute('aria-selected','false');
                    a.style.color = '#6c757d';
                    a.style.borderBottom = 'none';
                }
            });

            var panels = document.querySelectorAll('.settings-tab-panels [role="tabpanel"]');
            panels.forEach(function(p){
                if (p.id === targetId) {
                    p.style.display = 'block';
                    p.setAttribute('aria-hidden','false');
                } else {
                    p.style.display = 'none';
                    p.setAttribute('aria-hidden','true');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function(){
            var anchors = Array.from(document.querySelectorAll('.settings-nav-tabs a[href^="#"]'));
            anchors.forEach(function(a){
                a.addEventListener('click', function(ev){
                    ev.preventDefault();
                    var targetId = (a.getAttribute('href') || '').replace('#','');
                    if (!targetId) return;
                    activateTabById(targetId);
                    // update URL hash without scrolling
                    if (history && history.replaceState) {
                        history.replaceState(null, '', '#' + targetId);
                    } else {
                        location.hash = '#' + targetId;
                    }
                });
            });

            // On load: open tab from hash if present and valid, otherwise default to Temporary Manager
            var initial = (location.hash || '').replace('#','') || 'temporary-manager';
            var validPanel = document.getElementById(initial);
            if (!validPanel) initial = 'temporary-manager';
            activateTabById(initial);
        });
    })();
    </script>
</div>
{% endblock %}


