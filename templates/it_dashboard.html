{% extends "base.html" %}

{% block title %}IT Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-server"></i> IT Dashboard</h1>
        <p>Full system access and management</p>
    </div>

    <div class="dashboard-actions">
        <div class="new-request-dropdown">
            <button type="button" class="btn btn-primary new-request-toggle">
                <i class="fas fa-plus-circle"></i> New Request
                <i class="fas fa-caret-down dropdown-caret"></i>
            </button>
            <div class="new-request-menu">
                <a href="{{ url_for('new_request') }}">
                    <i class="fas fa-credit-card"></i> Payment Request for Finance
                </a>
                {% if show_item_requests_flag %}
                <a href="{{ url_for('procurement_request_item') }}">
                    <i class="fas fa-boxes"></i> Item Request for Procurement
                </a>
                {% else %}
                <a href="#" onclick="return false;" style="opacity: 0.6; cursor: not-allowed; pointer-events: none;">
                    <i class="fas fa-boxes"></i> Item Request for Procurement (COMING SOON)
                </a>
                {% endif %}
            </div>
        </div>
        <a href="{{ url_for('drafts') }}" class="btn btn-secondary">
            <i class="fas fa-file-alt"></i> My Drafts
        </a>
        {% if show_item_requests_flag %}
        <a href="{{ url_for('procurement_item_requests') }}" class="btn btn-secondary">
            <i class="fas fa-shopping-cart"></i> Item Requests
        </a>
        {% endif %}
        <a href="{{ url_for('archives') }}" class="btn btn-secondary">
            <i class="fas fa-archive"></i> Archives
        </a>
    </div>

    <div class="dashboard-tabs">
        <button class="tab-btn {% if active_tab == 'all' or active_tab == 'completed' or active_tab == 'rejected' or active_tab == 'recurring' or active_tab == 'my_requests' %}active{% endif %}" onclick="showTab('requests')">
            <i class="fas fa-file-invoice"></i> Requests
        </button>
        <button class="tab-btn {% if active_tab == 'users' %}active{% endif %}" onclick="showTab('users')">
            <i class="fas fa-users"></i> Users
        </button>
        <button class="tab-btn {% if active_tab == 'request-types' %}active{% endif %}" onclick="showTab('request-types')">
            <i class="fas fa-tags"></i> Request Types
        </button>
        <button class="tab-btn {% if active_tab == 'person-company-names' %}active{% endif %}" onclick="showTab('person-company-names')">
            <i class="fas fa-user-tag"></i> Person/Company Names
        </button>
        <button class="tab-btn {% if active_tab == 'procurement-categories-items' %}active{% endif %}" onclick="showTab('procurement-categories-items')">
            <i class="fas fa-shopping-cart"></i> Procurement Categories/Items
        </button>
        <button class="tab-btn {% if active_tab == 'branches' %}active{% endif %}" onclick="showTab('branches')">
            <i class="fas fa-building"></i> Branches/Locations
        </button>
        <button class="tab-btn {% if active_tab == 'logs' %}active{% endif %}" onclick="showTab('logs')">
            <i class="fas fa-history"></i> Audit Logs
        </button>
    </div>

    <!-- Tab Content Container -->
    <div class="tab-content-container">
        <!-- Requests Tab -->
        <div id="requests-tab" class="tab-content {% if active_tab == 'all' or active_tab == 'completed' or active_tab == 'rejected' or active_tab == 'recurring' or active_tab == 'my_requests' %}active{% endif %}">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button {% if active_tab == 'all' %}active{% endif %}" onclick="switchTab('all')" id="tab-all">
                <i class="fas fa-list"></i> All Requests
            </button>
            <button class="tab-button {% if active_tab == 'my_requests' %}active{% endif %}" onclick="switchTab('my_requests')" id="tab-my_requests">
                <i class="fas fa-user"></i> My Requests
            </button>
            <button class="tab-button {% if active_tab == 'completed' %}active{% endif %}" onclick="switchTab('completed')" id="tab-completed">
                <i class="fas fa-check-circle"></i> Completed
            </button>
            <button class="tab-button {% if active_tab == 'rejected' %}active{% endif %}" onclick="switchTab('rejected')" id="tab-rejected">
                <i class="fas fa-times-circle"></i> Rejected
            </button>
            <button class="tab-button {% if active_tab == 'recurring' %}active{% endif %}" onclick="switchTab('recurring')" id="tab-recurring">
                <i class="fas fa-sync-alt"></i> Recurring
            </button>
            <div class="tab-search">
                <input type="text" id="tabSearchInput" placeholder="Search by request # or requestor name..." class="tab-search-input" value="{{ search_query or '' }}">
                <button type="button" class="tab-search-btn" onclick="performSearch()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        <div class="card">
            <div class="card-header">
                <div class="header-top">
                    <div class="filter-controls">
                        {% if active_tab != 'my_requests' %}
                        <select id="departmentFilter" onchange="filterByDepartment()" class="form-select">
                            <option value="">All Departments</option>
                            <option value="HR" {% if department_filter == 'HR' %}selected{% endif %}>HR</option>
                            <option value="Finance" {% if department_filter == 'Finance' %}selected{% endif %}>Finance</option>
                            <option value="IT" {% if department_filter == 'IT' %}selected{% endif %}>IT</option>
                            <option value="PR" {% if department_filter == 'PR' %}selected{% endif %}>PR</option>
                            <option value="Auditing" {% if department_filter == 'Auditing' %}selected{% endif %}>Auditing</option>
                            <option value="Customer Service" {% if department_filter == 'Customer Service' %}selected{% endif %}>Customer Service</option>
                            <option value="Marketing" {% if department_filter == 'Marketing' %}selected{% endif %}>Marketing</option>
                            <option value="Operation" {% if department_filter == 'Operation' %}selected{% endif %}>Operation</option>
                            <option value="Procurement" {% if department_filter == 'Procurement' %}selected{% endif %}>Procurement</option>
                            <option value="Logistic" {% if department_filter == 'Logistic' %}selected{% endif %}>Logistic</option>
                            <option value="Quality Control" {% if department_filter == 'Quality Control' %}selected{% endif %}>Quality Control</option>
                            <option value="Project" {% if department_filter == 'Project' %}selected{% endif %}>Project</option>
                            <option value="Research and Development" {% if department_filter == 'Research and Development' %}selected{% endif %}>Research and Development</option>
                            <option value="Office" {% if department_filter == 'Office' %}selected{% endif %}>Office</option>
                            <option value="Maintenance" {% if department_filter == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                        </select>
                        {% endif %}
                        {% if active_tab == 'all' %}
                        <select id="statusFilter" onchange="applyStatusFilter()" class="form-select">
                            <option value="">All Statuses</option>
                            <option value="Pending Manager Approval" {% if status_filter == 'Pending Manager Approval' %}selected{% endif %}>Pending Manager Approval</option>
                            <option value="On Hold" {% if status_filter == 'On Hold' %}selected{% endif %}>On Hold</option>
                            <option value="Pending Finance Approval" {% if status_filter == 'Pending Finance Approval' %}selected{% endif %}>Pending Finance Approval</option>
                            <option value="Returned to Manager" {% if status_filter == 'Returned to Manager' %}selected{% endif %}>Returned to Manager</option>
                            <option value="Proof Pending" {% if status_filter == 'Proof Pending' %}selected{% endif %}>Proof Pending</option>
                            <option value="Proof Sent" {% if status_filter == 'Proof Sent' %}selected{% endif %}>Proof Sent</option>
                            <option value="Proof Rejected" {% if status_filter == 'Proof Rejected' %}selected{% endif %}>Proof Rejected</option>
                        </select>
                        {% endif %}
                        <select id="urgentFilter" onchange="filterByUrgent()" class="form-select">
                            <option value="">All Requests</option>
                            <option value="urgent" {% if urgent_filter == 'urgent' %}selected{% endif %}>üî¥ Urgent Only</option>
                            <option value="not_urgent" {% if urgent_filter == 'not_urgent' %}selected{% endif %}>‚ö™ Not Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="card-header-actions">
                    {% if status_filter or department_filter or urgent_filter or search_query %}
                    <div class="filter-indicator">
                        <span class="badge" style="background: #f57c00; color: white;">
                            <i class="fas fa-filter"></i> 
                            {% set filters = [] %}
                            {% if status_filter %}{{ filters.append(status_filter) or '' }}{% endif %}
                            {% if department_filter %}{{ filters.append(department_filter) or '' }}{% endif %}
                            {% if urgent_filter %}{{ filters.append(urgent_filter) or '' }}{% endif %}
                            {% if search_query %}{{ filters.append('Search: ' + search_query) or '' }}{% endif %}
                            {{ filters|join(' | ') }}
                        </span>
                        <a href="{{ url_for('it_dashboard') }}" class="btn btn-sm btn-outline">
                            <i class="fas fa-times"></i> Clear All
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <h4 class="card-title mb-4">Payment Requests</h4>
            <!-- All Requests Tab -->
            <div id="tab-content-all" class="tab-content {% if active_tab == 'all' %}active{% endif %}">
                <!-- Bulk Actions -->
                <div id="bulkActions" class="bulk-actions" style="display: none; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span id="selectedCount" style="font-weight: 600; color: #495057;">0 items selected</span>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()" disabled id="bulkDeleteBtn">
                                <i class="fas fa-trash"></i> Delete Selected
                            </button>
                            <button type="button" class="btn btn-sm btn-info" onclick="bulkView()" disabled id="bulkViewBtn">
                                <i class="fas fa-eye"></i> View Selected
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="clearSelection()">
                                <i class="fas fa-times"></i> Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
                
                {% if requests %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" onchange="toggleAllCheckboxes(this)">
                                    </th>
                                    <th>ID</th>
                                    <th>Type</th>
                                    <th>Payment Type</th>
                                    <th>Payment Method</th>
                                    <th>Requestor</th>
                                    <th>Department</th>
                                    <th>Submission Date</th>
                                    <th>Completed Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for req in requests %}
                                <tr {% if req.is_urgent %}style="border-left: 4px solid #dc3545;"{% endif %}>
                                    <td>
                                        <input type="checkbox" class="request-checkbox" value="{{ req.request_id }}" onchange="updateBulkActions()">
                                    </td>
                                    <td>
                                        <span>#{{ req.request_id }}</span>
                                        {% if req.is_urgent %}
                                            <br>
                                            <span class="badge" style="background: #dc3545; color: white; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-left: 1px;">URGENT</span>
                                        {% endif %}
                                    </td>
                                    <td><span class="badge badge-info">{{ req.request_type }}</span></td>
                                    <td>
                                        {% if req.recurring == 'Recurring' %}
                                            <span class="badge" style="background: #ffc107; color: #212529;">‚Üª Recurring</span>
                                        {% elif req.payment_date or req.recurring == 'Scheduled One-Time' %}
                                            <span class="badge" style="background: #fd7e14; color: white;">Scheduled One-Time</span>
                                        {% else %}
                                            <span class="badge" style="background: #17a2b8; color: white;">‚óè One-Time</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ req.payment_method or 'Card' }}</td>
                                    <td>{{ req.requestor_name }}</td>
                                    <td>{{ req.department }}</td>
                                    <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if req.status == 'Completed' and req.completion_date %}
                                            {{ req.completion_date.strftime('%Y-%m-%d') }}
                                        {% elif req.approval_date %}
                                            {{ req.approval_date.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            <span style="color: #999;">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        OMR {{ "%.3f"|format(req.amount) }}
                                    </td>
                                <td>
                                    {% if req.status == 'Approved' %}
                                        <span class="badge badge-success">‚úì {{ req.status }}</span>
                                    {% elif req.status == 'Completed' %}
                                        <span class="badge" style="background: #28a745; color: white;">‚úì {{ req.status }}</span>
                                    {% elif req.status == 'On Hold' %}
                                        <span class="badge" style="background: #ffc107; color: #212529;">‚è∏ On Hold</span>
                                    {% elif req.status in ['Pending Manager Approval', 'Pending Finance Approval'] %}
                                        <span class="badge" style="background: #6c757d; color: white;">‚è≥ {{ req.status }}</span>
                                    {% elif req.status == 'Returned to Manager' %}
                                        <span class="badge" style="background: #2196F3; color: white;">‚Ü© {{ req.status }}</span>
                                    {% elif req.status == 'Payment Pending' %}
                                        <span class="badge" style="background: #FF9800; color: white;">‚è≥ {{ req.status }}</span>
                                    {% elif req.status in ['Proof Pending', 'Proof Sent'] %}
                                        <span class="badge" style="background: #2196F3; color: white;">üìÑ {{ req.status }}</span>
                                    {% elif req.status == 'Paid' %}
                                        <span class="badge" style="background: #6f42c1; color: white;">üí∞ {{ req.status }}</span>
                                    {% elif req.status == 'Recurring' %}
                                        <span class="badge" style="background: #ffc107; color: #212529;">‚Üª {{ req.status }}</span>
                                    {% elif req.status in ['Rejected by Manager', 'Rejected by Finance', 'Proof Rejected'] or 'Rejected' in req.status %}
                                        <span class="badge" style="background: #dc3545; color: white;">‚úó {{ req.status }}</span>
                                    {% else %}
                                        <span class="badge badge-warning">‚è≥ {{ req.status }}</span>
                                    {% endif %}
                                </td>
                                    <td>
                                        <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_request', request_id=req.request_id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this request?')">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>No payment requests found.</p>
                    </div>
                {% endif %}
                </div>

                <!-- My Requests Tab -->
                <div id="tab-content-my_requests" class="tab-content {% if active_tab == 'my_requests' %}active{% endif %}">
                    {% if my_requests %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Payment Type</th>
                                        <th>Payment Method</th>
                                        <th>Requestor</th>
                                        <th>Department</th>
                                        <th>Submission Date</th>
                                        <th>Completed Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in my_requests %}
                                    <tr {% if req.is_urgent %}style="border-left: 4px solid #dc3545;"{% endif %}>
                                        <td>
                                            <span>#{{ req.request_id }}</span>
                                            {% if req.is_urgent %}
                                                <span class="badge" style="background: #dc3545; color: white; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-left: 1px;">URGENT</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ req.request_type }}</span>
                                        </td>
                                        <td>
                                            {% if req.recurring == 'Recurring' %}
                                                <span class="badge" style="background: #ffc107; color: #212529;">‚Üª Recurring</span>
                                            {% else %}
                                                <span class="badge" style="background: #17a2b8; color: white;">‚óè One-Time</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ req.payment_method or 'Card' }}</td>
                                        <td>{{ req.requestor_name }}</td>
                                        <td>{{ req.department }}</td>
                                        <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            {% if req.status == 'Completed' and req.completion_date %}
                                                {{ req.completion_date.strftime('%Y-%m-%d') }}
                                            {% elif req.approval_date %}
                                                {{ req.approval_date.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                <span style="color: #999;">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                                OMR {{ "%.3f"|format(req.amount) }}
                                        </td>
                                        <td>
                                            {% if req.status == 'Approved' %}
                                                <span class="badge badge-success">‚úì {{ req.status }}</span>
                                            {% elif req.status == 'Completed' %}
                                                <span class="badge" style="background: #28a745; color: white;">‚úì {{ req.status }}</span>
                                            {% elif req.status in ['Pending Manager Approval', 'Pending Finance Approval'] %}
                                                <span class="badge" style="background: #6c757d; color: white;">‚è≥ {{ req.status }}</span>
                                            {% elif req.status == 'Payment Pending' %}
                                                <span class="badge" style="background: #FF9800; color: white;">‚è≥ {{ req.status }}</span>
                                            {% elif req.status in ['Proof Pending', 'Proof Sent'] %}
                                                <span class="badge" style="background: #2196F3; color: white;">üìÑ {{ req.status }}</span>
                                            {% elif req.status == 'Paid' %}
                                                <span class="badge" style="background: #6f42c1; color: white;">üí∞ {{ req.status }}</span>
                                            {% elif req.status == 'Recurring' %}
                                                <span class="badge" style="background: #ffc107; color: #212529;">‚Üª {{ req.status }}</span>
                                            {% elif req.status in ['Rejected by Manager', 'Rejected by Finance', 'Proof Rejected'] or 'Rejected' in req.status %}
                                                <span class="badge" style="background: #dc3545; color: white;">‚úó {{ req.status }}</span>
                                            {% else %}
                                                <span class="badge badge-warning">‚è≥ {{ req.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No payment requests found.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Completed Tab -->
                <div id="tab-content-completed" class="tab-content {% if active_tab == 'completed' %}active{% endif %}">
                    {% if requests %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Requestor</th>
                                        <th>Department</th>
                                        <th>Submission Date</th>
                                        <th>Completed Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in requests %}
                                    <tr {% if req.is_urgent %}style="border-left: 4px solid #dc3545;"{% endif %}>
                                        <td>
                                        <span>#{{ req.request_id }}</span>
                                        {% if req.is_urgent %}
                                            <br>
                                            <span class="badge" style="background: #dc3545; color: white; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-left: 1px;">URGENT</span>
                                        {% endif %}
                                    </td>
                                        <td>{{ req.request_type }}</td>
                                        <td>{{ req.requestor_name }}</td>
                                        <td>{{ req.department }}</td>
                                        <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            {% if req.completion_date %}
                                                {{ req.completion_date.strftime('%Y-%m-%d') }}
                                            {% elif req.approval_date %}
                                                {{ req.approval_date.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                <span style="color: #999;">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                                OMR {{ "%.3f"|format(req.amount) }}
                                        </td>
                                        <td>
                                            <span class="badge" style="background: #28a745; color: white;">‚úì {{ req.status }}</span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No payment requests found.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Recurring Tab -->
                <div id="tab-content-recurring" class="tab-content {% if active_tab == 'recurring' %}active{% endif %}">
                    {% if requests %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Payment Type</th>
                                        <th>Payment Method</th>
                                        <th>Requestor</th>
                                        <th>Department</th>
                                        <th>Submission Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in requests %}
                                    <tr {% if req.is_urgent %}style="border-left: 4px solid #dc3545;"{% endif %}>
                                        <td>
                                            <span>#{{ req.request_id }}</span>
                                            {% if req.is_urgent %}
                                                <br>
                                                <span class="badge" style="background: #dc3545; color: white; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-left: 1px;">URGENT</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-info">{{ req.request_type }}</span>
                                        </td>
                                        <td>
                                            {% if req.recurring == 'Recurring' %}
                                                <span class="badge" style="background: #ffc107; color: #212529;">‚Üª Recurring</span>
                                            {% else %}
                                                <span class="badge" style="background: #17a2b8; color: white;">‚óè One-Time</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ req.payment_method or 'Card' }}</td>
                                        <td>{{ req.requestor_name }}</td>
                                        <td>{{ req.department }}</td>
                                        <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                                OMR {{ "%.3f"|format(req.amount) }}
                                        </td>
                                        <td>
                                            {% if req.status == 'Approved' %}
                                                <span class="badge badge-success">‚úì {{ req.status }}</span>
                                            {% elif req.status == 'Completed' %}
                                                <span class="badge" style="background: #28a745; color: white;">‚úì {{ req.status }}</span>
                                            {% elif req.status in ['Pending Manager Approval', 'Pending Finance Approval'] %}
                                                <span class="badge" style="background: #6c757d; color: white;">‚è≥ {{ req.status }}</span>
                                            {% elif req.status == 'Payment Pending' %}
                                                <span class="badge" style="background: #FF9800; color: white;">‚è≥ {{ req.status }}</span>
                                            {% elif req.status in ['Proof Pending', 'Proof Sent'] %}
                                                <span class="badge" style="background: #2196F3; color: white;">üìÑ {{ req.status }}</span>
                                            {% elif req.status == 'Paid' %}
                                                <span class="badge" style="background: #6f42c1; color: white;">üí∞ {{ req.status }}</span>
                                            {% elif req.status == 'Recurring' %}
                                                <span class="badge" style="background: #ffc107; color: #212529;">‚Üª {{ req.status }}</span>
                                            {% elif req.status in ['Rejected by Manager', 'Rejected by Finance', 'Proof Rejected'] or 'Rejected' in req.status %}
                                                <span class="badge" style="background: #dc3545; color: white;">‚úó {{ req.status }}</span>
                                            {% else %}
                                                <span class="badge badge-warning">‚è≥ {{ req.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No payment requests found.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Rejected Tab -->
                <div id="tab-content-rejected" class="tab-content {% if active_tab == 'rejected' %}active{% endif %}">
                    {% if requests %}
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Requestor</th>
                                        <th>Department</th>
                                        <th>Submission Date</th>
                                        <th>Rejected Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in requests %}
                                    <tr {% if req.is_urgent %}style="border-left: 4px solid #dc3545;"{% endif %}>
                                        <td>
                                        <span>#{{ req.request_id }}</span>
                                        {% if req.is_urgent %}
                                            <br>
                                            <span class="badge" style="background: #dc3545; color: white; font-size: 0.7em; font-weight: bold; padding: 2px 6px; border-radius: 3px; margin-left: 1px;">URGENT</span>
                                        {% endif %}
                                    </td>
                                        <td>{{ req.request_type }}</td>
                                        <td>{{ req.requestor_name }}</td>
                                        <td>{{ req.department }}</td>
                                        <td>{{ req.date.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            {% if req.manager_rejection_date %}
                                                {{ req.manager_rejection_date.strftime('%Y-%m-%d') }}
                                            {% elif req.finance_rejection_date %}
                                                {{ req.finance_rejection_date.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                <span style="color: #999;">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                                OMR {{ "%.3f"|format(req.amount) }}
                                        </td>
                                        <td>
                                            <span class="badge" style="background: #dc3545; color: white;">‚úó {{ req.status }}</span>
                                        </td>
                                        <td>
                                            <a href="{{ url_for('view_request', request_id=req.request_id) }}" class="btn btn-sm btn-info">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>No payment requests found.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Pagination Controls -->
                {% if active_tab == 'my_requests' and my_pagination %}
                <div class="pagination-container">
                    <div class="pagination-left">
                        <div class="pagination-info">
                            Showing {{ my_pagination.per_page * (my_pagination.page - 1) + 1 }} to 
                            {{ my_pagination.per_page * (my_pagination.page - 1) + my_pagination.items|length }} 
                            of {{ my_pagination.total }} requests
                        </div>
                        <div class="items-per-page">
                            <label for="per_page">Show:</label>
                            <select id="per_page" onchange="changeItemsPerPage(this.value)">
                                <option value="10" {% if my_pagination.per_page == 10 %}selected{% endif %}>10</option>
                                <option value="20" {% if my_pagination.per_page == 20 %}selected{% endif %}>20</option>
                                <option value="50" {% if my_pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if my_pagination.per_page == 100 %}selected{% endif %}>100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    {% if my_pagination.pages > 1 %}
                    <div class="pagination">
                        {% if my_pagination.has_prev %}
                            <a href="{{ url_for('it_dashboard', page=my_pagination.prev_num, per_page=my_pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        
                        {% for page_num in my_pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != my_pagination.page %}
                                    <a href="{{ url_for('it_dashboard', page=page_num, per_page=my_pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-outline">{{ page_num }}</a>
                                {% else %}
                                    <span class="btn btn-sm btn-primary">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if my_pagination.has_next %}
                            <a href="{{ url_for('it_dashboard', page=my_pagination.next_num, per_page=my_pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-secondary">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% elif pagination %}
                <div class="pagination-container">
                    <div class="pagination-left">
                        <div class="pagination-info">
                            Showing {{ pagination.per_page * (pagination.page - 1) + 1 }} to 
                            {{ pagination.per_page * (pagination.page - 1) + pagination.items|length }} 
                            of {{ pagination.total }} requests
                        </div>
                        <div class="items-per-page">
                            <label for="per_page">Show:</label>
                            <select id="per_page" onchange="changeItemsPerPage(this.value)">
                                <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
                                <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
                                <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
                                <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
                            </select>
                            <span>per page</span>
                        </div>
                    </div>
                    {% if pagination.pages > 1 %}
                    <div class="pagination">
                        {% if pagination.has_prev %}
                            <a href="{{ url_for('it_dashboard', page=pagination.prev_num, per_page=pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <a href="{{ url_for('it_dashboard', page=page_num, per_page=pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-outline">{{ page_num }}</a>
                                {% else %}
                                    <span class="btn btn-sm btn-primary">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="pagination-ellipsis">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                            <a href="{{ url_for('it_dashboard', page=pagination.next_num, per_page=pagination.per_page, tab=active_tab, status=status_filter, department=department_filter, urgent=urgent_filter, location=location_filter, search=search_query) }}" class="btn btn-sm btn-secondary">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    </div>

    <!-- Branches/Locations Tab -->
    <div id="branches-tab" class="tab-content {% if active_tab == 'branches' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-building"></i> Branches/Locations Management</h2>
                <div class="header-buttons">
                    <a href="{{ url_for('add_branch') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Branch
                    </a>
                    <a href="{{ url_for('add_location') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Location
                    </a>
                    <a href="{{ url_for('manage_branches') }}" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> Manage All Branches/Locations
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-persistent">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Branches/Locations Management:</strong> Manage company branch locations and location priorities. 
                    These branches will appear in the dropdown when users create new payment requests. Location priorities control the order of location groups in branch dropdowns.</span>
                </div>
                
                <!-- Location Filter -->
                <div class="filter-section mb-3">
                    <form method="GET" action="{{ url_for('it_dashboard') }}" class="filter-form">
                        <input type="hidden" name="tab" value="branches">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="location_filter" class="filter-label">
                                    <i class="fas fa-map-marker-alt"></i> Filter by Location:
                                </label>
                                <select name="location" id="location_filter" class="form-control filter-select" onchange="this.form.submit()">
                                    <option value="" {% if not location_filter %}selected{% endif %}>All Locations</option>
                                    {% if available_locations %}
                                        {% for location in available_locations %}
                                            <option value="{{ location.location_name }}" {% if location_filter == location.location_name %}selected{% endif %}>{{ location.location_name }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="filter-actions">
                                <a href="{{ url_for('it_dashboard', tab='branches') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Filter Summary -->
                <div class="filter-summary mb-3">
                    <div class="summary-info">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            {% if location_filter %}
                                Showing {{ branches|length }} branch{{ 'es' if branches|length != 1 else '' }} and {{ location_priorities|length }} location{{ 's' if location_priorities|length != 1 else '' }} for <strong>{{ location_filter }}</strong> location
                            {% else %}
                                Showing all {{ branches|length }} branch{{ 'es' if branches|length != 1 else '' }} and {{ location_priorities|length }} location{{ 's' if location_priorities|length != 1 else '' }} across all locations
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <!-- Locations Section -->
                <div class="mb-4">
                    <h3><i class="fas fa-map-marker-alt"></i> Locations</h3>
                    <div class="alert alert-info mb-3" style="font-size: 0.9em;">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> You can drag rows by the priority badge to reorder locations, or edit individual locations to set specific priority numbers. Lower priority numbers appear first in branch dropdowns.
                    </div>
                    <div class="table-responsive">
                        <table class="data-table" id="locationsTable">
                            <thead>
                                <tr>
                                    <th style="width: 120px; min-width: 120px;">Priority</th>
                                    <th>Location Name</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="locationsTableBody">
                                {% if location_priorities %}
                                    {% for location in location_priorities %}
                                    <tr data-location-id="{{ location.id }}" data-priority="{{ location.priority }}">
                                        <td>
                                            <span class="badge badge-info">{{ location.priority }}</span>
                                        </td>
                                        <td><strong>{{ location.location_name }}</strong></td>
                                        <td>
                                            {% if location.is_active %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ location.created_by.name if location.created_by else 'System' }}</td>
                                        <td>{{ location.created_at.strftime('%Y-%m-%d') if location.created_at else 'N/A' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('edit_location', location_id=location.id) }}" class="btn btn-sm btn-info" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('delete_location', location_id=location.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" 
                                                            title="Delete"
                                                            onclick="return confirm('Are you sure you want to delete location \"{{ location.location_name }}\"? This will only work if no branches are using this location.')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="empty-state">
                                                <i class="fas fa-map-marker-alt"></i>
                                                <p>No locations found. <a href="{{ url_for('add_location') }}">Add the first location</a></p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Branches Section -->
                <div>
                    <h3><i class="fas fa-building"></i> Branches</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if branches %}
                                    {% for branch in branches %}
                                    <tr>
                                        <td>{{ branch.id }}</td>
                                        <td><strong>{{ branch.name }}</strong></td>
                                        <td>
                                            <span class="badge badge-info">
                                                <i class="fas fa-map-marker-alt"></i> {{ branch.restaurant }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if branch.is_active %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ branch.created_by.name if branch.created_by else 'System' }}</td>
                                        <td>{{ branch.created_at.strftime('%Y-%m-%d') if branch.created_at else 'N/A' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('edit_branch', branch_id=branch.id) }}" class="btn btn-sm btn-info" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('toggle_branch', branch_id=branch.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm {% if branch.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                                            title="{% if branch.is_active %}Deactivate{% else %}Activate{% endif %}"
                                                            onclick="return confirm('Are you sure you want to {% if branch.is_active %}deactivate{% else %}activate{% endif %} this branch?')">
                                                        <i class="fas fa-{% if branch.is_active %}pause{% else %}play{% endif %}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="empty-state">
                                                <i class="fas fa-building"></i>
                                                <p>No branches found. <a href="{{ url_for('add_branch') }}">Add the first branch</a></p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content {% if active_tab == 'users' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-users"></i> User Management</h2>
                <div class="header-buttons">
                    <a href="{{ url_for('new_user') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add User
                    </a>
                    <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> Manage All Users
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if users %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Department</th>
                                    <th>Role</th>
                                    <th>Email</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for u in users %}
                                <tr>
                                    <td>{{ u.user_id }}</td>
                                    <td>{{ u.username }}</td>
                                    <td>{{ u.department }}</td>
                                    <td><span class="badge badge-primary">{{ u.role }}</span></td>
                                    <td>{{ u.email or 'N/A' }}</td>
                                    <td>{{ u.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <a href="{{ url_for('edit_user', user_id=u.user_id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% if u.user_id != current_user.user_id %}
                                        <form method="POST" action="{{ url_for('delete_user', user_id=u.user_id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user?')">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>No users found.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Request Types Tab -->
    <div id="request-types-tab" class="tab-content {% if active_tab == 'request-types' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-tags"></i> Request Types Management</h2>
                <div class="header-buttons">
                    <a href="{{ url_for('add_request_type') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Request Type
                    </a>
                    <a href="{{ url_for('manage_request_types') }}" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> Manage All Request Types
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-persistent">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Request Types Management:</strong> Manage payment request types for all departments. 
                    These types will appear in the dropdown when users create new payment requests.</span>
                </div>
                
                <!-- Department Filter and Search -->
                <div class="filter-section mb-3">
                    <form method="GET" action="{{ url_for('it_dashboard') }}" class="filter-form" id="requestTypesFilterForm" onsubmit="return false;">
                        <input type="hidden" name="tab" value="request-types">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="department_filter" class="filter-label">
                                    <i class="fas fa-building"></i> Filter by Department:
                                </label>
                                <select name="department" id="department_filter" class="form-control filter-select">
                                    <option value="all" {% if not department_filter or department_filter == 'all' %}selected{% endif %}>All Departments</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="request_types_search" class="filter-label">
                                    <i class="fas fa-search"></i> Search:
                                </label>
                                <input type="text" name="request_types_search" id="request_types_search" class="form-control filter-input" 
                                       placeholder="Search by name..." value="{{ request_types_search or '' }}">
                            </div>
                            <div class="filter-actions">
                                <a href="{{ url_for('it_dashboard', tab='request-types') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Filter Summary -->
                <div class="filter-summary mb-3">
                    <div class="summary-info">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            {% if department_filter and department_filter != 'all' or request_types_search %}
                                Showing {{ request_types|length }} request type{{ 's' if request_types|length != 1 else '' }}
                                {% if department_filter and department_filter != 'all' %}for <strong>{{ department_filter }}</strong> department{% endif %}
                                {% if request_types_search %}matching "<strong>{{ request_types_search }}</strong>"{% endif %}
                            {% else %}
                                Showing all {{ request_types|length }} request types across all departments
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if request_types %}
                                {% for request_type in request_types %}
                                <tr>
                                    <td>{{ request_type.id }}</td>
                                    <td>{{ request_type.name }}</td>
                                    <td>{{ request_type.department }}</td>
                                    <td>
                                        {% if request_type.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ request_type.created_by.name if request_type.created_by else 'System' }}</td>
                                    <td>{{ request_type.created_at.strftime('%Y-%m-%d') if request_type.created_at else 'N/A' }}</td>
                                    <td>
                                        <a href="{{ url_for('edit_request_type', request_type_id=request_type.id) }}" class="btn btn-sm btn-info">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_request_type', request_type_id=request_type.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this request type?')">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-tags"></i>
                                            <p>No request types found. <a href="{{ url_for('add_request_type') }}">Add the first request type</a></p>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Person/Company Names Tab -->
    <div id="person-company-names-tab" class="tab-content {% if active_tab == 'person-company-names' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-user-tag"></i> Person/Company Names Management</h2>
                <div class="header-buttons">
                    <a href="{{ url_for('add_person_company_option') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Person/Company Name
                    </a>
                    <a href="{{ url_for('manage_person_company_options') }}" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> Manage All Person/Company Names
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-persistent">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Person/Company Names Management:</strong> Manage dropdown options for Person/Company Name field based on department and request type. 
                    These options will appear in the searchable dropdown when users create new payment requests.</span>
                </div>
                
                <!-- Department Filter and Search -->
                <div class="filter-section mb-3">
                    <form method="GET" action="{{ url_for('it_dashboard') }}" class="filter-form" id="personCompanyFilterForm" onsubmit="return false;">
                        <input type="hidden" name="tab" value="person-company-names">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="department_filter_pcn" class="filter-label">
                                    <i class="fas fa-building"></i> Filter by Department:
                                </label>
                                <select name="department" id="department_filter_pcn" class="form-control filter-select">
                                    <option value="all" {% if not department_filter or department_filter == 'all' %}selected{% endif %}>All Departments</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept }}" {% if department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="person_company_search" class="filter-label">
                                    <i class="fas fa-search"></i> Search:
                                </label>
                                <input type="text" name="person_company_search" id="person_company_search" class="form-control filter-input" 
                                       placeholder="Search by name..." value="{{ person_company_search or '' }}">
                            </div>
                            <div class="filter-actions">
                                <a href="{{ url_for('it_dashboard', tab='person-company-names') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Filter Summary -->
                <div class="filter-summary mb-3">
                    <div class="summary-info">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            {% if department_filter and department_filter != 'all' or person_company_search %}
                                Showing {{ person_company_options|length }} person/company name option{{ 's' if person_company_options|length != 1 else '' }}
                                {% if department_filter and department_filter != 'all' %}for <strong>{{ department_filter }}</strong> department{% endif %}
                                {% if person_company_search %}matching "<strong>{{ person_company_search }}</strong>"{% endif %}
                            {% else %}
                                Showing all {{ person_company_options|length }} person/company name options across all departments
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Department</th>
                                <th>Request Type</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if person_company_options %}
                                {% for option in person_company_options %}
                                <tr>
                                    <td>{{ option.id }}</td>
                                    <td><strong>{{ option.name }}</strong></td>
                                    <td><span class="badge badge-info">{{ option.department }}</span></td>
                                    <td><span class="badge badge-secondary">{{ option.request_type }}</span></td>
                                    <td>
                                        {% if option.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-danger">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ option.created_by.name if option.created_by else 'System' }}</td>
                                    <td>{{ option.created_at.strftime('%Y-%m-%d') if option.created_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('edit_person_company_option', option_id=option.id) }}" class="btn btn-sm btn-info" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST" action="{{ url_for('toggle_person_company_option', option_id=option.id) }}" style="display: inline;">
                                                <button type="submit" class="btn btn-sm {% if option.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                                        title="{% if option.is_active %}Deactivate{% else %}Activate{% endif %}"
                                                        onclick="return confirm('Are you sure you want to {% if option.is_active %}deactivate{% else %}activate{% endif %} this person/company name option?')">
                                                    <i class="fas fa-{% if option.is_active %}pause{% else %}play{% endif %}"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="empty-state">
                                            <i class="fas fa-user-tag"></i>
                                            <p>No person/company name options found. <a href="{{ url_for('add_person_company_option') }}">Add the first option</a></p>
                                        </div>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Procurement Categories/Items Tab -->
    <div id="procurement-categories-items-tab" class="tab-content {% if active_tab == 'procurement-categories-items' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-shopping-cart"></i> Procurement Categories/Items Management</h2>
                <div class="header-buttons">
                    <a href="{{ url_for('add_procurement_category') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Category
                    </a>
                    <a href="{{ url_for('add_procurement_item') }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Item
                    </a>
                    <a href="{{ url_for('manage_procurement_categories_items') }}" class="btn btn-secondary">
                        <i class="fas fa-cog"></i> Manage All Categories/Items
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info alert-persistent">
                    <i class="fas fa-info-circle"></i>
                    <span><strong>Procurement Categories/Items Management:</strong> Manage category and item name/description options for each department when creating new item requests. 
                    These options will appear in the dropdowns when users create new procurement item requests.</span>
                </div>
                
                <!-- Department Filter and Search -->
                <div class="filter-section mb-3">
                    <form method="GET" action="{{ url_for('it_dashboard') }}" class="filter-form" id="procurementFilterForm" onsubmit="return false;">
                        <input type="hidden" name="tab" value="procurement-categories-items">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="procurement_department_filter" class="filter-label">
                                    <i class="fas fa-building"></i> Filter by Department:
                                </label>
                                <select name="procurement_department_filter" id="procurement_department_filter" class="form-control filter-select">
                                    <option value="all" {% if not procurement_department_filter or procurement_department_filter == 'all' %}selected{% endif %}>All Departments</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept }}" {% if procurement_department_filter == dept %}selected{% endif %}>{{ dept }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="procurement_search" class="filter-label">
                                    <i class="fas fa-search"></i> Search:
                                </label>
                                <input type="text" name="procurement_search" id="procurement_search" class="form-control filter-input" 
                                       placeholder="Search by name..." value="{{ procurement_search or '' }}">
                            </div>
                            <div class="filter-actions">
                                <a href="{{ url_for('it_dashboard', tab='procurement-categories-items') }}" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-times"></i> Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Filter Summary -->
                <div class="filter-summary mb-3">
                    <div class="summary-info">
                        <i class="fas fa-info-circle"></i>
                        <span>
                            {% if procurement_department_filter and procurement_department_filter != 'all' or procurement_search %}
                                Showing {{ procurement_categories|length }} categor{{ 'y' if procurement_categories|length == 1 else 'ies' }} and {{ procurement_items|length }} item{{ 's' if procurement_items|length != 1 else '' }}
                                {% if procurement_department_filter and procurement_department_filter != 'all' %}for <strong>{{ procurement_department_filter }}</strong> department{% endif %}
                                {% if procurement_search %}matching "<strong>{{ procurement_search }}</strong>"{% endif %}
                            {% else %}
                                Showing all {{ procurement_categories|length }} categor{{ 'y' if procurement_categories|length == 1 else 'ies' }} and {{ procurement_items|length }} item{{ 's' if procurement_items|length != 1 else '' }} across all departments
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <!-- Categories Section -->
                <div class="mb-4">
                    <h3><i class="fas fa-tags"></i> Categories</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if procurement_categories %}
                                    {% for category in procurement_categories %}
                                    <tr>
                                        <td>{{ category.id }}</td>
                                        <td><strong>{{ category.name }}</strong></td>
                                        <td><span class="badge badge-info">{{ category.department }}</span></td>
                                        <td>
                                            {% if category.is_active %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ category.created_by.name if category.created_by else 'System' }}</td>
                                        <td>{{ category.created_at.strftime('%Y-%m-%d') if category.created_at else 'N/A' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('edit_procurement_category', category_id=category.id) }}" class="btn btn-sm btn-info" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('toggle_procurement_category', category_id=category.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm {% if category.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                                            title="{% if category.is_active %}Deactivate{% else %}Activate{% endif %}"
                                                            onclick="return confirm('Are you sure you want to {% if category.is_active %}deactivate{% else %}activate{% endif %} this category?')">
                                                        <i class="fas fa-{% if category.is_active %}pause{% else %}play{% endif %}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="7" class="text-center">
                                            <div class="empty-state">
                                                <i class="fas fa-tags"></i>
                                                <p>No categories found. <a href="{{ url_for('add_procurement_category') }}">Add the first category</a></p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Items Section -->
                <div>
                    <h3><i class="fas fa-box"></i> Items</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Department</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Created Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if procurement_items %}
                                    {% for item in procurement_items %}
                                    <tr>
                                        <td>{{ item.id }}</td>
                                        <td><strong>{{ item.name }}</strong></td>
                                        <td><span class="badge badge-secondary">{{ item.category.name if item.category else 'N/A' }}</span></td>
                                        <td><span class="badge badge-info">{{ item.department }}</span></td>
                                        <td>{{ item.description or 'N/A' }}</td>
                                        <td>
                                            {% if item.is_active %}
                                                <span class="badge badge-success">Active</span>
                                            {% else %}
                                                <span class="badge badge-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.created_by.name if item.created_by else 'System' }}</td>
                                        <td>{{ item.created_at.strftime('%Y-%m-%d') if item.created_at else 'N/A' }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('edit_procurement_item', item_id=item.id) }}" class="btn btn-sm btn-info" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('toggle_procurement_item', item_id=item.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm {% if item.is_active %}btn-warning{% else %}btn-success{% endif %}" 
                                                            title="{% if item.is_active %}Deactivate{% else %}Activate{% endif %}"
                                                            onclick="return confirm('Are you sure you want to {% if item.is_active %}deactivate{% else %}activate{% endif %} this item?')">
                                                        <i class="fas fa-{% if item.is_active %}pause{% else %}play{% endif %}"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="empty-state">
                                                <i class="fas fa-box"></i>
                                                <p>No items found. <a href="{{ url_for('add_procurement_item') }}">Add the first item</a></p>
                                            </div>
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Logs Tab -->
    <div id="logs-tab" class="tab-content {% if active_tab == 'logs' %}active{% endif %}">
        <div class="card">
            <div class="card-header">
                <h2><i class="fas fa-history"></i> Audit Logs (Latest 50)</h2>
            </div>
            <div class="card-body">
                {% if logs %}
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Action</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>{{ log.log_id }}</td>
                                    <td>{{ log.user.name }}</td>
                                    <td>{{ log.action }}</td>
                                    <td>{{ utc_to_local(log.timestamp).strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No audit logs found.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Dashboard container styling */
.dashboard-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 20px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Tab button styling */
.tab-btn {
    cursor: pointer;
    padding: 10px 20px;
    border: 1px solid #ddd;
    background: #f8f9fa;
    border-radius: 5px 5px 0 0;
    margin-right: 5px;
    transition: all 0.3s ease;
    display: inline-block;
}

.tab-btn:hover {
    background: #e9ecef;
}

.tab-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

/* Tab content styling - ensure it's contained within dashboard */
.tab-content {
    margin-top: 0;
    border-top: 1px solid #ddd;
    padding: 20px;
    background: #fff;
    border-radius: 0 0 8px 8px;
    min-height: 400px;
}

/* Ensure tabs are visually connected */
.dashboard-tabs {
    margin-bottom: 0;
    border-bottom: 1px solid #ddd;
    padding-bottom: 0;
    background: #fff;
}

/* Tab content should feel integrated */
.tab-content .card {
    margin-top: 0;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    box-shadow: none;
    border: 1px solid #ddd;
}

/* Tab content container */
.tab-content-container {
    background: #fff;
    border-radius: 0 0 8px 8px;
    overflow: hidden;
}

/* Ensure all content is within the dashboard container */
.dashboard-container .tab-content {
    position: relative;
    z-index: 1;
}

/* Alert icon spacing */
.alert-persistent i {
    margin-right: 15px;
}

/* Header buttons styling */
.header-buttons {
    display: flex;
    gap: 10px;
    align-items: center;
}

/* Filter section styling */
.filter-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
}

.filter-form {
    margin: 0;
}

.filter-row {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-label {
    font-weight: 600;
    color: #495057;
    margin: 0;
    white-space: nowrap;
}

.filter-label i {
    color: #6c757d;
    margin-right: 5px;
}

.filter-select {
    min-width: 200px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    padding: 6px 12px;
    font-size: 14px;
}

.filter-actions {
    margin-left: auto;
}

@media (max-width: 768px) {
    .filter-row {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .filter-select {
        min-width: auto;
        width: 100%;
    }
    
    .filter-actions {
        margin-left: 0;
        margin-top: 10px;
    }
}

/* Filter summary styling */
.filter-summary {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 6px;
    padding: 12px 15px;
}

.summary-info {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #1565c0;
    font-size: 14px;
}

.summary-info i {
    color: #1976d2;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function applyStatusFilter() {
    const statusFilter = document.getElementById('statusFilter');
    const statusValue = statusFilter.value;
    
    const url = new URL(window.location);
    if (statusValue) {
        url.searchParams.set('status', statusValue);
    } else {
        url.searchParams.delete('status');
    }
    url.searchParams.set('page', '1'); // Reset to page 1 when filtering
    window.location.href = url.toString();
}

function filterByDepartment() {
    // Redirect to dashboard with department filter
    const departmentFilter = document.getElementById('departmentFilter');
    const departmentValue = departmentFilter.value;
    
    const url = new URL(window.location);
    if (departmentValue) {
        url.searchParams.set('department', departmentValue);
    } else {
        url.searchParams.delete('department');
    }
    // Preserve current tab and other filters
    const tab = url.searchParams.get('tab') || 'all';
    url.searchParams.set('tab', tab);
    url.searchParams.set('page', '1'); // Reset to page 1 when filtering
    window.location.href = url.toString();
}

function filterByUrgent() {
    // Redirect to dashboard with urgent filter
    const urgentFilter = document.getElementById('urgentFilter');
    const urgentValue = urgentFilter.value;
    
    const url = new URL(window.location);
    if (urgentValue) {
        url.searchParams.set('urgent', urgentValue);
    } else {
        url.searchParams.delete('urgent');
    }
    // Preserve current tab and other filters
    const tab = url.searchParams.get('tab') || 'all';
    url.searchParams.set('tab', tab);
    url.searchParams.set('page', '1'); // Reset to page 1 when filtering
    window.location.href = url.toString();
}

// Debounce timers for search
let searchDebounceTimer = null;
let requestTypesSearchDebounceTimer = null;
let personCompanySearchDebounceTimer = null;

function performSearch(commit) {
    const searchInput = document.getElementById('tabSearchInput');
    const searchValue = searchInput.value.trim();
    const url = new URL(window.location);
    
    // Update search query parameter
    if (searchValue) {
        url.searchParams.set('search', searchValue);
    } else {
        url.searchParams.delete('search');
    }
    
    // Reset to page 1 when searching
    url.searchParams.set('page', '1');
    
    if (commit) {
        window.location.href = url.toString();
        return;
    }
    
    fetch(url.toString(), { headers: { 'X-Requested-With': 'fetch' } })
        .then(res => res.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newBody = doc.querySelector('.card-body');
            const curBody = document.querySelector('.card-body');
            if (newBody && curBody) {
                curBody.innerHTML = newBody.innerHTML;
            }
        })
        .catch(() => {});
}

function performRequestTypesSearch(commit) {
    const searchInput = document.getElementById('request_types_search');
    const searchValue = searchInput ? searchInput.value.trim() : '';
    const url = new URL(window.location);
    
    // Update search query parameter
    if (searchValue) {
        url.searchParams.set('request_types_search', searchValue);
    } else {
        url.searchParams.delete('request_types_search');
    }
    
    // Preserve tab
    url.searchParams.set('tab', 'request-types');
    
    if (commit) {
        window.location.href = url.toString();
        return;
    }
    
    fetch(url.toString(), { headers: { 'X-Requested-With': 'fetch' } })
        .then(res => res.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const requestTypesTab = doc.querySelector('#request-types-tab');
            const currentRequestTypesTab = document.querySelector('#request-types-tab');
            
            if (requestTypesTab && currentRequestTypesTab) {
                // Update the table and filter summary
                const newTable = requestTypesTab.querySelector('.table-responsive');
                const newSummary = requestTypesTab.querySelector('.filter-summary');
                
                if (newTable) {
                    const currentTable = currentRequestTypesTab.querySelector('.table-responsive');
                    if (currentTable) {
                        currentTable.innerHTML = newTable.innerHTML;
                    }
                }
                
                if (newSummary) {
                    const currentSummary = currentRequestTypesTab.querySelector('.filter-summary');
                    if (currentSummary) {
                        currentSummary.innerHTML = newSummary.innerHTML;
                    }
                }
            }
        })
        .catch(() => {});
}

function performPersonCompanySearch(commit) {
    const searchInput = document.getElementById('person_company_search');
    const searchValue = searchInput ? searchInput.value.trim() : '';
    const url = new URL(window.location);
    
    // Update search query parameter
    if (searchValue) {
        url.searchParams.set('person_company_search', searchValue);
    } else {
        url.searchParams.delete('person_company_search');
    }
    
    // Preserve tab
    url.searchParams.set('tab', 'person-company-names');
    
    if (commit) {
        window.location.href = url.toString();
        return;
    }
    
    fetch(url.toString(), { headers: { 'X-Requested-With': 'fetch' } })
        .then(res => res.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const personCompanyTab = doc.querySelector('#person-company-names-tab');
            const currentPersonCompanyTab = document.querySelector('#person-company-names-tab');
            
            if (personCompanyTab && currentPersonCompanyTab) {
                // Update the table and filter summary
                const newTable = personCompanyTab.querySelector('.table-responsive');
                const newSummary = personCompanyTab.querySelector('.filter-summary');
                
                if (newTable) {
                    const currentTable = currentPersonCompanyTab.querySelector('.table-responsive');
                    if (currentTable) {
                        currentTable.innerHTML = newTable.innerHTML;
                    }
                }
                
                if (newSummary) {
                    const currentSummary = currentPersonCompanyTab.querySelector('.filter-summary');
                    if (currentSummary) {
                        currentSummary.innerHTML = newSummary.innerHTML;
                    }
                }
            }
        })
        .catch(() => {});
}

function performProcurementSearch(commit) {
    const searchInput = document.getElementById('procurement_search');
    const searchValue = searchInput ? searchInput.value.trim() : '';
    const url = new URL(window.location);
    
    // Update search query parameter
    if (searchValue) {
        url.searchParams.set('procurement_search', searchValue);
    } else {
        url.searchParams.delete('procurement_search');
    }
    
    // Preserve tab
    url.searchParams.set('tab', 'procurement-categories-items');
    
    if (commit) {
        window.location.href = url.toString();
        return;
    }
    
    fetch(url.toString(), { headers: { 'X-Requested-With': 'fetch' } })
        .then(res => res.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const procurementTab = doc.querySelector('#procurement-categories-items-tab');
            const currentProcurementTab = document.querySelector('#procurement-categories-items-tab');
            
            if (procurementTab && currentProcurementTab) {
                // Update the tables and filter summary
                const newCategoriesTable = procurementTab.querySelector('.mb-4 .table-responsive');
                const newItemsTable = procurementTab.querySelector('.mb-4 + div .table-responsive');
                const newSummary = procurementTab.querySelector('.filter-summary');
                
                if (newCategoriesTable) {
                    const currentCategoriesTable = currentProcurementTab.querySelector('.mb-4 .table-responsive');
                    if (currentCategoriesTable) {
                        currentCategoriesTable.innerHTML = newCategoriesTable.innerHTML;
                    }
                }
                
                if (newItemsTable) {
                    const currentItemsTable = currentProcurementTab.querySelector('.mb-4 + div .table-responsive');
                    if (currentItemsTable) {
                        currentItemsTable.innerHTML = newItemsTable.innerHTML;
                    }
                }
                
                if (newSummary) {
                    const currentSummary = currentProcurementTab.querySelector('.filter-summary');
                    if (currentSummary) {
                        currentSummary.innerHTML = newSummary.innerHTML;
                    }
                }
            }
        })
        .catch(() => {});
}

function filterTable() {
    // This function is kept for urgent filter (client-side filtering for urgent status)
    // Note: Department filtering is handled server-side via filterByDepartment()
    const urgentFilter = document.getElementById('urgentFilter');
    const urgentValue = urgentFilter.value;
    
    // Target only the requests table in the requests tab
    const requestsTab = document.getElementById('requests-tab');
    const table = requestsTab ? requestsTab.querySelector('.data-table') : null;
    
    if (!table) return; // Exit if table not found
    
    const rows = table.getElementsByTagName('tr');
    
    // Skip header row (index 0)
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const urgentBadge = row.querySelector('[style*="background: #dc3545"]'); // URGENT badge
        
        let showRow = true;
        
        // Filter by urgent status (client-side only)
        if (urgentValue) {
            const isUrgent = urgentBadge !== null;
            if (urgentValue === 'urgent' && !isUrgent) {
                showRow = false;
            } else if (urgentValue === 'not_urgent' && isUrgent) {
                showRow = false;
            }
        }
        
        // Show or hide row
        row.style.display = showRow ? '' : 'none';
    }
}

function clearSearch() {
    document.getElementById('tabSearchInput').value = '';
    performSearch();
}

function showTab(tabName) {
    // Hide all main dashboard tabs (not nested ones)
    const mainTabs = document.querySelectorAll('#requests-tab, #users-tab, #request-types-tab, #person-company-names-tab, #procurement-categories-items-tab, #branches-tab, #logs-tab');
    mainTabs.forEach(tab => {
        tab.classList.remove('active');
        tab.style.display = 'none';
    });
    
    // Remove active class from all buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    
    // Show selected tab
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
        targetTab.classList.add('active');
        targetTab.style.display = 'block';
    }
    
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
}

function switchTab(tabId) {
    // Redirect to the same page with the tab parameter
    const url = new URL(window.location);
    url.searchParams.set('tab', tabId);
    url.searchParams.set('page', '1'); // Reset to page 1 when switching tabs
    window.location.href = url.toString();
}

function changeItemsPerPage(perPage) {
    // Redirect to page 1 with new per_page value
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1');
    window.location.href = url.toString();
}

// Checkbox functionality
function toggleAllCheckboxes(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.request-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.request-checkbox');
    const checkedBoxes = document.querySelectorAll('.request-checkbox:checked');
    const selectedCount = checkedBoxes.length;
    const bulkActions = document.getElementById('bulkActions');
    const selectedCountSpan = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const bulkViewBtn = document.getElementById('bulkViewBtn');
    
    // Update selected count
    selectedCountSpan.textContent = `${selectedCount} item${selectedCount !== 1 ? 's' : ''} selected`;
    
    // Show/hide bulk actions
    if (selectedCount > 0) {
        bulkActions.style.display = 'block';
        bulkDeleteBtn.disabled = false;
        bulkViewBtn.disabled = false;
    } else {
        bulkActions.style.display = 'none';
        bulkDeleteBtn.disabled = true;
        bulkViewBtn.disabled = true;
    }
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectedCount === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (selectedCount === checkboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.request-checkbox');
    const selectAllCheckbox = document.getElementById('selectAll');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
    
    updateBulkActions();
}

function bulkDelete() {
    const checkedBoxes = document.querySelectorAll('.request-checkbox:checked');
    const requestIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (requestIds.length === 0) {
        alert('Please select at least one request to delete.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${requestIds.length} request(s)? This action cannot be undone.`)) {
        // Create a form to submit multiple deletions
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("bulk_delete_requests") }}';
        
        requestIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'request_ids';
            input.value = id;
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }
}

function bulkView() {
    const checkedBoxes = document.querySelectorAll('.request-checkbox:checked');
    const requestIds = Array.from(checkedBoxes).map(cb => cb.value);
    
    if (requestIds.length === 0) {
        alert('Please select at least one request to view.');
        return;
    }
    
    if (requestIds.length === 1) {
        // Single request - redirect to view page
        window.location.href = `{{ url_for('view_request', request_id=0) }}`.replace('0', requestIds[0]);
    } else {
        // Multiple requests - show in new window/tab
        const urls = requestIds.map(id => `{{ url_for('view_request', request_id=0) }}`.replace('0', id));
        urls.forEach(url => {
            window.open(url, '_blank');
        });
    }
}

// Initialize tab search functionality when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Set up tab search functionality
    const tabSearchInput = document.getElementById('tabSearchInput');
    if (tabSearchInput) {
        // Clear any existing debounce timer
        tabSearchInput.addEventListener('input', function() {
            clearTimeout(searchDebounceTimer);
            // Wait 500ms after user stops typing before performing search
            searchDebounceTimer = setTimeout(function() {
                performSearch(false);
            }, 500);
        });
        
        // Also trigger search on Enter key
        tabSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchDebounceTimer);
                performSearch(true);
            }
        });
    }
    
    // Set up tab search button
    const tabSearchBtn = document.querySelector('.tab-search-btn');
    if (tabSearchBtn) {
        tabSearchBtn.addEventListener('click', function() {
            clearTimeout(searchDebounceTimer);
            performSearch(true);
        });
    }
    
    // Set up Request Types search functionality
    const requestTypesSearchInput = document.getElementById('request_types_search');
    if (requestTypesSearchInput) {
        requestTypesSearchInput.addEventListener('input', function() {
            clearTimeout(requestTypesSearchDebounceTimer);
            // Wait 500ms after user stops typing before performing search
            requestTypesSearchDebounceTimer = setTimeout(function() {
                performRequestTypesSearch(false);
            }, 500);
        });
        
        // Also trigger search on Enter key
        requestTypesSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(requestTypesSearchDebounceTimer);
                performRequestTypesSearch(true);
            }
        });
    }
    
    // Set up Person/Company Names search functionality
    const personCompanySearchInput = document.getElementById('person_company_search');
    if (personCompanySearchInput) {
        personCompanySearchInput.addEventListener('input', function() {
            clearTimeout(personCompanySearchDebounceTimer);
            // Wait 500ms after user stops typing before performing search
            personCompanySearchDebounceTimer = setTimeout(function() {
                performPersonCompanySearch(false);
            }, 500);
        });
        
        // Also trigger search on Enter key
        personCompanySearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(personCompanySearchDebounceTimer);
                performPersonCompanySearch(true);
            }
        });
    }
    
    // Set up department filter change handlers
    const departmentFilter = document.getElementById('department_filter');
    if (departmentFilter) {
        departmentFilter.addEventListener('change', function() {
            // Update URL and refresh request types
            const url = new URL(window.location);
            const deptValue = this.value;
            if (deptValue && deptValue !== 'all') {
                url.searchParams.set('department', deptValue);
            } else {
                url.searchParams.delete('department');
            }
            url.searchParams.set('tab', 'request-types');
            url.searchParams.delete('request_types_search'); // Clear search when department changes
            window.location.href = url.toString();
        });
    }
    
    const departmentFilterPCN = document.getElementById('department_filter_pcn');
    if (departmentFilterPCN) {
        departmentFilterPCN.addEventListener('change', function() {
            // Update URL and refresh person/company options
            const url = new URL(window.location);
            const deptValue = this.value;
            if (deptValue && deptValue !== 'all') {
                url.searchParams.set('department', deptValue);
            } else {
                url.searchParams.delete('department');
            }
            url.searchParams.set('tab', 'person-company-names');
            url.searchParams.delete('person_company_search'); // Clear search when department changes
            window.location.href = url.toString();
        });
    }
    
    // Set up Procurement Categories/Items search functionality
    let procurementSearchDebounceTimer;
    const procurementSearchInput = document.getElementById('procurement_search');
    if (procurementSearchInput) {
        procurementSearchInput.addEventListener('input', function() {
            clearTimeout(procurementSearchDebounceTimer);
            // Wait 500ms after user stops typing before performing search
            procurementSearchDebounceTimer = setTimeout(function() {
                performProcurementSearch(false);
            }, 500);
        });
        
        // Also trigger search on Enter key
        procurementSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(procurementSearchDebounceTimer);
                performProcurementSearch(true);
            }
        });
    }
    
    // Set up Procurement department filter change handler
    const procurementDepartmentFilter = document.getElementById('procurement_department_filter');
    if (procurementDepartmentFilter) {
        procurementDepartmentFilter.addEventListener('change', function() {
            // Update URL and refresh procurement categories/items
            const url = new URL(window.location);
            const deptValue = this.value;
            if (deptValue && deptValue !== 'all') {
                url.searchParams.set('procurement_department_filter', deptValue);
            } else {
                url.searchParams.delete('procurement_department_filter');
            }
            url.searchParams.set('tab', 'procurement-categories-items');
            url.searchParams.delete('procurement_search'); // Clear search when department changes
            window.location.href = url.toString();
        });
    }
    
    // Initialize tab display - show only the active main dashboard tab
    const mainTabs = document.querySelectorAll('#requests-tab, #users-tab, #request-types-tab, #person-company-names-tab, #procurement-categories-items-tab, #branches-tab, #logs-tab');
    mainTabs.forEach(tab => {
        if (!tab.classList.contains('active')) {
            tab.style.display = 'none';
        } else {
            tab.style.display = 'block';
        }
    });
    
    // Initialize drag-and-drop for location priorities
    const locationsTableBody = document.getElementById('locationsTableBody');
    if (locationsTableBody) {
        // Load SortableJS if not already loaded
        if (typeof Sortable !== 'undefined') {
            const sortable = Sortable.create(locationsTableBody, {
                handle: '.badge-info',
                animation: 150,
                onEnd: function(evt) {
                    // Update priorities based on new order
                    const rows = locationsTableBody.querySelectorAll('tr');
                    const orders = [];
                    
                    rows.forEach((row, index) => {
                        const locationId = row.getAttribute('data-location-id');
                        if (locationId) {
                            const newPriority = index + 1; // Start from 1
                            orders.push({
                                id: parseInt(locationId),
                                priority: newPriority
                            });
                        }
                    });
                    
                    // Send update to server
                    fetch('{{ url_for("reorder_locations") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ orders: orders })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update priority badges
                            rows.forEach((row, index) => {
                                const badge = row.querySelector('.badge-info');
                                if (badge) {
                                    badge.textContent = index + 1;
                                }
                                row.setAttribute('data-priority', index + 1);
                            });
                            
                            // Show success message
                            const alert = document.createElement('div');
                            alert.className = 'alert alert-success alert-dismissible fade show';
                            alert.innerHTML = '<i class="fas fa-check-circle"></i> Location priorities updated successfully!';
                            alert.style.position = 'fixed';
                            alert.style.top = '20px';
                            alert.style.right = '20px';
                            alert.style.zIndex = '9999';
                            document.body.appendChild(alert);
                            
                            setTimeout(() => {
                                alert.remove();
                            }, 3000);
                        } else {
                            alert('Error updating priorities: ' + (data.error || 'Unknown error'));
                            location.reload(); // Reload to restore original order
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating priorities. Please refresh the page.');
                        location.reload();
                    });
                }
            });
        } else {
            // Load SortableJS dynamically
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js';
            script.onload = function() {
                const sortable = Sortable.create(locationsTableBody, {
                    handle: '.badge-info',
                    animation: 150,
                    onEnd: function(evt) {
                        const rows = locationsTableBody.querySelectorAll('tr');
                        const orders = [];
                        
                        rows.forEach((row, index) => {
                            const locationId = row.getAttribute('data-location-id');
                            if (locationId) {
                                orders.push({
                                    id: parseInt(locationId),
                                    priority: index + 1
                                });
                            }
                        });
                        
                        fetch('{{ url_for("reorder_locations") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ orders: orders })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                rows.forEach((row, index) => {
                                    const badge = row.querySelector('.badge-info');
                                    if (badge) badge.textContent = index + 1;
                                    row.setAttribute('data-priority', index + 1);
                                });
                                
                                const alert = document.createElement('div');
                                alert.className = 'alert alert-success alert-dismissible fade show';
                                alert.innerHTML = '<i class="fas fa-check-circle"></i> Location priorities updated successfully!';
                                alert.style.position = 'fixed';
                                alert.style.top = '20px';
                                alert.style.right = '20px';
                                alert.style.zIndex = '9999';
                                document.body.appendChild(alert);
                                setTimeout(() => alert.remove(), 3000);
                            } else {
                                alert('Error updating priorities: ' + (data.error || 'Unknown error'));
                                location.reload();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('Error updating priorities. Please refresh the page.');
                            location.reload();
                        });
                    }
                });
            };
            document.head.appendChild(script);
        }
    }
});

</script>

<style>
/* Drag and drop styling for location priorities */
#locationsTableBody tr {
    cursor: move;
}

#locationsTableBody tr:hover {
    background-color: #f8f9fa;
}

#locationsTableBody .badge-info {
    cursor: grab;
}

#locationsTableBody .badge-info:active {
    cursor: grabbing;
}

#locationsTableBody tr.sortable-ghost {
    opacity: 0.4;
    background-color: #e9ecef;
}

/* Ensure priority column is wider */
#locationsTable th:first-child,
#locationsTable td:first-child {
    width: 120px !important;
    min-width: 120px !important;
    max-width: 120px !important;
}
</style>
{% endblock %}

