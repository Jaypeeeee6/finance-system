<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Payment Request Management System{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% block extra_css %}{% endblock %}
    <!-- Tab session validation - must run before page content -->
    {% if current_user.is_authenticated %}
    <script>
    (function(){
        // IMMEDIATE CHECK - Redirect before page renders if session is invalid
        const TAB_SESSION_KEY = 'tab_session_id';
        const serverTabSessionId = '{{ session.get("tab_session_id", "") }}';
        const storedTabSessionId = sessionStorage.getItem(TAB_SESSION_KEY);
        
        // Check if this is a new tab: server has tab_session_id but client doesn't
        // Exception: If we just logged in (login_complete flag or coming from /login), store it
        const loginComplete = sessionStorage.getItem('login_complete');
        const comingFromLogin = document.referrer && document.referrer.includes('/login');
        
        if (serverTabSessionId && !storedTabSessionId) {
            if (loginComplete === 'true' || comingFromLogin) {
                // We just logged in - store the tab_session_id for this tab
                sessionStorage.setItem(TAB_SESSION_KEY, serverTabSessionId);
                sessionStorage.setItem('login_complete', 'true');
            } else {
                // New tab detected - server has session but this tab doesn't - redirect to logout
                sessionStorage.removeItem(TAB_SESSION_KEY);
                sessionStorage.removeItem('login_complete');
                window.location.replace("{{ url_for('logout') }}");
                return; // Prevent further execution
            }
        }
        
        // If stored ID doesn't match server ID, invalidate
        if (storedTabSessionId && serverTabSessionId && storedTabSessionId !== serverTabSessionId) {
            sessionStorage.removeItem(TAB_SESSION_KEY);
            window.location.replace("{{ url_for('logout') }}");
            return;
        }
        
        // Validate with server - if invalid, redirect immediately
        if (storedTabSessionId || serverTabSessionId) {
            fetch("{{ url_for('check_tab_session') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tab_session_id: storedTabSessionId || serverTabSessionId }),
                cache: 'no-cache'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    sessionStorage.removeItem(TAB_SESSION_KEY);
                    window.location.replace("{{ url_for('logout') }}");
                } else if (data.tab_session_id) {
                    sessionStorage.setItem(TAB_SESSION_KEY, data.tab_session_id);
                }
            })
            .catch(error => {
                console.error('Tab session check failed:', error);
                sessionStorage.removeItem(TAB_SESSION_KEY);
                window.location.replace("{{ url_for('logout') }}");
            });
        }
    })();
    </script>
    <style>
        /* Hide body content until tab session is validated */
        body.tab-session-pending {
            visibility: hidden;
        }
    </style>
    {% endif %}
</head>
<body {% if current_user.is_authenticated %}class="tab-session-pending" data-user-role="{{ current_user.role }}" data-user-department="{{ current_user.department }}" data-user-name="{{ current_user.name }}"{% endif %}>
    {% if current_user.is_authenticated %}
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <button class="hamburger-menu-desktop" id="hamburger-menu-desktop" aria-label="Toggle menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <img src="{{ url_for('static', filename='css/images/Maa-logo-transparent.png') }}" alt="Maa logo" class="nav-brand-logo" />
                <span>Payment System</span>
            </div>
            <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="notification-bell-container-responsive">
                <button class="notification-bell" onclick="toggleNotificationDropdown()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="nav-notification-badge-responsive" style="display: none;">0</span>
                </button>
                <div class="notification-dropdown" id="notification-dropdown-responsive">
                    <div class="notification-dropdown-header">
                        <h3>Notifications</h3>
                        <button class="close-dropdown" onclick="closeNotificationDropdown()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-dropdown-content" id="notification-dropdown-content-responsive">
                        <div class="notification-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    </div>
                    <div class="notification-dropdown-footer">
                        <button onclick="markAllAsRead()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-check-double"></i> Mark All as Read
                        </button>
                        <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-list"></i> View All
                        </a>
                    </div>
                </div>
            </div>
            <ul class="nav-menu" id="nav-menu">
                {% if not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <li class="nav-menu-desktop-hidden"><a href="{{ url_for('dashboard') }}" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
                {% endif %}
                
                {# Determine who can see each report separately. Payment reports keep existing roles; Item reports limited to GM, CEO, Operation Manager, IT department users, and Procurement Department Manager #}
                {% set can_view_payment_reports = current_user.role in ['Finance Admin', 'Finance Staff', 'GM', 'CEO', 'IT Staff', 'Department Manager', 'Operation Manager', 'Auditing Staff'] %}
                {% set can_view_item_reports = (current_user.role in ['GM', 'CEO', 'Operation Manager', 'Auditing Staff']) or (current_user.department == 'IT') or (current_user.role == 'Department Manager' and current_user.department == 'Procurement') %}

                {# If item reports are available, show a dropdown containing available report links.
                   If item reports are NOT available but payment reports are, show a direct Reports link that
                   redirects immediately to Payment Request Reports. #}
                {% if can_view_item_reports and not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <li class="reports-dropdown nav-menu-desktop-hidden">
                    <button type="button" class="nav-link reports-toggle">
                        <i class="fas fa-chart-bar"></i> Reports
                        <i class="fas fa-caret-down dropdown-caret"></i>
                    </button>
                    <div class="reports-menu">
                        {% if can_view_payment_reports %}
                        <a href="{{ url_for('reports') }}">
                            <span>Payment Request Reports</span>
                        </a>
                        {% endif %}

                        <a href="{{ url_for('item_request_reports') }}">
                            <span>Item Request Reports</span>
                        </a>
                    </div>
                </li>
                {% elif can_view_payment_reports %}
                <li class="nav-menu-desktop-hidden">
                    <a href="{{ url_for('reports') }}" class="nav-link">
                        <i class="fas fa-chart-bar"></i> Reports
                    </a>
                </li>
                {% endif %}
                
                {% if show_item_requests_flag or (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <li class="nav-menu-desktop-hidden"><a href="{{ url_for('procurement_item_requests') }}" class="nav-link"><i class="fas fa-shopping-cart"></i> Item Requests</a></li>
                {% endif %}
                
                {% if (current_user.role in ['Admin', 'Project Staff', 'Finance Admin', 'Finance Staff', 'GM', 'CEO', 'Operation Manager', 'IT Staff'] or (current_user.role == 'Department Manager' and current_user.department == 'IT')) and not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <li class="calendar-link-container">
                    <a href="{{ url_for('admin_calendar') }}" class="nav-link calendar-link">
                        <i class="fas fa-calendar-alt"></i> Calendar
                        <span class="notification-badge" id="nav-calendar-badge" style="display: none;">0</span>
                    </a>
                </li>
                {% endif %}
                
                
                
                <li class="notification-bell-container">
                    <button class="notification-bell" onclick="toggleNotificationDropdown()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="nav-notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-dropdown-header">
                            <h3>Notifications</h3>
                            <button class="close-dropdown" onclick="closeNotificationDropdown()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="notification-dropdown-content" id="notification-dropdown-content">
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                        <div class="notification-dropdown-footer">
                            <button onclick="markAllAsRead()" class="btn btn-sm btn-secondary">
                                <i class="fas fa-check-double"></i> Mark All as Read
                            </button>
                            <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                </li>
                <li class="nav-user">
                    <span class="user-info" {% if current_user.department == 'IT' or current_user.name == 'Super Admin' %}onclick="toggleUserSettingsDropdown()" style="cursor: pointer;"{% endif %}>
                        <i class="fas fa-user-circle"></i>
                        <span>{{ current_user.name }}</span>
                        <span class="user-role">{{ current_user.role }}</span>
                        {% if current_user.department == 'IT' or current_user.name == 'Super Admin' %}
                        <i class="fas fa-caret-down user-dropdown-caret"></i>
                        {% endif %}
                    </span>
                    {% if current_user.department == 'IT' or current_user.name == 'Super Admin' %}
                    <div class="notification-dropdown user-settings-dropdown" id="user-settings-dropdown">
                        <div class="notification-dropdown-content">
                            <button id="maintenance-toggle" class="btn btn-sm btn-warning" type="button" style="width: 100%; margin-bottom: 0.5rem;">
                                <i class="fas fa-tools"></i> Enable Maintenance
                            </button>
                            {# Removed 'Show Item Requests' toggle per request - Item Requests always visible #}
                            <button class="btn btn-sm btn-secondary" type="button" style="width: 100%;" onclick="toggleLoginTesting()">
                                <i class="fas fa-flask"></i>
                                {% if show_test_login_flag %}Hide Login for Testing{% else %}Show Login for Testing{% endif %}
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </li>
                <li class="nav-menu-desktop-hidden"><a href="{{ url_for('logout') }}" class="nav-link logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- Desktop Hamburger Side Popup Menu -->
    <div class="desktop-sidebar-menu" id="desktop-sidebar-menu">
        <div class="desktop-sidebar-overlay" id="desktop-sidebar-overlay"></div>
        <div class="desktop-sidebar-content">
            <button class="desktop-sidebar-close" id="desktop-sidebar-close" aria-label="Close menu">
                <i class="fas fa-times"></i>
            </button>
            <nav class="desktop-sidebar-nav">
                {% if not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <a href="{{ url_for('dashboard') }}" class="desktop-sidebar-item {% if request.path.startswith(url_for('dashboard')) or request.path.startswith(url_for('admin_dashboard')) or request.path.startswith(url_for('finance_dashboard')) or request.path.startswith(url_for('project_dashboard')) or request.path.startswith(url_for('operation_dashboard')) or request.path.startswith(url_for('procurement_dashboard')) or request.path.startswith(url_for('department_dashboard')) or request.path.startswith(url_for('gm_dashboard')) or request.path.startswith(url_for('ceo_dashboard')) or request.path.startswith(url_for('it_dashboard')) %}active{% endif %}">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                {% endif %}
                {% if can_view_item_reports and not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <div class="desktop-sidebar-dropdown">
                    <button class="desktop-sidebar-item desktop-sidebar-dropdown-toggle {% if request.path.startswith(url_for('reports')) or request.path.startswith(url_for('item_request_reports')) %}active{% endif %}" id="reports-dropdown-toggle">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                        <i class="fas fa-chevron-down dropdown-chevron"></i>
                    </button>
                    <div class="desktop-sidebar-submenu" id="reports-submenu">
                        {% if can_view_payment_reports %}
                        <a href="{{ url_for('reports') }}" class="desktop-sidebar-submenu-item {% if request.path.startswith(url_for('reports')) %}active{% endif %}">
                            <span>Payment Request Reports</span>
                        </a>
                        {% endif %}
                        <a href="{{ url_for('item_request_reports') }}" class="desktop-sidebar-submenu-item {% if request.path.startswith(url_for('item_request_reports')) %}active{% endif %}">
                            <span>Item Request Reports</span>
                        </a>
                    </div>
                </div>
                {% elif can_view_payment_reports %}
                <a href="{{ url_for('reports') }}" class="desktop-sidebar-item {% if request.path.startswith(url_for('reports')) %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </a>
                {% endif %}
                {% if show_item_requests_flag or (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <a href="{{ url_for('procurement_item_requests') }}" class="desktop-sidebar-item {% if request.path.startswith(url_for('procurement_item_requests')) %}active{% endif %}">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Item Requests</span>
                </a>
                {% endif %}
                {% if (current_user.role == 'IT Staff' or (current_user.role == 'Department Manager' and current_user.department == 'IT') or current_user.name == 'Super Admin') and not (current_user.department == 'Branch' and current_user.role in ['Branch Manager', 'Supervisor']) %}
                <a href="{{ url_for('archives') }}" class="desktop-sidebar-item {% if request.path.startswith(url_for('archives')) %}active{% endif %}">
                    <i class="fas fa-archive"></i>
                    <span>Archives</span>
                </a>
                {% endif %}
            </nav>
            <div class="desktop-sidebar-footer">
                <a href="{{ url_for('logout') }}" class="desktop-sidebar-item logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <main class="main-content">
        {% set maint = None %}
        {% if current_user.is_authenticated and (current_user.department == 'IT' or current_user.name == 'Super Admin') %}
            {% set maint = namespace(enabled=false, message='') %}
            {# IT users see an active maintenance banner if enabled #}
            {% if false %}{% endif %}
        {% endif %}
        {% if current_user.is_authenticated and (current_user.department == 'IT' or current_user.name == 'Super Admin') %}
        <div id="maintenance-banner" style="display:none;" class="maintenance-banner">
            <div class="maintenance-banner-content">
                <i class="fas fa-tools"></i>
                <span><strong>Maintenance Mode</strong> is ON. Non-IT users see a maintenance page.</span>
                <form method="POST" action="{{ url_for('maintenance_disable') }}" style="margin-left:auto;" onsubmit="return confirm('Disable maintenance mode and allow all users back in?');">
                    <button class="btn btn-sm btn-warning" type="submit"><i class="fas fa-power-off"></i> Disable</button>
                </form>
            </div>
        </div>
        <script>
        // Fetch status to toggle banner for IT users and set toggle button behavior
        (function(){
            const banner = document.getElementById('maintenance-banner');
            const toggleBtn = document.getElementById('maintenance-toggle');
            function setEnableBehavior(){
                if(!toggleBtn) return;
                toggleBtn.innerHTML = '<i class="fas fa-tools"></i> Enable Maintenance';
                toggleBtn.onclick = async function(){
                    if(!confirm('Enable maintenance mode? Non-IT users will be blocked until disabled.')) return;
                    const message = prompt('Optional message to display during maintenance:');
                    try{
                        await fetch('/maintenance/enable', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ message }) });
                        location.reload();
                    }catch(e){ console.error(e); }
                };
            }
            function setDisableBehavior(){
                if(!toggleBtn) return;
                toggleBtn.innerHTML = '<i class="fas fa-tools"></i> Disable Maintenance';
                toggleBtn.onclick = async function(){
                    if(!confirm('Disable maintenance mode and allow all users back in?')) return;
                    try{
                        await fetch('/maintenance/disable', { method:'POST' });
                        location.reload();
                    }catch(e){ console.error(e); }
                };
            }
            fetch('/maintenance/status')
                .then(r=>r.json())
                .then(s=>{
                    if(s.enabled){
                        if(banner) banner.style.display = 'block';
                        setDisableBehavior();
                    } else {
                        if(banner) banner.style.display = 'none';
                        setEnableBehavior();
                    }
                })
                .catch(()=>{ setEnableBehavior(); });
        })();
        </script>
        {% endif %}
        {# Optionally suppress one-time flashed messages for branch users right after login.
           When app.py sets session['suppress_flashes_once']=True we skip rendering flashes once
           and remove the flag so future flashes behave normally. #}
        {% if session.get('suppress_flashes_once') %}
            {% set _ = session.pop('suppress_flashes_once') %}
            {% set messages = [] %}
        {% else %}
            {% set messages = get_flashed_messages(with_categories=true) %}
        {% endif %}

        {# Show permission_denied session message first (if any) and clear it #}
        {% if session.get('permission_denied') %}
            <div class="flash-messages">
                <div class="alert alert-danger">
                    <span>{{ session.pop('permission_denied') }}</span>
                    <button class="close-alert" onclick="this.parentElement.remove()">&times;</button>
                </div>
            </div>
        {% endif %}

        {% if messages %}
            {# Existing inline alerts remain for non-error categories #}
            <div class="flash-messages">
                {% for category, message in messages %}
                    {% if category != 'error' %}
                    <div class="alert alert-{{ category }}">
                        <span>{{ message }}</span>
                        <button class="close-alert" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>

            {# Central modal-style error dialog with OK button for error messages #}
            {% for category, message in messages %}
                {% if category == 'error' %}
                <div id="flash-error-modal" class="flash-error-modal" style="display:flex;">
                    <div class="flash-error-backdrop"></div>
                    <div class="flash-error-dialog">
                        <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
                        <div class="flash-error-body">
                            {{ message }}
                        </div>
                        <div class="flash-error-actions">
                            <button type="button" class="flash-error-ok-btn" onclick="(function(){ var m=document.getElementById('flash-error-modal'); if(m){m.style.display='none'; document.body.classList.remove('flash-error-open');}})()">OK</button>
                        </div>
                    </div>
                </div>
                <script>
                    // Ensure body is dimmed and scrolling is locked when error modal is shown
                    document.addEventListener('DOMContentLoaded', function() {
                        var m = document.getElementById('flash-error-modal');
                        if (m) {
                            document.body.classList.add('flash-error-open');
                        }
                    });
                </script>
                {% endif %}
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>&copy; 2024 Payment Request Management System. All rights reserved.</p>
    </footer>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/realtime.js') }}"></script>
    <script src="{{ url_for('static', filename='js/multiple-file-upload.js') }}"></script>
    
    <!-- Tab session validation completion and inactivity auto-logout (10 minutes) -->
    {% if current_user.is_authenticated %}
    <script>
    (function(){
        // Show page content after validation (if we get here, session is valid)
        document.body.classList.remove('tab-session-pending');
        
        // Inactivity auto-logout (10 minutes)
        const TAB_SESSION_KEY = 'tab_session_id'; // Define here for idle timeout
        let idleTimer = null;
        const IDLE_LIMIT_MS = 10 * 60 * 1000; // 10 minutes = 600,000 milliseconds
        
        const resetTimer = () => {
            if (idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                // User has been idle for 10 minutes - log them out
                // Clear tab session and redirect to logout
                sessionStorage.removeItem(TAB_SESSION_KEY);
                sessionStorage.removeItem('login_complete');
                window.location.href = "{{ url_for('logout') }}";
            }, IDLE_LIMIT_MS);
        };
        ['click','mousemove','keydown','scroll','touchstart','touchmove','focus'].forEach(evt => {
            window.addEventListener(evt, resetTimer, { passive: true });
        });
        // Start timer on load
        resetTimer();
        // Also reset when tab becomes visible again
        document.addEventListener('visibilitychange', function(){ if (!document.hidden) resetTimer(); });
        
        // Clear tab session when tab is closed (best effort - not always reliable)
        window.addEventListener('beforeunload', function() {
            // Try to clear sessionStorage (though this may not always execute)
            try {
                sessionStorage.removeItem(TAB_SESSION_KEY);
            } catch(e) {}
        });
    })();
    </script>
    {% endif %}
    
    <!-- Hamburger Menu JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const hamburgerMenuDesktop = document.getElementById('hamburger-menu-desktop');
        const navMenu = document.getElementById('nav-menu');
        const desktopSidebar = document.getElementById('desktop-sidebar-menu');
        const desktopSidebarClose = document.getElementById('desktop-sidebar-close');
        const desktopSidebarOverlay = document.getElementById('desktop-sidebar-overlay');
        
        // Handle responsive hamburger menu
        if (hamburgerMenu && navMenu) {
            hamburgerMenu.addEventListener('click', function() {
                hamburgerMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                const isClickInsideMenu = navMenu.contains(event.target);
                const isClickOnHamburger = hamburgerMenu.contains(event.target);
                
                if (!isClickInsideMenu && !isClickOnHamburger && navMenu.classList.contains('active')) {
                    hamburgerMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });
            
            // Close menu when clicking on a nav link (but not the Reports toggle)
            const navLinks = navMenu.querySelectorAll('.nav-link:not(.reports-toggle)');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    hamburgerMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
            
            // Close menu when clicking on reports submenu items (after toggling reports dropdown)
            const reportsMenuLinks = navMenu.querySelectorAll('.reports-menu a');
            reportsMenuLinks.forEach(link => {
                link.addEventListener('click', function() {
                    hamburgerMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
        }
        
        // Handle desktop hamburger menu (opens sidebar)
        if (hamburgerMenuDesktop && desktopSidebar) {
            hamburgerMenuDesktop.addEventListener('click', function(e) {
                e.preventDefault();
                hamburgerMenuDesktop.classList.toggle('active');
                desktopSidebar.classList.toggle('active');
            });
        }
        
        // Close desktop sidebar when clicking close button
        if (desktopSidebarClose && desktopSidebar) {
            desktopSidebarClose.addEventListener('click', function() {
                desktopSidebar.classList.remove('active');
                hamburgerMenuDesktop.classList.remove('active');
            });
        }
        
        // Close desktop sidebar when clicking overlay
        if (desktopSidebarOverlay && desktopSidebar) {
            desktopSidebarOverlay.addEventListener('click', function() {
                desktopSidebar.classList.remove('active');
                hamburgerMenuDesktop.classList.remove('active');
            });
        }
        
        // Handle Reports dropdown in sidebar
        const reportsDropdownToggle = document.getElementById('reports-dropdown-toggle');
        const reportsSubmenu = document.getElementById('reports-submenu');
        
        if (reportsDropdownToggle && reportsSubmenu) {
            reportsDropdownToggle.addEventListener('click', function(e) {
                e.preventDefault();
                reportsDropdownToggle.classList.toggle('active');
                reportsSubmenu.classList.toggle('active');
            });
        }
        
        // Close desktop sidebar when clicking on a non-dropdown sidebar link
        if (desktopSidebar) {
            const sidebarLinks = desktopSidebar.querySelectorAll('.desktop-sidebar-item:not(.desktop-sidebar-dropdown-toggle)');
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function() {
                    desktopSidebar.classList.remove('active');
                    hamburgerMenuDesktop.classList.remove('active');
                });
            });
        }
        
        // Close sidebar and reset dropdown when clicking on a submenu link
        if (reportsSubmenu) {
            const submenuLinks = reportsSubmenu.querySelectorAll('.desktop-sidebar-submenu-item');
            submenuLinks.forEach(link => {
                link.addEventListener('click', function() {
                    desktopSidebar.classList.remove('active');
                    hamburgerMenuDesktop.classList.remove('active');
                    reportsDropdownToggle.classList.remove('active');
                    reportsSubmenu.classList.remove('active');
                });
            });
        }
    });
    </script>
    
    <!-- Notification Bell JavaScript -->
    <script>
    let notificationDropdownOpen = false;
    let userSettingsDropdownOpen = false;
    
    function getResponsiveMode() {
        return window.innerWidth <= 1024;
    }
    
    function toggleNotificationDropdown() {
        const isResponsive = getResponsiveMode();
        const dropdownId = isResponsive ? 'notification-dropdown-responsive' : 'notification-dropdown';
        const contentId = isResponsive ? 'notification-dropdown-content-responsive' : 'notification-dropdown-content';
        
        const dropdown = document.getElementById(dropdownId);
        if (notificationDropdownOpen) {
            closeNotificationDropdown();
        } else {
            openNotificationDropdown(dropdownId, contentId);
        }
    }
    
    function openNotificationDropdown(dropdownId, contentId) {
        const dropdown = document.getElementById(dropdownId);
        const content = document.getElementById(contentId);
        
        if (!dropdown || !content) return;
        
        dropdown.classList.add('show');
        notificationDropdownOpen = true;
        
        // Update notification count first
        updateNotificationBadge();
        
        // Load notifications
        loadNotifications(contentId);
    }
    
    function closeNotificationDropdown() {
        const desktopDropdown = document.getElementById('notification-dropdown');
        const responsiveDropdown = document.getElementById('notification-dropdown-responsive');
        
        if (desktopDropdown) desktopDropdown.classList.remove('show');
        if (responsiveDropdown) responsiveDropdown.classList.remove('show');
        notificationDropdownOpen = false;
        
        // Stop dynamic time updates when dropdown is closed
        stopDynamicTimeUpdates();
    }
    
    function toggleUserSettingsDropdown() {
        const dropdown = document.getElementById('user-settings-dropdown');
        if (!dropdown) return;
        const isOpen = dropdown.classList.contains('show');
        closeUserSettingsDropdown();
        if (!isOpen) {
            dropdown.classList.add('show');
            userSettingsDropdownOpen = true;
        }
    }
    
    function closeUserSettingsDropdown() {
        const dropdown = document.getElementById('user-settings-dropdown');
        if (dropdown) dropdown.classList.remove('show');
        userSettingsDropdownOpen = false;
    }

    // 'toggleItemRequests' removed â€” Item Requests are always visible now.

    async function toggleLoginTesting() {
        if (!confirm('Toggle visibility of the Login for Testing button on the login page?')) return;
        try {
            const resp = await fetch('/it/tools/toggle_login_testing', {
                method: 'POST',
                headers: { 'X-Requested-With': 'fetch' }
            });
            const data = await resp.json();
            if (data && data.success) {
                alert(data.message || 'Login for Testing visibility updated.');
                // No need to reload current page unless on login; but safe to reload
                location.reload();
            } else {
                alert(data.message || 'Failed to toggle Login for Testing visibility.');
            }
        } catch (e) {
            console.error(e);
            alert('Error toggling Login for Testing visibility. Please try again.');
        }
    }
    
    function loadNotifications(contentId) {
        const content = document.getElementById(contentId);
        if (!content) return;
        
        content.innerHTML = '<div class="notification-loading"><i class="fas fa-spinner fa-spin"></i> Loading notifications...</div>';
        
        fetch('/api/notifications/recent')
            .then(response => response.json())
            .then(data => {
                console.log('ðŸ”” DEBUG: Loaded notifications:', data);
                displayNotifications(data, contentId);
                // Update notification count after loading
                updateNotificationBadge();
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                if (content) {
                    content.innerHTML = '<div class="notification-empty"><i class="fas fa-exclamation-triangle"></i><p>Error loading notifications</p></div>';
                }
            });
    }
    
    function displayNotifications(notifications, contentId) {
        const content = document.getElementById(contentId);
        if (!content) return;
        
        if (notifications.length === 0) {
            content.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
            return;
        }
        
        let html = '';
        notifications.forEach(notification => {
            const isUnread = !notification.is_read;
            
            html += `
                <div class="notification-item-dropdown ${isUnread ? 'unread' : ''}" data-notification-id="${notification.notification_id}" data-created-at="${notification.created_at}">
                    <div class="notification-title-dropdown">
                        ${isUnread ? '<i class="fas fa-circle notification-dot"></i>' : ''}
                        ${notification.title}
                    </div>
                    <div class="notification-message-dropdown">${notification.message}</div>
                    <div class="notification-time-dropdown" data-time-element="true">${getTimeAgo(notification.created_at)}</div>
                    <div class="notification-actions-dropdown">
                        ${notification.request_id ? `<a href="/request/${notification.request_id}" class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</a>` : ''}
                        ${notification.item_request_id ? `<a href="/procurement/item-request/${notification.item_request_id}/view" class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</a>` : ''}
                        ${isUnread ? `<button onclick=\"markAsRead(${notification.notification_id})\" class=\"btn btn-sm btn-success\"><i class=\"fas fa-check\"></i> Mark Read</button>` : ''}
                    </div>
                </div>
            `;
        });
        
        content.innerHTML = html;
        
        // Start dynamic time updates
        startDynamicTimeUpdates();
    }
    
    function startDynamicTimeUpdates() {
        if (window.notificationTimeInterval) {
            clearInterval(window.notificationTimeInterval);
        }
        window.notificationTimeInterval = setInterval(() => {
            const timeElements = document.querySelectorAll('[data-time-element="true"]');
            timeElements.forEach(element => {
                const notificationItem = element.closest('.notification-item-dropdown');
                const createdAt = notificationItem.getAttribute('data-created-at');
                if (createdAt) {
                    element.textContent = getTimeAgo(createdAt);
                }
            });
        }, 60000);
    }
    
    function stopDynamicTimeUpdates() {
        if (window.notificationTimeInterval) {
            clearInterval(window.notificationTimeInterval);
            window.notificationTimeInterval = null;
        }
    }
    
    function getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const dateGST = new Date(date.getTime() + (4 * 60 * 60 * 1000));
        const diffInSeconds = Math.floor((now - dateGST) / 1000);
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        return dateGST.toLocaleDateString();
    }
    
    function markAsRead(notificationId) {
        fetch(`/notifications/mark_read/${notificationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notificationItems = document.querySelectorAll(`[data-notification-id="${notificationId}"]`);
                    notificationItems.forEach(notificationItem => {
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                            const dot = notificationItem.querySelector('.notification-dot');
                            if (dot) { dot.remove(); }
                            const markButton = notificationItem.querySelector('button');
                            if (markButton) { markButton.remove(); }
                        }
                    });
                    updateNotificationBadge();
                }
            })
            .catch(error => { console.error('Error marking notification as read:', error); });
    }
    
    function updateNotificationBadge() {
        fetch('/api/notifications/unread_count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('nav-notification-badge');
                const badgeResponsive = document.getElementById('nav-notification-badge-responsive');
                if (badge) {
                    if (data.count > 0) { badge.textContent = data.count; badge.style.display = 'flex'; }
                    else { badge.style.display = 'none'; }
                }
                if (badgeResponsive) {
                    if (data.count > 0) { badgeResponsive.textContent = data.count; badgeResponsive.style.display = 'flex'; }
                    else { badgeResponsive.style.display = 'none'; }
                }
            })
            .catch(error => { console.error('Error updating notification count:', error); });
    }
    
    window.updateNotificationBadge = updateNotificationBadge;
    
    function markAllAsRead() {
        fetch('/notifications/mark_all_read', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item-dropdown.unread').forEach(item => {
                    item.classList.remove('unread');
                    const dot = item.querySelector('.notification-dot');
                    if (dot) { dot.remove(); }
                    const markButton = item.querySelector('button[onclick*="markAsRead"]');
                    if (markButton) { markButton.remove(); }
                });
                updateNotificationBadge();
            }
        })
        .catch(error => { console.error('Error marking all notifications as read:', error); });
    }
    
    document.addEventListener('click', function(event) {
        const desktopDropdown = document.getElementById('notification-dropdown');
        const responsiveDropdown = document.getElementById('notification-dropdown-responsive');
        const bells = document.querySelectorAll('.notification-bell');
        
        let isClickInside = false;
        let isClickOnBell = false;
        if (desktopDropdown && desktopDropdown.contains(event.target)) { isClickInside = true; }
        if (responsiveDropdown && responsiveDropdown.contains(event.target)) { isClickInside = true; }
        bells.forEach(b => { if (b.contains(event.target)) { isClickOnBell = true; } });
        if (notificationDropdownOpen && !isClickInside && !isClickOnBell) { closeNotificationDropdown(); }
        
        // Close user settings dropdown when clicking outside
        const userDropdown = document.getElementById('user-settings-dropdown');
        const userInfo = document.querySelector('.nav-user .user-info');
        const isClickInsideUserDropdown = userDropdown && userDropdown.contains(event.target);
        const isClickOnUserInfo = userInfo && userInfo.contains(event.target);
        if (userSettingsDropdownOpen && !isClickInsideUserDropdown && !isClickOnUserInfo) {
            closeUserSettingsDropdown();
        }
    });
    
    function updateCalendarBadge() {
        fetch('/api/calendar/pending_count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('nav-calendar-badge');
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            })
            .catch(error => {
                console.error('Error updating calendar badge:', error);
            });
    }
    
    window.updateCalendarBadge = updateCalendarBadge;
    
    document.addEventListener('DOMContentLoaded', function() {
        updateNotificationBadge();
        updateCalendarBadge();
        setInterval(updateNotificationBadge, 5000);
        setInterval(updateCalendarBadge, 5000);
        window.addEventListener('focus', function() {
            updateNotificationBadge();
            updateCalendarBadge();
        });
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

