<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Payment Request Management System{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    {% block extra_css %}{% endblock %}
    <!-- Tab session validation - must run before page content -->
    {% if current_user.is_authenticated %}
    <script>
    (function(){
        // IMMEDIATE CHECK - Redirect before page renders if session is invalid
        const TAB_SESSION_KEY = 'tab_session_id';
        const serverTabSessionId = '{{ session.get("tab_session_id", "") }}';
        const storedTabSessionId = sessionStorage.getItem(TAB_SESSION_KEY);
        
        // Check if this is a new tab: server has tab_session_id but client doesn't
        // Exception: If we just logged in (login_complete flag or coming from /login), store it
        const loginComplete = sessionStorage.getItem('login_complete');
        const comingFromLogin = document.referrer && document.referrer.includes('/login');
        
        if (serverTabSessionId && !storedTabSessionId) {
            if (loginComplete === 'true' || comingFromLogin) {
                // We just logged in - store the tab_session_id for this tab
                sessionStorage.setItem(TAB_SESSION_KEY, serverTabSessionId);
                sessionStorage.setItem('login_complete', 'true');
            } else {
                // New tab detected - server has session but this tab doesn't - redirect to logout
                sessionStorage.removeItem(TAB_SESSION_KEY);
                sessionStorage.removeItem('login_complete');
                window.location.replace("{{ url_for('logout') }}");
                return; // Prevent further execution
            }
        }
        
        // If stored ID doesn't match server ID, invalidate
        if (storedTabSessionId && serverTabSessionId && storedTabSessionId !== serverTabSessionId) {
            sessionStorage.removeItem(TAB_SESSION_KEY);
            window.location.replace("{{ url_for('logout') }}");
            return;
        }
        
        // Validate with server - if invalid, redirect immediately
        if (storedTabSessionId || serverTabSessionId) {
            fetch("{{ url_for('check_tab_session') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tab_session_id: storedTabSessionId || serverTabSessionId }),
                cache: 'no-cache'
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valid) {
                    sessionStorage.removeItem(TAB_SESSION_KEY);
                    window.location.replace("{{ url_for('logout') }}");
                } else if (data.tab_session_id) {
                    sessionStorage.setItem(TAB_SESSION_KEY, data.tab_session_id);
                }
            })
            .catch(error => {
                console.error('Tab session check failed:', error);
                sessionStorage.removeItem(TAB_SESSION_KEY);
                window.location.replace("{{ url_for('logout') }}");
            });
        }
    })();
    </script>
    <style>
        /* Hide body content until tab session is validated */
        body.tab-session-pending {
            visibility: hidden;
        }
    </style>
    {% endif %}
</head>
<body {% if current_user.is_authenticated %}class="tab-session-pending" data-user-role="{{ current_user.role }}" data-user-department="{{ current_user.department }}"{% endif %}>
    {% if current_user.is_authenticated %}
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-file-invoice-dollar"></i>
                <span>Payment System</span>
            </div>
            <button class="hamburger-menu" id="hamburger-menu" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="notification-bell-container-responsive">
                <button class="notification-bell" onclick="toggleNotificationDropdown()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="nav-notification-badge-responsive" style="display: none;">0</span>
                </button>
                <div class="notification-dropdown" id="notification-dropdown-responsive">
                    <div class="notification-dropdown-header">
                        <h3>Notifications</h3>
                        <button class="close-dropdown" onclick="closeNotificationDropdown()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-dropdown-content" id="notification-dropdown-content-responsive">
                        <div class="notification-loading">
                            <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                        </div>
                    </div>
                    <div class="notification-dropdown-footer">
                        <button onclick="markAllAsRead()" class="btn btn-sm btn-secondary">
                            <i class="fas fa-check-double"></i> Mark All as Read
                        </button>
                        <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-list"></i> View All
                        </a>
                    </div>
                </div>
            </div>
            <ul class="nav-menu" id="nav-menu">
                <li><a href="{{ url_for('dashboard') }}" class="nav-link"><i class="fas fa-home"></i> Dashboard</a></li>
                
                
                {% if current_user.role in ['Finance Admin', 'Finance Staff', 'GM', 'CEO', 'IT Staff', 'Department Manager', 'Operation Manager'] %}
                <li><a href="{{ url_for('reports') }}" class="nav-link"><i class="fas fa-chart-bar"></i> Reports</a></li>
                {% endif %}
                
                {% if current_user.role in ['Admin', 'Project Staff', 'Finance Admin', 'Finance Staff', 'GM', 'CEO', 'Operation Manager', 'IT Staff', 'IT Department Manager'] %}
                <li><a href="{{ url_for('admin_calendar') }}" class="nav-link"><i class="fas fa-calendar-alt"></i> Calendar</a></li>
                {% endif %}
                
                
                
                <li class="notification-bell-container">
                    <button class="notification-bell" onclick="toggleNotificationDropdown()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="nav-notification-badge" style="display: none;">0</span>
                    </button>
                    <div class="notification-dropdown" id="notification-dropdown">
                        <div class="notification-dropdown-header">
                            <h3>Notifications</h3>
                            <button class="close-dropdown" onclick="closeNotificationDropdown()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="notification-dropdown-content" id="notification-dropdown-content">
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading notifications...
                            </div>
                        </div>
                        <div class="notification-dropdown-footer">
                            <button onclick="markAllAsRead()" class="btn btn-sm btn-secondary">
                                <i class="fas fa-check-double"></i> Mark All as Read
                            </button>
                            <a href="{{ url_for('notifications') }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-list"></i> View All
                            </a>
                        </div>
                    </div>
                </li>
                <li class="nav-user">
                    <span class="user-info">
                        <i class="fas fa-user-circle"></i>
                        <span>{{ current_user.name }}</span>
                        <span class="user-role">{{ current_user.role }}</span>
                    </span>
                </li>
                {% if current_user.is_authenticated and current_user.department == 'IT' %}
                <li>
                    <button id="maintenance-toggle" class="nav-link" style="cursor: pointer;">
                        <i class="fas fa-tools"></i> Maintenance
                    </button>
                </li>
                {% endif %}
                <li><a href="{{ url_for('logout') }}" class="nav-link logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
    </nav>
    {% endif %}

    <main class="main-content">
        {% set maint = None %}
        {% if current_user.is_authenticated and current_user.department == 'IT' %}
            {% set maint = namespace(enabled=false, message='') %}
            {# IT users see an active maintenance banner if enabled #}
            {% if false %}{% endif %}
        {% endif %}
        {% if current_user.is_authenticated and current_user.department == 'IT' %}
        <div id="maintenance-banner" style="display:none;" class="maintenance-banner">
            <div class="maintenance-banner-content">
                <i class="fas fa-tools"></i>
                <span><strong>Maintenance Mode</strong> is ON. Non-IT users see a maintenance page.</span>
                <form method="POST" action="{{ url_for('maintenance_disable') }}" style="margin-left:auto;" onsubmit="return confirm('Disable maintenance mode and allow all users back in?');">
                    <button class="btn btn-sm btn-warning" type="submit"><i class="fas fa-power-off"></i> Disable</button>
                </form>
            </div>
        </div>
        <script>
        // Fetch status to toggle banner for IT users and set toggle button behavior
        (function(){
            const banner = document.getElementById('maintenance-banner');
            const toggleBtn = document.getElementById('maintenance-toggle');
            function setEnableBehavior(){
                if(!toggleBtn) return;
                toggleBtn.innerHTML = '<i class="fas fa-tools"></i> Enable Maintenance';
                toggleBtn.onclick = async function(){
                    if(!confirm('Enable maintenance mode? Non-IT users will be blocked until disabled.')) return;
                    const message = prompt('Optional message to display during maintenance:');
                    try{
                        await fetch('/maintenance/enable', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ message }) });
                        location.reload();
                    }catch(e){ console.error(e); }
                };
            }
            function setDisableBehavior(){
                if(!toggleBtn) return;
                toggleBtn.innerHTML = '<i class="fas fa-tools"></i> Disable Maintenance';
                toggleBtn.onclick = async function(){
                    if(!confirm('Disable maintenance mode and allow all users back in?')) return;
                    try{
                        await fetch('/maintenance/disable', { method:'POST' });
                        location.reload();
                    }catch(e){ console.error(e); }
                };
            }
            fetch('/maintenance/status')
                .then(r=>r.json())
                .then(s=>{
                    if(s.enabled){
                        if(banner) banner.style.display = 'block';
                        setDisableBehavior();
                    } else {
                        if(banner) banner.style.display = 'none';
                        setEnableBehavior();
                    }
                })
                .catch(()=>{ setEnableBehavior(); });
        })();
        </script>
        {% endif %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">
                            <span>{{ message }}</span>
                            <button class="close-alert" onclick="this.parentElement.remove()">&times;</button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>&copy; 2024 Payment Request Management System. All rights reserved.</p>
    </footer>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script src="{{ url_for('static', filename='js/realtime.js') }}"></script>
    <script src="{{ url_for('static', filename='js/multiple-file-upload.js') }}"></script>
    
    <!-- Tab session validation completion and inactivity auto-logout (10 minutes) -->
    {% if current_user.is_authenticated %}
    <script>
    (function(){
        // Show page content after validation (if we get here, session is valid)
        document.body.classList.remove('tab-session-pending');
        
        // Inactivity auto-logout (10 minutes)
        const TAB_SESSION_KEY = 'tab_session_id'; // Define here for idle timeout
        let idleTimer = null;
        const IDLE_LIMIT_MS = 10 * 60 * 1000; // 10 minutes = 600,000 milliseconds
        
        const resetTimer = () => {
            if (idleTimer) clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                // User has been idle for 10 minutes - log them out
                // Clear tab session and redirect to logout
                sessionStorage.removeItem(TAB_SESSION_KEY);
                sessionStorage.removeItem('login_complete');
                window.location.href = "{{ url_for('logout') }}";
            }, IDLE_LIMIT_MS);
        };
        ['click','mousemove','keydown','scroll','touchstart','touchmove','focus'].forEach(evt => {
            window.addEventListener(evt, resetTimer, { passive: true });
        });
        // Start timer on load
        resetTimer();
        // Also reset when tab becomes visible again
        document.addEventListener('visibilitychange', function(){ if (!document.hidden) resetTimer(); });
        
        // Clear tab session when tab is closed (best effort - not always reliable)
        window.addEventListener('beforeunload', function() {
            // Try to clear sessionStorage (though this may not always execute)
            try {
                sessionStorage.removeItem(TAB_SESSION_KEY);
            } catch(e) {}
        });
    })();
    </script>
    {% endif %}
    
    <!-- Hamburger Menu JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const hamburgerMenu = document.getElementById('hamburger-menu');
        const navMenu = document.getElementById('nav-menu');
        
        if (hamburgerMenu && navMenu) {
            hamburgerMenu.addEventListener('click', function() {
                hamburgerMenu.classList.toggle('active');
                navMenu.classList.toggle('active');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                const isClickInsideMenu = navMenu.contains(event.target);
                const isClickOnHamburger = hamburgerMenu.contains(event.target);
                
                if (!isClickInsideMenu && !isClickOnHamburger && navMenu.classList.contains('active')) {
                    hamburgerMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                }
            });
            
            // Close menu when clicking on a nav link
            const navLinks = navMenu.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    hamburgerMenu.classList.remove('active');
                    navMenu.classList.remove('active');
                });
            });
        }
    });
    </script>
    
    <!-- Notification Bell JavaScript -->
    <script>
    let notificationDropdownOpen = false;
    
    function getResponsiveMode() {
        return window.innerWidth <= 1024;
    }
    
    function toggleNotificationDropdown() {
        const isResponsive = getResponsiveMode();
        const dropdownId = isResponsive ? 'notification-dropdown-responsive' : 'notification-dropdown';
        const contentId = isResponsive ? 'notification-dropdown-content-responsive' : 'notification-dropdown-content';
        
        const dropdown = document.getElementById(dropdownId);
        if (notificationDropdownOpen) {
            closeNotificationDropdown();
        } else {
            openNotificationDropdown(dropdownId, contentId);
        }
    }
    
    function openNotificationDropdown(dropdownId, contentId) {
        const dropdown = document.getElementById(dropdownId);
        const content = document.getElementById(contentId);
        
        if (!dropdown || !content) return;
        
        dropdown.classList.add('show');
        notificationDropdownOpen = true;
        
        // Update notification count first
        updateNotificationBadge();
        
        // Load notifications
        loadNotifications(contentId);
    }
    
    function closeNotificationDropdown() {
        const desktopDropdown = document.getElementById('notification-dropdown');
        const responsiveDropdown = document.getElementById('notification-dropdown-responsive');
        
        if (desktopDropdown) desktopDropdown.classList.remove('show');
        if (responsiveDropdown) responsiveDropdown.classList.remove('show');
        notificationDropdownOpen = false;
        
        // Stop dynamic time updates when dropdown is closed
        stopDynamicTimeUpdates();
    }
    
    function loadNotifications(contentId) {
        const content = document.getElementById(contentId);
        if (!content) return;
        
        content.innerHTML = '<div class="notification-loading"><i class="fas fa-spinner fa-spin"></i> Loading notifications...</div>';
        
        fetch('/api/notifications/recent')
            .then(response => response.json())
            .then(data => {
                console.log('ðŸ”” DEBUG: Loaded notifications:', data);
                displayNotifications(data, contentId);
                // Update notification count after loading
                updateNotificationBadge();
            })
            .catch(error => {
                console.error('Error loading notifications:', error);
                if (content) {
                    content.innerHTML = '<div class="notification-empty"><i class="fas fa-exclamation-triangle"></i><p>Error loading notifications</p></div>';
                }
            });
    }
    
    function displayNotifications(notifications, contentId) {
        const content = document.getElementById(contentId);
        if (!content) return;
        
        if (notifications.length === 0) {
            content.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
            return;
        }
        
        let html = '';
        notifications.forEach(notification => {
            const isUnread = !notification.is_read;
            
            html += `
                <div class="notification-item-dropdown ${isUnread ? 'unread' : ''}" data-notification-id="${notification.notification_id}" data-created-at="${notification.created_at}">
                    <div class="notification-title-dropdown">
                        ${isUnread ? '<i class="fas fa-circle notification-dot"></i>' : ''}
                        ${notification.title}
                    </div>
                    <div class="notification-message-dropdown">${notification.message}</div>
                    <div class="notification-time-dropdown" data-time-element="true">${getTimeAgo(notification.created_at)}</div>
                    <div class="notification-actions-dropdown">
                        ${notification.request_id ? `<a href="/request/${notification.request_id}" class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</a>` : ''}
                        ${notification.item_request_id ? `<a href="/procurement/item-request/${notification.item_request_id}/view" class="btn btn-sm btn-info"><i class="fas fa-eye"></i> View</a>` : ''}
                        ${isUnread ? `<button onclick=\"markAsRead(${notification.notification_id})\" class=\"btn btn-sm btn-success\"><i class=\"fas fa-check\"></i> Mark Read</button>` : ''}
                    </div>
                </div>
            `;
        });
        
        content.innerHTML = html;
        
        // Start dynamic time updates
        startDynamicTimeUpdates();
    }
    
    function startDynamicTimeUpdates() {
        if (window.notificationTimeInterval) {
            clearInterval(window.notificationTimeInterval);
        }
        window.notificationTimeInterval = setInterval(() => {
            const timeElements = document.querySelectorAll('[data-time-element="true"]');
            timeElements.forEach(element => {
                const notificationItem = element.closest('.notification-item-dropdown');
                const createdAt = notificationItem.getAttribute('data-created-at');
                if (createdAt) {
                    element.textContent = getTimeAgo(createdAt);
                }
            });
        }, 60000);
    }
    
    function stopDynamicTimeUpdates() {
        if (window.notificationTimeInterval) {
            clearInterval(window.notificationTimeInterval);
            window.notificationTimeInterval = null;
        }
    }
    
    function getTimeAgo(dateString) {
        const now = new Date();
        const date = new Date(dateString);
        const dateGST = new Date(date.getTime() + (4 * 60 * 60 * 1000));
        const diffInSeconds = Math.floor((now - dateGST) / 1000);
        if (diffInSeconds < 60) return 'Just now';
        if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
        return dateGST.toLocaleDateString();
    }
    
    function markAsRead(notificationId) {
        fetch(`/notifications/mark_read/${notificationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const notificationItems = document.querySelectorAll(`[data-notification-id="${notificationId}"]`);
                    notificationItems.forEach(notificationItem => {
                        if (notificationItem) {
                            notificationItem.classList.remove('unread');
                            const dot = notificationItem.querySelector('.notification-dot');
                            if (dot) { dot.remove(); }
                            const markButton = notificationItem.querySelector('button');
                            if (markButton) { markButton.remove(); }
                        }
                    });
                    updateNotificationBadge();
                }
            })
            .catch(error => { console.error('Error marking notification as read:', error); });
    }
    
    function updateNotificationBadge() {
        fetch('/api/notifications/unread_count')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('nav-notification-badge');
                const badgeResponsive = document.getElementById('nav-notification-badge-responsive');
                if (badge) {
                    if (data.count > 0) { badge.textContent = data.count; badge.style.display = 'flex'; }
                    else { badge.style.display = 'none'; }
                }
                if (badgeResponsive) {
                    if (data.count > 0) { badgeResponsive.textContent = data.count; badgeResponsive.style.display = 'flex'; }
                    else { badgeResponsive.style.display = 'none'; }
                }
            })
            .catch(error => { console.error('Error updating notification count:', error); });
    }
    
    window.updateNotificationBadge = updateNotificationBadge;
    
    function markAllAsRead() {
        fetch('/notifications/mark_all_read', { method: 'GET', headers: { 'Content-Type': 'application/json' } })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item-dropdown.unread').forEach(item => {
                    item.classList.remove('unread');
                    const dot = item.querySelector('.notification-dot');
                    if (dot) { dot.remove(); }
                    const markButton = item.querySelector('button[onclick*="markAsRead"]');
                    if (markButton) { markButton.remove(); }
                });
                updateNotificationBadge();
            }
        })
        .catch(error => { console.error('Error marking all notifications as read:', error); });
    }
    
    document.addEventListener('click', function(event) {
        const desktopDropdown = document.getElementById('notification-dropdown');
        const responsiveDropdown = document.getElementById('notification-dropdown-responsive');
        const bells = document.querySelectorAll('.notification-bell');
        
        let isClickInside = false;
        let isClickOnBell = false;
        if (desktopDropdown && desktopDropdown.contains(event.target)) { isClickInside = true; }
        if (responsiveDropdown && responsiveDropdown.contains(event.target)) { isClickInside = true; }
        bells.forEach(b => { if (b.contains(event.target)) { isClickOnBell = true; } });
        if (notificationDropdownOpen && !isClickInside && !isClickOnBell) { closeNotificationDropdown(); }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        updateNotificationBadge();
        setInterval(updateNotificationBadge, 5000);
        window.addEventListener('focus', function() { updateNotificationBadge(); });
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>

