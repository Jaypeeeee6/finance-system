{% extends "base.html" %}

{% block title %}View Item Request #{{ item_request.id }}{% endblock %}

{% block extra_css %}
<style>
/* View Request Page Specific Tab Styles */
.view-request-page .step-tab.rejected .step-tab-content {
    background: #dc3545 !important;
    color: white !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.rejected .step-tab-content::before {
    content: "✗" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

.view-request-page .step-tab.warning .step-tab-content::before {
    content: "⏳" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

.view-request-page .step-tab.rejected:hover .step-tab-content {
    background: #c82333 !important;
}

.view-request-page .step-tab.warning .step-tab-content {
    background: #ffc107 !important;
    color: #212529 !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.warning:hover .step-tab-content {
    background: #e0a800 !important;
}

.view-request-page .step-tab.completed .step-tab-content {
    background: #28a745 !important;
    color: white !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.completed .step-tab-content::before {
    content: "✓" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

/* Manager Approval Required section */
.dashboard-container .card.manager-approval-required .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.manager-approval-required .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Your Approval Required section */
.dashboard-container .card.your-approval-required .card-header {
    background: #4caf50 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.your-approval-required .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

.dashboard-container .card.your-approval-required .card-header p {
    color: white !important;
    margin: 0 !important;
    opacity: 0.9 !important;
}

/* Procurement Manager Approval Required section */
.dashboard-container .card.procurement-approval-required .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-approval-required .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Procurement Manager Approval form section */
.dashboard-container .card.procurement-approval-form .card-header {
    background: #4caf50 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-approval-form .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Manager Decision section */
.dashboard-container .card.manager-decision .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.manager-decision .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Procurement Manager Decision section */
.dashboard-container .card.procurement-manager-decision .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-manager-decision .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Assigned to Procurement section */
.dashboard-container .card.assigned-section .card-header {
    background: #17a2b8 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.assigned-section .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Completed section */
.dashboard-container .card.completed-section .card-header {
    background: #28a745 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.completed-section .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Filter pill style for item chips */
.filter-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #000;
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    margin-right: 8px;
    margin-bottom: 8px;
}

.item-quantity-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #f0f0f0;
    color: #333;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    margin-right: 8px;
    margin-bottom: 8px;
}

.item-chips-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
}

.item-chip-row {
    display: flex;
    align-items: center;
    gap: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container view-request-page">
    <div class="dashboard-header">
        <h1><i class="fas fa-shopping-cart"></i> Item Request #{{ item_request.id }}
            {% if item_request.is_urgent %}
                <span style="margin-left: 12px; font-size: 0.9rem; background: #dc3545; color: white; padding: 6px 10px; border-radius: 18px; font-weight: 600;">
                    URGENT
                </span>
            {% endif %}
            {% if item_request.payment_date %}
                <span style="margin-left: 12px; font-size: 0.9rem; background: #eef7ee; color: #198754; padding: 6px 10px; border-radius: 18px; font-weight: 600;">
                    This item request has been scheduled for {{ item_request.payment_date.strftime('%B %d, %Y') }}
                    {% if payment_date_scheduled_by %} by {{ payment_date_scheduled_by }}{% endif %}
                </span>
            {% endif %}
        </h1>
        <a href="{{ url_for('procurement_item_requests') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Item Requests
        </a>
    </div>

    <!-- Step Tabs Container -->
    <div class="step-tabs-container">
        <ul class="step-tabs">
            <li class="step-tab completed" data-step="submit">
                <div class="step-tab-content">
                    Submit Request
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Rejected by Manager' %}rejected{% elif item_request.status == 'Pending Manager Approval' or (item_request.status == 'On Hold' and item_request.manager_on_hold_by_user_id) %}warning{% elif item_request.status in ['Pending Procurement Manager Approval', 'Assigned to Procurement', 'Completed'] or (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}completed{% else %}disabled{% endif %}" data-step="manager">
                <div class="step-tab-content">
                    Manager Approval
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Rejected by Procurement Manager' %}rejected{% elif item_request.status == 'Pending Procurement Manager Approval' or (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}warning{% elif item_request.status in ['Assigned to Procurement', 'Completed'] %}completed{% else %}disabled{% endif %}" data-step="procurement">
                <div class="step-tab-content">
                    Procurement Manager Approval
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Assigned to Procurement' %}warning{% elif item_request.status == 'Completed' %}completed{% else %}disabled{% endif %}" data-step="assigned">
                <div class="step-tab-content">
                    Assigned to Procurement
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Completed' %}completed{% else %}disabled{% endif %}" data-step="completed">
                <div class="step-tab-content">
                    Completed
                </div>
            </li>
        </ul>

        <!-- Step 1: Submit Request -->
        <div class="step-content active request-details-section" id="step-submit">
            <h3 style="margin: 0;"><i class="fas fa-paper-plane"></i> Request Details</h3>
            <div class="admin-mode-warning">
                <i class="fas fa-info-circle"></i>
                <span>Request submitted successfully. This step is always completed.</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Requestor Name</label>
                    <input type="text" value="{{ item_request.requestor_name }}" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <input type="text" value="{{ item_request.department }}" readonly style="background: #f5f5f5;">
                </div>
            </div>

            {% if item_request.category %}
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" value="{{ item_request.category }}" readonly style="background: #f5f5f5;">
                </div>
            </div>
            {% endif %}

            {% if item_request.item_name and ',' in item_request.item_name %}
                {# Multiple items - display as chips #}
                <div class="form-group">
                    <label>Item Name & Quantity</label>
                    <div class="item-chips-container">
                        {% set item_list = item_request.item_name.split(',') %}
                        {% set quantity_list = (item_request.quantity or '').split(';') if item_request.quantity else [] %}
                        {% for item in item_list %}
                            {% set item_trimmed = item.strip() %}
                            {% if item_trimmed %}
                                <div class="item-chip-row">
                                    <span class="filter-pill">{{ item_trimmed }}</span>
                                    {% if loop.index0 < quantity_list|length %}
                                        {% set qty_trimmed = quantity_list[loop.index0].strip() %}
                                        {% if qty_trimmed %}
                                            <span class="item-quantity-chip">Qty: {{ qty_trimmed }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% else %}
                {# Single item - display as normal input fields #}
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" value="{{ item_request.item_name }}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="text" value="{{ item_request.quantity or 'Not specified' }}" readonly style="background: #f5f5f5;">
                    </div>
                </div>
            {% endif %}

            <div class="form-row">
                <div class="form-group">
                    <label>Branch Name</label>
                    <input type="text" value="{{ item_request.branch_name }}" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Request Date</label>
                    <input type="text" value="{{ item_request.request_date.strftime('%Y-%m-%d') if item_request.request_date else 'N/A' }}" readonly style="background: #f5f5f5;">
                </div>
            </div>

            <div class="form-group">
                <label>Purpose/Description</label>
                <textarea rows="4" readonly style="background: #f5f5f5;">{{ item_request.purpose }}</textarea>
            </div>

            {% if item_request.notes %}
            <div class="form-group">
                <label>Additional Notes</label>
                <textarea rows="3" readonly style="background: #f5f5f5;">{{ item_request.notes }}</textarea>
            </div>
            {% endif %}

            <!-- Optional: Schedule payment date (authorized roles only, not required) -->
            {% if item_request.status in ['Pending Manager Approval', 'Pending Procurement Manager Approval'] and can_schedule_payment_date %}
            <div class="form-group" style="margin-top: 10px;">
                <label for="item_payment_date"><i class="fas fa-calendar-plus"></i> Schedule Payment Date (optional)</label>
                {% if not item_request.payment_date %}
                <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                    <input type="date" id="item_payment_date" name="item_payment_date_input">
                    <button type="button" class="btn btn-primary btn-sm" style="padding: 6px 10px; font-size: 0.9rem;" onclick="scheduleItemPaymentDate()"><i class="fas fa-save"></i> Set Payment Date</button>
                </div>
                <small class="form-text text-muted" style="display:block; margin-top: 6px;">Setting a date is optional and applies to this request only.</small>
                {% else %}
                <div style="background:#f8f9fa; border:1px solid #e1e5ea; border-radius:6px; padding:10px; display:block;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-calendar-check" style="color:#198754;"></i>
                        <span style="font-weight:600;">Scheduled for {{ item_request.payment_date.strftime('%B %d, %Y') }}</span>
                        {% if payment_date_scheduled_by %}<span style="color:#6c757d;">by {{ payment_date_scheduled_by }}</span>{% endif %}
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                        <input type="date" id="item_payment_date" value="{{ item_request.payment_date.strftime('%Y-%m-%d') }}">
                        <button type="button" class="btn btn-primary btn-sm" style="padding: 6px 10px; font-size: 0.9rem;" onclick="scheduleItemPaymentDate()"><i class="fas fa-edit"></i> Update Payment Date</button>
                    </div>
                    <small class="form-text text-muted" style="display:block; margin-top: 6px;">You can change the scheduled date at any time.</small>
                </div>
                {% endif %}
            </div>
            <script>
            async function scheduleItemPaymentDate(){
                const input = document.getElementById('item_payment_date');
                if(!input || !input.value){
                    alert('Please select a payment date.');
                    return;
                }
                try {
                    const res = await fetch(`{{ url_for('schedule_item_payment_date', request_id=item_request.id) }}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ payment_date: input.value })
                    });
                    if(res.redirected){
                        window.location.href = res.url;
                    } else {
                        window.location.reload();
                    }
                } catch (e) {
                    alert('Failed to schedule payment date.');
                }
            }
            </script>
            {% endif %}

            <div class="form-group">
                <label>Status</label>
                <div>
                    {% if item_request.status == 'Completed' %}
                        <span class="badge" style="background: #28a745; color: white; padding: 8px 16px; font-size: 0.9rem;">✓ {{ item_request.status }}</span>
                    {% elif item_request.status == 'On Hold' %}
                        <span class="badge" style="background: #ffc107; color: #212529; padding: 8px 16px; font-size: 0.9rem;">⏸ On Hold Until Further Notice</span>
                    {% elif item_request.status in ['Pending Manager Approval', 'Pending Procurement Manager Approval', 'Assigned to Procurement'] %}
                        <span class="badge" style="background: #2196F3; color: white; padding: 8px 16px; font-size: 0.9rem;">⏳ {{ item_request.status }}</span>
                    {% elif item_request.status in ['Rejected by Manager', 'Rejected by Procurement Manager'] %}
                        <span class="badge" style="background: #dc3545; color: white; padding: 8px 16px; font-size: 0.9rem;">✗ {{ item_request.status }}</span>
                    {% else %}
                        <span class="badge badge-warning" style="padding: 8px 16px; font-size: 0.9rem;">{{ item_request.status }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label>Created At</label>
                <input type="text" value="{{ item_request.created_at.strftime('%Y-%m-%d %H:%M:%S') if item_request.created_at else 'N/A' }}" readonly style="background: #f5f5f5;">
            </div>
        </div>

        <!-- Step 2: Manager Approval -->
        <div class="step-content" id="step-manager">
            <h3><i class="fas fa-user-tie"></i> Manager Approval</h3>
            
            {% if item_request.status in ['Pending Procurement Manager Approval', 'Assigned to Procurement', 'Completed', 'Rejected by Manager'] or (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Manager Approval: {% if item_request.status == 'Rejected by Manager' %}Rejected{% else %}Completed{% endif %}</span>
                </div>
                
                <!-- Show manager approval details -->
                <div class="card manager-decision" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Manager Decision</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            {% if item_request.status == 'Rejected by Manager' %}
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #721c24; font-weight: bold; font-size: 1.1rem;">REJECTED BY MANAGER</span>
                                </div>
                            {% else %}
                                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #155724; font-weight: bold; font-size: 1.1rem;">APPROVED BY MANAGER</span>
                                    {% if item_request.is_urgent %}
                                        <span style="background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 8px; font-size: 0.9rem;">URGENT</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>{% if item_request.status == 'Rejected by Manager' %}Rejected by:{% else %}Approved by:{% endif %}</strong>
                                {% if item_request.status == 'Rejected by Manager' %}
                                    {{ manager_rejector_name or item_request.manager_rejector or 'Manager' }}
                                {% else %}
                                    {{ manager_approver_name or item_request.manager_approver or 'Manager' }}
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if item_request.status == 'Rejected by Manager' %}
                            {% if item_request.manager_rejection_reason %}
                            <div class="form-group">
                                <label>Rejection Reason</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.manager_rejection_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.manager_rejection_date %}
                            <div class="form-group">
                                <label>Rejection Date</label>
                                <input type="text" value="{{ item_request.manager_rejection_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% else %}
                            {% if item_request.manager_approval_reason %}
                            <div class="form-group">
                                <label>Manager Notes</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.manager_approval_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.manager_approval_date %}
                            <div class="form-group">
                                <label>Manager Approval Date</label>
                                <input type="text" value="{{ item_request.manager_approval_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% elif item_request.status in ['Pending Manager Approval', 'On Hold'] and not (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}
                <!-- Manager approval required or On Hold -->
                <div class="card manager-approval-required" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-user-tie"></i> Manager Approval Required</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display (similar to Finance Approval tab) -->
                        {% if item_request.status == 'On Hold' %}
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #856404; font-weight: bold; font-size: 1.1rem;">ON HOLD UNTIL FURTHER NOTICE</span>
                            </div>
                            {% if item_request.manager_on_hold_by %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>Put on hold by:</strong> {{ item_request.manager_on_hold_by }}
                                {% if item_request.manager_on_hold_date %}
                                <span style="margin-left: 10px;">on {{ item_request.manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item_request.manager_on_hold_reason %}
                            <div style="margin-top: 0.5rem; padding: 10px; background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px;">
                                <strong style="color: #856404;">Reason:</strong>
                                <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.manager_on_hold_reason }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <p style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                                    <strong>Status:</strong> {% if item_request.status == 'On Hold' %}On Hold Until Further Notice{% else %}Waiting for Manager Approval{% endif %}
                                </p>
                                
                                <p style="margin-bottom: 0.5rem; color: #666;">
                                    <strong>Assigned Manager:</strong> 
                                    {% if temporary_manager_name %}
                                        <span style="color: #ff9800; font-weight: 600;">{{ temporary_manager_name }}</span>
                                        <span style="font-style: italic; color: #666;">(Temporary Assignment)</span>
                                        <span style="margin-left: 10px; color: #999;">|</span>
                                        <span style="margin-left: 10px;">Original: 
                                            {% if requestor_user and requestor_user.role == 'Department Manager' %}
                                                <strong>{{ gm_name }}, {{ op_manager_name }}</strong>
                                            {% else %}
                                                <strong>{{ manager_name if manager_name else ('Department Manager for ' + item_request.department) }}</strong>
                                            {% endif %}
                                        </span>
                                    {% elif requestor_user and requestor_user.role == 'Department Manager' %}
                                        {{ gm_name }}, {{ op_manager_name }}
                                    {% elif requestor_user and requestor_user.role in ['Finance Admin', 'Finance Staff', 'GM', 'Operation Manager'] and user.user_id == item_request.user_id %}
                                        {{ gm_name }}, {{ op_manager_name }}
                                    {% elif user.role == 'Operation Manager' and item_request.department == 'Operation' %}
                                        {{ user.name }} (You)
                                    {% elif user.role == 'Operation Manager' and item_request.department == 'Project' %}
                                        {{ user.name }} (You)
                                    {% elif item_request.department == 'Project' %}
                                        {{ manager_name if manager_name else 'Operation Manager' }}
                                    {% else %}
                                        {{ manager_name if manager_name else 'Department Manager for ' + item_request.department }}
                                    {% endif %}
                                </p>
                                <p style="margin-bottom: 0; color: #666;">
                                    <strong>Department:</strong> {{ item_request.department }}
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; text-align: center;">
                                    <i class="fas fa-clock" style="font-size: 2rem; color: #f57c00; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 600; color: #856404;">Pending Review</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manager approval form (visible to authorized managers) -->
                {% if can_approve_manager or can_reject_manager %}
                    <div class="card your-approval-required">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Your Approval Required</h4>
                            <p>As the manager{% if requestor_user %} of {{ requestor_user.name }}{% endif %}, please review and approve this request.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_manager_decision', request_id=item_request.id) }}">
                                <div class="form-group">
                                    <label for="item_manager_approval_status">Set Status *</label>
                                    <select name="approval_status" id="item_manager_approval_status" required onchange="toggleItemManagerApprovalFields()">
                                        <option value="">-- Select Status --</option>
                                        <option value="approve">Approve</option>
                                        <option value="reject">Reject</option>
                                        <option value="on_hold">On Hold</option>
                                    </select>
                                </div>
                                
                                <div id="item_manager_approve_fields" style="display: none;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="is_urgent" id="item_manager_is_urgent">
                                            Mark as Urgent
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="item_manager_approval_reason">Approval Notes (Optional)</label>
                                        <textarea name="approval_reason" id="item_manager_approval_reason" rows="3" placeholder="Add any notes about this approval..."></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_manager_reject_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="item_manager_rejection_reason">Reason for Rejection *</label>
                                        <textarea name="rejection_reason" id="item_manager_rejection_reason" rows="3" placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_manager_on_hold_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="item_manager_on_hold_reason">On Hold Reason (Optional)</label>
                                        <textarea name="on_hold_reason" id="item_manager_on_hold_reason" rows="3" placeholder="Add any notes about why this request is on hold..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Decision
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Step 3: Procurement Manager Approval -->
        <div class="step-content" id="step-procurement">
            <h3><i class="fas fa-shopping-cart"></i> Procurement Manager Approval</h3>
            
            {% if item_request.status in ['Assigned to Procurement', 'Completed', 'Rejected by Procurement Manager'] and item_request.status != 'On Hold' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Procurement Manager Approval: {% if item_request.status == 'Rejected by Procurement Manager' %}Rejected{% else %}Completed{% endif %}</span>
                </div>
                
                <!-- Show procurement manager approval details -->
                <div class="card procurement-manager-decision" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Procurement Manager Decision</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            {% if item_request.status == 'Rejected by Procurement Manager' %}
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #721c24; font-weight: bold; font-size: 1.1rem;">REJECTED</span>
                                </div>
                            {% else %}
                                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #155724; font-weight: bold; font-size: 1.1rem;">APPROVED BY PROCUREMENT MANAGER</span>
                                </div>
                            {% endif %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>{% if item_request.status == 'Rejected by Procurement Manager' %}Rejected by:{% else %}Approved by:{% endif %}</strong>
                                {{ procurement_manager_approver_name or item_request.procurement_manager_approver or 'Procurement Manager' }}
                            </div>
                        </div>
                        
                        {% if item_request.status == 'Rejected by Procurement Manager' %}
                            {% if item_request.procurement_manager_rejection_reason %}
                            <div class="form-group">
                                <label>Rejection Reason</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.procurement_manager_rejection_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_rejection_date %}
                            <div class="form-group">
                                <label>Rejection Date</label>
                                <input type="text" value="{{ item_request.procurement_manager_rejection_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% else %}
                            {% if item_request.procurement_manager_approval_reason %}
                            <div class="form-group">
                                <label>Procurement Manager Notes</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.procurement_manager_approval_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_approval_date %}
                            <div class="form-group">
                                <label>Procurement Manager Approval Date</label>
                                <input type="text" value="{{ item_request.procurement_manager_approval_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                            {% if item_request.amount %}
                            <div class="form-group">
                                <label>Amount</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 12px; color: #666; font-weight: 600;">OMR</span>
                                    <input type="text" value="{{ "%.3f"|format(item_request.amount) }}" readonly style="background: #f5f5f5; padding-left: 55px; font-weight: bold;">
                                </div>
                            </div>
                            {% endif %}
                            {% if assigned_to_name %}
                            <div class="form-group">
                                <label>Assigned To</label>
                                <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            {% elif item_request.status in ['Pending Procurement Manager Approval', 'On Hold'] %}
                <!-- Procurement Manager approval required or On Hold -->
                <div class="card procurement-approval-required" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-shopping-cart"></i> Procurement Manager Approval Required</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display (similar to Finance Approval tab) -->
                        {% if item_request.status == 'On Hold' %}
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #856404; font-weight: bold; font-size: 1.1rem;">ON HOLD UNTIL FURTHER NOTICE</span>
                            </div>
                            {% if item_request.procurement_manager_on_hold_by %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>Put on hold by:</strong> {{ item_request.procurement_manager_on_hold_by }}
                                {% if item_request.procurement_manager_on_hold_date %}
                                <span style="margin-left: 10px;">on {{ item_request.procurement_manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_on_hold_reason %}
                            <div style="margin-top: 0.5rem; padding: 10px; background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px;">
                                <strong style="color: #856404;">Reason:</strong>
                                <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.procurement_manager_on_hold_reason }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <p style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                                    <strong>Status:</strong> {% if item_request.status == 'On Hold' %}On Hold Until Further Notice{% else %}Waiting for Procurement Manager Approval{% endif %}
                                </p>
                                <p style="margin-bottom: 0.5rem; color: #666;">
                                    <strong>Department:</strong> {{ item_request.department }}
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; text-align: center;">
                                    <i class="fas fa-clock" style="font-size: 2rem; color: #f57c00; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 600; color: #856404;">Pending Review</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Procurement Manager approval form (visible to Procurement Manager) -->
                {% if can_approve_procurement_manager or can_reject_procurement_manager %}
                    <div class="card procurement-approval-form">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Your Approval Required</h4>
                            <p>As the Procurement Manager{% if requestor_user %} of {{ requestor_user.name }}{% endif %}, please review, approve, and assign this request.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_procurement_manager_decision', request_id=item_request.id) }}">
                                <div class="form-group">
                                    <label for="item_procurement_approval_status">Set Status *</label>
                                    <select name="approval_status" id="item_procurement_approval_status" required onchange="toggleItemProcurementManagerApprovalFields()">
                                        <option value="">-- Select Status --</option>
                                        <option value="approve">Approve</option>
                                        <option value="reject">Reject</option>
                                        <option value="on_hold">On Hold</option>
                                    </select>
                                </div>
                                
                                <div id="item_procurement_approve_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_amount">Amount (OMR) *</label>
                                        <div style="position: relative;">
                                            <span style="position: absolute; left: 12px; top: 12px; color: #666; font-weight: 600;">OMR</span>
                                            <input type="number" name="amount" id="procurement_amount" step="0.001" min="0" required style="padding-left: 55px; width: 100%;" placeholder="0.000">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="procurement_assigned_to_user_id">Assign to Procurement Member *</label>
                                        <select name="assigned_to_user_id" id="procurement_assigned_to_user_id" required>
                                            <option value="">-- Select Procurement Member --</option>
                                            {% for member in procurement_members %}
                                                <option value="{{ member.user_id }}">{{ member.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="procurement_approval_reason">Approval Notes (Optional)</label>
                                        <textarea name="approval_reason" id="procurement_approval_reason" rows="3" placeholder="Add any notes about this approval..."></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_reject_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_rejection_reason">Reason for Rejection *</label>
                                        <textarea name="rejection_reason" id="procurement_rejection_reason" rows="3" placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_on_hold_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_on_hold_reason">On Hold Reason (Optional)</label>
                                        <textarea name="on_hold_reason" id="procurement_on_hold_reason" rows="3" placeholder="Add any notes about why this request is on hold..."></textarea>
                                    </div>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Decision
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Step 4: Assigned to Procurement -->
        <div class="step-content" id="step-assigned">
            <h3><i class="fas fa-user-check"></i> Assigned to Procurement</h3>
            
            {% if item_request.status == 'Assigned to Procurement' %}
                <div class="admin-mode-warning" style="background: #17a2b8; color: white;">
                    <i class="fas fa-user-check"></i>
                    <span>Request has been assigned to a procurement member for processing</span>
                </div>
                
                <div class="card assigned-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Assignment Details</h4>
                    </div>
                    <div class="card-body">
                        {% if assigned_to_name %}
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5; font-weight: bold;">
                        </div>
                        {% endif %}
                        {% if item_request.assignment_date %}
                        <div class="form-group">
                            <label>Assignment Date</label>
                            <input type="text" value="{{ item_request.assignment_date.strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if assigned_by_name %}
                        <div class="form-group">
                            <label>Assigned By</label>
                            <input type="text" value="{{ assigned_by_name }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Completion form (visible to Procurement department members) -->
                {% if can_complete %}
                    <div class="card your-approval-required">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Mark Request as Completed</h4>
                            <p>Complete this item request once the item has been procured and delivered.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_complete', request_id=item_request.id) }}" enctype="multipart/form-data" id="item-request-complete-form">
                                <div class="form-group">
                                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 0.5rem;">
                                        <strong>Upload Receipt:</strong> This is for the proof of transfer made by the Procurement Manager to the assigned Procurement Staff.
                                    </p>
                                    <div id="item-receipt-upload-container" 
                                         data-multiple-file-upload
                                         data-input-name="receipt_files"
                                         data-accepted-types=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                         data-max-size="10485760"
                                         data-max-files="10"
                                         data-required="true"
                                         data-label="Upload Receipt"
                                         data-help-text="Required for Finance Admin approval (PDF, JPG, PNG, DOC, DOCX, XLS, XLSX - Max 50MB each)">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <p style="color: #666; font-size: 0.95rem; margin-bottom: 0.5rem;">
                                        <strong>Upload Invoice:</strong> This is for the proof of payment made for the requested item.
                                    </p>
                                    <div id="item-invoice-upload-container" 
                                         data-multiple-file-upload
                                         data-input-name="invoice_files"
                                         data-accepted-types=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                         data-max-size="10485760"
                                         data-max-files="10"
                                         data-required="true"
                                         data-label="Upload Invoice"
                                         data-help-text="Required for Finance Admin approval (PDF, JPG, PNG, DOC, DOCX, XLS, XLSX - Max 50MB each)">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="completion_notes">Completion Notes (Optional)</label>
                                    <textarea name="completion_notes" id="completion_notes" rows="3" placeholder="Add any notes about the completion..."></textarea>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Mark as Completed
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% elif item_request.status == 'Completed' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Request has been completed</span>
                </div>
                
                <div class="card assigned-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Assignment Details</h4>
                    </div>
                    <div class="card-body">
                        {% if assigned_to_name %}
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if item_request.assignment_date %}
                        <div class="form-group">
                            <label>Assignment Date</label>
                            <input type="text" value="{{ item_request.assignment_date.strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if receipt_files %}
                        <div class="form-group">
                            <label>Upload Receipt</label>
                            <ul style="list-style: none; padding-left: 0; margin-bottom: 0;">
                                {% for file in receipt_files %}
                                <li style="margin-bottom: 6px;">
                                    <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-file"></i> {{ file }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if invoice_files %}
                        <div class="form-group">
                            <label>Upload Invoice</label>
                            <ul style="list-style: none; padding-left: 0; margin-bottom: 0;">
                                {% for file in invoice_files %}
                                <li style="margin-bottom: 6px;">
                                    <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-file-invoice"></i> {{ file }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="admin-mode-warning">
                    <i class="fas fa-info-circle"></i>
                    <span>This step will be available after Procurement Manager approval and assignment.</span>
                </div>
            {% endif %}
        </div>

        <!-- Step 5: Completed -->
        <div class="step-content" id="step-completed">
            <h3><i class="fas fa-check-circle"></i> Completed</h3>
            
            {% if item_request.status == 'Completed' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Request has been completed successfully</span>
                </div>
                
                <div class="card completed-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Completion Details</h4>
                    </div>
                    <div class="card-body">
                        {% if completed_by_name %}
                        <div class="form-group">
                            <label>Completed By</label>
                            <input type="text" value="{{ completed_by_name }}" readonly style="background: #f5f5f5; font-weight: bold;">
                        </div>
                        {% endif %}
                        {% if item_request.completion_date %}
                        <div class="form-group">
                            <label>Completion Date</label>
                            <input type="text" value="{{ item_request.completion_date.strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if item_request.completion_notes %}
                        <div class="form-group">
                            <label>Completion Notes</label>
                            <textarea readonly style="background: #f8f9fa;">{{ item_request.completion_notes }}</textarea>
                        </div>
                        {% endif %}
                        {% if receipt_files %}
                        <div class="form-group">
                            <label>Upload Receipt</label>
                            <ul style="list-style: none; padding-left: 0; margin-bottom: 0;">
                                {% for file in receipt_files %}
                                <li style="margin-bottom: 6px;">
                                    <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-file"></i> {{ file }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if invoice_files %}
                        <div class="form-group">
                            <label>Upload Invoice</label>
                            <ul style="list-style: none; padding-left: 0; margin-bottom: 0;">
                                {% for file in invoice_files %}
                                <li style="margin-bottom: 6px;">
                                    <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-file-invoice"></i> {{ file }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="admin-mode-warning">
                    <i class="fas fa-info-circle"></i>
                    <span>This request has not been completed yet.</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Toggle fields for Manager Approval based on status selection
function toggleItemManagerApprovalFields() {
    const status = document.getElementById('item_manager_approval_status').value;
    const approveFields = document.getElementById('item_manager_approve_fields');
    const rejectFields = document.getElementById('item_manager_reject_fields');
    const onHoldFields = document.getElementById('item_manager_on_hold_fields');
    const rejectionReasonField = document.getElementById('item_manager_rejection_reason');
    
    // Hide all fields first and remove required attributes
    approveFields.style.display = 'none';
    rejectFields.style.display = 'none';
    onHoldFields.style.display = 'none';
    if (rejectionReasonField) {
        rejectionReasonField.removeAttribute('required');
    }
    
    // Show relevant fields based on selection and add required attributes
    if (status === 'approve') {
        approveFields.style.display = 'block';
    } else if (status === 'reject') {
        rejectFields.style.display = 'block';
        if (rejectionReasonField) {
            rejectionReasonField.setAttribute('required', 'required');
        }
    } else if (status === 'on_hold') {
        onHoldFields.style.display = 'block';
    }
}

// Toggle fields for Procurement Manager Approval based on status selection
function toggleItemProcurementManagerApprovalFields() {
    const status = document.getElementById('item_procurement_approval_status').value;
    const approveFields = document.getElementById('item_procurement_approve_fields');
    const rejectFields = document.getElementById('item_procurement_reject_fields');
    const onHoldFields = document.getElementById('item_procurement_on_hold_fields');
    const rejectionReasonField = document.getElementById('procurement_rejection_reason');
    const amountField = document.getElementById('procurement_amount');
    const assignedToField = document.getElementById('procurement_assigned_to_user_id');
    
    // Hide all fields first and remove required attributes
    approveFields.style.display = 'none';
    rejectFields.style.display = 'none';
    onHoldFields.style.display = 'none';
    if (rejectionReasonField) {
        rejectionReasonField.removeAttribute('required');
    }
    if (amountField) {
        amountField.removeAttribute('required');
    }
    if (assignedToField) {
        assignedToField.removeAttribute('required');
    }
    
    // Show relevant fields based on selection and add required attributes
    if (status === 'approve') {
        approveFields.style.display = 'block';
        if (amountField) {
            amountField.setAttribute('required', 'required');
        }
        if (assignedToField) {
            assignedToField.setAttribute('required', 'required');
        }
    } else if (status === 'reject') {
        rejectFields.style.display = 'block';
        if (rejectionReasonField) {
            rejectionReasonField.setAttribute('required', 'required');
        }
    } else if (status === 'on_hold') {
        onHoldFields.style.display = 'block';
    }
}

// Step tabs functionality
document.addEventListener('DOMContentLoaded', function() {
    const stepTabs = document.querySelectorAll('.step-tab');
    const stepContents = document.querySelectorAll('.step-content');
    
    // Add click event listeners to tabs
    stepTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const step = this.getAttribute('data-step');
            
            // Don't allow clicking on disabled tabs
            if (this.classList.contains('disabled')) {
                return;
            }
            
            // Remove active class from all tabs and contents
            stepTabs.forEach(t => t.classList.remove('active'));
            stepContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Show/hide request details section based on active tab
            const requestDetailsSection = document.querySelector('.request-details-section');
            if (requestDetailsSection) {
                if (step === 'submit') {
                    requestDetailsSection.style.display = 'block';
                } else {
                    requestDetailsSection.style.display = 'none';
                }
            }
        });
    });
    
    // Handle item request completion form submission with multiple file upload components
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        itemRequestCompleteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get both upload components
            const receiptContainer = document.getElementById('item-receipt-upload-container');
            const invoiceContainer = document.getElementById('item-invoice-upload-container');
            
            if (receiptContainer && receiptContainer.uploadComponent && invoiceContainer && invoiceContainer.uploadComponent) {
                const receiptComponent = receiptContainer.uploadComponent;
                const invoiceComponent = invoiceContainer.uploadComponent;
                
                // Validate that both have files (both are required)
                if (receiptComponent.getFiles().length === 0) {
                    alert('Please select at least one receipt file to upload.');
                    return;
                }
                
                if (invoiceComponent.getFiles().length === 0) {
                    alert('Please select at least one invoice file to upload.');
                    return;
                }
                
                // Prepare form data with all selected files
                const formData = new FormData(this);
                receiptComponent.prepareFormData(formData);
                invoiceComponent.prepareFormData(formData);
                
                // Submit the form with FormData
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        window.location.href = window.location.href;
                    } else {
                        console.error('Form submission failed');
                        alert('Form submission failed. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            } else {
                // Fallback to regular form submission if components not found
                this.submit();
            }
        });
    }
});

</script>
{% endblock %}

