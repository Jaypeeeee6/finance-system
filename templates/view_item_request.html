{% extends "base.html" %}

{% block title %}View Item Request #{{ item_request.id }}{% endblock %}

{% block extra_css %}
<style>
/* View Request Page Specific Tab Styles */
.view-request-page .step-tab.rejected .step-tab-content {
    background: #dc3545 !important;
    color: white !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.rejected .step-tab-content::before {
    content: "✗" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

.view-request-page .step-tab.warning .step-tab-content::before {
    content: "⏳" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

.view-request-page .step-tab.rejected:hover .step-tab-content {
    background: #c82333 !important;
}

.view-request-page .step-tab.warning .step-tab-content {
    background: #ffc107 !important;
    color: #212529 !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.warning:hover .step-tab-content {
    background: #e0a800 !important;
}

.view-request-page .step-tab.completed .step-tab-content {
    background: #28a745 !important;
    color: white !important;
    font-weight: 600 !important;
}

.view-request-page .step-tab.completed .step-tab-content::before {
    content: "✓" !important;
    margin-right: 0.5rem !important;
    font-weight: bold !important;
    font-size: 1.1rem !important;
}

/* Manager Approval Required section */
.dashboard-container .card.manager-approval-required .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.manager-approval-required .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Your Approval Required section */
.dashboard-container .card.your-approval-required .card-header {
    background: #4caf50 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.your-approval-required .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

.dashboard-container .card.your-approval-required .card-header p {
    color: white !important;
    margin: 0 !important;
    opacity: 0.9 !important;
}

/* Procurement Manager Approval Required section */
.dashboard-container .card.procurement-approval-required .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-approval-required .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Procurement Manager Approval form section */
.dashboard-container .card.procurement-approval-form .card-header {
    background: #4caf50 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-approval-form .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Manager Decision section */
.dashboard-container .card.manager-decision .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.manager-decision .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Procurement Manager Decision section */
.dashboard-container .card.procurement-manager-decision .card-header {
    background: #e3f2fd !important;
    color: #1976d2 !important;
    border-left: 4px solid #2196f3 !important;
    border-top: none !important;
}

.dashboard-container .card.procurement-manager-decision .card-header h4 {
    color: #1976d2 !important;
    margin: 0 !important;
}

/* Assigned to Procurement section */
.dashboard-container .card.assigned-section .card-header {
    background: #17a2b8 !important;
    color: white !important;
    border-top: none !important;
}

/* Override grid columns for Assigned to Procurement tab to include Amount column */
#step-assigned .procurement-cart-header-row,
#step-assigned .procurement-cart-row {
    grid-template-columns: 2fr 1fr 1fr;
}

/* Align Quantity column to left in Assigned to Procurement tab */
#step-assigned .procurement-cart-qty {
    justify-content: flex-start;
}

.procurement-cart-total-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 8px;
    align-items: center;
    margin-top: 10px;
    padding: 10px 12px;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
}

.procurement-cart-total-label {
    text-align: right;
    font-weight: 600;
    color: #111827;
}

.procurement-cart-total-value {
    text-align: right;
    font-weight: 700;
    color: #111827;
    letter-spacing: 0.01em;
}

.dashboard-container .card.assigned-section .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Completed section */
.dashboard-container .card.completed-section .card-header {
    background: #28a745 !important;
    color: white !important;
    border-top: none !important;
}

.dashboard-container .card.completed-section .card-header h4 {
    color: white !important;
    margin: 0 !important;
}

/* Filter pill style for item chips */
.filter-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #000;
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    margin-right: 8px;
    margin-bottom: 8px;
}

.item-quantity-chip {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: #f0f0f0;
    color: #333;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    margin-right: 8px;
    margin-bottom: 8px;
}

.item-chips-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 8px;
}

.edited-badge {
    display: inline-block;
    margin-left: 8px;
    padding: 2px 8px;
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeeba;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    vertical-align: middle;
    cursor: pointer;
    transition: background-color 0.2s;
}

.edited-badge:hover {
    background: #ffe69c;
}

/* Field History Modal Styles */
.field-history-modal {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 2000;
}

.field-history-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
}

.field-history-container {
    position: relative;
    max-width: 720px;
    margin: 8vh auto;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
}

.field-history-header {
    background: linear-gradient(45deg, #007bff, #6f42c1);
    color: white;
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.field-history-header h4 {
    margin: 0;
    font-size: 1.2rem;
}

.field-history-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    margin: 0;
    line-height: 1;
}

.field-history-close:hover {
    opacity: 0.8;
}

.field-history-body {
    padding: 25px;
    max-height: 60vh;
    overflow-y: auto;
}

.history-row {
    border-bottom: 1px solid #e9ecef;
    padding: 15px 0;
}

.history-row:last-child {
    border-bottom: none;
}

.history-meta {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.history-user {
    font-weight: 600;
    color: #495057;
}

.history-time {
    color: #6c757d;
}

.history-values {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.history-values div {
    padding: 8px;
    border-radius: 4px;
}

.history-values div:first-child {
    background: #fff3cd;
    border: 1px solid #ffeeba;
}

.history-values div:last-child {
    background: #d4edda;
    border: 1px solid #c3e6cb;
}

.item-chip-row {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Assigned-to-Procurement cart-style item list */
.procurement-cart-card .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.procurement-cart-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0.5rem;
}

.procurement-cart-header-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    padding: 7px 12px;
    gap: 10px;
    background: #f8f9fb;
    border-radius: 8px;
    font-weight: 600;
    color: #555;
    margin-bottom: 5px;
    font-size: 0.85rem;
}

.procurement-cart-row {
    display: grid;
    grid-template-columns: 2fr 1fr;
    align-items: center;
    padding: 4px 10px;
    margin-bottom: 4px;
    background: #ffffff;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(15, 23, 42, 0.06);
    gap: 10px;
}

.procurement-cart-item-name {
    font-weight: 600;
    color: #374151;
    font-size: 0.85rem;
}

.procurement-cart-qty {
    display: flex;
    justify-content: flex-end;
}

.procurement-cart-amount {
    display: flex;
    justify-content: flex-end;
}

.procurement-cart-amount input[type="number"] {
    width: 70px;
    height: 32px;
    text-align: center;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.8rem;
    padding: 0;
}

.procurement-cart-amount input[type="number"]:focus {
    outline: none;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.quantity-control {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #f9fafb;
    padding: 2px 4px;
    border-radius: 999px;
    flex-shrink: 0;
}

.quantity-control input[type="number"] {
    width: 60px;
    min-width: 60px;
    flex: 0 0 60px;
    border: none;
    background: transparent;
    text-align: center;
    font-weight: 600;
    font-size: 0.8rem;
}

.original-qty-inline {
    font-size: 0.75rem;
    font-weight: 600;
    color: #374151;
    margin: 0 3px;
}

.quantity-control input[type="number"]:focus {
    outline: none;
    box-shadow: none;
}

.qty-btn {
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffffff;
}

.qty-btn.minus {
    background: #f97316;
}

.qty-btn.plus {
    background: #22c55e;
}

.qty-btn:disabled {
    opacity: 0.6;
    cursor: default;
}

.readonly-qty-pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    background: #f3f4f6;
    font-weight: 600;
    color: #374151;
    font-size: 0.85rem;
}

/* Make Save Quantities buttons match Mark as Completed button size */
#manager_save_quantities_btn,
#manager_save_quantity_btn,
#procurement_manager_save_quantities_btn,
#procurement_manager_save_quantity_btn,
.billing-completion-grid button.btn-success[type="submit"] {
    padding: 0.4rem 0.9rem !important;
    font-size: 0.9rem !important;
}

/* Make Submit for Final Approval button green */
#submit-final-approval-btn {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
}

#submit-final-approval-btn:hover {
    background-color: #218838 !important;
    border-color: #1e7e34 !important;
}

/* Highlight when procurement quantity is less than original requested quantity */
.qty-less-than-original {
    background: #fff3cd;
    border: 1px solid #ffc107;
}

/* Make entire row red when quantity is 0 */
.qty-zero {
    background: #ffe5e5 !important;
    border: 1px solid #dc3545 !important;
}

.qty-zero .procurement-cart-item-name {
    color: #dc3545;
    font-weight: 600;
}

.previously-rejected-by-manager {
    background-color: #ffe5e5 !important;
    border-left: 4px solid #dc3545 !important;
}

.previously-rejected-by-manager .procurement-cart-item-name {
    color: #dc3545;
    font-weight: 500;
}

/* Custom tooltip for info icons */
.tooltip-wrapper {
    position: relative;
    display: inline-block;
}

.tooltip-wrapper .tooltip-icon {
    color: #dc3545;
    margin-left: 8px;
    cursor: help;
    font-size: 0.9em;
}

.tooltip-wrapper .tooltip-text {
    visibility: hidden;
    width: 280px;
    background-color: #333;
    color: #fff;
    text-align: left;
    border-radius: 6px;
    padding: 8px 12px;
    position: fixed !important;
    transform: translateX(-50%);
    z-index: 99999 !important;
    bottom: auto;
    left: auto;
    margin-left: 0;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.875rem;
    font-weight: normal;
    line-height: 1.4;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    pointer-events: none;
    white-space: normal;
    word-wrap: break-word;
}

.tooltip-wrapper .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

.tooltip-wrapper:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}

/* Ensure tooltips can overflow containers */
.card-body,
.billing-completion-grid,
#item-request-complete-form,
.card.your-approval-required {
    overflow: visible !important;
    border-radius: 8px !important;
}

.card.your-approval-required .card-header {
    border-radius: 8px 8px 0 0 !important;
}

/* Position tooltip using fixed positioning to avoid clipping */
.tooltip-wrapper {
    position: relative;
    display: inline-block;
}

.tooltip-wrapper .tooltip-text {
    position: fixed !important;
    transform: translateX(-50%);
    white-space: normal;
    word-wrap: break-word;
}

.procurement-cart-note.initially-hidden {
    display: none;
}

.quantity-readonly-display {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.edit-qty-btn {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 4px;
    transition: all 0.2s;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.edit-qty-btn:hover {
    background: #f3f4f6;
    color: #374151;
}

.edit-qty-btn i {
    font-size: 0.875rem;
}

/* Assignment Details form fields styling */
.card.assigned-section .card-body .form-group {
    margin-bottom: 0.85rem !important;
}

.card.assigned-section .card-body .form-group label {
    font-size: 0.9rem !important;
    margin-bottom: 0.3rem !important;
}

.card.assigned-section .card-body .form-control,
.card.assigned-section .card-body input[type="text"] {
    padding: 0.4rem 0.6rem !important;
    font-size: 0.9rem !important;
    height: auto !important;
}

/* Billing and Completion Two-Column Layout */
.billing-completion-grid {
    display: grid !important;
    grid-template-columns: 1fr 1.5fr !important;
    gap: 30px !important;
}

.card.your-approval-required {
    display: flex;
    flex-direction: column;
}

.card.your-approval-required .card-body {
    display: flex;
    flex-direction: column;
    max-height: 480px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    flex: 1;
}

.card.your-approval-required .card-footer {
    padding: 1rem !important;
    background: #f8f9fa !important;
    border-top: 1px solid #dee2e6 !important;
    flex-shrink: 0;
}

.billing-completion-grid > div:last-child {
    border-left: 1px solid #e0e0e0;
    padding-left: 15px;
}

/* Smaller form controls in left column */
.billing-completion-grid > div:first-child .form-control {
    padding: 0.4rem 0.75rem !important;
    font-size: 0.9rem !important;
    height: auto !important;
}

.billing-completion-grid > div:first-child textarea.form-control,
.billing-completion-grid > div:first-child textarea {
    padding: 0.4rem 0.75rem !important;
    font-size: 0.9rem !important;
}

.billing-completion-grid > div:first-child .btn {
    padding: 0.4rem 0.9rem !important;
    font-size: 0.9rem !important;
}

.billing-completion-grid > div:first-child label {
    font-size: 0.9rem !important;
    margin-bottom: 0.4rem !important;
}

.billing-completion-grid > div:first-child .form-group {
    margin-bottom: 1rem !important;
}

.billing-completion-grid > div:first-child small {
    font-size: 0.85rem !important;
}

@media (max-width: 768px) {
    .billing-completion-grid {
        grid-template-columns: 1fr !important;
        gap: 20px !important;
    }
    
    .card.your-approval-required {
        display: block !important;
    }

    .card.your-approval-required .card-body {
        max-height: none !important;
        overflow-y: visible !important;
    }
    
    .billing-completion-grid > div:last-child {
        border-left: none !important;
        border-top: 1px solid #e0e0e0 !important;
        padding-left: 0 !important;
        padding-top: 20px !important;
    }
}

/* Success Modal Styles (matching error modal but green) */
.flash-success-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

.flash-success-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
}

.flash-success-dialog {
    position: relative;
    background: white;
    border-radius: 8px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    max-width: 500px;
    width: 90%;
    overflow: hidden;
}

.flash-success-title {
    background: #28a745;
    color: white;
    margin: 0;
    padding: 20px;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flash-success-body {
    padding: 20px;
    font-size: 1rem;
    color: #333;
    word-break: break-word;
}

.flash-success-actions {
    display: flex;
    justify-content: flex-end;
    padding: 15px 20px;
    border-top: 1px solid #e9ecef;
    gap: 10px;
}

.flash-success-ok-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 20px;
    border-radius: 4px;
    font-size: 0.95rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.flash-success-ok-btn:hover {
    background: #218838;
}

body.flash-success-open {
    overflow: hidden;
}

/* Red asterisks for required fields in Your Approval Required sections */
.card.your-approval-required .required-asterisk,
.card.procurement-approval-form .required-asterisk {
    color: #dc3545;
    font-weight: 600;
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container view-request-page"
     data-request-status="{{ item_request.status }}"
     data-user-department="{{ user.department }}"
     data-user-role="{{ user.role }}">
    <div class="dashboard-header">
        <h1><i class="fas fa-shopping-cart"></i> Item Request #{{ item_request.id }}
            {% if item_request.is_urgent %}
                <span style="margin-left: 12px; font-size: 0.9rem; background: #dc3545; color: white; padding: 6px 10px; border-radius: 18px; font-weight: 600;">
                    URGENT
                </span>
            {% endif %}
            {% if item_request.payment_date %}
                <span style="margin-left: 12px; font-size: 0.9rem; background: #eef7ee; color: #198754; padding: 6px 10px; border-radius: 18px; font-weight: 600;">
                    This item request has been scheduled for {{ item_request.payment_date.strftime('%B %d, %Y') }}
                    {% if payment_date_scheduled_by %} by {{ payment_date_scheduled_by }}{% endif %}
                </span>
            {% endif %}
            {# Show 'from store' banner when assigned-to-procurement step is completed (Final Approval or Completed) #}
            {% if item_request.from_store_no_receipt and item_request.status in ['Final Approval', 'Completed'] %}
                <span style="margin-left: 12px; font-size: 0.9rem; background: #eef7ee; color: #198754; padding: 6px 10px; border-radius: 18px; font-weight: 600;">
                    This item was procured from the store, there is no receipt or invoice.
                </span>
            {% endif %}
        </h1>
        <a href="{{ url_for('procurement_item_requests') }}" id="back-to-item-requests-btn" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>

    <!-- Step Tabs Container -->
    <div class="step-tabs-container">
        <ul class="step-tabs">
            <li class="step-tab completed" data-step="submit">
                <div class="step-tab-content">
                    Submit Request
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Rejected by Manager' %}rejected{% elif item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id %}completed{% elif item_request.status == 'Pending Manager Approval' or (item_request.status == 'On Hold' and item_request.manager_on_hold_by_user_id) %}warning{% elif item_request.status in ['Pending Procurement Manager Approval', 'Assigned to Procurement', 'Completed', 'Final Approval'] %}completed{% else %}disabled{% endif %}" data-step="manager">
                <div class="step-tab-content">
                    Manager Approval
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Rejected by Procurement Manager' %}rejected{% elif item_request.status == 'Pending Procurement Manager Approval' or (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}warning{% elif item_request.status in ['Assigned to Procurement', 'Completed', 'Final Approval'] %}completed{% else %}disabled{% endif %}" data-step="procurement">
                <div class="step-tab-content">
                    Procurement Manager Approval
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Assigned to Procurement' %}warning{% elif item_request.status in ['Completed', 'Final Approval'] %}completed{% else %}disabled{% endif %}" data-step="assigned">
                <div class="step-tab-content">
                    Assigned to Procurement
                </div>
            </li>
            <li class="step-tab {% if item_request.status == 'Final Approval' %}warning{% elif item_request.status == 'Completed' %}completed{% else %}disabled{% endif %}" data-step="completed">
                <div class="step-tab-content">
                    Final Approval
                </div>
            </li>
        </ul>

        <!-- Step 1: Submit Request -->
        <div class="step-content active request-details-section" id="step-submit">
            <h3 style="margin: 0;"><i class="fas fa-paper-plane"></i> Request Details</h3>
            <div class="admin-mode-warning">
                <i class="fas fa-info-circle"></i>
                <span>Request submitted successfully. This step is always completed.</span>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Requestor Name</label>
                    <input type="text" value="{{ item_request.requestor_name }}" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <input type="text" value="{{ item_request.department }}" readonly style="background: #f5f5f5;">
                </div>
            </div>

            {% if item_request.category %}
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" value="{{ item_request.category }}" readonly style="background: #f5f5f5;">
                </div>
            </div>
            {% endif %}

            {% if item_request.item_name and ',' in item_request.item_name %}
                {# Multiple items - display as chips (show procurement manager quantities if exist, otherwise manager-approved quantities, otherwise original) #}
                        {% set item_list = item_request.item_name.split(',') %}
                {# Use procurement manager quantities if they exist, otherwise original requested quantities (which are stored as JSON) #}
                {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                        {# procurement_quantities is stored as JSON array, so try to parse it; otherwise treat as semicolon-separated #}
                {% set quantity_list = [] %}
                {% if raw_quantity_source %}
                    {% if raw_quantity_source.startswith('[') %}
                        {# JSON array format - convert to list of strings #}
                        {% set quantity_list = (raw_quantity_source | from_json) if raw_quantity_source else [] %}
                    {% else %}
                        {# Semicolon-separated format (for backward compatibility) #}
                        {% set quantity_list = raw_quantity_source.split(';') %}
                    {% endif %}
                {% endif %}
                {# Filter out items with quantity 0 #}
                {% set items_to_display = [] %}
                        {% for item in item_list %}
                            {% set item_trimmed = item.strip() %}
                            {% if item_trimmed %}
                        {% set qty_value = '' %}
                                    {% if loop.index0 < quantity_list|length %}
                            {% set qty_raw = quantity_list[loop.index0].strip() %}
                            {% if qty_raw %}
                                                {# Quantities may be stored as "Item Name: 2"; extract numeric part #}
                                {% if ':' in qty_raw %}
                                    {% set parts = qty_raw.split(':', 1) %}
                                    {% if parts|length > 1 %}
                                        {% set qty_value = parts[1].strip() %}
                                    {% else %}
                                        {% set qty_value = qty_raw %}
                                        {% endif %}
                                {% else %}
                                    {% set qty_value = qty_raw %}
                                    {% endif %}
                            {% endif %}
                        {% endif %}
                        {% set qty_num = qty_value|int(0) %}
                        {# Only include items with quantity > 0 #}
                        {% if qty_num > 0 %}
                            {% set _ = items_to_display.append({'name': item_trimmed, 'qty': qty_value, 'index': loop.index0}) %}
                        {% endif %}
                            {% endif %}
                        {% endfor %}
                {% if items_to_display|length > 0 %}
                <div class="form-group">
                    <label>Item Name & Quantity {% if quantities_edited %}<span class="edited-badge" data-field="quantities" role="button" tabindex="0">Edited</span>{% endif %}</label>
                    <div class="item-chips-container">
                        {% for item_data in items_to_display %}
                            <div class="item-chip-row">
                                <span class="filter-pill">{{ item_data.name }}</span>
                                {% if item_data.qty %}
                                    <span class="item-quantity-chip">Qty: {{ item_data.qty }}</span>
                                {% endif %}
                    </div>
                        {% endfor %}
                </div>
                </div>
                {% endif %}
            {% else %}
                {# Single item - display as normal input fields (show procurement manager quantities if exist, otherwise original quantity) #}
                {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                {% set qty = '0' %}
                {% if raw_quantity_source %}
                    {% if raw_quantity_source.startswith('[') %}
                        {# JSON array format - get first element #}
                        {% set qty_array = (raw_quantity_source | from_json) %}
                        {% set qty = (qty_array[0] if qty_array|length > 0 else '0') %}
                    {% else %}
                        {# Semicolon-separated or single value #}
                        {% set qty = raw_quantity_source.split(';')[0] if ';' in raw_quantity_source else raw_quantity_source %}
                    {% endif %}
                {% endif %}
                {# Extract numeric quantity for comparison #}
                {% set qty_num = qty|int(0) %}
                {# Only display if quantity > 0 #}
                {% if qty_num > 0 %}
                <div class="form-row">
                    <div class="form-group">
                        <label>Item Name</label>
                        <input type="text" value="{{ item_request.item_name }}" readonly style="background: #f5f5f5;">
                    </div>
                    <div class="form-group">
                        <label>Quantity {% if quantities_edited %}<span class="edited-badge" data-field="quantities" role="button" tabindex="0">Edited</span>{% endif %}</label>
                        <input type="text" value="{{ qty }}" readonly style="background: #f5f5f5;">
                    </div>
                </div>
                {% endif %}
            {% endif %}

            <!-- Field History Modal for Quantity Edits -->
            <div id="fieldHistoryModal" class="field-history-modal" style="display:none;">
                <div class="field-history-overlay" onclick="closeFieldHistoryModal()"></div>
                <div class="field-history-container">
                    <div class="field-history-header">
                        <h4 id="fieldHistoryTitle">Edit History</h4>
                        <button type="button" class="field-history-close" onclick="closeFieldHistoryModal()">&times;</button>
                    </div>
                    <div class="field-history-body" id="fieldHistoryBody"></div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Branch Name</label>
                    <input type="text" value="{{ item_request.branch_name }}" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label>Request Date</label>
                    <input type="text" value="{{ item_request.request_date.strftime('%Y-%m-%d') if item_request.request_date else 'N/A' }}" readonly style="background: #f5f5f5;">
                </div>
            </div>

            <div class="form-group">
                <label>Purpose/Description</label>
                <textarea rows="4" readonly style="background: #f5f5f5;">{{ item_request.purpose }}</textarea>
            </div>

            {% if item_request.notes %}
            <div class="form-group">
                <label>Additional Notes</label>
                <textarea rows="3" readonly style="background: #f5f5f5;">{{ item_request.notes }}</textarea>
            </div>
            {% endif %}

            <div class="form-group">
                <label><i class="fas fa-upload"></i> Item Sample / Reference</label>
                {% if requestor_item_uploads and requestor_item_uploads|length > 0 %}
                    {% for file in requestor_item_uploads %}
                    <div style="margin-bottom: 10px; padding: 8px; background: #e7f3ff; border-radius: 4px; border: 1px solid #b3d9ff; display: flex; align-items: center; gap: 10px;">
                        <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-info">
                            <i class="fas fa-download"></i> View Item Sample {{ loop.index }}
                        </a>
                        <small style="color: #666;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #666; font-style: italic;">No files uploaded by requestor</p>
                {% endif %}
            </div>

            <div class="form-group">
                <label><i class="fas fa-upload"></i> Evidence of Damage / Reason</label>
                {% if requestor_evidence_uploads and requestor_evidence_uploads|length > 0 %}
                    {% for file in requestor_evidence_uploads %}
                    <div style="margin-bottom: 10px; padding: 8px; background: #fff7e6; border-radius: 4px; border: 1px solid #ffe5b4; display: flex; align-items: center; gap: 10px;">
                        <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-info">
                            <i class="fas fa-download"></i> View Evidence {{ loop.index }}
                        </a>
                        <small style="color: #666;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                    </div>
                    {% endfor %}
                {% else %}
                    <p style="color: #666; font-style: italic;">No evidence files uploaded by requestor</p>
                {% endif %}
            </div>

            <!-- Optional: Schedule payment date (authorized roles only, not required) -->
            {% if item_request.status in ['Pending Manager Approval', 'Pending Procurement Manager Approval'] and can_schedule_payment_date %}
            <div class="form-group" style="margin-top: 10px;">
                <label for="item_payment_date"><i class="fas fa-calendar-plus"></i> Schedule Payment Date (optional)</label>
                {% if not item_request.payment_date %}
                <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
                    <input type="date" id="item_payment_date" name="item_payment_date_input">
                    <button type="button" class="btn btn-primary btn-sm" style="padding: 6px 10px; font-size: 0.9rem;" onclick="scheduleItemPaymentDate()"><i class="fas fa-save"></i> Set Payment Date</button>
                </div>
                <small class="form-text text-muted" style="display:block; margin-top: 6px;">Setting a date is optional and applies to this request only.</small>
                {% else %}
                <div style="background:#f8f9fa; border:1px solid #e1e5ea; border-radius:6px; padding:10px; display:block;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <i class="fas fa-calendar-check" style="color:#198754;"></i>
                        <span style="font-weight:600;">Scheduled for {{ item_request.payment_date.strftime('%B %d, %Y') }}</span>
                        {% if payment_date_scheduled_by %}<span style="color:#6c757d;">by {{ payment_date_scheduled_by }}</span>{% endif %}
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                        <input type="date" id="item_payment_date" value="{{ item_request.payment_date.strftime('%Y-%m-%d') }}">
                        <button type="button" class="btn btn-primary btn-sm" style="padding: 6px 10px; font-size: 0.9rem;" onclick="scheduleItemPaymentDate()"><i class="fas fa-edit"></i> Update Payment Date</button>
                    </div>
                    <small class="form-text text-muted" style="display:block; margin-top: 6px;">You can change the scheduled date at any time.</small>
                </div>
                {% endif %}
            </div>
            <script>
            async function scheduleItemPaymentDate(){
                const input = document.getElementById('item_payment_date');
                if(!input || !input.value){
                    alert('Please select a payment date.');
                    return;
                }
                try {
                    const res = await fetch(`{{ url_for('schedule_item_payment_date', request_id=item_request.id) }}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ payment_date: input.value })
                    });
                    if(res.redirected){
                        window.location.href = res.url;
                    } else {
                        window.location.reload();
                    }
                } catch (e) {
                    alert('Failed to schedule payment date.');
                }
            }
            </script>
            {% endif %}

            <div class="form-group">
                <label>Status</label>
                <div>
                    {% if item_request.status == 'Completed' %}
                        <span class="badge" style="background: #28a745; color: white; padding: 8px 16px; font-size: 0.9rem;">✓ {{ item_request.status }}</span>
                    {% elif item_request.status == 'On Hold' %}
                        <span class="badge" style="background: #ffc107; color: #212529; padding: 8px 16px; font-size: 0.9rem;">⏸ On Hold Until Further Notice</span>
                    {% elif item_request.status in ['Pending Manager Approval', 'Pending Procurement Manager Approval', 'Assigned to Procurement'] %}
                        <span class="badge" style="background: #2196F3; color: white; padding: 8px 16px; font-size: 0.9rem;">⏳ {{ item_request.status }}</span>
                    {% elif item_request.status in ['Rejected by Manager', 'Rejected by Procurement Manager'] %}
                        <span class="badge" style="background: #dc3545; color: white; padding: 8px 16px; font-size: 0.9rem;">✗ {{ item_request.status }}</span>
                    {% else %}
                        <span class="badge badge-warning" style="padding: 8px 16px; font-size: 0.9rem;">{{ item_request.status }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="form-group">
                <label>Created At</label>
                <input type="text" value="{{ utc_to_local(item_request.created_at).strftime('%Y-%m-%d %H:%M:%S') if item_request.created_at else 'N/A' }}" readonly style="background: #f5f5f5;">
            </div>
        </div>

        <!-- Step 2: Manager Approval -->
        <div class="step-content" id="step-manager">
            <h3><i class="fas fa-user-tie"></i> Manager Approval</h3>
            
            {% if item_request.status in ['Pending Procurement Manager Approval', 'Assigned to Procurement', 'Completed', 'Final Approval', 'Rejected by Manager'] or (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Manager Approval: {% if item_request.status == 'Rejected by Manager' %}Rejected{% else %}Completed{% endif %}</span>
                </div>
                
                <!-- Show manager approval details -->
                <div class="card manager-decision" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Manager Decision</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            {% if item_request.status == 'Rejected by Manager' %}
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #721c24; font-weight: bold; font-size: 1.1rem;">REJECTED BY MANAGER</span>
                                </div>
                            {% else %}
                                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #155724; font-weight: bold; font-size: 1.1rem;">APPROVED BY MANAGER</span>
                                    {% if item_request.is_urgent %}
                                        <span style="background-color: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; margin-left: 8px; font-size: 0.9rem;">URGENT</span>
                                    {% endif %}
                                </div>
                            {% endif %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>{% if item_request.status == 'Rejected by Manager' %}Rejected by:{% else %}Approved by:{% endif %}</strong>
                                {% if item_request.status == 'Rejected by Manager' %}
                                    {{ manager_rejector_name or item_request.manager_rejector or 'Manager' }}
                                {% else %}
                                    {{ manager_approver_name or item_request.manager_approver or 'Manager' }}
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if item_request.status == 'Rejected by Manager' %}
                            {% if item_request.manager_rejection_reason %}
                            <div class="form-group">
                                <label>Rejection Reason</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.manager_rejection_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.manager_rejection_date %}
                            <div class="form-group">
                                <label>Rejection Date</label>
                                <input type="text" value="{{ item_request.manager_rejection_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% else %}
                            {% if item_request.manager_approval_reason %}
                            <div class="form-group">
                                <label>Manager Notes</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.manager_approval_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.manager_approval_date %}
                            <div class="form-group">
                                <label>Manager Approval Date</label>
                                <input type="text" value="{{ item_request.manager_approval_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                            
                            <!-- Show on-hold history if request was previously put on hold by manager -->
                            {% if item_request.manager_on_hold_by %}
                            <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #dee2e6;">
                                <label style="color: #856404; font-weight: bold;"><i class="fas fa-pause-circle"></i> On Hold History</label>
                                <div style="background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #856404;">Put on hold by:</strong> 
                                        <span style="color: #856404;">{{ item_request.manager_on_hold_by }}</span>
                                        {% if item_request.manager_on_hold_date %}
                                        <span style="color: #856404; margin-left: 10px;">on {{ item_request.manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                        {% endif %}
                                    </div>
                                    {% if item_request.manager_on_hold_reason %}
                                    <div style="margin-top: 8px;">
                                        <strong style="color: #856404;">Reason:</strong>
                                        <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.manager_on_hold_reason }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                {# Show Item Quantities section after manager approval (read-only) #}
                {% if item_request.item_name %}
                    {% set manager_can_edit_quantities_after = False %}
                    
                    {# Multi-item requests: item_name is a comma-separated list #}
                    {% if ',' in item_request.item_name %}
                    <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4><i class="fas fa-shopping-cart"></i> Item Quantities for Manager Approval</h4>
                        </div>
                        <div class="card-body">
                            <p style="color: #6b7280; font-size: 0.95rem; font-weight: 500; margin-bottom: 0.85rem;">
                                <strong>Note:</strong> These are the manager-approved quantities (read-only).
                            </p>
                            {% set item_list = item_request.item_name.split(',') %}
                            {% set raw_quantity_source = item_request.procurement_quantities %}
                            {# Parse quantity_list from JSON or semicolon-separated format #}
                            {% set quantity_list = [] %}
                            {% if raw_quantity_source %}
                                {% if raw_quantity_source.startswith('[') %}
                                    {% set quantity_list = (raw_quantity_source | from_json) %}
                                {% else %}
                                    {% set quantity_list = raw_quantity_source.split(';') %}
                                {% endif %}
                            {% endif %}
                            {% set original_source = item_request.procurement_quantities %}
                            {# original_list should be the same as quantity_list (already parsed) #}
                            {% set original_list = quantity_list %}
                            {# Debug: Convert to ensure it's a proper list #}
                            {% if original_list is string %}
                                {# If original_list is still a string (JSON wasn't parsed), parse it now #}
                                {% set original_list = (original_list | from_json) if original_list.startswith('[') else original_list.split(';') %}
                            {% endif %}
                            {# Filter out items with quantity 0 #}
                            {% set items_to_display = [] %}
                            {% for item in item_list %}
                                {% set item_trimmed = item.strip() %}
                                {% if item_trimmed %}
                                    {% set qty = '' %}
                                    {% if loop.index0 < quantity_list|length %}
                                        {% set qty_raw = quantity_list[loop.index0] | trim %}
                                        {% if qty_raw %}
                                            {% if ':' in qty_raw %}
                                                {% set parts = qty_raw.split(':', 1) %}
                                                {% if parts|length > 1 %}
                                                    {% set qty = parts[1].strip() %}
                                                {% else %}
                                                    {% set qty = qty_raw %}
                                                {% endif %}
                                            {% else %}
                                                {% set qty = qty_raw %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    {% set qty_num = qty|int(0) %}
                                    {# Only include items with quantity > 0 #}
                                    {% if qty_num > 0 %}
                                        {% set orig_qty_raw = '' %}
                                        {% if loop.index0 < original_list|length %}
                                            {% set oq = original_list[loop.index0]|string %}
                                            {% if oq and oq != '' %}
                                                {# Remove quotes and trim if it's a JSON string value #}
                                                {% set oq_clean = oq|replace('"', '')|trim %}
                                                {% if ':' in oq_clean %}
                                                    {# Handle "Item Name: qty" format #}
                                                    {% set o_parts = oq_clean.split(':', 1) %}
                                                    {% set orig_qty_raw = o_parts[1].strip() if o_parts|length > 1 else oq_clean %}
                                                {% else %}
                                                    {% set orig_qty_raw = oq_clean %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                        {% set orig_qty_num = orig_qty_raw|int(0) %}
                                        {% set mgr_qty_num = qty|int(0) %}
                                        {% set is_less = mgr_qty_num < orig_qty_num %}
                                        {% set _ = items_to_display.append({'name': item_trimmed, 'qty': qty, 'is_less': is_less}) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if items_to_display|length > 0 %}
                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: right;">Quantity</div>
                                </div>
                                
                                {% for item_data in items_to_display %}
                                    <div class="procurement-cart-row {% if item_data.is_less %}qty-less-than-original{% endif %}">
                                        <div class="procurement-cart-item-name">
                                            {{ item_data.name }}
                                        </div>
                                        <div class="procurement-cart-qty">
                                            <span class="readonly-qty-pill">
                                                {{ item_data.qty }}
                                            </span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p style="color: #6b7280; font-style: italic;">No items to display (all items were rejected with quantity 0).</p>
                            {% endif %}

                            {% if item_request.manager_quantity_rejection_reason %}
                            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Reason for Rejecting Item(s)</label>
                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    {# Find items with quantity 0 #}
                                    {% set rejected_items = [] %}
                                    {% for item in item_list %}
                                        {% set item_trimmed = item.strip() %}
                                        {% if item_trimmed %}
                                            {% set qty = '' %}
                                            {% if loop.index0 < quantity_list|length %}
                                                {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                {% if qty_raw %}
                                                    {% if ':' in qty_raw %}
                                                        {% set parts = qty_raw.split(':', 1) %}
                                                        {% if parts|length > 1 %}
                                                            {% set qty = parts[1].strip() %}
                                                        {% else %}
                                                            {% set qty = qty_raw %}
                                                        {% endif %}
                                                    {% else %}
                                                        {% set qty = qty_raw %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                            {% set qty_num = qty|int(0) %}
                                            {% if qty_num == 0 %}
                                                {% set _ = rejected_items.append(item_trimmed) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if rejected_items|length > 0 %}
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #fecaca;">
                                        <strong style="color: #991b1b;">Rejected Items (Quantity set to 0):</strong>
                                        <ul style="color: #991b1b; margin: 5px 0 0 20px; padding: 0;">
                                            {% for rejected_item in rejected_items %}
                                            <li>{{ rejected_item }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.manager_quantity_rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {# Show legend only if there are items highlighted yellow #}
                            {% set has_highlighted_items = false %}
                            {% for item_data in items_to_display %}
                                {% if item_data.is_less %}
                                    {% set has_highlighted_items = true %}
                                {% endif %}
                            {% endfor %}
                            {% if has_highlighted_items %}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border: 1px solid #ffc107; border-radius: 50%;"></span>
                                    <span>Edited by Manager (see Request Details for Edit History)</span>
                                </div>
                            </div>
                            {% endif %}
                            <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                Quantities shown here reflect the manager-approved amounts and are read-only.
                            </p>
                        </div>
                    </div>

                    {# Single-item requests: item_name is a single string #}
                    {% else %}
                    {% set raw_quantity_source = item_request.procurement_quantities %}
                    {% set qty = (raw_quantity_source or '0') %}
                    {% if ';' in qty %}
                        {% set qty = qty.split(';')[0] %}
                    {% endif %}
                    {% set qty_num = qty|int(0) %}
                    {# Only display if quantity > 0 #}
                    {% if qty_num > 0 %}
                    {# Parse orig_qty_raw from JSON if needed #}
                    {% set orig_qty_raw = '' %}
                    {% set proc_qty = item_request.procurement_quantities %}
                    {% if proc_qty %}
                        {% if proc_qty.startswith('[') %}
                            {# JSON format - extract first element #}
                            {% set qty_array = (proc_qty | from_json) %}
                            {% set orig_qty_raw = (qty_array[0] if qty_array|length > 0 else '0')|string %}
                        {% else %}
                            {% set orig_qty_raw = proc_qty.strip() %}
                        {% endif %}
                    {% endif %}
                    {% set orig_qty_num = orig_qty_raw|int(0) %}
                    {% set mgr_qty_num = qty|int(0) %}
                    {% set is_less = mgr_qty_num < orig_qty_num %}

                    <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4><i class="fas fa-shopping-cart"></i> Item Quantity for Manager Approval</h4>
                        </div>
                        <div class="card-body">
                            <p style="color: #6b7280; font-size: 0.95rem; font-weight: 500; margin-bottom: 0.85rem;">
                                <strong>Note:</strong> This is the manager-approved quantity (read-only).
                            </p>

                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: right;">Quantity</div>
                                </div>

                                <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %}">
                                    <div class="procurement-cart-item-name">
                                        {{ item_request.item_name }}
                                    </div>
                                    <div class="procurement-cart-qty">
                                        <span class="readonly-qty-pill">
                                            {{ qty }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {% if item_request.manager_quantity_rejection_reason %}
                            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Reason for Rejecting Item</label>
                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    {% set qty_num = qty|int(0) %}
                                    {% if qty_num == 0 %}
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #fecaca;">
                                        <strong style="color: #991b1b;">Rejected Item (Quantity set to 0):</strong>
                                        <p style="color: #991b1b; margin: 5px 0 0 0;">{{ item_request.item_name }}</p>
                                    </div>
                                    {% endif %}
                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.manager_quantity_rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {# Show legend only if item is highlighted yellow #}
                            {% if is_less %}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border: 1px solid #ffc107; border-radius: 50%;"></span>
                                    <span>Edited by Manager (see Request Details for Edit History)</span>
                                </div>
                            </div>
                            {% endif %}
                            <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                Quantity shown here reflects the manager-approved amount and is read-only.
                            </p>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                {% endif %}
            {% elif item_request.status in ['Pending Manager Approval', 'On Hold'] and not (item_request.status == 'On Hold' and item_request.procurement_manager_on_hold_by_user_id) %}
                <!-- Manager approval required or On Hold -->
                <div class="card manager-approval-required" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-user-tie"></i> Manager Approval Required</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display (similar to Finance Approval tab) -->
                        {% if item_request.status == 'On Hold' %}
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #856404; font-weight: bold; font-size: 1.1rem;">ON HOLD UNTIL FURTHER NOTICE</span>
                            </div>
                            {% if item_request.manager_on_hold_by %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>Put on hold by:</strong> {{ item_request.manager_on_hold_by }}
                                {% if item_request.manager_on_hold_date %}
                                <span style="margin-left: 10px;">on {{ item_request.manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item_request.manager_on_hold_reason %}
                            <div style="margin-top: 0.5rem; padding: 10px; background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px;">
                                <strong style="color: #856404;">Reason:</strong>
                                <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.manager_on_hold_reason }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <p style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                                    <strong>Status:</strong> {% if item_request.status == 'On Hold' %}On Hold Until Further Notice{% else %}Waiting for Manager Approval{% endif %}
                                </p>
                                
                                <p style="margin-bottom: 0.5rem; color: #666;">
                                    <strong>Assigned Manager:</strong> 
                                    {% if temporary_manager_name %}
                                        <span style="color: #ff9800; font-weight: 600;">{{ temporary_manager_name }}</span>
                                        <span style="font-style: italic; color: #666;">(Temporary Assignment)</span>
                                        <span style="margin-left: 10px; color: #999;">|</span>
                                        <span style="margin-left: 10px;">Original: 
                                            {% if requestor_user and requestor_user.role == 'Department Manager' %}
                                                <strong>{{ gm_name }}, {{ op_manager_name }}</strong>
                                            {% else %}
                                                <strong>{{ manager_name if manager_name else ('Department Manager for ' + item_request.department) }}</strong>
                                            {% endif %}
                                        </span>
                                    {% elif requestor_user and requestor_user.role == 'Department Manager' %}
                                        {{ gm_name }}, {{ op_manager_name }}
                                    {% elif requestor_user and requestor_user.role in ['Finance Admin', 'Finance Staff', 'GM', 'Operation Manager'] and user.user_id == item_request.user_id %}
                                        {{ gm_name }}, {{ op_manager_name }}
                                    {% elif user.role == 'Operation Manager' and item_request.department == 'Operation' %}
                                        {{ user.name }} (You)
                                    {% elif user.role == 'Operation Manager' and item_request.department == 'Project' %}
                                        {{ user.name }} (You)
                                    {% elif item_request.department == 'Project' %}
                                        {{ manager_name if manager_name else 'Operation Manager' }}
                                    {% else %}
                                        {{ manager_name if manager_name else 'Department Manager for ' + item_request.department }}
                                    {% endif %}
                                </p>
                                <p style="margin-bottom: 0; color: #666;">
                                    <strong>Department:</strong> {{ item_request.department }}
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; text-align: center;">
                                    <i class="fas fa-clock" style="font-size: 2rem; color: #f57c00; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 600; color: #856404;">Pending Review</p>
                                </div>
                            </div>
                        </div>

                        {# Manager-stage quantity adjustment (for multi-item and single-item requests) #}
                        {% if item_request.item_name %}
                            {% set manager_can_edit_quantities = can_approve_manager %}

                            {# Multi-item requests: item_name is a comma-separated list #}
                            {% if ',' in item_request.item_name %}
                            <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-shopping-cart"></i> Item Quantities for Manager Approval</h4>
                                </div>
                                <div class="card-body">
                                    <p style="color: #dc3545; font-size: 1rem; font-weight: 500; margin-bottom: 0.85rem;">
                                        <strong>Note:</strong> If you do not want to approve an item, set its quantity to <strong>0</strong>. Adjust the quantities below as part of your manager approval.
                                    </p>
                                    {% set item_list = item_request.item_name.split(',') %}
                                    {# Use procurement-adjusted quantities if they exist; otherwise fall back to original requested quantities #}
                                    {% set raw_quantity_source = item_request.procurement_quantities %}
                                    {# Parse quantity_list from JSON or semicolon-separated format #}
                                    {% set quantity_list = [] %}
                                    {% if raw_quantity_source %}
                                        {% if raw_quantity_source.startswith('[') %}
                                            {% set quantity_list = (raw_quantity_source | from_json) %}
                                        {% else %}
                                            {% set quantity_list = raw_quantity_source.split(';') %}
                                        {% endif %}
                                    {% endif %}
                                    {# Original requestor quantities (for comparison only) #}
                                    {% set original_source = item_request.procurement_quantities %}
                                    {% set original_list = [] %}
                                    {% if original_source %}
                                        {% if original_source.startswith('[') %}
                                            {% set original_list = (original_source | from_json) %}
                                        {% else %}
                                            {% set original_list = original_source.split(';') %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% if manager_can_edit_quantities %}
                                    <form method="POST" action="{{ url_for('update_item_request_quantities_manager', request_id=item_request.id) }}" id="manager_quantities_form_multi">
                                    {% endif %}
                                        <div class="procurement-cart-table">
                                            <div class="procurement-cart-header-row">
                                                <div>Item</div>
                                                <div style="text-align: right;">Quantity</div>
                                                <div style="text-align: right;">Amount</div>
                                            </div>
                                            
                                            {% for item in item_list %}
                                                {% set item_trimmed = item.strip() %}
                                                {% if item_trimmed %}
                                                    {% set qty = '' %}
                                                    {% if loop.index0 < quantity_list|length %}
                                                        {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                        {% if qty_raw %}
                                                            {# Quantities may be stored as "Item Name: 2"; extract numeric part #}
                                                            {% if ':' in qty_raw %}
                                                                {% set parts = qty_raw.split(':', 1) %}
                                                                {% if parts|length > 1 %}
                                                                    {% set qty = parts[1].strip() %}
                                                                {% else %}
                                                                    {% set qty = qty_raw %}
                                                                {% endif %}
                                                            {% else %}
                                                                    {% set qty = qty_raw %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}

                                                    {# Derive original numeric quantity for comparison #}
                                                    {% set orig_qty_raw = '' %}
                                                    {% if loop.index0 < original_list|length %}
                                                        {% set oq = original_list[loop.index0]|string %}
                                                        {% if oq and oq != '' %}
                                                            {# Remove quotes and trim if it's a JSON string value #}
                                                            {% set oq_clean = oq|replace('"', '')|trim %}
                                                            {% if ':' in oq_clean %}
                                                                {# Handle "Item Name: qty" format #}
                                                                {% set o_parts = oq_clean.split(':', 1) %}
                                                                {% set orig_qty_raw = o_parts[1].strip() if o_parts|length > 1 else oq_clean %}
                                                            {% else %}
                                                                {% set orig_qty_raw = oq_clean %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                    {% set orig_qty_num = orig_qty_raw|int(0) %}
                                                    {% set mgr_qty_num = qty|int(0) %}
                                                    {% set is_less = mgr_qty_num < orig_qty_num %}
                                                    {% set diff = mgr_qty_num - orig_qty_num %}
                                                    {% set diff_abs = diff|abs %}

                                                    <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %}"
                                                         id="cart_row_{{ loop.index0 }}"
                                                         data-orig-qty="{{ orig_qty_num }}"
                                                         data-orig-display="{{ orig_qty_raw or '0' }}">
                                                        <div class="procurement-cart-item-name">
                                                            {{ item_trimmed }}
                                                        </div>
                                                        <div class="procurement-cart-qty">
                                                            {% if manager_can_edit_quantities %}
                                                            <div class="quantity-control">
                                                                <button type="button"
                                                                        class="qty-btn minus"
                                                                        data-index="{{ loop.index0 }}"
                                                                        onclick="adjustCartQuantity(this.dataset.index, -1)">
                                                                    -
                                                                </button>
                                                                <input type="number"
                                                                       name="quantities[]"
                                                                       id="cart_qty_{{ loop.index0 }}"
                                                                       min="0"
                                                                       step="1"
                                                                       value="{{ qty or 0 }}"
                                                                       data-index="{{ loop.index0 }}"
                                                                       oninput="updateCartQuantityState(this.dataset.index)">
                                                                <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                <button type="button"
                                                                        class="qty-btn plus"
                                                                        data-index="{{ loop.index0 }}"
                                                                        onclick="adjustCartQuantity(this.dataset.index, 1)">
                                                                    +
                                                                </button>
                                                            </div>
                                                            {% else %}
                                                            <span class="readonly-qty-pill">
                                                                {{ qty or '0' }} / {{ orig_qty_raw or '0' }}
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div id="cart_note_mgr_{{ loop.index0 }}"
                                                         class="procurement-cart-note {% if mgr_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                         style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px;">
                                                        {% if mgr_qty_num != orig_qty_num %}
                                                            Requestor requested <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                            You have currently set <strong>{{ diff_abs }}</strong>
                                                            {% if diff > 0 %}more{% else %}less{% endif %} than requested.
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        {% if manager_can_edit_quantities %}
                                        {% if item_request.manager_quantity_rejection_reason %}
                                        <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                            <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item(s)</label>
                                            <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.manager_quantity_rejection_reason }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div id="manager_rejection_reason_group" style="display: none; margin-top: 1rem;">
                                            <div class="form-group">
                                                <label for="manager_quantity_rejection_reason">Reason for Rejecting Item(s) *</label>
                                                <textarea name="quantity_rejection_reason" id="manager_quantity_rejection_reason" rows="3" placeholder="Please provide a reason for rejecting the item(s) with quantity set to 0..." style="width: 100%;">{{ item_request.manager_quantity_rejection_reason or '' }}</textarea>
                                                <small class="form-text text-muted">This field is required when at least one item quantity is set to 0.</small>
                                            </div>
                                        </div>
                                        <div class="step-actions" style="margin-top: 1rem;">
                                            <button type="submit" class="btn btn-success" id="manager_save_quantities_btn">
                                                <i class="fas fa-save"></i> Save Quantities
                                            </button>
                                        </div>
                                        {% endif %}
                                    {% if manager_can_edit_quantities %}
                                    </form>
                                    {% endif %}

                                    <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                        {% if manager_can_edit_quantities %}
                                            Any quantity changes you make here will be visible to all authorized users who can view this item request, including Procurement.
                                        {% else %}
                                            Quantities shown here reflect the latest manager-approved amounts and are read-only for you.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            {# Single-item requests: item_name is a single string #}
                            {% else %}
                            {% set raw_quantity_source = item_request.procurement_quantities %}
                            {% set qty = (raw_quantity_source or '0') %}
                            {% if ';' in qty %}
                                {% set qty = qty.split(';')[0] %}
                            {% endif %}
                            {# Parse orig_qty_raw from JSON if needed #}
                            {% set orig_qty_raw = '' %}
                            {% set proc_qty = item_request.procurement_quantities %}
                            {% if proc_qty %}
                                {% if proc_qty.startswith('[') %}
                                    {# JSON format - extract first element #}
                                    {% set qty_array = (proc_qty | from_json) %}
                                    {% set orig_qty_raw = (qty_array[0] if qty_array|length > 0 else '0')|string %}
                                {% else %}
                                    {% set orig_qty_raw = proc_qty.strip() %}
                                {% endif %}
                            {% endif %}
                            {% set orig_qty_num = orig_qty_raw|int(0) %}
                            {% set mgr_qty_num = qty|int(0) %}
                            {% set is_less = mgr_qty_num < orig_qty_num %}
                            {% set diff = mgr_qty_num - orig_qty_num %}
                            {% set diff_abs = diff|abs %}

                            <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-shopping-cart"></i> Item Quantity for Manager Approval</h4>
                                </div>
                                <div class="card-body">
                                    <p style="color: #dc3545; font-size: 1rem; font-weight: 500; margin-bottom: 0.85rem;">
                                        <strong>Note:</strong> If you do not want to approve this item, set the quantity to <strong>0</strong>. Adjust the quantity below as part of your manager approval.
                                    </p>

                                    {% if manager_can_edit_quantities %}
                                    <form method="POST" action="{{ url_for('update_item_request_quantities_manager', request_id=item_request.id) }}" id="manager_quantities_form_single">
                                    {% endif %}
                                        <div class="procurement-cart-table">
                                            <div class="procurement-cart-header-row">
                                                <div>Item</div>
                                                <div style="text-align: right;">Quantity</div>
                                            </div>

                                            <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %}"
                                                 id="cart_row_0"
                                                 data-orig-qty="{{ orig_qty_num }}"
                                                 data-orig-display="{{ orig_qty_raw or '0' }}">
                                                <div class="procurement-cart-item-name">
                                                    {{ item_request.item_name }}
                                                </div>
                                                <div class="procurement-cart-qty">
                                                    {% if manager_can_edit_quantities %}
                                                    <div class="quantity-control">
                                                        <button type="button"
                                                                class="qty-btn minus"
                                                                data-index="0"
                                                                onclick="adjustCartQuantity(this.dataset.index, -1)">
                                                            -
                                                        </button>
                                                        <input type="number"
                                                               name="quantities[]"
                                                               id="cart_qty_0"
                                                               min="0"
                                                               step="1"
                                                               value="{{ qty or 0 }}"
                                                               data-index="0"
                                                               oninput="updateCartQuantityState(this.dataset.index)">
                                                        <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                        <button type="button"
                                                                class="qty-btn plus"
                                                                data-index="0"
                                                                onclick="adjustCartQuantity(this.dataset.index, 1)">
                                                            +
                                                        </button>
                                                    </div>
                                                    {% else %}
                                                    <span class="readonly-qty-pill">
                                                        {{ qty or '0' }} / {{ orig_qty_raw or '0' }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div id="cart_note_0"
                                                 class="procurement-cart-note {% if mgr_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                 style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px;">
                                                {% if mgr_qty_num != orig_qty_num %}
                                                    Requestor requested <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                    You have currently set <strong>{{ diff_abs }}</strong>
                                                    {% if diff > 0 %}more{% else %}less{% endif %} than requested.
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if manager_can_edit_quantities %}
                                        {% if item_request.manager_quantity_rejection_reason %}
                                        <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                            <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item</label>
                                            <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.manager_quantity_rejection_reason }}</p>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div id="manager_rejection_reason_group_single" style="display: none; margin-top: 1rem;">
                                            <div class="form-group">
                                                <label for="manager_quantity_rejection_reason_single">Reason for Rejecting Item *</label>
                                                <textarea name="quantity_rejection_reason" id="manager_quantity_rejection_reason_single" rows="3" placeholder="Please provide a reason for rejecting this item..." style="width: 100%;">{{ item_request.manager_quantity_rejection_reason or '' }}</textarea>
                                                <small class="form-text text-muted">This field is required when the quantity is set to 0.</small>
                                            </div>
                                        </div>
                                        <div class="step-actions" style="margin-top: 1rem;">
                                            <button type="submit" class="btn btn-success" id="manager_save_quantity_btn">
                                                <i class="fas fa-save"></i> Save Quantity
                                            </button>
                                        </div>
                                        {% endif %}
                                    {% if manager_can_edit_quantities %}
                                    </form>
                                    {% endif %}

                                    <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                        {% if manager_can_edit_quantities %}
                                            Any quantity changes you make here will be visible to all authorized users who can view this item request, including Procurement.
                                        {% else %}
                                            Quantity shown here reflects the latest manager-approved amount and is read-only for you.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Manager approval form (visible to authorized managers) -->
                {% if can_approve_manager or can_reject_manager %}
                    <div class="card your-approval-required">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Your Approval Required</h4>
                            <p>As the manager{% if requestor_user %} of {{ requestor_user.name }}{% endif %}, please review and approve this request.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_manager_decision', request_id=item_request.id) }}">
                                <div class="form-group">
                                    <label for="item_manager_approval_status">Set Status <span class="required-asterisk">*</span></label>
                                    <select name="approval_status" id="item_manager_approval_status" required onchange="toggleItemManagerApprovalFields()">
                                        <option value="">-- Select Status --</option>
                                        <option value="approve">Approve</option>
                                        <option value="reject">Reject</option>
                                        <option value="on_hold">On Hold</option>
                                    </select>
                                </div>
                                
                                <div id="item_manager_approve_fields" style="display: none;">
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" name="is_urgent" id="item_manager_is_urgent">
                                            Mark as Urgent
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="item_manager_approval_reason">Approval Notes (Optional)</label>
                                        <textarea name="approval_reason" id="item_manager_approval_reason" rows="3" placeholder="Add any notes about this approval..."></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_manager_reject_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="item_manager_rejection_reason">Reason for Rejection <span class="required-asterisk">*</span></label>
                                        <textarea name="rejection_reason" id="item_manager_rejection_reason" rows="3" placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_manager_on_hold_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="item_manager_on_hold_reason">On Hold Reason <span class="required-asterisk">*</span></label>
                                        <textarea name="on_hold_reason" id="item_manager_on_hold_reason" rows="3" placeholder="Add any notes about why this request is on hold..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Decision
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Step 3: Procurement Manager Approval -->
        <div class="step-content" id="step-procurement">
            <h3><i class="fas fa-shopping-cart"></i> Procurement Manager Approval</h3>
            
            {% if item_request.status in ['Assigned to Procurement', 'Completed', 'Final Approval', 'Rejected by Procurement Manager'] and item_request.status != 'On Hold' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Procurement Manager Approval: {% if item_request.status == 'Rejected by Procurement Manager' %}Rejected{% else %}Completed{% endif %}</span>
                </div>
                
                <!-- Show procurement manager approval details -->
                <div class="card procurement-manager-decision" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Procurement Manager Decision</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            {% if item_request.status == 'Rejected by Procurement Manager' %}
                                <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #721c24; font-weight: bold; font-size: 1.1rem;">REJECTED</span>
                                </div>
                            {% else %}
                                <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                    <span style="color: #155724; font-weight: bold; font-size: 1.1rem;">APPROVED BY PROCUREMENT MANAGER</span>
                                </div>
                            {% endif %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>{% if item_request.status == 'Rejected by Procurement Manager' %}Rejected by:{% else %}Approved by:{% endif %}</strong>
                                {{ procurement_manager_approver_name or item_request.procurement_manager_approver or 'Procurement Manager' }}
                            </div>
                        </div>
                        
                        {% if item_request.status == 'Rejected by Procurement Manager' %}
                            {% if item_request.procurement_manager_rejection_reason %}
                            <div class="form-group">
                                <label>Rejection Reason</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.procurement_manager_rejection_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_rejection_date %}
                            <div class="form-group">
                                <label>Rejection Date</label>
                                <input type="text" value="{{ item_request.procurement_manager_rejection_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        {% else %}
                            {% if item_request.procurement_manager_approval_reason %}
                            <div class="form-group">
                                <label>Procurement Manager Notes</label>
                                <textarea readonly style="background: #f8f9fa;">{{ item_request.procurement_manager_approval_reason }}</textarea>
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_approval_date %}
                            <div class="form-group">
                                <label>Procurement Manager Approval Date</label>
                                <input type="text" value="{{ item_request.procurement_manager_approval_date.strftime('%Y-%m-%d') }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                            {% if item_request.amount %}
                            <div class="form-group">
                                <label>Amount</label>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 12px; top: 12px; color: #666; font-weight: 600;">OMR</span>
                                    <input type="text" value="{{ "%.3f"|format(item_request.amount) }}" readonly style="background: #f5f5f5; padding-left: 55px; font-weight: bold;">
                                </div>
                            </div>
                            {% endif %}
                            {% if assigned_to_name %}
                            <div class="form-group">
                                <label>Assigned To</label>
                                <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                            
                            <!-- Show on-hold history if request was previously put on hold by procurement manager -->
                            {% if item_request.procurement_manager_on_hold_by %}
                            <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #dee2e6;">
                                <label style="color: #856404; font-weight: bold;"><i class="fas fa-pause-circle"></i> On Hold History</label>
                                <div style="background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    <div style="margin-bottom: 8px;">
                                        <strong style="color: #856404;">Put on hold by:</strong> 
                                        <span style="color: #856404;">{{ item_request.procurement_manager_on_hold_by }}</span>
                                        {% if item_request.procurement_manager_on_hold_date %}
                                        <span style="color: #856404; margin-left: 10px;">on {{ item_request.procurement_manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                        {% endif %}
                                    </div>
                                    {% if item_request.procurement_manager_on_hold_reason %}
                                    <div style="margin-top: 8px;">
                                        <strong style="color: #856404;">Reason:</strong>
                                        <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.procurement_manager_on_hold_reason }}</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                {# Show Item Quantities section after procurement manager approval (read-only) #}
                {% if item_request.item_name %}
                    {# Multi-item requests: item_name is a comma-separated list #}
                    {% if ',' in item_request.item_name %}
                    <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4><i class="fas fa-shopping-cart"></i> Item Quantities for Procurement Manager Approval</h4>
                        </div>
                        <div class="card-body">
                            <p style="color: #6b7280; font-size: 0.95rem; font-weight: 500; margin-bottom: 0.85rem;">
                                <strong>Note:</strong> These are the procurement manager-approved quantities (read-only).
                            </p>
                            {% set item_list = item_request.item_name.split(',') %}
                            {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                            {# Parse quantity_list from JSON or semicolon-separated format #}
                            {% set quantity_list = [] %}
                            {% if raw_quantity_source %}
                                {% if raw_quantity_source.startswith('[') %}
                                    {% set quantity_list = (raw_quantity_source | from_json) %}
                                {% else %}
                                    {% set quantity_list = raw_quantity_source.split(';') %}
                                {% endif %}
                            {% endif %}
                            {# Manager-approved quantities for comparison #}
                            {% set manager_quantity_source = item_request.procurement_quantities %}
                            {% set manager_quantity_list = [] %}
                            {% if manager_quantity_source %}
                                {% if manager_quantity_source.startswith('[') %}
                                    {% set manager_quantity_list = (manager_quantity_source | from_json) %}
                                {% else %}
                                    {% set manager_quantity_list = manager_quantity_source.split(';') %}
                                {% endif %}
                            {% endif %}
                            {# Filter out items with quantity 0 #}
                            {% set items_to_display = [] %}
                            {% for item in item_list %}
                                {% set item_trimmed = item.strip() %}
                                {% if item_trimmed %}
                                    {% set qty = '' %}
                                    {% if loop.index0 < quantity_list|length %}
                                        {% set qty_raw = quantity_list[loop.index0] | trim %}
                                        {% if qty_raw %}
                                            {% if ':' in qty_raw %}
                                                {% set parts = qty_raw.split(':', 1) %}
                                                {% if parts|length > 1 %}
                                                    {% set qty = parts[1].strip() %}
                                                {% else %}
                                                    {% set qty = qty_raw %}
                                                {% endif %}
                                            {% else %}
                                                {% set qty = qty_raw %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    {% set qty_num = qty|int(0) %}
                                    {# Only include items with quantity > 0 #}
                                    {% if qty_num > 0 %}
                                        {# Compare with manager-approved quantity #}
                                        {% set mgr_qty = '' %}
                                        {% if loop.index0 < manager_quantity_list|length %}
                                            {% set mgr_qty_raw = manager_quantity_list[loop.index0] | trim %}
                                            {% if mgr_qty_raw %}
                                                {% if ':' in mgr_qty_raw %}
                                                    {% set mgr_parts = mgr_qty_raw.split(':', 1) %}
                                                    {% if mgr_parts|length > 1 %}
                                                        {% set mgr_qty = mgr_parts[1].strip() %}
                                                    {% else %}
                                                        {% set mgr_qty = mgr_qty_raw %}
                                                    {% endif %}
                                                {% else %}
                                                    {% set mgr_qty = mgr_qty_raw %}
                                                {% endif %}
                                            {% endif %}
                                        {% endif %}
                                        {% set mgr_qty_num = mgr_qty|int(0) %}
                                        {# Highlight if procurement manager reduced quantity OR if manager rejected (0) but procurement manager re-enabled it #}
                                        {% set is_less = (qty_num < mgr_qty_num) or (mgr_qty_num == 0 and qty_num > 0) %}
                                        {% set _ = items_to_display.append({'name': item_trimmed, 'qty': qty, 'is_less': is_less}) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if items_to_display|length > 0 %}
                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: right;">Quantity</div>
                                </div>
                                
                                {% for item_data in items_to_display %}
                                    <div class="procurement-cart-row {% if item_data.is_less %}qty-less-than-original{% endif %}">
                                        <div class="procurement-cart-item-name">
                                            {{ item_data.name }}
                                        </div>
                                        <div class="procurement-cart-qty">
                                            <span class="readonly-qty-pill">
                                                {{ item_data.qty }}
                                            </span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p style="color: #6b7280; font-style: italic;">No items to display (all items were rejected with quantity 0).</p>
                            {% endif %}

                            {# Find items with quantity 0 and only show the section if there are rejected items and a saved reason #}
                            {% set rejected_items = [] %}
                            {% for item in item_list %}
                                {% set item_trimmed = item.strip() %}
                                {% if item_trimmed %}
                                    {% set qty = '' %}
                                    {% if loop.index0 < quantity_list|length %}
                                        {% set qty_raw = quantity_list[loop.index0] | trim %}
                                        {% if qty_raw %}
                                            {% if ':' in qty_raw %}
                                                {% set parts = qty_raw.split(':', 1) %}
                                                {% if parts|length > 1 %}
                                                    {% set qty = parts[1].strip() %}
                                                {% else %}
                                                    {% set qty = qty_raw %}
                                                {% endif %}
                                            {% else %}
                                                {% set qty = qty_raw %}
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    {% set qty_num = qty|int(0) %}
                                    {% if qty_num == 0 %}
                                        {% set _ = rejected_items.append(item_trimmed) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% if rejected_items|length > 0 and item_request.procurement_manager_quantity_rejection_reason %}
                            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Reason for Rejecting Item(s)</label>
                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #fecaca;">
                                        <strong style="color: #991b1b;">Rejected Items (Quantity set to 0):</strong>
                                        <ul style="color: #991b1b; margin: 5px 0 0 20px; padding: 0;">
                                            {% for rejected_item in rejected_items %}
                                            <li>{{ rejected_item }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_manager_quantity_rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {# Show legend only if there are items highlighted yellow #}
                            {% set has_highlighted_items = false %}
                            {% for item_data in items_to_display %}
                                {% if item_data.is_less %}
                                    {% set has_highlighted_items = true %}
                                {% endif %}
                            {% endfor %}
                            {% if has_highlighted_items %}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border: 1px solid #ffc107; border-radius: 50%;"></span>
                                    <span>Edited by Procurement Manager (see Request Details for Edit History)</span>
                                </div>
                            </div>
                            {% endif %}
                            <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                Quantities shown here reflect the procurement manager-approved amounts and are read-only.
                            </p>
                        </div>
                    </div>

                    {# Single-item requests: item_name is a single string #}
                    {% else %}
                    {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                    {% set qty = (raw_quantity_source or '0') %}
                    {% if ';' in qty %}
                        {% set qty = qty.split(';')[0] %}
                    {% endif %}
                    {% set qty_num = qty|int(0) %}
                    {# Manager-approved quantity for comparison #}
                    {% set mgr_qty_raw = (item_request.procurement_quantities or '').strip() %}
                    {% if ';' in mgr_qty_raw %}
                        {% set mgr_qty_raw = mgr_qty_raw.split(';')[0] %}
                    {% endif %}
                    {% set mgr_qty_num = mgr_qty_raw|int(0) %}
                    {# Highlight if procurement manager reduced quantity OR if manager rejected (0) but procurement manager re-enabled it #}
                    {% set is_less = (qty_num < mgr_qty_num) or (mgr_qty_num == 0 and qty_num > 0) %}
                    {# Only display if quantity > 0 #}
                    {% if qty_num > 0 %}
                    <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <h4><i class="fas fa-shopping-cart"></i> Item Quantity for Procurement Manager Approval</h4>
                        </div>
                        <div class="card-body">
                            <p style="color: #6b7280; font-size: 0.95rem; font-weight: 500; margin-bottom: 0.85rem;">
                                <strong>Note:</strong> This is the procurement manager-approved quantity (read-only).
                            </p>

                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: right;">Quantity</div>
                                </div>

                                <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %}">
                                    <div class="procurement-cart-item-name">
                                        {{ item_request.item_name }}
                                    </div>
                                    <div class="procurement-cart-qty">
                                        <span class="readonly-qty-pill">
                                            {{ qty }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {% set qty_num = qty|int(0) %}
                            {% if item_request.procurement_manager_quantity_rejection_reason and qty_num == 0 %}
                            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Reason for Rejecting Item</label>
                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #fecaca;">
                                        <strong style="color: #991b1b;">Rejected Item (Quantity set to 0):</strong>
                                        <p style="color: #991b1b; margin: 5px 0 0 0;">{{ item_request.item_name }}</p>
                                    </div>
                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_manager_quantity_rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {# Show legend only if item is highlighted yellow #}
                            {% if is_less %}
                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <div style="display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #6b7280;">
                                    <span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border: 1px solid #ffc107; border-radius: 50%;"></span>
                                    <span>Edited by Procurement Manager (see Request Details for Edit History)</span>
                                </div>
                            </div>
                            {% endif %}
                            <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                Quantity shown here reflects the procurement manager-approved amount and is read-only.
                            </p>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                {% endif %}
            {% elif item_request.status in ['Pending Procurement Manager Approval', 'On Hold'] %}
                <!-- Procurement Manager approval required or On Hold -->
                <div class="card procurement-approval-required" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-shopping-cart"></i> Procurement Manager Approval Required</h4>
                    </div>
                    <div class="card-body">
                        <!-- Status Display (similar to Finance Approval tab) -->
                        {% if item_request.status == 'On Hold' %}
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #856404; font-weight: bold; font-size: 1.1rem;">ON HOLD UNTIL FURTHER NOTICE</span>
                            </div>
                            {% if item_request.procurement_manager_on_hold_by %}
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>Put on hold by:</strong> {{ item_request.procurement_manager_on_hold_by }}
                                {% if item_request.procurement_manager_on_hold_date %}
                                <span style="margin-left: 10px;">on {{ item_request.procurement_manager_on_hold_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if item_request.procurement_manager_on_hold_reason %}
                            <div style="margin-top: 0.5rem; padding: 10px; background: #fff9e6; border: 1px solid #ffc107; border-radius: 6px;">
                                <strong style="color: #856404;">Reason:</strong>
                                <p style="color: #856404; margin: 5px 0 0 0; white-space: pre-wrap;">{{ item_request.procurement_manager_on_hold_reason }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <p style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                                    <strong>Status:</strong> {% if item_request.status == 'On Hold' %}On Hold Until Further Notice{% else %}Waiting for Procurement Manager Approval{% endif %}
                                </p>
                                <p style="margin-bottom: 0.5rem; color: #666;">
                                    <strong>Department:</strong> {{ item_request.department }}
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; text-align: center;">
                                    <i class="fas fa-clock" style="font-size: 2rem; color: #f57c00; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 600; color: #856404;">Pending Review</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        {# Procurement Manager-stage quantity adjustment (for multi-item and single-item requests) #}
                        {% if item_request.item_name %}
                            {% set procurement_manager_can_edit_quantities = can_approve_procurement_manager %}
                            {% set manager_rejection_reason = item_request.manager_quantity_rejection_reason or '' %}
                            {% set manager_reason_submitter = manager_approver_name or item_request.manager_approver or 'Authorized Manager' %}
                            {% set procurement_manager_reason_value = item_request.procurement_manager_quantity_rejection_reason or manager_rejection_reason %}
                            {% set procurement_reason_inherited = (not item_request.procurement_manager_quantity_rejection_reason) and manager_rejection_reason %}

                            {# Multi-item requests: item_name is a comma-separated list #}
                            {% if ',' in item_request.item_name %}
                            <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-shopping-cart"></i> Item Quantities for Procurement Manager Approval</h4>
                                </div>
                                <div class="card-body">
                                    <p style="color: #dc3545; font-size: 1rem; font-weight: 500; margin-bottom: 0.85rem;">
                                        <strong>Note:</strong> If you do not want to approve an item, set its quantity to <strong>0</strong>. Adjust the quantities below as part of your procurement manager approval.
                                    </p>
                                    {% set item_list = item_request.item_name.split(',') %}
                                    {# Use procurement manager quantities if they exist; otherwise use manager-approved quantities; otherwise original requested quantities #}
                                    {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                                    {# Parse quantity_list from JSON or semicolon-separated format #}
                                    {% set quantity_list = [] %}
                                    {% if raw_quantity_source %}
                                        {% if raw_quantity_source.startswith('[') %}
                                            {% set quantity_list = (raw_quantity_source | from_json) %}
                                        {% else %}
                                            {% set quantity_list = raw_quantity_source.split(';') %}
                                        {% endif %}
                                    {% endif %}
                                    {# Manager-approved quantities (for comparison - this is the "original" for procurement manager) #}
                                    {% set original_source = item_request.procurement_quantities %}
                                    {% set original_list = [] %}
                                    {% if original_source %}
                                        {% if original_source.startswith('[') %}
                                            {% set original_list = (original_source | from_json) %}
                                        {% else %}
                                            {% set original_list = original_source.split(';') %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {% if procurement_manager_can_edit_quantities %}
                                    <form method="POST" action="{{ url_for('update_item_request_quantities_procurement_manager', request_id=item_request.id) }}">
                                    {% endif %}
                                        <div class="procurement-cart-table">
                                            <div class="procurement-cart-header-row">
                                                <div>Item</div>
                                                <div style="text-align: right;">Quantity</div>
                                            </div>
                                            
                                            {% for item in item_list %}
                                                {% set item_trimmed = item.strip() %}
                                                {% if item_trimmed %}
                                                    {% set qty = '' %}
                                                    {% if loop.index0 < quantity_list|length %}
                                                        {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                        {% if qty_raw %}
                                                            {# Quantities may be stored as "Item Name: 2"; extract numeric part #}
                                                            {% if ':' in qty_raw %}
                                                                {% set parts = qty_raw.split(':', 1) %}
                                                                {% if parts|length > 1 %}
                                                                    {% set qty = parts[1].strip() %}
                                                                {% else %}
                                                                    {% set qty = qty_raw %}
                                                                {% endif %}
                                                            {% else %}
                                                                {% set qty = qty_raw %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}

                                                    {# Derive original numeric quantity for comparison #}
                                                    {% set orig_qty_raw = '' %}
                                                    {% if loop.index0 < original_list|length %}
                                                        {% set oq = original_list[loop.index0]|string %}
                                                        {% if oq and oq != '' %}
                                                            {# Remove quotes and trim if it's a JSON string value #}
                                                            {% set oq_clean = oq|replace('"', '')|trim %}
                                                            {% if ':' in oq_clean %}
                                                                {# Handle "Item Name: qty" format #}
                                                                {% set o_parts = oq_clean.split(':', 1) %}
                                                                {% set orig_qty_raw = o_parts[1].strip() if o_parts|length > 1 else oq_clean %}
                                                            {% else %}
                                                                {% set orig_qty_raw = oq_clean %}
                                                            {% endif %}
                                                        {% endif %}
                                                    {% endif %}
                                                    {% set orig_qty_num = orig_qty_raw|int(0) %}
                                                    {% set mgr_qty_num = qty|int(0) %}
                                                    {% set is_less = mgr_qty_num < orig_qty_num %}
                                                    {% set diff = mgr_qty_num - orig_qty_num %}
                                                    {% set diff_abs = diff|abs %}
                                                    {% set was_previously_rejected = orig_qty_num == 0 %}

                                                    <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %} {% if was_previously_rejected %}previously-rejected-by-manager{% endif %}"
                                                         id="procurement_cart_row_{{ loop.index0 }}"
                                                         data-orig-qty="{{ orig_qty_num }}"
                                                         data-orig-display="{{ orig_qty_raw or '0' }}">
                                                        <div class="procurement-cart-item-name">
                                                            {{ item_trimmed }}
                                                            {% if was_previously_rejected %}
                                                            <span class="tooltip-wrapper">
                                                                <i class="fas fa-info-circle tooltip-icon"></i>
                                                                <span class="tooltip-text">This item was previously rejected by the manager but is kept in case you want to edit it again</span>
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="procurement-cart-qty">
                                                            {% if procurement_manager_can_edit_quantities %}
                                                                {% if was_previously_rejected %}
                                                                {# Read-only display with edit icon for previously rejected items #}
                                                                <div class="quantity-readonly-display" id="procurement_qty_readonly_{{ loop.index0 }}">
                                                                    <span class="readonly-qty-pill">
                                                                        {{ qty or 0 }} / {{ orig_qty_raw or '0' }}
                                                                    </span>
                                                                    <button type="button"
                                                                            class="edit-qty-btn"
                                                                            data-index="{{ loop.index0 }}"
                                                                            onclick="enableProcurementQuantityEdit(this.dataset.index)"
                                                                            title="Edit quantity">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                </div>
                                                                {# Editable quantity control with cancel button (hidden by default for previously rejected items) #}
                                                                <div id="procurement_qty_editable_wrapper_{{ loop.index0 }}" style="display: none; align-items: center; gap: 8px; justify-content: flex-end;">
                                                                    <div class="quantity-control" id="procurement_qty_editable_{{ loop.index0 }}">
                                                                        <button type="button"
                                                                                class="qty-btn minus"
                                                                                data-index="{{ loop.index0 }}"
                                                                                onclick="adjustProcurementCartQuantity(this.dataset.index, -1)">
                                                                            -
                                                                        </button>
                                                                        <input type="number"
                                                                               name="quantities[]"
                                                                               id="procurement_cart_qty_{{ loop.index0 }}"
                                                                               min="0"
                                                                               step="1"
                                                                               value="{{ qty or 0 }}"
                                                                               data-index="{{ loop.index0 }}"
                                                                               data-original-value="{{ qty or 0 }}"
                                                                               oninput="updateProcurementCartQuantityState(this.dataset.index)">
                                                                        <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                        <button type="button"
                                                                                class="qty-btn plus"
                                                                                data-index="{{ loop.index0 }}"
                                                                                onclick="adjustProcurementCartQuantity(this.dataset.index, 1)">
                                                                            +
                                                                        </button>
                                                                    </div>
                                                                    <button type="button"
                                                                            class="edit-qty-btn"
                                                                            data-index="{{ loop.index0 }}"
                                                                            onclick="cancelProcurementQuantityEdit(this.dataset.index)"
                                                                            title="Cancel editing">
                                                                        <i class="fas fa-times"></i>
                                                                    </button>
                                                                </div>
                                                                {% else %}
                                                                {# Normal editable quantity control for non-rejected items #}
                                                                <div class="quantity-control">
                                                                    <button type="button"
                                                                            class="qty-btn minus"
                                                                            data-index="{{ loop.index0 }}"
                                                                            onclick="adjustProcurementCartQuantity(this.dataset.index, -1)">
                                                                        -
                                                                    </button>
                                                                    <input type="number"
                                                                           name="quantities[]"
                                                                           id="procurement_cart_qty_{{ loop.index0 }}"
                                                                           min="0"
                                                                           step="1"
                                                                           value="{{ qty or 0 }}"
                                                                           data-index="{{ loop.index0 }}"
                                                                           oninput="updateProcurementCartQuantityState(this.dataset.index)">
                                                                    <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                    <button type="button"
                                                                            class="qty-btn plus"
                                                                            data-index="{{ loop.index0 }}"
                                                                            onclick="adjustProcurementCartQuantity(this.dataset.index, 1)">
                                                                        +
                                                                    </button>
                                                                </div>
                                                                {% endif %}
                                                            {% else %}
                                                            <span class="readonly-qty-pill">
                                                                {{ qty or '0' }} / {{ orig_qty_raw or '0' }}
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div id="procurement_cart_note_{{ loop.index0 }}"
                                                         class="procurement-cart-note {% if mgr_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                         style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px;">
                                                        {% if mgr_qty_num != orig_qty_num %}
                                                            Manager approved <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                            You have currently set <strong>{{ diff_abs }}</strong>
                                                            {% if diff > 0 %}more{% else %}less{% endif %} than manager approved.
                                                        {% endif %}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        {% if procurement_manager_can_edit_quantities %}
                                        {# Previously saved reason display - only shown when editing is enabled and at least one quantity is 0 #}
                                        {% set _rejected_items_preview = [] %}
                                        {% for item in item_list %}
                                            {% set item_trimmed = item.strip() %}
                                            {% if item_trimmed %}
                                                {% set qty_preview = '' %}
                                                {% if loop.index0 < quantity_list|length %}
                                                    {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                    {% if qty_raw %}
                                                        {% if ':' in qty_raw %}
                                                            {% set parts = qty_raw.split(':', 1) %}
                                                            {% if parts|length > 1 %}
                                                                {% set qty_preview = parts[1].strip() %}
                                                            {% else %}
                                                                {% set qty_preview = qty_raw %}
                                                            {% endif %}
                                                        {% else %}
                                                            {% set qty_preview = qty_raw %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                                {% if qty_preview|int(0) == 0 %}
                                                    {% set _ = _rejected_items_preview.append(item_trimmed) %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if item_request.procurement_manager_quantity_rejection_reason and _rejected_items_preview|length > 0 %}
                                        <div id="procurement_manager_saved_rejection_reason_group" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                            <div class="form-group">
                                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item(s)</label>
                                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_manager_quantity_rejection_reason }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        {% if manager_rejection_reason %}
                                        <div id="manager_original_rejection_reason_multi" style="margin-top: 0.75rem; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">
                                                Original reason from {{ manager_reason_submitter }} (authorized manager)
                                            </div>
                                            <p style="margin: 0; color: #4b5563; white-space: pre-wrap;">{{ manager_rejection_reason }}</p>
                                        </div>
                                        {% endif %}
                                        <div id="procurement_manager_rejection_reason_group" style="display: none; margin-top: 1rem;">
                                            <div class="form-group">
                                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                                                    <label for="procurement_manager_quantity_rejection_reason" style="margin: 0;">Reason for Rejecting Item(s) *</label>
                                                </div>
                                                <textarea name="quantity_rejection_reason"
                                                          id="procurement_manager_quantity_rejection_reason"
                                                          rows="3"
                                                          placeholder="Please provide a reason for rejecting the item(s) with quantity set to 0..."
                                                          style="width: 100%;"
                                                          data-default-value="{{ procurement_manager_reason_value }}"
                                                          data-original-value="{{ procurement_manager_reason_value }}"
                                                          data-start-readonly="false">{{ procurement_manager_reason_value }}</textarea>
                                                <small class="form-text text-muted">This field is required when at least one item quantity is set to 0.</small>
                                            </div>
                                        </div>
                                        <div class="step-actions" style="margin-top: 1rem;">
                                            <button type="submit" class="btn btn-success" id="procurement_manager_save_quantities_btn">
                                                <i class="fas fa-save"></i> Save Quantities
                                            </button>
                                        </div>
                                        {% endif %}
                                    {% if procurement_manager_can_edit_quantities %}
                                    </form>
                                    {% endif %}

                                    <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                        {% if procurement_manager_can_edit_quantities %}
                                            Any quantity changes you make here will be visible to all authorized users who can view this item request, including Procurement staff.
                                        {% else %}
                                            Quantities shown here reflect the latest procurement manager-approved amounts and are read-only for you.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>

                            {# Single-item requests: item_name is a single string #}
                            {% else %}
                            {% set raw_quantity_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                            {# Parse qty from JSON if needed #}
                            {% set qty = '0' %}
                            {% if raw_quantity_source %}
                                {% if raw_quantity_source.startswith('[') %}
                                    {% set qty_array = (raw_quantity_source | from_json) %}
                                    {% set qty = (qty_array[0] if qty_array|length > 0 else '0')|string %}
                                {% else %}
                                    {% set qty = raw_quantity_source.split(';')[0] if ';' in raw_quantity_source else raw_quantity_source %}
                                {% endif %}
                            {% endif %}
                            {# Parse orig_qty_raw from JSON if needed #}
                            {% set orig_qty_raw = '' %}
                            {% set proc_qty = item_request.procurement_quantities %}
                            {% if proc_qty %}
                                {% if proc_qty.startswith('[') %}
                                    {# JSON format - extract first element #}
                                    {% set qty_array = (proc_qty | from_json) %}
                                    {% set orig_qty_raw = (qty_array[0] if qty_array|length > 0 else '0')|string %}
                                {% else %}
                                    {% set orig_qty_raw = proc_qty.split(';')[0] if ';' in proc_qty else proc_qty %}
                                {% endif %}
                            {% endif %}
                            {% set orig_qty_num = orig_qty_raw|int(0) %}
                            {% set mgr_qty_num = qty|int(0) %}
                            {% set is_less = mgr_qty_num < orig_qty_num %}
                            {% set diff = mgr_qty_num - orig_qty_num %}
                            {% set diff_abs = diff|abs %}
                            {% set was_previously_rejected = orig_qty_num == 0 %}

                            <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                                <div class="card-header">
                                    <h4><i class="fas fa-shopping-cart"></i> Item Quantity for Procurement Manager Approval</h4>
                                </div>
                                <div class="card-body">
                                    <p style="color: #dc3545; font-size: 1rem; font-weight: 500; margin-bottom: 0.85rem;">
                                        <strong>Note:</strong> If you do not want to approve this item, set the quantity to <strong>0</strong>. Adjust the quantity below as part of your procurement manager approval.
                                    </p>

                                    {% if procurement_manager_can_edit_quantities %}
                                    <form method="POST" action="{{ url_for('update_item_request_quantities_procurement_manager', request_id=item_request.id) }}">
                                    {% endif %}
                                        <div class="procurement-cart-table">
                                            <div class="procurement-cart-header-row">
                                                <div>Item</div>
                                                <div style="text-align: right;">Quantity</div>
                                            </div>

                                            <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %} {% if was_previously_rejected %}previously-rejected-by-manager{% endif %}"
                                                 id="procurement_cart_row_0"
                                                 data-orig-qty="{{ orig_qty_num }}"
                                                 data-orig-display="{{ orig_qty_raw or '0' }}">
                                                <div class="procurement-cart-item-name">
                                                    {{ item_request.item_name }}
                                                    {% if was_previously_rejected %}
                                                    <span class="tooltip-wrapper">
                                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                                        <span class="tooltip-text">This item was previously rejected by the manager but is kept in case you want to edit it again</span>
                                                    </span>
                                                    {% endif %}
                                                </div>
                                                <div class="procurement-cart-qty">
                                                    {% if procurement_manager_can_edit_quantities %}
                                                        {% if was_previously_rejected %}
                                                        {# Read-only display with edit icon for previously rejected items #}
                                                        <div class="quantity-readonly-display" id="procurement_qty_readonly_0">
                                                            <span class="readonly-qty-pill">
                                                                {{ qty or 0 }} / {{ orig_qty_raw or '0' }}
                                                            </span>
                                                            <button type="button"
                                                                    class="edit-qty-btn"
                                                                    data-index="0"
                                                                    onclick="enableProcurementQuantityEdit(this.dataset.index)"
                                                                    title="Edit quantity">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                        {# Editable quantity control with cancel button (hidden by default for previously rejected items) #}
                                                        <div id="procurement_qty_editable_wrapper_0" style="display: none; align-items: center; gap: 8px; justify-content: flex-end;">
                                                            <div class="quantity-control" id="procurement_qty_editable_0">
                                                                <button type="button"
                                                                        class="qty-btn minus"
                                                                        data-index="0"
                                                                        onclick="adjustProcurementCartQuantity(this.dataset.index, -1)">
                                                                    -
                                                                </button>
                                                                <input type="number"
                                                                       name="quantities[]"
                                                                       id="procurement_cart_qty_0"
                                                                       min="0"
                                                                       step="1"
                                                                       value="{{ qty or 0 }}"
                                                                       data-index="0"
                                                                       data-original-value="{{ qty or 0 }}"
                                                                       oninput="updateProcurementCartQuantityState(this.dataset.index)">
                                                                <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                <button type="button"
                                                                        class="qty-btn plus"
                                                                        data-index="0"
                                                                        onclick="adjustProcurementCartQuantity(this.dataset.index, 1)">
                                                                    +
                                                                </button>
                                                            </div>
                                                            <button type="button"
                                                                    class="edit-qty-btn"
                                                                    data-index="0"
                                                                    onclick="cancelProcurementQuantityEdit(this.dataset.index)"
                                                                    title="Cancel editing">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                        {% else %}
                                                        {# Normal editable quantity control for non-rejected items #}
                                                        <div class="quantity-control">
                                                            <button type="button"
                                                                    class="qty-btn minus"
                                                                    data-index="0"
                                                                    onclick="adjustProcurementCartQuantity(this.dataset.index, -1)">
                                                                -
                                                            </button>
                                                            <input type="number"
                                                                   name="quantities[]"
                                                                   id="procurement_cart_qty_0"
                                                                   min="0"
                                                                   step="1"
                                                                   value="{{ qty or 0 }}"
                                                                   data-index="0"
                                                                   oninput="updateProcurementCartQuantityState(this.dataset.index)">
                                                            <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                            <button type="button"
                                                                    class="qty-btn plus"
                                                                    data-index="0"
                                                                    onclick="adjustProcurementCartQuantity(this.dataset.index, 1)">
                                                                +
                                                            </button>
                                                        </div>
                                                        {% endif %}
                                                    {% else %}
                                                    <span class="readonly-qty-pill">
                                                        {{ qty or '0' }} / {{ orig_qty_raw or '0' }}
                                                    </span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div id="procurement_cart_note_0"
                                                 class="procurement-cart-note {% if mgr_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                 style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px;">
                                                {% if mgr_qty_num != orig_qty_num %}
                                                    Manager approved <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                    You have currently set <strong>{{ diff_abs }}</strong>
                                                    {% if diff > 0 %}more{% else %}less{% endif %} than manager approved.
                                                {% endif %}
                                            </div>
                                        </div>

                                        {% if procurement_manager_can_edit_quantities %}
                                        {# Previously saved reason display - only shown when editing is enabled and quantity is 0 #}
                                        {% if item_request.procurement_manager_quantity_rejection_reason and mgr_qty_num == 0 %}
                                        <div id="procurement_manager_saved_rejection_reason_group_single" style="display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                            <div class="form-group">
                                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item</label>
                                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_manager_quantity_rejection_reason }}</p>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        <div id="procurement_manager_rejection_reason_group_single" style="display: none; margin-top: 1rem;">
                                            <div class="form-group">
                                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
                                                    <label for="procurement_manager_quantity_rejection_reason_single" style="margin: 0;">Reason for Rejecting Item *</label>
                                                </div>
                                                <textarea name="quantity_rejection_reason"
                                                          id="procurement_manager_quantity_rejection_reason_single"
                                                          rows="3"
                                                          placeholder="Please provide a reason for rejecting this item..."
                                                          style="width: 100%;"
                                                          data-default-value="{{ procurement_manager_reason_value }}"
                                                          data-original-value="{{ procurement_manager_reason_value }}"
                                                          data-start-readonly="false">{{ procurement_manager_reason_value }}</textarea>
                                                <small class="form-text text-muted">This field is required when the quantity is set to 0.</small>
                                            </div>
                                        </div>
                                        {% if manager_rejection_reason %}
                                        <div id="manager_original_rejection_reason_single" style="margin-top: 0.75rem; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 6px; padding: 10px;">
                                            <div style="font-weight: 600; color: #374151; margin-bottom: 4px;">
                                                Original reason from {{ manager_reason_submitter }} (authorized manager)
                                            </div>
                                            <p style="margin: 0; color: #4b5563; white-space: pre-wrap;">{{ manager_rejection_reason }}</p>
                                        </div>
                                        {% endif %}
                                        <div class="step-actions" style="margin-top: 1rem;">
                                            <button type="submit" class="btn btn-success" id="procurement_manager_save_quantity_btn">
                                                <i class="fas fa-save"></i> Save Quantity
                                            </button>
                                        </div>
                                        {% endif %}
                                    {% if procurement_manager_can_edit_quantities %}
                                    </form>
                                    {% endif %}

                                    <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                                        {% if procurement_manager_can_edit_quantities %}
                                            Any quantity changes you make here will be visible to all authorized users who can view this item request, including Procurement staff.
                                        {% else %}
                                            Quantity shown here reflects the latest procurement manager-approved amount and is read-only for you.
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}

                <!-- Procurement Manager approval form (visible to Procurement Manager) -->
                {% if can_approve_procurement_manager or can_reject_procurement_manager %}
                    <div class="card procurement-approval-form">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Your Approval Required</h4>
                            <p>As the Procurement Manager, please review, approve, and assign this request.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_procurement_manager_decision', request_id=item_request.id) }}">
                                <div class="form-group">
                                    <label for="item_procurement_approval_status">Set Status <span class="required-asterisk">*</span></label>
                                    <select name="approval_status" id="item_procurement_approval_status" required onchange="toggleItemProcurementManagerApprovalFields()" data-item-status="{{ item_request.status }}">
                                        <option value="">-- Select Status --</option>
                                        <option value="approve">Approve</option>
                                        <option value="reject">Reject</option>
                                        <option value="on_hold">On Hold</option>
                                    </select>
                                </div>
                                
                                <div id="item_procurement_approve_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_approval_reason">Approval Notes (Optional)</label>
                                        <textarea name="approval_reason" id="procurement_approval_reason" rows="3" placeholder="Add any notes about this approval..."></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_reject_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_rejection_reason">Reason for Rejection <span class="required-asterisk">*</span></label>
                                        <textarea name="rejection_reason" id="procurement_rejection_reason" rows="3" placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_on_hold_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_on_hold_reason">On Hold Reason <span class="required-asterisk">*</span></label>
                                        <textarea name="on_hold_reason" id="procurement_on_hold_reason" rows="3" placeholder="Add any notes about why this request is on hold..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Decision
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Step 4: Assigned to Procurement -->
        <div class="step-content" id="step-assigned">
            <h3><i class="fas fa-user-check"></i> Assigned to Procurement</h3>
            
            {% if item_request.status in ['Assigned to Procurement', 'Final Approval', 'Completed'] %}
                <div class="admin-mode-warning" style="background: {% if item_request.status == 'Completed' %}#28a745{% elif item_request.status == 'Final Approval' %}#17a2b8{% else %}#17a2b8{% endif %}; color: white;">
                    <i class="fas fa-user-check"></i>
                    <span>{% if item_request.status == 'Completed' %}Request has been completed{% elif item_request.status == 'Final Approval' %}Request has been assigned to a procurement member for processing{% else %}Request has been assigned to a procurement member for processing{% endif %}</span>
                </div>
                
                <div class="card assigned-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Assignment Details</h4>
                    </div>
                    <div class="card-body">
                        {% if assigned_to_name and item_request.assignment_date %}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 1rem;">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label>Assigned To</label>
                                <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5; font-weight: bold;">
                            </div>
                                <div class="form-group" style="margin-bottom: 0;">
                                <label>Assignment Date</label>
                                <input type="text" value="{{ utc_to_local(item_request.assignment_date).strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                            </div>
                        </div>
                        {% elif assigned_to_name %}
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5; font-weight: bold;">
                        </div>
                        {% elif item_request.assignment_date %}
                        <div class="form-group">
                            <label>Assignment Date</label>
                            <input type="text" value="{{ utc_to_local(item_request.assignment_date).strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if assigned_by_name %}
                        <div class="form-group">
                            <label>Assigned By</label>
                            <input type="text" value="{{ assigned_by_name }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Display uploaded files (if any) - moved above Billing and Completion for completed status -->
                {% if receipt_files or invoice_files %}
                <div class="card assigned-section" style="margin-bottom: 1.5rem;" id="uploaded-files-card">
                    <div class="card-header">
                        <h4>Uploaded Files</h4>
                    </div>
                    <div class="card-body">
                        {% if receipt_files %}
                        <div class="form-group" id="uploaded-receipts-list">
                            <label><i class="fas fa-check-circle"></i> Receipt (Proof of transfer made by the Procurement Manager)</label>
                            {% for file in receipt_files %}
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Receipt {{ loop.index }}
                                </a>
                                <small style="color: #666; margin-left: 10px;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                            </div>
                            {% endfor %}
                        </div>
                        {% if item_request.receipt_amount %}
                        <div class="form-group" style="margin-top: 10px;">
                            <label>Receipt Amount (OMR)</label>
                            <input type="text"
                                   value="{{ '%.3f'|format(item_request.receipt_amount) }}"
                                   readonly
                                   style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if item_request.receipt_reference_number %}
                        <div class="form-group">
                            <label>Receipt Reference Number</label>
                            <input type="text"
                                   value="{{ item_request.receipt_reference_number }}"
                                   readonly
                                   style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% endif %}
                        {% if invoice_files %}
                        <div class="form-group" id="uploaded-invoices-list">
                            <label><i class="fas fa-check-circle"></i> Invoice (Proof of payment made for the requested item)</label>
                            {% set invoice_amount_lookup = {} %}
                            {% set invoice_items_lookup = {} %}
                            {% set invoice_total_ns = namespace(total=0.0) %}
                            {% for inv in invoice_entries or [] %}
                                {% if inv.filename %}
                                    {% set inv_amt = inv['amount'] if inv['amount'] is defined else None %}
                                    {% set inv_items = inv['items'] if inv['items'] is defined else [] %}
                                    {% if inv_items is none %}{% set inv_items = [] %}{% endif %}
                                    {% set _ = invoice_amount_lookup.update({inv.filename: inv_amt}) %}
                                    {% set _ = invoice_items_lookup.update({inv.filename: inv_items}) %}
                                    {% if inv_amt %}
                                        {% set invoice_total_ns.total = invoice_total_ns.total + (inv_amt | float) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% for file in invoice_files %}
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Invoice {{ loop.index }}
                                </a>
                                <small style="color: #666; margin-left: 10px;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                                {% if invoice_amount_lookup.get(file) %}
                                <div style="margin-top: 6px; font-weight: 600; color: #1f2937;">Amount: OMR {{ '%.3f'|format(invoice_amount_lookup.get(file)|float) }}</div>
                                {% endif %}
                                {% if invoice_items_lookup.get(file) %}
                                <div style="margin-top: 4px; color: #374151;">
                                    <strong>Items:</strong>
                                    <ul style="margin: 4px 0 0 18px; padding: 0;">
                                        {% for itm in invoice_items_lookup.get(file) %}
                                        <li>{{ itm }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% if invoice_total_ns is not defined %}
                                {% set invoice_total_ns = namespace(total=0.0) %}
                            {% endif %}
                            {% set invoice_total_value = (invoice_total_ns.total if invoice_total_ns.total > 0 else item_request.invoice_amount) %}
                            {% if invoice_total_value is not none %}
                            <div class="form-group" style="margin-top: 10px;">
                                <label>Invoice Amount (OMR)</label>
                                <input type="text"
                                       value="{{ '%.3f'|format(invoice_total_value) }}"
                                       readonly
                                       style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {# Read-only Billing & Completion view for authorized viewers (not the assigned procurement) #}
                {% if not can_complete and item_request.item_name %}
                <div class="card assigned-section procurement-cart-card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-check-circle"></i> Billing and Completion (Read-Only)</h4>
                        <p style="margin: 0;">These are the quantities and amounts set by the assigned procurement staff.</p>
                    </div>
                    <div class="card-body">
                        {% set amount_list = (item_request.procurement_amounts or '').split(';') %}
                        {# Prefer saved assigned procurement quantities if they exist, otherwise default to procurement manager-approved quantities, then manager quantities, then original request #}
                        {% set quantity_source = item_request.assigned_procurement_quantities or item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                        {% if ',' in item_request.item_name %}
                            {% set item_list = item_request.item_name.split(',') %}
                            {# Parse quantity_list from JSON or semicolon-separated format #}
                            {% set quantity_list = [] %}
                            {% if quantity_source %}
                                {% if quantity_source.startswith('[') %}
                                    {% set quantity_list = (quantity_source | from_json) %}
                                {% else %}
                                    {% set quantity_list = quantity_source.split(';') %}
                                {% endif %}
                            {% endif %}
                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: left;">Quantity</div>
                                    <div style="text-align: right;">Amount</div>
                                </div>
                                {% for item in item_list %}
                                    {% set item_trimmed = item.strip() %}
                                    {% if item_trimmed %}
                                        {% set qty = quantity_list[loop.index0]|trim if loop.index0 < quantity_list|length else '0' %}
                                        {% if ':' in qty %}
                                            {% set parts = qty.split(':', 1) %}
                                            {% set qty = parts[1].strip() if parts|length > 1 else qty %}
                                        {% endif %}
                                        {% set qty_num = qty|int(0) %}
                                        {% if qty_num > 0 %}
                                        {% set amt_val = amount_list[loop.index0] if amount_list|length > loop.index0 else '0.000' %}
                                        <div class="procurement-cart-row">
                                            <div class="procurement-cart-item-name">{{ item_trimmed }}</div>
                                            <div class="procurement-cart-qty">
                                                <span class="readonly-qty-pill">{{ qty or '0' }}</span>
                                            </div>
                                            <div class="procurement-cart-amount">
                                                <span class="readonly-qty-pill">{{ amt_val or '0.000' }}</span>
                                            </div>
                                        </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if item_request.procurement_quantity_rejection_reason %}
                            <div class="form-group" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Reason for Rejecting Item(s)</label>
                                <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                    {% set rejected_items = [] %}
                                    {% for item in item_list %}
                                        {% set item_trimmed = item.strip() %}
                                        {% if item_trimmed %}
                                            {% set qty = quantity_list[loop.index0]|trim if loop.index0 < quantity_list|length else '0' %}
                                            {% if ':' in qty %}
                                                {% set parts = qty.split(':', 1) %}
                                                {% set qty = parts[1].strip() if parts|length > 1 else qty %}
                                            {% endif %}
                                            {% set qty_num = qty|int(0) %}
                                            {% if qty_num == 0 %}
                                                {% set _ = rejected_items.append(item_trimmed) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if rejected_items|length > 0 %}
                                    <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #fecaca;">
                                        <strong style="color: #991b1b;">Rejected Items (Quantity set to 0):</strong>
                                        <ul style="color: #991b1b; margin: 5px 0 0 20px; padding: 0;">
                                            {% for rejected_item in rejected_items %}
                                            <li>{{ rejected_item }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                    <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_quantity_rejection_reason }}</p>
                                </div>
                            </div>
                            {% endif %}
                        {% else %}
                            {% set qty_single = (quantity_source or '').split(';')[0] if quantity_source else '' %}
                            {% if ':' in qty_single %}
                                {% set parts = qty_single.split(':', 1) %}
                                {% set qty_single = parts[1].strip() if parts|length > 1 else qty_single %}
                            {% endif %}
                            {% set qty_single_num = qty_single|int(0) %}
                            {% if qty_single_num > 0 %}
                            {% set amt_single = amount_list[0] if amount_list|length > 0 else '0.000' %}
                            <div class="procurement-cart-table">
                                <div class="procurement-cart-header-row">
                                    <div>Item</div>
                                    <div style="text-align: left;">Quantity</div>
                                    <div style="text-align: right;">Amount</div>
                                </div>
                                <div class="procurement-cart-row">
                                    <div class="procurement-cart-item-name">{{ item_request.item_name }}</div>
                                    <div class="procurement-cart-qty">
                                        <span class="readonly-qty-pill">{{ qty_single or '0' }}</span>
                                    </div>
                                    <div class="procurement-cart-amount">
                                        <span class="readonly-qty-pill">{{ amt_single or '0.000' }}</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                        {% set readonly_ns = namespace(total=0.0) %}
                        {% if ',' in item_request.item_name %}
                            {% for item in item_list %}
                                {% set item_trimmed = item.strip() %}
                                {% if item_trimmed %}
                                    {% set qty = quantity_list[loop.index0]|trim if loop.index0 < quantity_list|length else '0' %}
                                    {% if ':' in qty %}
                                        {% set parts = qty.split(':', 1) %}
                                        {% set qty = parts[1].strip() if parts|length > 1 else qty %}
                                    {% endif %}
                                    {% set qty_num = qty|int(0) %}
                                    {% if qty_num > 0 %}
                                        {% set amt_val = amount_list[loop.index0] if amount_list|length > loop.index0 else '0.000' %}
                                        {% set readonly_ns.total = readonly_ns.total + (amt_val | float) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            {% set qty_single = (quantity_source or '').split(';')[0] if quantity_source else '' %}
                            {% if ':' in qty_single %}
                                {% set parts = qty_single.split(':', 1) %}
                                {% set qty_single = parts[1].strip() if parts|length > 1 else qty_single %}
                            {% endif %}
                            {% set qty_single_num = qty_single|int(0) %}
                            {% if qty_single_num > 0 %}
                                {% set amt_single = amount_list[0] if amount_list|length > 0 else '0.000' %}
                                {% set readonly_ns.total = readonly_ns.total + (amt_single | float) %}
                            {% endif %}
                        {% endif %}
                        <div class="procurement-cart-total-row">
                            <div class="procurement-cart-total-label">TOTAL AMOUNT</div>
                            <div class="procurement-cart-total-value" id="assignedProcurementTotal">OMR {{ '%.3f'|format(readonly_ns.total) }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {# Items Assigned section moved to Billing and Completion section #}

                {# Button to assign request to self (only if not already assigned and user is procurement staff) #}
                {% if not item_request.assigned_to_user_id and user.department == 'Procurement' and user.role not in ['GM', 'Operation Manager'] %}
                <div class="card assigned-section" style="margin-bottom: 1.5rem;">
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('assign_item_request_to_self', request_id=item_request.id) }}" style="display: inline-block;">
                            <button type="submit" class="btn btn-primary" onclick="return confirm('Are you sure you want to assign this request to yourself?');">
                                <i class="fas fa-user-plus"></i> Assign to Myself
                            </button>
                        </form>
                        <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #6b7280;">
                            Click this button to assign this request to yourself for processing.
                        </p>
                    </div>
                </div>
                {% endif %}

                <!-- Completion form (visible to Procurement department members) -->
                {% if can_complete %}
                    <div class="card your-approval-required">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Billing and Completion</h4>
                            <p>Complete this item request once the item has been procured and delivered.</p>
                        </div>
                        <div class="card-body">
                            <div class="billing-completion-grid" style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; margin: 0;">
                                {# Left Column: Receipt, Invoice, and Completion Notes #}
                                <div style="padding-right: 15px;">
                                    <form method="POST" action="{{ url_for('item_request_complete', request_id=item_request.id) }}" enctype="multipart/form-data" id="item-request-complete-form">
                                        <div class="form-group">
                                            <div style="margin-bottom: 12px;">
                                                <label style="display: inline-flex; align-items: center; gap: 10px;">
                                                    <input type="checkbox" id="from_store_no_receipt_checkbox" name="from_store_no_receipt" value="1" {% if item_request.from_store_no_receipt %}checked{% endif %} />
                                                    <span>This item is from the store. There is no receipt and invoice</span>
                                                </label>
                                            </div>
                                            <div id="item-receipt-upload-container" 
                                                 data-multiple-file-upload
                                                 data-input-name="receipt_files"
                                                 data-accepted-types=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                                 data-max-size="10485760"
                                                 data-max-files="10"
                                                 data-required="true"
                                                 data-label="Upload Receipt"
                                                 data-help-text="PDF, JPG, PNG, DOC, DOCX, XLS, XLSX - Max 50MB each">
                                            </div>
                                            <script>
                                                (function() {
                                                    function positionTooltip(tooltipWrapper) {
                                                        var icon = tooltipWrapper.querySelector('.tooltip-icon');
                                                        var tooltip = tooltipWrapper.querySelector('.tooltip-text');
                                                        if (icon && tooltip) {
                                                            var iconRect = icon.getBoundingClientRect();
                                                            tooltip.style.left = (iconRect.left + iconRect.width / 2) + 'px';
                                                            tooltip.style.top = (iconRect.top - tooltip.offsetHeight - 8) + 'px';
                                                        }
                                                    }
                                                    
                                                    function addInfoIcon() {
                                                        var container = document.getElementById('item-receipt-upload-container');
                                                        if (container) {
                                                            var label = container.querySelector('label');
                                                            if (label && !label.querySelector('.receipt-info-icon')) {
                                                                var tooltipWrapper = document.createElement('span');
                                                                tooltipWrapper.className = 'tooltip-wrapper receipt-info-icon';
                                                                tooltipWrapper.style.marginLeft = '8px';
                                                                tooltipWrapper.innerHTML = '<i class="fas fa-info-circle tooltip-icon" style="color: #17a2b8;"></i><span class="tooltip-text">This is for the proof of transfer made by the Procurement Manager to the assigned procurement staff member.</span>';
                                                                label.appendChild(tooltipWrapper);
                                                                
                                                                // Position tooltip on hover
                                                                tooltipWrapper.addEventListener('mouseenter', function() {
                                                                    positionTooltip(tooltipWrapper);
                                                                });
                                                                
                                                                // Reposition on scroll/resize
                                                                window.addEventListener('scroll', function() {
                                                                    if (tooltipWrapper.querySelector('.tooltip-text').style.visibility === 'visible') {
                                                                        positionTooltip(tooltipWrapper);
                                                                    }
                                                                });
                                                                
                                                                return true;
                                                            }
                                                        }
                                                        return false;
                                                    }
                                                    
                                                    // Try immediately
                                                    if (!addInfoIcon()) {
                                                        // If not found, try multiple times
                                                        var attempts = 0;
                                                        var interval = setInterval(function() {
                                                            attempts++;
                                                            if (addInfoIcon() || attempts > 20) {
                                                                clearInterval(interval);
                                                            }
                                                        }, 100);
                                                    }
                                                })();
                                            </script>
                                        </div>

                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="completion_receipt_amount">Receipt Amount (OMR) <span style="color: red;">*</span></label>
                                                <input type="number"
                                                       name="receipt_amount"
                                                       id="completion_receipt_amount"
                                                       class="form-control"
                                                       step="0.001"
                                                       min="0"
                                                       placeholder="Enter amount transferred to procurement staff in OMR"
                                                       value="{% if item_request.receipt_amount is not none %}{{ '%.3f'|format(item_request.receipt_amount) }}{% endif %}"
                                                       required>
                                            </div>

                                            <div class="form-group" style="margin-bottom: 0;">
                                                <label for="completion_receipt_reference_number">Receipt Reference Number <span style="color: red;">*</span></label>
                                                <input type="text"
                                                       name="receipt_reference_number"
                                                       id="completion_receipt_reference_number"
                                                       class="form-control"
                                                       placeholder="Enter the bank transfer or receipt reference number (letters and numbers only)"
                                                       pattern="[A-Za-z0-9]+"
                                                       oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g, '')"
                                                       value="{{ item_request.receipt_reference_number or '' }}"
                                                       required>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group" style="margin-top: 2.5rem;">
                                            <div id="item-invoice-upload-container" 
                                                 data-multiple-file-upload
                                                 data-input-name="invoice_files"
                                                 data-accepted-types=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                                 data-max-size="10485760"
                                                 data-max-files="10"
                                                 data-required="true"
                                                 data-label="Upload Invoice"
                                                 data-help-text="PDF, JPG, PNG, DOC, DOCX, XLS, XLSX - Max 50MB each">
                                            </div>
                                            <script>
                                                (function() {
                                                    function positionTooltip(tooltipWrapper) {
                                                        var icon = tooltipWrapper.querySelector('.tooltip-icon');
                                                        var tooltip = tooltipWrapper.querySelector('.tooltip-text');
                                                        if (icon && tooltip) {
                                                            var iconRect = icon.getBoundingClientRect();
                                                            tooltip.style.left = (iconRect.left + iconRect.width / 2) + 'px';
                                                            tooltip.style.top = (iconRect.top - tooltip.offsetHeight - 8) + 'px';
                                                        }
                                                    }
                                                    
                                                    function addInfoIcon() {
                                                        var container = document.getElementById('item-invoice-upload-container');
                                                        if (container) {
                                                            var label = container.querySelector('label');
                                                            if (label && !label.querySelector('.invoice-info-icon')) {
                                                                var tooltipWrapper = document.createElement('span');
                                                                tooltipWrapper.className = 'tooltip-wrapper invoice-info-icon';
                                                                tooltipWrapper.style.marginLeft = '8px';
                                                                tooltipWrapper.innerHTML = '<i class="fas fa-info-circle tooltip-icon" style="color: #17a2b8;"></i><span class="tooltip-text">This is for the proof of payment made for the requested item.</span>';
                                                                label.appendChild(tooltipWrapper);
                                                                
                                                                // Position tooltip on hover
                                                                tooltipWrapper.addEventListener('mouseenter', function() {
                                                                    positionTooltip(tooltipWrapper);
                                                                });
                                                                
                                                                // Reposition on scroll/resize
                                                                window.addEventListener('scroll', function() {
                                                                    if (tooltipWrapper.querySelector('.tooltip-text').style.visibility === 'visible') {
                                                                        positionTooltip(tooltipWrapper);
                                                                    }
                                                                });
                                                                
                                                                return true;
                                                            }
                                                        }
                                                        return false;
                                                    }
                                                    
                                                    // Try immediately
                                                    if (!addInfoIcon()) {
                                                        // If not found, try multiple times
                                                        var attempts = 0;
                                                        var interval = setInterval(function() {
                                                            attempts++;
                                                            if (addInfoIcon() || attempts > 20) {
                                                                clearInterval(interval);
                                                            }
                                                        }, 100);
                                                    }
                                                })();
                                            </script>
                                        </div>
                                        <div class="form-group" id="invoice-item-mapping" style="margin-top: 10px; display: none;">
                                            <label>Which item(s) does each invoice cover? <span style="color: red;">*</span></label>
                                            <div id="invoice-item-mapping-list" style="display: grid; gap: 10px;"></div>
                                            <small class="form-text text-muted">Select at least one item for every invoice file you upload.</small>
                                        </div>
                                        <input type="hidden" name="invoice_item_map" id="invoice_item_map_input">
                                        
                                        <div class="form-group">
                                            <label for="completion_notes">Completion Notes (Optional)</label>
                                            <textarea name="completion_notes" id="completion_notes" rows="3" placeholder="Add any notes about the completion..."></textarea>
                                        </div>
                                    </form>
                                    </div>
                                    
                                    {# Right Column: Items Assigned for Procurement #}
                                    <div>
                                        {% if item_request.item_name %}
                                            <div class="form-group">
                                                <p style="color: #dc3545; font-size: 1rem; font-weight: 500; margin-bottom: 0.85rem;">
                                                    <strong>Note:</strong> If the item is not bought, set quantity to <strong>0</strong>.
                                                </p>
                                                {% set all_amounts = (item_request.procurement_amounts or '').split(';') %}
                                        {% if ',' in item_request.item_name %}
                                            {# Multi-item request #}
                                            {% set item_list = item_request.item_name.split(',') %}
                                            {# PRIORITY: Show saved assigned procurement quantities if they exist, otherwise default to procurement manager quantities, then manager quantities, then original #}
                                            {% set display_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                                            {# If assigned procurement staff has saved quantities, use those; otherwise default to procurement manager-approved quantities #}
                                            {% set raw_quantity_source = item_request.assigned_procurement_quantities or display_source %}
                                            {# Parse quantity_list from JSON or semicolon-separated format #}
                                            {% set quantity_list = [] %}
                                            {% if raw_quantity_source %}
                                                {% if raw_quantity_source.startswith('[') %}
                                                    {% set quantity_list = (raw_quantity_source | from_json) %}
                                                {% else %}
                                                    {% set quantity_list = raw_quantity_source.split(';') %}
                                                {% endif %}
                                            {% endif %}
                                            {# Baseline (for showing quantity comparison) is always the most recent approval from procurement manager #}
                                            {% set original_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                                            {% set original_list = [] %}
                                            {% if original_source %}
                                                {% if original_source.startswith('[') %}
                                                    {% set original_list = (original_source | from_json) %}
                                                {% else %}
                                                    {% set original_list = original_source.split(';') %}
                                                {% endif %}
                                            {% endif %}
                                            
                                            {% if can_complete %}
                                            <form method="POST" action="{{ url_for('update_item_request_quantities', request_id=item_request.id) }}" style="margin-bottom: 1rem;" novalidate>
                                            {% endif %}
                                                <div class="procurement-cart-table">
                                                    <div class="procurement-cart-header-row">
                                                        <div>Item</div>
                                                        <div style="text-align: left;">Quantity</div>
                                                        <div style="text-align: right;">Amount</div>
                                                    </div>
                                                    
                                                    {% for item in item_list %}
                                                        {% set item_trimmed = item.strip() %}
                                                        {% if item_trimmed %}
                                                            {% set qty = '' %}
                                                            {% if loop.index0 < quantity_list|length %}
                                                                {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                                {% if qty_raw %}
                                                                    {% if ':' in qty_raw %}
                                                                        {% set parts = qty_raw.split(':', 1) %}
                                                                        {% if parts|length > 1 %}
                                                                            {% set qty = parts[1].strip() %}
                                                                        {% else %}
                                                                            {% set qty = qty_raw %}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {% set qty = qty_raw %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                            {% set orig_qty_raw = '' %}
                                                            {% if loop.index0 < original_list|length %}
                                                                {% set oq = original_list[loop.index0] | trim %}
                                                                {% if oq %}
                                                                    {% if ':' in oq %}
                                                                        {% set o_parts = oq.split(':', 1) %}
                                                                        {% if o_parts|length > 1 %}
                                                                            {% set orig_qty_raw = o_parts[1].strip() %}
                                                                        {% else %}
                                                                            {% set orig_qty_raw = oq %}
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {% set orig_qty_raw = oq %}
                                                                    {% endif %}
                                                                {% endif %}
                                                            {% endif %}
                                                            {% set orig_qty_num = orig_qty_raw|int(0) %}
                                                            {% set proc_qty_num = qty|int(0) %}
                                                            {% set is_less = proc_qty_num < orig_qty_num %}
                                                            {% set was_manager_zero = orig_qty_num == 0 %}
                                                            
                                                            {% if orig_qty_num > 0 %}
                                                            <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %}" 
                                                                 id="cart_row_{{ loop.index0 }}"
                                                                 data-orig-qty="{{ orig_qty_num }}"
                                                                 data-orig-display="{{ orig_qty_raw or '0' }}">
                                                                <div class="procurement-cart-item-name">
                                                                    {{ item_trimmed }}
                                                                    {% if was_manager_zero %}
                                                                    <span class="tooltip-wrapper">
                                                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                                                        <span class="tooltip-text">This item was rejected by the manager (quantity set to 0). Click edit to re-enable if you are procuring it.</span>
                                                                    </span>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="procurement-cart-qty">
                                                                    {% if can_complete %}
                                                                        {% if was_manager_zero %}
                                                                        <div class="quantity-readonly-display" id="cart_qty_readonly_{{ loop.index0 }}">
                                                                            <span class="readonly-qty-pill">{{ qty or 0 }} / {{ orig_qty_raw or '0' }}</span>
                                                                            <button type="button"
                                                                                    class="edit-qty-btn"
                                                                                    data-index="{{ loop.index0 }}"
                                                                                    onclick="enableCartQuantityEdit(this.dataset.index)"
                                                                                    title="Edit quantity">
                                                                                <i class="fas fa-edit"></i>
                                                                            </button>
                                                                        </div>
                                                                        <div id="cart_qty_editable_wrapper_{{ loop.index0 }}" style="display: none; align-items: center; gap: 8px; justify-content: flex-end;">
                                                                            <div class="quantity-control" id="cart_qty_editable_{{ loop.index0 }}">
                                                                                <button type="button" class="qty-btn minus" data-index="{{ loop.index0 }}" onclick="adjustCartQuantity(this.dataset.index, -1)">-</button>
                                                                                <input type="number" name="quantities[]" id="cart_qty_{{ loop.index0 }}" min="0" step="1" value="{{ qty or 0 }}" data-index="{{ loop.index0 }}" data-original-value="{{ qty or 0 }}" oninput="updateCartQuantityState(this.dataset.index)">
                                                                                <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                                <button type="button" class="qty-btn plus" data-index="{{ loop.index0 }}" onclick="adjustCartQuantity(this.dataset.index, 1)">+</button>
                                                                            </div>
                                                                            <button type="button"
                                                                                    class="edit-qty-btn"
                                                                                    data-index="{{ loop.index0 }}"
                                                                                    onclick="cancelCartQuantityEdit(this.dataset.index)"
                                                                                    title="Cancel editing">
                                                                                <i class="fas fa-times"></i>
                                                                            </button>
                                                                        </div>
                                                                        {% else %}
                                                                        <div class="quantity-control">
                                                                            <button type="button" class="qty-btn minus" data-index="{{ loop.index0 }}" onclick="adjustCartQuantity(this.dataset.index, -1)">-</button>
                                                                            <input type="number" name="quantities[]" id="cart_qty_{{ loop.index0 }}" min="0" step="1" value="{{ qty or 0 }}" data-index="{{ loop.index0 }}" oninput="updateCartQuantityState(this.dataset.index)">
                                                                            <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                            <button type="button" class="qty-btn plus" data-index="{{ loop.index0 }}" onclick="adjustCartQuantity(this.dataset.index, 1)">+</button>
                                                                        </div>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="readonly-qty-pill">{{ qty or '0' }}</span>
                                                                    {% endif %}
                                                                </div>
                                                                <div class="procurement-cart-amount">
                                                                    {% set amt_val = (all_amounts[loop.index0]|trim if all_amounts|length > loop.index0 else '')|default('0.000', true) %}
                                                                    {% set amt_val = amt_val if amt_val else '0.000' %}
                                                                    {% if can_complete %}
                                                                        {% if was_manager_zero %}
                                                                        <div id="cart_amount_readonly_{{ loop.index0 }}" class="quantity-readonly-display" style="justify-content: flex-end;">
                                                                            <span class="readonly-qty-pill">{{ amt_val }}</span>
                                                                        </div>
                                                                        <input type="number" name="amounts[]" id="cart_amount_{{ loop.index0 }}" min="0" step="0.001" value="{{ amt_val }}" data-index="{{ loop.index0 }}" style="display: none;">
                                                                        {% else %}
                                                                        <input type="number" name="amounts[]" id="cart_amount_{{ loop.index0 }}" min="0" step="0.001" value="{{ amt_val }}" data-index="{{ loop.index0 }}">
                                                                        {% endif %}
                                                                    {% else %}
                                                                        <span class="readonly-qty-pill">{{ amt_val }}</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div id="cart_note_{{ loop.index0 }}"
                                                                 class="procurement-cart-note {% if proc_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                                 style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px; {% if proc_qty_num == orig_qty_num %}display: none;{% endif %}">
                                                                {% if proc_qty_num != orig_qty_num %}
                                                                    Requestor requested for <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                                    You have currently set to <strong>{{ (proc_qty_num - orig_qty_num)|abs }}</strong>
                                                                    {% if proc_qty_num > orig_qty_num %}more{% else %}less{% endif %} than requested.
                                                                {% endif %}
                                                            </div>
                                                        {% endif %}
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                                
                                            {% if item_request.procurement_quantity_rejection_reason %}
                                            <div id="assigned_saved_rejection_reason_group" style="display: block; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                                <div class="form-group">
                                                    <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item(s)</label>
                                                    <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                        <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_quantity_rejection_reason }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            <div id="assigned_rejection_reason_group" style="display: none; margin-top: 1rem;">
                                                <div class="form-group">
                                                <label for="assigned_quantity_rejection_reason">Reason for Rejecting Item(s) <span style="color: red;">*</span></label>
                                                    <textarea name="quantity_rejection_reason" id="assigned_quantity_rejection_reason" rows="3" placeholder="Please provide a reason for rejecting the item(s) with quantity set to 0..." style="width: 100%;">{{ item_request.procurement_quantity_rejection_reason or '' }}</textarea>
                                                    <small class="form-text text-muted">This field is required when at least one item quantity is set to 0.</small>
                                                </div>
                                            </div>

                                                {% set assigned_ns = namespace(total=0.0) %}
                                                {% for item in item_list %}
                                                    {% set item_trimmed = item.strip() %}
                                                    {% if item_trimmed %}
                                                        {% set qty = '' %}
                                                        {% if loop.index0 < quantity_list|length %}
                                                            {% set qty_raw = quantity_list[loop.index0] | trim %}
                                                            {% if qty_raw %}
                                                                {% if ':' in qty_raw %}
                                                                    {% set parts = qty_raw.split(':', 1) %}
                                                                    {% if parts|length > 1 %}
                                                                        {% set qty = parts[1].strip() %}
                                                                    {% else %}
                                                                        {% set qty = qty_raw %}
                                                                    {% endif %}
                                                                {% else %}
                                                                    {% set qty = qty_raw %}
                                                                {% endif %}
                                                            {% endif %}
                                                        {% endif %}
                                                        {% set orig_qty_num = original_list[loop.index0]|default('0')|int(0) %}
                                                        {% if orig_qty_num > 0 %}
                                                            {% set amt_val = (all_amounts[loop.index0]|trim if all_amounts|length > loop.index0 else '')|default('0.000', true) %}
                                                            {% set amt_val = amt_val if amt_val else '0.000' %}
                                                            {% set assigned_ns.total = assigned_ns.total + (amt_val | float) %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                                <div class="procurement-cart-total-row">
                                                    <div class="procurement-cart-total-label">TOTAL AMOUNT</div>
                                                    <div class="procurement-cart-total-value" id="assignedProcurementTotal">OMR {{ '%.3f'|format(assigned_ns.total) }}</div>
                                                </div>
                                                
                                            {% if can_complete %}
                                            </form>
                                            {% endif %}
                                        {% else %}
                                            {# Single-item request #}
                                            {# PRIORITY: Show saved assigned procurement quantities if they exist, otherwise default to procurement manager quantities, then manager quantities, then original #}
                                            {% set display_source_single = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                                            {# If assigned procurement staff has saved quantities, use those; otherwise default to procurement manager-approved quantity #}
                                            {% set raw_quantity_source = item_request.assigned_procurement_quantities or display_source_single %}
                                            {% set current_raw = (raw_quantity_source or '').split(';')[0] %}
                                            {% set qty = (current_raw or '').strip() %}
                                            {# Baseline (for showing quantity comparison) is always the most recent approval from procurement manager #}
                                            {% set baseline_source = item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                                            {% set orig_qty_raw = '' %}
                                            {% if baseline_source %}
                                                {% if baseline_source.startswith('[') %}
                                                    {% set qty_array = (baseline_source | from_json) %}
                                                    {% set orig_qty_raw = (qty_array[0] if qty_array|length > 0 else '0')|string %}
                                                {% else %}
                                                    {% set orig_qty_raw = baseline_source.split(';')[0] if ';' in baseline_source else baseline_source %}
                                                {% endif %}
                                            {% endif %}
                                            {% set orig_qty_num = orig_qty_raw|int(0) %}
                                            {% set proc_qty_num = qty|int(0) %}
                                            {% set is_less = proc_qty_num < orig_qty_num %}
                                            {% set was_manager_zero = orig_qty_num == 0 %}
                                            
                                            {% if orig_qty_num > 0 %}
                                            {% if can_complete %}
                                            <form method="POST" action="{{ url_for('update_item_request_quantities', request_id=item_request.id) }}" style="margin-bottom: 1rem;" novalidate>
                                            {% endif %}
                                                <div class="procurement-cart-table">
                                                    <div class="procurement-cart-header-row">
                                                        <div>Item</div>
                                                        <div style="text-align: left;">Quantity</div>
                                                        <div style="text-align: right;">Amount</div>
                                                    </div>
                                                    <div class="procurement-cart-row {% if is_less %}qty-less-than-original{% endif %} {% if was_manager_zero %}previously-rejected-by-manager{% endif %}" 
                                                         id="cart_row_0"
                                                         data-orig-qty="{{ orig_qty_num }}"
                                                         data-orig-display="{{ orig_qty_raw or '0' }}">
                                                        <div class="procurement-cart-item-name">
                                                            {{ item_request.item_name }}
                                                            {% if was_manager_zero %}
                                                            <span class="tooltip-wrapper">
                                                                <i class="fas fa-info-circle tooltip-icon"></i>
                                                                <span class="tooltip-text">This item was rejected by the manager (quantity set to 0). Click edit to re-enable if you are procuring it.</span>
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="procurement-cart-qty">
                                                            {% if can_complete %}
                                                                {% if was_manager_zero %}
                                                                <div class="quantity-readonly-display" id="cart_qty_readonly_0">
                                                                    <span class="readonly-qty-pill">{{ qty or 0 }} / {{ orig_qty_raw or '0' }}</span>
                                                                    <button type="button"
                                                                            class="edit-qty-btn"
                                                                            data-index="0"
                                                                            onclick="enableCartQuantityEdit(this.dataset.index)"
                                                                            title="Edit quantity">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                </div>
                                                                <div id="cart_qty_editable_wrapper_0" style="display: none; align-items: center; gap: 8px; justify-content: flex-end;">
                                                                    <div class="quantity-control" id="cart_qty_editable_0">
                                                                        <button type="button" class="qty-btn minus" data-index="0" onclick="adjustCartQuantity(this.dataset.index, -1)">-</button>
                                                                        <input type="number" name="quantities[]" id="cart_qty_0" min="0" step="1" value="{{ qty or 0 }}" data-index="0" data-original-value="{{ qty or 0 }}" oninput="updateCartQuantityState(this.dataset.index)">
                                                                        <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                        <button type="button" class="qty-btn plus" data-index="0" onclick="adjustCartQuantity(this.dataset.index, 1)">+</button>
                                                                    </div>
                                                                    <button type="button"
                                                                            class="edit-qty-btn"
                                                                            data-index="0"
                                                                            onclick="cancelCartQuantityEdit(this.dataset.index)"
                                                                            title="Cancel editing">
                                                                        <i class="fas fa-times"></i>
                                                                    </button>
                                                                </div>
                                                                {% else %}
                                                                <div class="quantity-control">
                                                                    <button type="button" class="qty-btn minus" onclick="adjustCartQuantity(0, -1)">-</button>
                                                                    <input type="number" name="quantities[]" id="cart_qty_0" min="0" step="1" value="{{ qty or 0 }}" data-index="0" oninput="updateCartQuantityState(0)">
                                                                    <span class="original-qty-inline">/ {{ orig_qty_raw or '0' }}</span>
                                                                    <button type="button" class="qty-btn plus" onclick="adjustCartQuantity(0, 1)">+</button>
                                                                </div>
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="readonly-qty-pill">{{ qty or '0' }}</span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="procurement-cart-amount">
                                                            {% set amt_raw = all_amounts[0]|trim if all_amounts|length > 0 else '' %}
                                                            {% set amt_val = amt_raw if amt_raw else (('%.3f'|format(item_request.amount)) if item_request.amount else '0.000') %}
                                                            {% if can_complete %}
                                                                {% if was_manager_zero %}
                                                                <div id="cart_amount_readonly_0" class="quantity-readonly-display" style="justify-content: flex-end;">
                                                                    <span class="readonly-qty-pill">{{ amt_val }}</span>
                                                                </div>
                                                                <input type="number" name="amounts[]" id="cart_amount_0" min="0" step="0.001" value="{{ amt_val }}" data-index="0" style="display: none;">
                                                                {% else %}
                                                                <input type="number" name="amounts[]" id="cart_amount_0" min="0" step="0.001" value="{{ amt_val }}" data-index="0">
                                                                {% endif %}
                                                            {% else %}
                                                                <span class="readonly-qty-pill">{{ amt_val }}</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div id="cart_note_0"
                                                         class="procurement-cart-note {% if proc_qty_num == orig_qty_num %}initially-hidden{% endif %}"
                                                         style="grid-column: 1 / -1; font-size: 0.85rem; color: #6b7280; margin: 2px 4px 10px 4px; {% if proc_qty_num == orig_qty_num %}display: none;{% endif %}">
                                                        {% if proc_qty_num != orig_qty_num %}
                                                            Requestor requested for <strong>{{ orig_qty_raw or '0' }}</strong> of this item.
                                                            You have currently set to <strong>{{ (proc_qty_num - orig_qty_num)|abs }}</strong>
                                                            {% if proc_qty_num > orig_qty_num %}more{% else %}less{% endif %} than requested.
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% if item_request.procurement_quantity_rejection_reason %}
                                                <div id="assigned_saved_rejection_reason_group_single" style="display: block; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                                                    <div class="form-group">
                                                        <label style="color: #dc3545; font-weight: bold;"><i class="fas fa-exclamation-circle"></i> Previously Saved Reason for Rejecting Item</label>
                                                        <div style="background: #fff5f5; border: 1px solid #fecaca; border-radius: 6px; padding: 12px; margin-top: 8px;">
                                                            <p style="color: #991b1b; margin: 0; white-space: pre-wrap;">{{ item_request.procurement_quantity_rejection_reason }}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endif %}
                                                <div id="assigned_rejection_reason_group_single" style="display: none; margin-top: 1rem;">
                                                    <div class="form-group">
                                                        <label for="assigned_quantity_rejection_reason_single">Reason for Rejecting Item <span style="color: red;">*</span></label>
                                                        <textarea name="quantity_rejection_reason" id="assigned_quantity_rejection_reason_single" rows="3" placeholder="Please provide a reason for rejecting this item..." style="width: 100%;">{{ item_request.procurement_quantity_rejection_reason or '' }}</textarea>
                                                        <small class="form-text text-muted">This field is required when the quantity is set to 0.</small>
                                                    </div>
                                                </div>

                                                {% set assigned_ns = namespace(total=0.0) %}
                                                {% if orig_qty_num > 0 %}
                                                    {% set amt_val = (all_amounts[0]|trim if all_amounts|length > 0 else '')|default('0.000', true) %}
                                                    {% set amt_val = amt_val if amt_val else '0.000' %}
                                                    {% set assigned_ns.total = assigned_ns.total + (amt_val | float) %}
                                                {% endif %}
                                                <div class="procurement-cart-total-row">
                                                    <div class="procurement-cart-total-label">TOTAL AMOUNT</div>
                                                    <div class="procurement-cart-total-value" id="assignedProcurementTotal">OMR {{ '%.3f'|format(assigned_ns.total) }}</div>
                                                </div>
                                                
                                            {% if can_complete %}
                                            </form>
                                            {% endif %}
                                            {% endif %}
                                        {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                        </div>
                    </div>
                    <div class="card-footer" style="display: flex; gap: 10px; align-items: center;">
                        <button type="button" class="btn btn-success" id="save-uploads-btn" form="item-request-complete-form" style="padding: 0.6rem 1.2rem !important; font-size: 1rem !important;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        <button type="submit" class="btn btn-success" id="submit-final-approval-btn" form="item-request-complete-form" style="padding: 0.6rem 1.2rem !important; font-size: 1rem !important;">
                            <i class="fas fa-check"></i> Submit for Final Approval
                        </button>
                    </div>
                {% endif %}
            {% elif item_request.status == 'Completed' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Request has been completed</span>
                </div>
                
                <div class="card assigned-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Assignment Details</h4>
                    </div>
                    <div class="card-body">
                        {% if assigned_to_name %}
                        <div class="form-group">
                            <label>Assigned To</label>
                            <input type="text" value="{{ assigned_to_name }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if item_request.assignment_date %}
                        <div class="form-group">
                            <label>Assignment Date</label>
                            <input type="text" value="{{ item_request.assignment_date.strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if receipt_files %}
                        <div class="form-group">
                            <label><i class="fas fa-check-circle"></i> Receipt (Proof of transfer made by the Procurement Manager)</label>
                            {% for file in receipt_files %}
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Receipt {{ loop.index }}
                                </a>
                                <small style="color: #666; margin-left: 10px;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                            </div>
                            {% endfor %}
                            {% if invoice_total_ns is not defined %}
                                {% set invoice_total_ns = namespace(total=0.0) %}
                            {% endif %}
                            {% set invoice_total_value = (invoice_total_ns.total if invoice_total_ns.total > 0 else item_request.invoice_amount) %}
                            {% if invoice_total_value is not none %}
                            <div class="form-group" style="margin-top: 10px;">
                                <label>Invoice Amount (OMR)</label>
                                <input type="text"
                                       value="{{ '%.3f'|format(invoice_total_value) }}"
                                       readonly
                                       style="background: #f5f5f5;">
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if item_request.receipt_amount is not none or item_request.receipt_reference_number %}
                        <div class="form-group" style="margin-top: 8px;">
                            <label>Receipt Amount (OMR)</label>
                            <input type="text"
                                   value="{% if item_request.receipt_amount is not none %}{{ '%.3f'|format(item_request.receipt_amount) }}{% else %}-{% endif %}"
                                   readonly
                                   style="background: #f5f5f5;">
                        </div>
                        <div class="form-group">
                            <label>Receipt Reference Number</label>
                            <input type="text"
                                   value="{{ item_request.receipt_reference_number or '-' }}"
                                   readonly
                                   style="background: #f5f5f5;">
                        </div>
                        {% endif %}

                        {% if invoice_files %}
                        <div class="form-group">
                            <label><i class="fas fa-check-circle"></i> Invoice (Proof of payment made for the requested item)</label>
                            {% set invoice_amount_lookup = {} %}
                            {% set invoice_items_lookup = {} %}
                            {% set invoice_total_ns = namespace(total=0.0) %}
                            {% for inv in invoice_entries or [] %}
                                {% if inv.filename %}
                                    {% set inv_amt = inv['amount'] if inv['amount'] is defined else None %}
                                    {% set inv_items = inv['items'] if inv['items'] is defined else [] %}
                                    {% if inv_items is none %}{% set inv_items = [] %}{% endif %}
                                    {% set _ = invoice_amount_lookup.update({inv.filename: inv_amt}) %}
                                    {% set _ = invoice_items_lookup.update({inv.filename: inv_items}) %}
                                    {% if inv_amt %}
                                        {% set invoice_total_ns.total = invoice_total_ns.total + (inv_amt | float) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                            {% for file in invoice_files %}
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="{{ url_for('uploaded_file', filename=file) }}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Invoice {{ loop.index }}
                                </a>
                                <small style="color: #666; margin-left: 10px;">{{ file.split('_', 1)[1] if '_' in file else file }}</small>
                                {% if invoice_amount_lookup.get(file) %}
                                <div style="margin-top: 6px; font-weight: 600; color: #1f2937;">Amount: OMR {{ '%.3f'|format(invoice_amount_lookup.get(file)|float) }}</div>
                                {% endif %}
                                {% if invoice_items_lookup.get(file) %}
                                <div style="margin-top: 4px; color: #374151;">
                                    <strong>Items:</strong>
                                    <ul style="margin: 4px 0 0 18px; padding: 0;">
                                        {% for itm in invoice_items_lookup.get(file) %}
                                        <li>{{ itm }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {# Read-only view of procurement quantities/amounts after completion #}
                        {% if item_request.item_name %}
                        {% set amount_list = (item_request.procurement_amounts or '').split(';') %}
                        {# Prefer saved assigned procurement quantities if they exist, otherwise default to procurement manager quantities, then manager quantities, then original #}
                        {% set quantity_source = item_request.assigned_procurement_quantities or item_request.procurement_manager_quantities or item_request.procurement_quantities %}
                        <div class="card assigned-section procurement-cart-card" style="margin-top: 1.5rem;">
                            <div class="card-header">
                                <h4><i class="fas fa-shopping-cart"></i> Billing and Completion (Read-Only)</h4>
                                <p style="margin: 0;">These are the final quantities and amounts saved by the assigned procurement staff.</p>
                            </div>
                            <div class="card-body">
                                {% if ',' in item_request.item_name %}
                                    {% set item_list = item_request.item_name.split(',') %}
                                    {# Parse quantity_list from JSON or semicolon-separated format #}
                                    {% set quantity_list = [] %}
                                    {% if quantity_source %}
                                        {% if quantity_source.startswith('[') %}
                                            {% set quantity_list = (quantity_source | from_json) %}
                                        {% else %}
                                            {% set quantity_list = quantity_source.split(';') %}
                                        {% endif %}
                                    {% endif %}
                                    <div class="procurement-cart-table">
                                        <div class="procurement-cart-header-row">
                                            <div>Item</div>
                                            <div style="text-align: left;">Quantity</div>
                                            <div style="text-align: right;">Amount</div>
                                        </div>
                                        {% for item in item_list %}
                                            {% set item_trimmed = item.strip() %}
                                            {% if item_trimmed %}
                                                {% set qty = quantity_list[loop.index0]|trim if loop.index0 < quantity_list|length else '0' %}
                                                {% if ':' in qty %}
                                                    {% set parts = qty.split(':', 1) %}
                                                    {% set qty = parts[1].strip() if parts|length > 1 else qty %}
                                                {% endif %}
                                                {% set qty_num = qty|int(0) %}
                                                {% set amt_val = amount_list[loop.index0] if amount_list|length > loop.index0 else '0.000' %}
                                                <div class="procurement-cart-row {% if qty_num == 0 %}qty-zero{% endif %}">
                                                    <div class="procurement-cart-item-name">{{ item_trimmed }}</div>
                                                    <div class="procurement-cart-qty">
                                                        <span class="readonly-qty-pill">{{ qty or '0' }}</span>
                                                    </div>
                                                    <div class="procurement-cart-amount">
                                                        <span class="readonly-qty-pill">{{ amt_val or '0.000' }}</span>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    {% set qty_single = (quantity_source or '').split(';')[0] if quantity_source else '' %}
                                    {% if ':' in qty_single %}
                                        {% set parts = qty_single.split(':', 1) %}
                                        {% set qty_single = parts[1].strip() if parts|length > 1 else qty_single %}
                                    {% endif %}
                                    {% set qty_single_num = qty_single|int(0) %}
                                    {% set amt_single = amount_list[0] if amount_list|length > 0 else '0.000' %}
                                    <div class="procurement-cart-table">
                                        <div class="procurement-cart-header-row">
                                            <div>Item</div>
                                            <div style="text-align: left;">Quantity</div>
                                            <div style="text-align: right;">Amount</div>
                                        </div>
                                        <div class="procurement-cart-row {% if qty_single_num == 0 %}qty-zero{% endif %}">
                                            <div class="procurement-cart-item-name">{{ item_request.item_name }}</div>
                                            <div class="procurement-cart-qty">
                                                <span class="readonly-qty-pill">{{ qty_single or '0' }}</span>
                                            </div>
                                            <div class="procurement-cart-amount">
                                                <span class="readonly-qty-pill">{{ amt_single or '0.000' }}</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                {% set readonly_ns = namespace(total=0.0) %}
                                {% for amt in amount_list %}
                                    {% set readonly_ns.total = readonly_ns.total + (amt | float) %}
                                {% endfor %}
                                <div class="procurement-cart-total-row">
                                    <div class="procurement-cart-total-label">TOTAL AMOUNT</div>
                                    <div class="procurement-cart-total-value">OMR {{ '%.3f'|format(readonly_ns.total) }}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                    </div>
                </div>
            {% else %}
                <div class="admin-mode-warning">
                    <i class="fas fa-info-circle"></i>
                    <span>This step will be available after Procurement Manager approval and assignment.</span>
                </div>
            {% endif %}
        </div>

        <!-- Step 5: Completed -->
        <div class="step-content" id="step-completed">
            <h3><i class="fas fa-check-circle"></i> Completed</h3>
            
            {% if item_request.status == 'Final Approval' %}
                <h3><i class="fas fa-user-tie"></i> Final Approval</h3>
                <div class="admin-mode-warning" style="background: #fff3cd; color: #856404;">
                    <i class="fas fa-clock"></i>
                    <span>Final approval is required from Procurement Manager.</span>
                </div>

                <div class="card manager-approval-required" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4><i class="fas fa-user-tie"></i> Final Approval Required</h4>
                    </div>
                    <div class="card-body">
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #856404; font-weight: bold; font-size: 1.1rem;">PENDING FINAL APPROVAL</span>
                            </div>
                            <div style="text-align: center; margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                                <strong>Pending by:</strong> {{ procurement_manager_approver_name or item_request.procurement_manager_approver or 'Procurement Manager' }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <p style="margin-bottom: 0.5rem; font-size: 1.1rem;">
                                    <strong>Status:</strong> Pending Final Approval
                                </p>
                                
                                <p style="margin-bottom: 0.5rem; color: #666;">
                                    <strong>Department:</strong> {{ item_request.department }}
                                </p>
                            </div>
                            <div class="col-md-4 text-right">
                                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 1rem; text-align: center;">
                                    <i class="fas fa-clock" style="font-size: 2rem; color: #f57c00; margin-bottom: 0.5rem;"></i>
                                    <p style="margin: 0; font-weight: 600; color: #856404;">Pending Review</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {% if can_approve_procurement_manager or can_reject_procurement_manager %}
                    <div class="card your-approval-required">
                        <div class="card-header">
                            <h4><i class="fas fa-check-circle"></i> Your Approval Required</h4>
                            <p>As the Procurement Manager, please review and approve this request.</p>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('item_request_procurement_manager_decision', request_id=item_request.id) }}">
                                <div class="form-group">
                                    <label for="item_procurement_approval_status">Set Status <span class="required-asterisk">*</span></label>
                                    <select name="approval_status" id="item_procurement_approval_status" required onchange="toggleItemProcurementManagerApprovalFields()" data-item-status="{{ item_request.status }}">
                                        <option value="">-- Select Status --</option>
                                        <option value="approve">Approve</option>
                                        <option value="reject">Reject</option>
                                        <option value="on_hold">On Hold</option>
                                    </select>
                                </div>
                                
                                <div id="item_procurement_approve_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_approval_reason">Approval Notes (Optional)</label>
                                        <textarea name="approval_reason" id="procurement_approval_reason" rows="3" placeholder="Add any notes about this approval..."></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_reject_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_rejection_reason">Reason for Rejection <span class="required-asterisk">*</span></label>
                                        <textarea name="rejection_reason" id="procurement_rejection_reason" rows="3" placeholder="Please provide a clear reason for rejecting this request..." required></textarea>
                                    </div>
                                </div>
                                
                                <div id="item_procurement_on_hold_fields" style="display: none;">
                                    <div class="form-group">
                                        <label for="procurement_on_hold_reason">On Hold Reason <span class="required-asterisk">*</span></label>
                                        <textarea name="on_hold_reason" id="procurement_on_hold_reason" rows="3" placeholder="Add any notes about why this request is on hold..." required></textarea>
                                    </div>
                                </div>
                                
                                <div class="step-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check"></i> Submit Decision
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}
            {% elif item_request.status == 'Completed' %}
                <div class="admin-mode-warning" style="background: #28a745; color: white;">
                    <i class="fas fa-check-circle"></i>
                    <span>Request has been completed successfully</span>
                </div>
                
                <div class="card completed-section" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h4>Completion Details</h4>
                    </div>
                    <div class="card-body">
                        <div class="status-display" style="margin-bottom: 1.5rem;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 0.5rem;">Status</div>
                            <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 12px 20px; text-align: center;">
                                <span style="color: #155724; font-weight: bold; font-size: 1.1rem;">COMPLETED</span>
                            </div>
                        </div>
                        
                        {% if completed_by_name %}
                        <div class="form-group">
                            <label>Completed By</label>
                            <input type="text" value="{{ completed_by_name }}" readonly style="background: #f5f5f5; font-weight: bold;">
                        </div>
                        {% endif %}
                        {% if item_request.completion_date %}
                        <div class="form-group">
                            <label>Completion Date</label>
                            <input type="text" value="{{ utc_to_local(item_request.completion_date).strftime('%Y-%m-%d %H:%M:%S') }}" readonly style="background: #f5f5f5;">
                        </div>
                        {% endif %}
                        {% if item_request.completion_notes %}
                        <div class="form-group">
                            <label>Completion Notes</label>
                            <textarea readonly style="background: #f8f9fa;">{{ item_request.completion_notes }}</textarea>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="admin-mode-warning">
                    <i class="fas fa-info-circle"></i>
                    <span>This request has not been completed yet.</span>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Toggle fields for Manager Approval based on status selection
function toggleItemManagerApprovalFields() {
    const status = document.getElementById('item_manager_approval_status').value;
    const approveFields = document.getElementById('item_manager_approve_fields');
    const rejectFields = document.getElementById('item_manager_reject_fields');
    const onHoldFields = document.getElementById('item_manager_on_hold_fields');
    const rejectionReasonField = document.getElementById('item_manager_rejection_reason');
    const onHoldReasonField = document.getElementById('item_manager_on_hold_reason');
    
    // Hide all fields first and remove required attributes
    approveFields.style.display = 'none';
    rejectFields.style.display = 'none';
    onHoldFields.style.display = 'none';
    if (rejectionReasonField) {
        rejectionReasonField.removeAttribute('required');
    }
    if (onHoldReasonField) {
        onHoldReasonField.removeAttribute('required');
    }
    
    // Show relevant fields based on selection and add required attributes
    if (status === 'approve') {
        approveFields.style.display = 'block';
    } else if (status === 'reject') {
        rejectFields.style.display = 'block';
        if (rejectionReasonField) {
            rejectionReasonField.setAttribute('required', 'required');
        }
    } else if (status === 'on_hold') {
        onHoldFields.style.display = 'block';
        if (onHoldReasonField) {
            onHoldReasonField.setAttribute('required', 'required');
        }
    }
}

// Toggle fields for Procurement Manager Approval based on status selection
function toggleItemProcurementManagerApprovalFields() {
    const status = document.getElementById('item_procurement_approval_status').value;
    const approveFields = document.getElementById('item_procurement_approve_fields');
    const rejectFields = document.getElementById('item_procurement_reject_fields');
    const onHoldFields = document.getElementById('item_procurement_on_hold_fields');
    const rejectionReasonField = document.getElementById('procurement_rejection_reason');
    const onHoldReasonField = document.getElementById('procurement_on_hold_reason');
    
    // Hide all fields first and remove required attributes
    approveFields.style.display = 'none';
    rejectFields.style.display = 'none';
    onHoldFields.style.display = 'none';
    if (rejectionReasonField) {
        rejectionReasonField.removeAttribute('required');
    }
    if (onHoldReasonField) {
        onHoldReasonField.removeAttribute('required');
    }
    
    // Show relevant fields based on selection and add required attributes
    if (status === 'approve') {
        approveFields.style.display = 'block';
    } else if (status === 'reject') {
        rejectFields.style.display = 'block';
        if (rejectionReasonField) {
            rejectionReasonField.setAttribute('required', 'required');
        }
    } else if (status === 'on_hold') {
        onHoldFields.style.display = 'block';
        if (onHoldReasonField) {
            onHoldReasonField.setAttribute('required', 'required');
        }
    }
}

// Step tabs functionality
document.addEventListener('DOMContentLoaded', function() {
    const stepTabs = document.querySelectorAll('.step-tab');
    const stepContents = document.querySelectorAll('.step-content');
    
    // Add click event listeners to tabs
    stepTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const step = this.getAttribute('data-step');
            
            // Don't allow clicking on disabled tabs
            if (this.classList.contains('disabled')) {
                return;
            }
            
            // Remove active class from all tabs and contents
            stepTabs.forEach(t => t.classList.remove('active'));
            stepContents.forEach(c => c.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            this.classList.add('active');
            document.getElementById(`step-${step}`).classList.add('active');
            
            // Update URL to preserve tab state on refresh
            const url = new URL(window.location);
            url.searchParams.set('tab', step);
            window.history.pushState({}, '', url);
            
            // Show/hide request details section based on active tab
            const requestDetailsSection = document.querySelector('.request-details-section');
            if (requestDetailsSection) {
                if (step === 'submit') {
                    requestDetailsSection.style.display = 'block';
                } else {
                    requestDetailsSection.style.display = 'none';
                }
            }
        });
    });
    
    // Check for URL parameter to set initial active tab (preserves tab state on refresh)
    const urlParams = new URLSearchParams(window.location.search);
    let requestedTab = urlParams.get('tab');
    const viewPageContainer = document.querySelector('.dashboard-container.view-request-page');
    const requestStatus = viewPageContainer?.dataset.requestStatus;
    const userDepartment = viewPageContainer?.dataset.userDepartment;
    
    // Auditing should land on Assigned tab for completed requests
    if (userDepartment === 'Auditing' && requestStatus === 'Completed') {
        requestedTab = 'assigned';
        const url = new URL(window.location);
        url.searchParams.set('tab', 'assigned');
        window.history.replaceState({}, '', url);
    }
    
    // If no tab parameter and status is "Assigned to Procurement", default to assigned tab
    if (!requestedTab && requestStatus === 'Assigned to Procurement') {
        requestedTab = 'assigned';
        // Update URL to include the tab parameter
        const url = new URL(window.location);
        url.searchParams.set('tab', 'assigned');
        window.history.replaceState({}, '', url);
    }
    
    // Always remove active class from all tabs and contents first (to clear default)
    stepTabs.forEach(t => t.classList.remove('active'));
    stepContents.forEach(c => c.classList.remove('active'));
    
    if (requestedTab) {
        // Activate the requested tab from URL parameter
        const requestedTabElement = document.querySelector(`[data-step="${requestedTab}"]`);
        const requestedContent = document.getElementById(`step-${requestedTab}`);
        
        if (requestedTabElement && requestedContent && !requestedTabElement.classList.contains('disabled')) {
            requestedTabElement.classList.add('active');
            requestedContent.classList.add('active');
            
            // Show/hide request details section based on active tab
            const requestDetailsSection = document.querySelector('.request-details-section');
            if (requestDetailsSection) {
                if (requestedTab === 'submit') {
                    requestDetailsSection.style.display = 'block';
                } else {
                    requestDetailsSection.style.display = 'none';
                }
            }
            
            // Scroll to the tab content to keep user in the same place
            requestedContent.scrollIntoView({ behavior: 'auto', block: 'start' });
        } else {
            // If requested tab is invalid or disabled, fall back to default (submit)
            const defaultTab = document.querySelector('[data-step="submit"]');
            const defaultContent = document.getElementById('step-submit');
            if (defaultTab && defaultContent) {
                defaultTab.classList.add('active');
                defaultContent.classList.add('active');
            }
        }
    } else {
        // No URL parameter - use default (submit tab is already active in HTML)
        const defaultTab = document.querySelector('[data-step="submit"]');
        const defaultContent = document.getElementById('step-submit');
        if (defaultTab && defaultContent) {
            defaultTab.classList.add('active');
            defaultContent.classList.add('active');
        }
    }
    
    
    // Handle item request completion form submission with multiple file upload components
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        const hasExistingReceipts = {{ 'true' if receipt_files else 'false' }};
        const hasExistingInvoices = {{ 'true' if invoice_files else 'false' }};
        const invoiceItemOptions = {{ assigned_items|tojson }};
        const invoiceItemQuantities = {{ assigned_item_quantities|tojson }};
        const invoiceMappingWrapper = document.getElementById('invoice-item-mapping');
        const invoiceMappingList = document.getElementById('invoice-item-mapping-list');
        const invoiceItemMapInput = document.getElementById('invoice_item_map_input');
        const receiptUploadContainer = document.getElementById('item-receipt-upload-container');
        const invoiceUploadContainer = document.getElementById('item-invoice-upload-container');
        // Checkbox to indicate item came from store (no receipt/invoice expected)
        const fromStoreNoReceiptCheckbox = document.getElementById('from_store_no_receipt_checkbox');
        // Flag used by validation to skip receipt/invoice requirements
        let noReceiptFromStore = false;
        if (fromStoreNoReceiptCheckbox) {
            // Initialize based on existing value (in case of server-side pre-check)
            noReceiptFromStore = !!fromStoreNoReceiptCheckbox.checked;
            fromStoreNoReceiptCheckbox.addEventListener('change', function() {
                noReceiptFromStore = !!this.checked;

                // Toggle receipt upload component
                if (receiptUploadContainer && receiptUploadContainer.uploadComponent) {
                    const comp = receiptUploadContainer.uploadComponent;
                    if (noReceiptFromStore) {
                        comp.clearFiles();
                        comp.required = false;
                        const addBtn = document.getElementById('add-files-btn-' + receiptUploadContainer.id);
                        if (addBtn) { addBtn.disabled = true; addBtn.style.opacity = '0.6'; addBtn.style.cursor = 'not-allowed'; }
                    } else {
                        comp.required = true;
                        const addBtn = document.getElementById('add-files-btn-' + receiptUploadContainer.id);
                        if (addBtn) { addBtn.disabled = false; addBtn.style.opacity = '1'; addBtn.style.cursor = 'pointer'; }
                    }
                    // Gray out the label when disabled
                    try {
                        const rLabel = receiptUploadContainer.querySelector('label');
                        if (rLabel) {
                            rLabel.style.color = noReceiptFromStore ? '#6b7280' : '';
                            rLabel.style.opacity = noReceiptFromStore ? '0.85' : '';
                        }
                    } catch (err) {}
                }

                // Toggle invoice upload component and invoice mapping UI
                if (invoiceUploadContainer && invoiceUploadContainer.uploadComponent) {
                    const comp = invoiceUploadContainer.uploadComponent;
                    if (noReceiptFromStore) {
                        comp.clearFiles();
                        comp.required = false;
                        const addBtn = document.getElementById('add-files-btn-' + invoiceUploadContainer.id);
                        if (addBtn) { addBtn.disabled = true; addBtn.style.opacity = '0.6'; addBtn.style.cursor = 'not-allowed'; }
                        if (invoiceMappingWrapper) {
                            invoiceMappingWrapper.style.display = 'none';
                            invoiceItemMapInput.value = '';
                            invoiceMappingList.innerHTML = '';
                        }
                    } else {
                        comp.required = true;
                        const addBtn = document.getElementById('add-files-btn-' + invoiceUploadContainer.id);
                        if (addBtn) { addBtn.disabled = false; addBtn.style.opacity = '1'; addBtn.style.cursor = 'pointer'; }
                        // Refresh mapping if there are files
                        refreshInvoiceMapping();
                    }
                    // Gray out the label when disabled
                    try {
                        const iLabel = invoiceUploadContainer.querySelector('label');
                        if (iLabel) {
                            iLabel.style.color = noReceiptFromStore ? '#6b7280' : '';
                            iLabel.style.opacity = noReceiptFromStore ? '0.85' : '';
                        }
                    } catch (err) {}
                } else {
                    // If fallback inputs are used, disable them visually when noReceiptFromStore
                    const receiptFileInput = itemRequestCompleteForm.querySelector('input[name="receipt_files"]');
                    const invoiceFileInput = itemRequestCompleteForm.querySelector('input[name="invoice_files"]');
                    if (receiptFileInput) receiptFileInput.disabled = noReceiptFromStore;
                    if (invoiceFileInput) invoiceFileInput.disabled = noReceiptFromStore;
                    if (noReceiptFromStore && invoiceMappingWrapper) {
                        invoiceMappingWrapper.style.display = 'none';
                        invoiceItemMapInput.value = '';
                        invoiceMappingList.innerHTML = '';
                    } else if (invoiceMappingWrapper) {
                        refreshInvoiceMapping();
                    }
                }

                // Disable/enable other related inputs: receipt amount, receipt reference, and invoice mapping inputs
                const receiptAmountInputEl = itemRequestCompleteForm.querySelector('#completion_receipt_amount');
                const receiptRefEl = itemRequestCompleteForm.querySelector('#completion_receipt_reference_number');
                if (receiptAmountInputEl) {
                    receiptAmountInputEl.disabled = noReceiptFromStore;
                    if (noReceiptFromStore) receiptAmountInputEl.removeAttribute('required');
                    else receiptAmountInputEl.setAttribute('required', 'true');
                }
                if (receiptRefEl) {
                    receiptRefEl.disabled = noReceiptFromStore;
                    if (noReceiptFromStore) receiptRefEl.removeAttribute('required');
                    else receiptRefEl.setAttribute('required', 'true');
                }

                if (invoiceMappingList) {
                    // Disable/enable all checkboxes and invoice amount inputs inside mapping
                    invoiceMappingList.querySelectorAll('input').forEach(inp => {
                        try {
                            if (inp.getAttribute && inp.getAttribute('data-invoice-amount') === 'true') {
                                inp.disabled = noReceiptFromStore;
                                if (noReceiptFromStore) inp.removeAttribute('required');
                                else inp.setAttribute('required', 'true');
                            } else if (inp.classList && inp.classList.contains('invoice-item-checkbox')) {
                                if (inp.getAttribute('data-qty-zero') === 'true') {
                                    inp.disabled = true;
                                } else {
                                    inp.disabled = noReceiptFromStore;
                                }
                            } else {
                                inp.disabled = noReceiptFromStore;
                            }
                        } catch (err) {
                            // ignore individual input errors
                        }
                    });
                }
            });
            // Apply initial state based on current checkbox value (server-side pre-check)
            // Wait for upload components to initialize before applying the state.
            const applyInitialFromStoreState = () => {
                const receiptReady = (!receiptUploadContainer) || (receiptUploadContainer && receiptUploadContainer.uploadComponent);
                const invoiceReady = (!invoiceUploadContainer) || (invoiceUploadContainer && invoiceUploadContainer.uploadComponent);
                if (receiptReady && invoiceReady) {
                    fromStoreNoReceiptCheckbox.dispatchEvent(new Event('change'));
                    return true;
                }
                return false;
            };

            if (!applyInitialFromStoreState()) {
                let initAttempts = 0;
                const initInterval = setInterval(() => {
                    initAttempts++;
                    if (applyInitialFromStoreState() || initAttempts > 30) {
                        clearInterval(initInterval);
                    }
                }, 100);
            }
        }

        const sanitizeForId = (val) => String(val || '').replace(/[^a-zA-Z0-9_-]/g, '');

        const syncInvoiceItemMapInput = () => {
            if (!invoiceItemMapInput || !invoiceMappingList) return {};
            const map = {};
            invoiceMappingList.querySelectorAll('[data-invoice-file]').forEach(group => {
                const fileName = group.getAttribute('data-invoice-file');
                const selected = Array.from(group.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value)
                    .filter(Boolean);
                const amountInput = group.querySelector('input[type="number"][data-invoice-amount]');
                let amountVal = amountInput ? parseFloat(amountInput.value) : null;
                if (isNaN(amountVal)) {
                    amountVal = null;
                }
                if (fileName && selected.length > 0) {
                    map[fileName] = {
                        items: selected,
                        amount: amountVal,
                    };
                }
            });
            invoiceItemMapInput.value = JSON.stringify(map);
            return map;
        };

        const renderInvoiceItemMapping = (files) => {
            if (!invoiceMappingWrapper || !invoiceMappingList) return;
            const fileList = Array.from(files || []);
            
            // Get existing files that are already rendered
            const existingFileNames = new Set();
            document.querySelectorAll('[data-invoice-file]').forEach(elem => {
                existingFileNames.add(elem.getAttribute('data-invoice-file'));
            });
            
            // Filter to only new files (not already rendered)
            const newFiles = fileList.filter(file => !existingFileNames.has(file.name));
            
            // If no new files and list is empty, hide the wrapper
            if (newFiles.length === 0 && invoiceMappingList.children.length === 0) {
                invoiceMappingWrapper.style.display = 'none';
                if (invoiceItemMapInput) {
                    invoiceItemMapInput.value = '';
                }
                return;
            }
            
            // Show wrapper if there are files
            if (fileList.length > 0) {
                invoiceMappingWrapper.style.display = 'block';
            }
            
            newFiles.forEach((file, idx) => {
                const fileRow = document.createElement('div');
                fileRow.className = 'invoice-mapping-row';
                fileRow.style.padding = '10px';
                fileRow.style.border = '1px solid #dee2e6';
                fileRow.style.borderRadius = '6px';
                fileRow.style.background = '#f8f9fa';
                fileRow.setAttribute('data-invoice-file', file.name);

                const title = document.createElement('div');
                title.style.fontWeight = '600';
                title.style.marginBottom = '6px';
                title.textContent = file.name;
                if (noReceiptFromStore) {
                    title.style.color = '#6b7280';
                    title.style.opacity = '0.95';
                }
                fileRow.appendChild(title);

                const optionsWrap = document.createElement('div');
                optionsWrap.style.display = 'flex';
                optionsWrap.style.flexWrap = 'wrap';
                optionsWrap.style.gap = '10px';

                invoiceItemOptions.forEach((itemName, itemIdx) => {
                    const qtyVal = Array.isArray(invoiceItemQuantities) && invoiceItemQuantities.length > itemIdx
                        ? invoiceItemQuantities[itemIdx]
                        : null;
                    const optionId = `inv-${sanitizeForId(file.name)}-${itemIdx}`;
                    const label = document.createElement('label');
                    label.setAttribute('for', optionId);
                    label.style.display = 'inline-flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '6px';
                    label.style.marginRight = '10px';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = optionId;
                    checkbox.value = itemName;
                    checkbox.className = 'invoice-item-checkbox';
                    
                    // Mark if quantity is 0 for later reference
                    if (qtyVal !== null && qtyVal <= 0) {
                        checkbox.setAttribute('data-qty-zero', 'true');
                        checkbox.disabled = true;
                        label.style.setProperty('opacity', '0.5', 'important');
                        label.title = 'This item has quantity 0 and cannot be selected.';
                    } else if (noReceiptFromStore) {
                        // Gray out selectable labels when overall disabled
                        label.style.color = '#6b7280';
                        label.style.opacity = '0.85';
                    }

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(itemName));
                    optionsWrap.appendChild(label);
                });

                fileRow.appendChild(optionsWrap);

                const amountWrap = document.createElement('div');
                amountWrap.style.marginTop = '8px';
                const amountLabel = document.createElement('label');
                amountLabel.textContent = 'Invoice amount (OMR) *';
                amountLabel.style.display = 'block';
                amountLabel.style.fontWeight = '500';
                amountLabel.style.marginBottom = '4px';
                const amountInput = document.createElement('input');
                amountInput.type = 'number';
                amountInput.min = '0';
                amountInput.step = '0.001';
                amountInput.required = true;
                if (noReceiptFromStore) {
                    amountInput.disabled = true;
                    amountInput.removeAttribute('required');
                    amountLabel.style.color = '#6b7280';
                    amountLabel.style.opacity = '0.9';
                }
                amountInput.setAttribute('data-invoice-amount', 'true');
                amountInput.style.width = '160px';
                amountInput.placeholder = '0.000';
                amountWrap.appendChild(amountLabel);
                amountWrap.appendChild(amountInput);
                fileRow.appendChild(amountWrap);

                invoiceMappingList.appendChild(fileRow);
            });

            syncInvoiceItemMapInput();
        };

        if (invoiceMappingList) {
            invoiceMappingList.addEventListener('change', function(e) {
                if (e.target && e.target.classList.contains('invoice-item-checkbox')) {
                    syncInvoiceItemMapInput();
                }
            });
        }

        const refreshInvoiceMapping = () => {
            if (invoiceUploadContainer && invoiceUploadContainer.uploadComponent) {
                renderInvoiceItemMapping(invoiceUploadContainer.uploadComponent.getFiles());
            } else {
                const fallbackInput = itemRequestCompleteForm.querySelector('input[name="invoice_files"]');
                renderInvoiceItemMapping(fallbackInput ? fallbackInput.files : []);
            }
        };

        if (invoiceUploadContainer) {
            invoiceUploadContainer.addEventListener('multipleFileUpload:changed', (evt) => {
                renderInvoiceItemMapping(evt.detail?.files || []);
            });
        }

        const invoiceFileInputFallback = itemRequestCompleteForm.querySelector('input[name="invoice_files"]');
        if (invoiceFileInputFallback) {
            invoiceFileInputFallback.addEventListener('change', (e) => {
                renderInvoiceItemMapping(e.target.files);
            });
        }

        // Initialize mapping UI
        refreshInvoiceMapping();
        // Helper to render uploaded files card without a full reload
        const renderUploadedFiles = (receipts, invoices) => {
            const card = document.getElementById('uploaded-files-card');
            if (!card) return;
            const receiptsList = document.getElementById('uploaded-receipts-list');
            const invoicesList = document.getElementById('uploaded-invoices-list');

            // If no files at all, hide the card
            if ((!receipts || receipts.length === 0) && (!invoices || invoices.length === 0)) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            if (receiptsList) {
                if (receipts && receipts.length > 0) {
                    receiptsList.style.display = 'block';
                    receiptsList.innerHTML = `
                        <label><i class="fas fa-check-circle"></i> Receipt (Proof of transfer made by the Procurement Manager)</label>
                        ${receipts.map((file, idx) => `
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="${window.location.origin + "{{ url_for('uploaded_file', filename='__FILE__') }}".replace('__FILE__', file)}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Receipt ${idx + 1}
                                </a>
                                <small style="color: #666; margin-left: 10px;">${file.includes('_') ? file.split('_', 2)[1] || file : file}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    receiptsList.style.display = 'none';
                    receiptsList.innerHTML = '';
                }
            }

            if (invoicesList) {
                if (invoices && invoices.length > 0) {
                    invoicesList.style.display = 'block';
                    invoicesList.innerHTML = `
                        <label><i class="fas fa-check-circle"></i> Invoice (Proof of payment made for the requested item)</label>
                        ${invoices.map((file, idx) => `
                            <div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; border: 1px solid #ffc107;">
                                <a href="${window.location.origin + "{{ url_for('uploaded_file', filename='__FILE__') }}".replace('__FILE__', file)}" target="_blank" class="btn btn-warning">
                                    <i class="fas fa-download"></i> View Invoice ${idx + 1}
                                </a>
                                <small style="color: #666; margin-left: 10px;">${file.includes('_') ? file.split('_', 2)[1] || file : file}</small>
                            </div>
                        `).join('')}
                    `;
                } else {
                    invoicesList.style.display = 'none';
                    invoicesList.innerHTML = '';
                }
            }
        };

        // Save uploads without completing the request
        const saveUploadsBtn = document.getElementById('save-uploads-btn');
        if (saveUploadsBtn) {
            const originalSaveHTML = saveUploadsBtn.innerHTML;
            saveUploadsBtn.addEventListener('click', function() {
                const receiptComponent = receiptUploadContainer ? receiptUploadContainer.uploadComponent : null;
                const invoiceComponent = invoiceUploadContainer ? invoiceUploadContainer.uploadComponent : null;
                const receiptInput = itemRequestCompleteForm.querySelector('input[name="receipt_files"]');
                const invoiceInput = itemRequestCompleteForm.querySelector('input[name="invoice_files"]');

                const receiptFileList = receiptComponent
                    ? receiptComponent.getFiles()
                    : (receiptInput && receiptInput.files ? Array.from(receiptInput.files) : []);
                const invoiceFileList = invoiceComponent
                    ? invoiceComponent.getFiles()
                    : (invoiceInput && invoiceInput.files ? Array.from(invoiceInput.files) : []);
                const invoiceMap = syncInvoiceItemMapInput();
                if (invoiceFileList && invoiceFileList.length > 0) {
                    const missingMappings = invoiceFileList.filter(f => {
                        const entry = invoiceMap[f.name];
                        return !entry || !entry.items || entry.items.length === 0 || !entry.amount || entry.amount <= 0;
                    });
                    if (missingMappings.length > 0) {
                        showReceiptUploadErrorDialog('Please select item name(s) and enter a positive amount for each invoice file: ' + missingMappings.map(f => f.name).join(', '));
                        return;
                    }
                }

                saveUploadsBtn.disabled = true;
                saveUploadsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                // Ensure the latest mapping is in the form before submission
                syncInvoiceItemMapInput();

                const formData = new FormData(itemRequestCompleteForm);
                if (receiptComponent) {
                    receiptComponent.prepareFormData(formData);
                }
                if (invoiceComponent) {
                    invoiceComponent.prepareFormData(formData);
                }
                
                // Collect quantities and amounts from the right column
                const quantityInputs = document.querySelectorAll('#step-assigned input[id^="cart_qty_"]');
                const amountInputs = document.querySelectorAll('#step-assigned input[id^="cart_amount_"]');
                
                quantityInputs.forEach(input => {
                    if (input.value) {
                        formData.append('quantities[]', input.value);
                    }
                });
                
                amountInputs.forEach(input => {
                    if (input.value) {
                        formData.append('amounts[]', input.value);
                    }
                });
                
                // Collect rejection reason if present
                const rejectionReasonField = document.querySelector('#assigned_quantity_rejection_reason') || 
                                             document.querySelector('#assigned_quantity_rejection_reason_single');
                if (rejectionReasonField && rejectionReasonField.value) {
                    formData.append('quantity_rejection_reason', rejectionReasonField.value);
                }
                
                formData.append('save_uploads', 'true');

                fetch("{{ url_for('item_request_save_uploads', request_id=item_request.id) }}", {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                })
                .then(async response => {
                    const contentType = response.headers.get('content-type') || '';
                    let data = null;
                    if (contentType.includes('application/json')) {
                        data = await response.json();
                    }

                    if (response.ok && data && data.success) {
                        renderUploadedFiles(data.receipt_files || [], data.invoice_files || []);
                        saveUploadsBtn.disabled = false;
                        saveUploadsBtn.innerHTML = originalSaveHTML;
                        // Provide immediate success feedback and refresh to sync UI
                        showSuccessDialog(data.message || 'Changes saved successfully.');
                        // Reload page after user closes the modal
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                        return;
                    }

                    // Show error message if provided
                    if (data && data.message) {
                        saveUploadsBtn.disabled = false;
                        saveUploadsBtn.innerHTML = originalSaveHTML;
                        showReceiptUploadErrorDialog(data.message);
                        return;
                    }

                    if (response.ok) {
                        window.location.href = window.location.href;
                        return;
                    }

                    throw new Error('Save failed');
                })
                .catch(() => {
                    saveUploadsBtn.disabled = false;
                    saveUploadsBtn.innerHTML = originalSaveHTML;
                    showReceiptUploadErrorDialog('Could not save uploads. Please try again.');
                });
            });
        }

        // Store original values for assigned procurement quantities before adding validation
        ensureOriginalValuesStored();
        
        // Store original button HTML
        const submitButton = itemRequestCompleteForm.querySelector('button[type="submit"]');
        let originalButtonHTML = submitButton ? submitButton.innerHTML : '';
        
    itemRequestCompleteForm.addEventListener('submit', function(e) {
        // Prevent duplicate submissions
        if (this.dataset.mcSubmitting === 'true') {
            return;
        }

        // Locate assigned procurement form once
        const assignedForm = Array.from(document.querySelectorAll('form[action*="update_quantities"]')).find(f => {
            const action = f.getAttribute('action') || '';
            return !action.includes('update_quantities_manager') && !action.includes('update_quantities_procurement_manager');
        });
            // Function to reset button state
            const resetButton = () => {
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonHTML;
                }
            };
            
            // ALWAYS prevent default first
            e.preventDefault();
            
            // Check for unsaved quantity edits first
            if (hasUnsavedQuantityEdits()) {
                resetButton();
                showQuantityEditErrorDialog();
                return false;
            }
            
            // Collect all validation errors
            const errors = [];
            let firstInvalidInput = null;
            
            // Validate that all amount fields are filled (amounts[] inputs in procurement cart)
            const amountInputs = document.querySelectorAll('input[name="amounts[]"]');
            if (amountInputs.length > 0) {
                let hasEmptyAmount = false;
                amountInputs.forEach(input => {
                    const valueStr = String(input.value || '').trim();
                    const amount = parseFloat(valueStr);
                    const index = input.dataset.index || input.id.replace('cart_amount_', '');
                    const qtyInput = document.getElementById('cart_qty_' + index);
                    const qtyVal = qtyInput ? parseInt(qtyInput.value || '0', 10) : null;
                    
                    // If quantity is zero, allow empty/zero amount
                    const skipAmount = qtyVal === 0;
                    
                    const isEmpty = valueStr === '';
                    const isZero = valueStr === '0';
                    const isNaNValue = isNaN(amount);
                    const isNotPositive = amount <= 0;
                    
                    if (!skipAmount && (isEmpty || isZero || isNaNValue || isNotPositive)) {
                        hasEmptyAmount = true;
                        if (!firstInvalidInput) {
                            firstInvalidInput = input;
                        }
                    }
                });
                
                if (hasEmptyAmount) {
                    errors.push('Please fill in all amount fields before completing the request (amounts not required for items with quantity 0).');
                }
            }

            // Validate rejection reason if any quantity is 0 (assigned procurement)
            if (assignedForm) {
                const qtyInputs = assignedForm.querySelectorAll('input[name="quantities[]"]');
                let hasZero = false;
                qtyInputs.forEach(input => {
                    const qty = parseInt(input.value || '0', 10);
                    if (qty === 0) hasZero = true;
                });
                if (hasZero) {
                    const rejectionField = assignedForm.querySelector('#assigned_quantity_rejection_reason') ||
                                           assignedForm.querySelector('#assigned_quantity_rejection_reason_single') ||
                                           assignedForm.querySelector('textarea[name="quantity_rejection_reason"]');
                    if (rejectionField && !rejectionField.value.trim()) {
                        errors.push('Please provide a reason for rejecting the item(s) with quantity set to 0.');
                        if (!firstInvalidInput) firstInvalidInput = rejectionField;
                    }
                }
            }
            
            // Get both upload components
            const receiptContainer = receiptUploadContainer;
            const invoiceContainer = invoiceUploadContainer;
            
            // Validate receipt files
            let receiptFilesMissing = false;
            if (!hasExistingReceipts && !noReceiptFromStore) {
                if (receiptContainer && receiptContainer.uploadComponent) {
                    const receiptComponent = receiptContainer.uploadComponent;
                    if (receiptComponent.getFiles().length === 0) {
                        receiptFilesMissing = true;
                    }
                } else {
                    // Fallback: check if receipt file input exists and has files
                    const receiptFileInput = this.querySelector('input[name="receipt_files"]');
                    if (!receiptFileInput || !receiptFileInput.files || receiptFileInput.files.length === 0) {
                        receiptFilesMissing = true;
                    }
                }
                if (receiptFilesMissing) {
                    errors.push('Please select at least one receipt file to upload.');
                }
            }
            
            // Validate invoice files
            let invoiceFilesMissing = false;
            let invoiceFileList = [];
            if (!hasExistingInvoices && !noReceiptFromStore) {
                if (invoiceContainer && invoiceContainer.uploadComponent) {
                    const invoiceComponent = invoiceContainer.uploadComponent;
                    invoiceFileList = invoiceComponent.getFiles();
                    if (invoiceComponent.getFiles().length === 0) {
                        invoiceFilesMissing = true;
                    }
                } else {
                    // Fallback: check if invoice file input exists and has files
                    const invoiceFileInput = this.querySelector('input[name="invoice_files"]');
                    invoiceFileList = invoiceFileInput && invoiceFileInput.files ? Array.from(invoiceFileInput.files) : [];
                    if (!invoiceFileInput || !invoiceFileInput.files || invoiceFileInput.files.length === 0) {
                        invoiceFilesMissing = true;
                    }
                }
                if (invoiceFilesMissing) {
                    errors.push('Please select at least one invoice file to upload.');
                }
            } else if (invoiceContainer && invoiceContainer.uploadComponent) {
                invoiceFileList = invoiceContainer.uploadComponent.getFiles();
            }

            // Validate that each uploaded invoice file has item mapping and amount
            const invoiceMap = syncInvoiceItemMapInput();
            if (!noReceiptFromStore && invoiceFileList && invoiceFileList.length > 0) {
                const missingInvoiceMapping = invoiceFileList.filter(f => {
                    const entry = invoiceMap[f.name];
                    return !entry || !entry.items || entry.items.length === 0 || !entry.amount || entry.amount <= 0;
                });
                if (missingInvoiceMapping.length > 0) {
                    errors.push('Please choose item name(s) and enter a positive amount for each invoice file: ' + missingInvoiceMapping.map(f => f.name).join(', '));
                }
            }
            
            // If there are any errors, show them and stop
            if (errors.length > 0) {
                resetButton();
                // Focus the first invalid input if it's an amount field
                if (firstInvalidInput) {
                    firstInvalidInput.focus();
                }
                // Show combined error message in a readable list format
                const errorMessage = 'Please fix the following issues before completing the request:<br><br>' + 
                    errors.map(err => '• ' + err).join('<br>');
                showMarkCompleteValidationErrorDialog(errorMessage);
                return false;
            }
            
            // Validate receipt amount - must be > 0
            // Validate receipt amount - must be > 0 only if a new receipt is being uploaded
            const receiptAmountInput = this.querySelector('input[name="receipt_amount"]');
            if (receiptAmountInput && !hasExistingReceipts && !noReceiptFromStore) {
                const receiptAmount = parseFloat(receiptAmountInput.value);
                if (isNaN(receiptAmount) || receiptAmount <= 0) {
                    resetButton();
                    showMarkCompleteValidationErrorDialog('Receipt Amount must be greater than 0.');
                    return false;
                }
            }
            
            // Validate receipt reference number - must not be empty only if a new receipt is being uploaded
            const receiptRefInput = this.querySelector('input[name="receipt_reference_number"]');
            if (receiptRefInput && !hasExistingReceipts && !noReceiptFromStore) {
                const receiptRef = receiptRefInput.value.trim();
                if (!receiptRef || receiptRef === '') {
                    resetButton();
                    showMarkCompleteValidationErrorDialog('Receipt Reference Number is required.');
                    return false;
                }
            }
            
            // All validations passed - first save quantities/amounts (assigned procurement), then submit completion with uploads
            this.dataset.mcSubmitting = 'true';

            const saveAssigned = () => {
                if (!assignedForm) return Promise.resolve({ ok: true });
                const assignedData = new FormData(assignedForm);
                return fetch(assignedForm.action, {
                    method: 'POST',
                    body: assignedData
                });
            };

            const submitCompletion = () => {
                // Ensure invoice item mapping is captured
                syncInvoiceItemMapInput();
                const formData = new FormData(this);
                if (assignedForm) {
                    const extraFields = assignedForm.querySelectorAll('input[name], textarea[name], select[name]');
                    extraFields.forEach(field => {
                        const { name, type } = field;
                        if (!name) return;
                        if (type === 'checkbox' || type === 'radio') {
                            if (!field.checked) return;
                        }
                        formData.append(name, field.value ?? '');
                    });
                }
                if (receiptContainer && receiptContainer.uploadComponent) {
                    receiptContainer.uploadComponent.prepareFormData(formData);
                }
                if (invoiceContainer && invoiceContainer.uploadComponent) {
                    invoiceContainer.uploadComponent.prepareFormData(formData);
                }

                return fetch(this.action, {
                    method: 'POST',
                    body: formData,
                });
            };

            saveAssigned()
                .then(res => {
                    if (!res || !res.ok) {
                        throw new Error('save-assigned-failed');
                    }
                    return submitCompletion();
                })
                .then(response => {
                    if (!response) {
                        throw new Error('complete-failed');
                    }
                    if (response.redirected) {
                        window.location.href = response.url;
                        return;
                    }
                    if (response.ok) {
                        window.location.reload();
                        return;
                    }
                    // Try to extract server error message (JSON or text/HTML) and show it
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('application/json')) {
                        return response.json().then(data => {
                            throw new Error(data.message || JSON.stringify(data));
                        });
                    }
                    return response.text().then(txt => {
                        // Strip HTML tags for readability if any
                        const plain = txt ? txt.replace(/<[^>]*>/g, ' ').trim() : '';
                        throw new Error(plain || 'Form submission failed. Please try again.');
                    });
                })
                .catch(err => {
                    console.error('Error:', err);
                    resetButton();
                    this.dataset.mcSubmitting = 'false';
                    if (String(err.message || '').includes('save-assigned')) {
                        showMarkCompleteValidationErrorDialog('Could not save quantities/amounts before completing. Please try again.');
                    } else {
                        // Show server-provided message when available
                        showMarkCompleteValidationErrorDialog(err.message || 'Form submission failed. Please try again.');
                    }
                });
        });
    }
});

// Quantity controls for Assigned-to-Procurement cart
function adjustCartQuantity(index, delta) {
    index = parseInt(index, 10) || 0;
    const input = document.getElementById('cart_qty_' + index);
    if (!input) return;

    let current = parseInt(input.value || '0', 10);
    if (isNaN(current)) current = 0;

    current += delta;
    if (current < 0) current = 0;

    input.value = current;

    // Update row highlight and note in real-time
    updateCartQuantityState(index);
}

function updateCartQuantityState(index) {
    index = parseInt(index, 10) || 0;
    const input = document.getElementById('cart_qty_' + index);
    const row = document.getElementById('cart_row_' + index);
    const note = document.getElementById('cart_note_' + index) || document.getElementById('cart_note_mgr_' + index);
    
    // Allow quantity styling even if the note container is missing
    if (!input || !row) return;

    const origQty = parseInt(row.getAttribute('data-orig-qty') || '0', 10);
    let current = parseInt(input.value || '0', 10);
    if (isNaN(current)) current = 0;

    const diff = current - origQty;
    const diffAbs = Math.abs(diff);

    // Make item name red if quantity is 0
    if (current === 0) {
        row.classList.add('qty-zero');
    } else {
        row.classList.remove('qty-zero');
    }

    // Row highlight when less than original
    if (current < origQty) {
        row.classList.add('qty-less-than-original');
    } else {
        row.classList.remove('qty-less-than-original');
    }

    // Update note
    if (current === origQty) {
        if (note) {
            note.style.display = 'none';
            note.innerHTML = '';
        }
    } else if (note) {
        const origDisplay = row.getAttribute('data-orig-display') || String(origQty);
        const moreOrLess = diff > 0 ? 'more' : 'less';
        note.style.display = 'block';
        note.innerHTML =
            'Requestor requested <strong>' + origDisplay +
            '</strong> of this item. You have currently set <strong>' +
            diffAbs + '</strong> ' + moreOrLess + ' than requested.';
    }
    
    // Show or hide rejection reason as quantities change
    checkManagerRejectionReasonRequired();
    checkAssignedProcurementRejectionReasonRequired();
}

function calculateAssignedProcurementTotal() {
    const totalEl = document.getElementById('assignedProcurementTotal');
    const amountInputs = document.querySelectorAll('#step-assigned input[id^="cart_amount_"]');
    
    // Skip if there is no total display or no editable amount inputs (e.g., read-only view)
    if (!totalEl || amountInputs.length === 0) return;
    
    let total = 0;
    amountInputs.forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) {
            total += val;
        }
    });
    
    totalEl.textContent = 'OMR ' + total.toFixed(3);
}

// Quantity controls for Procurement Manager cart
function adjustProcurementCartQuantity(index, delta) {
    index = parseInt(index, 10) || 0;
    const input = document.getElementById('procurement_cart_qty_' + index);
    if (!input) return;

    let current = parseInt(input.value || '0', 10);
    if (isNaN(current)) current = 0;

    current += delta;
    if (current < 0) current = 0;

    input.value = current;

    // Update row highlight and note in real-time
    updateProcurementCartQuantityState(index);
}

function updateProcurementCartQuantityState(index) {
    index = parseInt(index, 10) || 0;
    const input = document.getElementById('procurement_cart_qty_' + index);
    const row = document.getElementById('procurement_cart_row_' + index);
    const note = document.getElementById('procurement_cart_note_' + index);
    if (!input || !row || !note) return;

    const origQty = parseInt(row.getAttribute('data-orig-qty') || '0', 10);
    let current = parseInt(input.value || '0', 10);
    if (isNaN(current)) current = 0;

    const diff = current - origQty;
    const diffAbs = Math.abs(diff);

    // Make item name red if quantity is 0
    if (current === 0) {
        row.classList.add('qty-zero');
    } else {
        row.classList.remove('qty-zero');
    }

    // Row highlight when less than original
    if (current < origQty) {
        row.classList.add('qty-less-than-original');
    } else {
        row.classList.remove('qty-less-than-original');
    }

    // Update note
    if (current === origQty) {
        note.style.display = 'none';
        note.innerHTML = '';
    } else {
        const origDisplay = row.getAttribute('data-orig-display') || String(origQty);
        const moreOrLess = diff > 0 ? 'more' : 'less';
        note.style.display = 'block';
        // Check if this is a procurement manager cart (has procurement_cart prefix)
        const isProcurementCart = input.id && input.id.startsWith('procurement_cart');
        if (isProcurementCart) {
            note.innerHTML =
                'Manager approved <strong>' + origDisplay +
                '</strong> of this item. You have currently set <strong>' +
                diffAbs + '</strong> ' + moreOrLess + ' than manager approved.';
        } else {
            note.innerHTML =
                'Requestor requested <strong>' + origDisplay +
                '</strong> of this item. You have currently set <strong>' +
                diffAbs + '</strong> ' + moreOrLess + ' than requested.';
        }
    }
    
    // Check if any quantity is 0 and show/hide rejection reason field
    checkProcurementManagerRejectionReasonRequired();
}

// Enable editing for procurement manager quantity (for previously rejected items)
function enableProcurementQuantityEdit(index) {
    index = parseInt(index, 10) || 0;
    const readonlyDiv = document.getElementById('procurement_qty_readonly_' + index);
    const editableWrapper = document.getElementById('procurement_qty_editable_wrapper_' + index);
    
    if (readonlyDiv && editableWrapper) {
        // Store the current value as the original value for cancel functionality
        const input = document.getElementById('procurement_cart_qty_' + index);
        if (input) {
            // Store the current value before editing
            input.setAttribute('data-original-value', input.value || '0');
        }
        
        // Hide read-only display
        readonlyDiv.style.display = 'none';
        // Show editable wrapper (contains quantity-control and X button)
        editableWrapper.style.display = 'flex';
        // Focus on the input
        if (input) {
            input.focus();
            input.select();
        }
        
        // Check if rejection reason field should be shown (based on current quantity)
        checkProcurementManagerRejectionReasonRequired();
    }
}

// Cancel editing for procurement manager quantity (for previously rejected items)
function cancelProcurementQuantityEdit(index) {
    index = parseInt(index, 10) || 0;
    const readonlyDiv = document.getElementById('procurement_qty_readonly_' + index);
    const editableWrapper = document.getElementById('procurement_qty_editable_wrapper_' + index);
    const note = document.getElementById('procurement_cart_note_' + index);
    
    if (readonlyDiv && editableWrapper) {
        // Restore the original value
        const input = document.getElementById('procurement_cart_qty_' + index);
        if (input) {
            const originalValue = input.getAttribute('data-original-value') || '0';
            input.value = originalValue;
        }
        
        // Hide the note
        if (note) {
            note.style.display = 'none';
            note.innerHTML = '';
        }
        
        // Hide editable wrapper
        editableWrapper.style.display = 'none';
        // Show read-only display
        readonlyDiv.style.display = 'inline-flex';
        
        // Check if rejection reason field should be hidden (based on restored quantity)
        checkProcurementManagerRejectionReasonRequired();
    }
}

// Enable editing for assigned procurement quantity (for items set to 0 by procurement manager)
function enableCartQuantityEdit(index) {
    index = parseInt(index, 10) || 0;
    const readonlyDiv = document.getElementById('cart_qty_readonly_' + index);
    const editableWrapper = document.getElementById('cart_qty_editable_wrapper_' + index);
    const amountReadonly = document.getElementById('cart_amount_readonly_' + index);
    const amountInput = document.getElementById('cart_amount_' + index);
    const note = document.getElementById('cart_note_' + index);
    
    if (readonlyDiv && editableWrapper) {
        // Store the current value as the original value for cancel functionality
        const input = document.getElementById('cart_qty_' + index);
        if (input) {
            // Store the current value before editing
            input.setAttribute('data-original-value', input.value || '0');
        }
        // Store the current amount as the original value
        if (amountInput && !amountInput.dataset.originalValue) {
            amountInput.dataset.originalValue = amountInput.value || '0';
        }
        
        // Hide read-only display
        readonlyDiv.style.display = 'none';
        // Show editable wrapper (contains quantity-control and X button)
        editableWrapper.style.display = 'flex';
        // Toggle amount visibility
        if (amountReadonly && amountInput) {
            amountReadonly.style.display = 'none';
            amountInput.style.display = 'block';
            amountInput.disabled = false;
        }
        // Focus on the input
        if (input) {
            input.focus();
            input.select();
        }
        
        // Update quantity state
        updateCartQuantityState(index);
        // Keep note in sync if present
        if (note) {
            note.style.display = '';
        }
    }
    
    calculateAssignedProcurementTotal();
}

// Cancel editing for assigned procurement quantity (for items set to 0 by procurement manager)
function cancelCartQuantityEdit(index) {
    index = parseInt(index, 10) || 0;
    const readonlyDiv = document.getElementById('cart_qty_readonly_' + index);
    const editableWrapper = document.getElementById('cart_qty_editable_wrapper_' + index);
    const note = document.getElementById('cart_note_' + index);
    const amountReadonly = document.getElementById('cart_amount_readonly_' + index);
    const amountInput = document.getElementById('cart_amount_' + index);
    
    if (readonlyDiv && editableWrapper) {
        // Restore the original value
        const input = document.getElementById('cart_qty_' + index);
        if (input) {
            const originalValue = input.getAttribute('data-original-value') || '0';
            input.value = originalValue;
        }
        // Restore the original amount
        if (amountInput) {
            const originalAmount = amountInput.dataset.originalValue || amountInput.getAttribute('data-original-value') || amountInput.value || '0';
            amountInput.value = originalAmount;
        }
        
        // Hide the note
        if (note) {
            note.style.display = 'none';
            note.innerHTML = '';
        }
        
        // Hide editable wrapper
        editableWrapper.style.display = 'none';
        // Show read-only display
        readonlyDiv.style.display = 'inline-flex';
        // Toggle amount visibility back to readonly
        if (amountReadonly && amountInput) {
            amountReadonly.style.display = 'flex';
            amountInput.style.display = 'none';
            amountInput.disabled = true;
        }
        
        // Update quantity state
        updateCartQuantityState(index);
    }
    
    calculateAssignedProcurementTotal();
}

// Check if manager rejection reason is required (when any quantity is 0)
function checkManagerRejectionReasonRequired() {
    // Check multi-item form
    const multiRejectionGroup = document.getElementById('manager_rejection_reason_group');
    const multiRejectionField = document.getElementById('manager_quantity_rejection_reason');
    const multiSaveBtn = document.getElementById('manager_save_quantities_btn');
    
    if (multiRejectionGroup && multiRejectionField && multiSaveBtn) {
        let hasZero = false;
        const quantityInputs = document.querySelectorAll('input[name="quantities[]"]');
        quantityInputs.forEach(input => {
            if (input.id && input.id.startsWith('cart_qty_')) {
                const qty = parseInt(input.value || '0', 10);
                if (qty === 0) {
                    hasZero = true;
                }
            }
        });
        
        // Show editable field only if any quantity is 0 (don't show based on saved value)
        if (hasZero) {
            multiRejectionGroup.style.display = 'block';
            multiRejectionField.setAttribute('required', 'required');
        } else {
            multiRejectionGroup.style.display = 'none';
            multiRejectionField.removeAttribute('required');
            // Don't clear the value - keep it for when they show the field again
        }
    }
    
    // Check single-item form
    const singleRejectionGroup = document.getElementById('manager_rejection_reason_group_single');
    const singleRejectionField = document.getElementById('manager_quantity_rejection_reason_single');
    const singleSaveBtn = document.getElementById('manager_save_quantity_btn');
    
    if (singleRejectionGroup && singleRejectionField && singleSaveBtn) {
        const quantityInput = document.getElementById('cart_qty_0');
        if (quantityInput) {
            const qty = parseInt(quantityInput.value || '0', 10);
            // Show editable field only if quantity is 0
            if (qty === 0) {
                singleRejectionGroup.style.display = 'block';
                singleRejectionField.setAttribute('required', 'required');
            } else {
                singleRejectionGroup.style.display = 'none';
                singleRejectionField.removeAttribute('required');
                // Don't clear the value - keep it for when they show the field again
            }
        }
    }
}

// Check if procurement manager rejection reason is required (when any quantity is 0)
function checkProcurementManagerRejectionReasonRequired() {
    // Check multi-item form
    const multiRejectionGroup = document.getElementById('procurement_manager_rejection_reason_group');
    const multiRejectionField = document.getElementById('procurement_manager_quantity_rejection_reason');
    const multiSavedReasonGroup = document.getElementById('procurement_manager_saved_rejection_reason_group');
    const multiSaveBtn = document.getElementById('procurement_manager_save_quantities_btn');
    const multiEditBtn = null;
    const multiCancelBtn = null;
    
    if (multiRejectionGroup && multiRejectionField && multiSaveBtn) {
        const { hasZeroAny, hasZeroNew } = procurementManagerHasNewZero(false);
        
        if (hasZeroAny && hasZeroNew) {
            multiRejectionGroup.style.display = 'block';
            multiRejectionField.setAttribute('required', 'required');
            // Prefill with default/inherited reason if empty
            const defaultVal = multiRejectionField.dataset ? (multiRejectionField.dataset.defaultValue || '') : '';
            if (!multiRejectionField.value.trim() && defaultVal) {
                multiRejectionField.value = defaultVal;
            }
            // Show previously saved reason if it exists
            if (multiSavedReasonGroup) {
                multiSavedReasonGroup.style.display = 'block';
            }
            // Make editable immediately
            setProcurementManagerReasonReadonly(multiRejectionField, false);
        } else {
            multiRejectionGroup.style.display = 'none';
            multiRejectionField.removeAttribute('required');
            if (multiSavedReasonGroup) {
                multiSavedReasonGroup.style.display = 'none';
            }
        }
    }
    
    // Check single-item form
    const singleRejectionGroup = document.getElementById('procurement_manager_rejection_reason_group_single');
    const singleRejectionField = document.getElementById('procurement_manager_quantity_rejection_reason_single');
    const singleSavedReasonGroup = document.getElementById('procurement_manager_saved_rejection_reason_group_single');
    const singleSaveBtn = document.getElementById('procurement_manager_save_quantity_btn');
    const singleEditBtn = null;
    const singleCancelBtn = null;
    
    if (singleRejectionGroup && singleRejectionField && singleSaveBtn) {
        const { hasZeroAny, hasZeroNew } = procurementManagerHasNewZero(true);
        if (hasZeroAny && hasZeroNew) {
            singleRejectionGroup.style.display = 'block';
            singleRejectionField.setAttribute('required', 'required');
            // Prefill with default/inherited reason if empty
            const defaultVal = singleRejectionField.dataset ? (singleRejectionField.dataset.defaultValue || '') : '';
            if (!singleRejectionField.value.trim() && defaultVal) {
                singleRejectionField.value = defaultVal;
            }
            // Show previously saved reason if it exists
            if (singleSavedReasonGroup) {
                singleSavedReasonGroup.style.display = 'block';
            }
            // Make editable immediately
            setProcurementManagerReasonReadonly(singleRejectionField, false);
        } else {
            singleRejectionGroup.style.display = 'none';
            singleRejectionField.removeAttribute('required');
            if (singleSavedReasonGroup) {
                singleSavedReasonGroup.style.display = 'none';
            }
        }
    }
}

// Helpers to manage procurement manager rejection reason edit/cancel behaviour
function getProcurementManagerReasonElements(context = 'multi') {
    const isSingle = context === 'single';
    return {
        textarea: document.getElementById(isSingle ? 'procurement_manager_quantity_rejection_reason_single' : 'procurement_manager_quantity_rejection_reason'),
        editBtn: document.getElementById(isSingle ? 'procurement_manager_reason_edit_btn_single' : 'procurement_manager_reason_edit_btn'),
        cancelBtn: document.getElementById(isSingle ? 'procurement_manager_reason_cancel_btn_single' : 'procurement_manager_reason_cancel_btn')
    };
}

function procurementManagerHasNewZero(isSingle = false) {
    let hasZeroAny = false;
    let hasZeroNew = false;
    if (isSingle) {
        const qtyInput = document.getElementById('procurement_cart_qty_0');
        const row = document.getElementById('procurement_cart_row_0');
        const origQty = row ? parseInt(row.dataset.origQty || '0', 10) : 0;
        if (qtyInput) {
            const qty = parseInt(qtyInput.value || '0', 10);
            if (qty === 0) {
                hasZeroAny = true;
                if (origQty > 0) {
                    hasZeroNew = true;
                }
            }
        }
    } else {
        const quantityInputs = document.querySelectorAll('input[name="quantities[]"]');
        quantityInputs.forEach(input => {
            if (input.id && input.id.startsWith('procurement_cart_qty_')) {
                const row = document.getElementById('procurement_cart_row_' + input.dataset.index);
                const origQty = row ? parseInt(row.dataset.origQty || '0', 10) : 0;
                const qty = parseInt(input.value || '0', 10);
                if (qty === 0) {
                    hasZeroAny = true;
                    if (origQty > 0) {
                        hasZeroNew = true;
                    }
                }
            }
        });
    }
    return { hasZeroAny, hasZeroNew };
}

function setProcurementManagerReasonReadonly(textarea, isReadonly) {
    if (!textarea) return;
    if (isReadonly) {
        textarea.setAttribute('readonly', 'readonly');
        textarea.style.backgroundColor = '#f1f5f9';
        textarea.style.color = '#6b7280';
        textarea.style.cursor = 'not-allowed';
    } else {
        textarea.removeAttribute('readonly');
        textarea.style.backgroundColor = '#ffffff';
        textarea.style.color = '';
        textarea.style.cursor = 'text';
    }
}

function enableProcurementManagerReasonEdit(context = 'multi') {
    const { textarea, editBtn, cancelBtn } = getProcurementManagerReasonElements(context);
    if (!textarea) return;
    // Deprecated: field now editable immediately when visible
}

function cancelProcurementManagerReasonEdit(context = 'multi') {
    const { textarea, editBtn, cancelBtn } = getProcurementManagerReasonElements(context);
    if (!textarea) return;
    // Deprecated: field now editable immediately when visible
}

function initializeProcurementManagerReasonFields() {
    ['multi', 'single'].forEach(context => {
        const { textarea, editBtn, cancelBtn } = getProcurementManagerReasonElements(context);
        if (!textarea) return;
        const defaultVal = textarea.dataset ? (textarea.dataset.defaultValue || '') : '';
        if (!textarea.value.trim() && defaultVal) {
            textarea.value = defaultVal;
        }
        if (textarea.dataset && !textarea.dataset.originalValue) {
            textarea.dataset.originalValue = textarea.value || '';
        }
        const startReadonly = textarea.dataset ? (textarea.dataset.startReadonly === 'true') : textarea.hasAttribute('readonly');
        setProcurementManagerReasonReadonly(textarea, startReadonly);
        if (startReadonly) {
            if (editBtn) editBtn.style.display = 'inline-flex';
            if (cancelBtn) cancelBtn.style.display = 'none';
        } else {
            if (editBtn) editBtn.style.display = 'none';
            if (cancelBtn) cancelBtn.style.display = 'none';
        }
    });
}

// Check if assigned procurement rejection reason is required (when any quantity is 0)
function checkAssignedProcurementRejectionReasonRequired() {
    const assignedForm = Array.from(document.querySelectorAll('form[action*="update_quantities"]')).find(f => {
        const action = f.getAttribute('action') || '';
        return !action.includes('update_quantities_manager') && !action.includes('update_quantities_procurement_manager');
    });

    const multiGroup = document.getElementById('assigned_rejection_reason_group');
    const multiField = document.getElementById('assigned_quantity_rejection_reason');
    const multiSavedGroup = document.getElementById('assigned_saved_rejection_reason_group');
    const singleGroup = document.getElementById('assigned_rejection_reason_group_single');
    const singleField = document.getElementById('assigned_quantity_rejection_reason_single');
    const singleSavedGroup = document.getElementById('assigned_saved_rejection_reason_group_single');

    if (!assignedForm) {
        // Hide any assigned-specific reason fields if form not present
        [multiGroup, singleGroup].forEach(g => { if (g) g.style.display = 'none'; });
        [multiField, singleField].forEach(f => { if (f) f.removeAttribute('required'); });
        if (multiSavedGroup) multiSavedGroup.style.display = 'none';
        if (singleSavedGroup) singleSavedGroup.style.display = 'none';
        return;
    }

    const quantityInputs = assignedForm.querySelectorAll('input[name="quantities[]"]');
    let hasZero = false;
    quantityInputs.forEach(input => {
        const qty = parseInt(input.value || '0', 10);
        if (qty === 0) {
            hasZero = true;
        }
    });

    // Multi-item form fields
    if (multiGroup && multiField && quantityInputs.length > 1) {
        if (hasZero) {
            multiGroup.style.display = 'block';
            multiField.setAttribute('required', 'required');
            if (multiSavedGroup && multiSavedGroup.querySelector('p') && multiSavedGroup.querySelector('p').textContent.trim()) {
                multiSavedGroup.style.display = 'block';
            }
        } else {
            multiGroup.style.display = 'none';
            multiField.removeAttribute('required');
            if (multiSavedGroup) {
                multiSavedGroup.style.display = 'none';
            }
        }
    }

    // Single-item form fields
    if (singleGroup && singleField && quantityInputs.length === 1) {
        if (hasZero) {
            singleGroup.style.display = 'block';
            singleField.setAttribute('required', 'required');
            if (singleSavedGroup && singleSavedGroup.querySelector('p') && singleSavedGroup.querySelector('p').textContent.trim()) {
                singleSavedGroup.style.display = 'block';
            }
        } else {
            singleGroup.style.display = 'none';
            singleField.removeAttribute('required');
            if (singleSavedGroup) {
                singleSavedGroup.style.display = 'none';
            }
        }
    }
}

// Store original quantity values for unsaved edits detection
let originalQuantityValues = {};

// Function to ensure original values are stored (call this before checking)
function ensureOriginalValuesStored() {
    // Store assigned procurement quantity values if not already stored
    const allQuantityForms = document.querySelectorAll('form[action*="update_quantities"]');
    for (let form of allQuantityForms) {
        const action = form.getAttribute('action') || '';
        // Skip manager and procurement manager forms
        if (action.includes('update_quantities_manager') || 
            action.includes('update_quantities_procurement_manager')) {
            continue;
        }
        // This is the assigned procurement form
        const quantityInputs = form.querySelectorAll('input[name="quantities[]"]');
        quantityInputs.forEach(input => {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            if (originalQuantityValues['assigned_' + index] === undefined) {
                originalQuantityValues['assigned_' + index] = parseInt(input.value || '0', 10);
            }
        });
        break;
    }
    
    // Also check inputs directly by ID (fallback)
    let index = 0;
    while (true) {
        const input = document.getElementById('cart_qty_' + index);
        if (!input) break;
        const form = input.closest('form');
        if (form) {
            const action = form.getAttribute('action') || '';
            if (action.includes('update_quantities_manager') || 
                action.includes('update_quantities_procurement_manager')) {
                index++;
                continue;
            }
        }
        if (input.name === 'quantities[]' && originalQuantityValues['assigned_' + index] === undefined) {
            originalQuantityValues['assigned_' + index] = parseInt(input.value || '0', 10);
        }
        index++;
    }
}

// Function to show error dialog (similar to flash error modal)
function showQuantityEditErrorDialog() {
    // Create error modal if it doesn't exist
    let errorModal = document.getElementById('quantity-edit-error-modal');
    if (!errorModal) {
        errorModal = document.createElement('div');
        errorModal.id = 'quantity-edit-error-modal';
        errorModal.className = 'flash-error-modal';
        errorModal.style.display = 'flex';
        errorModal.innerHTML = `
            <div class="flash-error-backdrop"></div>
            <div class="flash-error-dialog">
                <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
                <div class="flash-error-body">
                    You have unsaved quantity edits. Please save your quantity edits before approving, rejecting, or marking the request as completed.
                </div>
                <div class="flash-error-actions">
                    <button type="button" class="flash-error-ok-btn" onclick="closeQuantityEditErrorDialog()">OK</button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
        document.body.classList.add('flash-error-open');
    } else {
        errorModal.style.display = 'flex';
        document.body.classList.add('flash-error-open');
    }
}

// Function to close error dialog
function closeQuantityEditErrorDialog() {
    const errorModal = document.getElementById('quantity-edit-error-modal');
    if (errorModal) {
        errorModal.style.display = 'none';
        document.body.classList.remove('flash-error-open');
    }
    
    // Reset Mark as Completed button state if it was changed to PROCESSING
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        const submitButton = itemRequestCompleteForm.querySelector('button[type="submit"]');
        if (submitButton && submitButton.innerHTML.includes('Processing')) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-check"></i> Mark as Completed';
        }
    }
}

// Function to show amount validation error dialog
function showAmountValidationErrorDialog() {
    // Create error modal if it doesn't exist
    let errorModal = document.getElementById('amount-validation-error-modal');
    if (!errorModal) {
        errorModal = document.createElement('div');
        errorModal.id = 'amount-validation-error-modal';
        errorModal.className = 'flash-error-modal';
        errorModal.style.display = 'flex';
        errorModal.innerHTML = `
            <div class="flash-error-backdrop"></div>
            <div class="flash-error-dialog">
                <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
                <div class="flash-error-body">
                    Please fill in all amount fields before saving quantities and amounts.
                </div>
                <div class="flash-error-actions">
                    <button type="button" class="flash-error-ok-btn" onclick="closeAmountValidationErrorDialog()">OK</button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
        document.body.classList.add('flash-error-open');
    } else {
        errorModal.style.display = 'flex';
        document.body.classList.add('flash-error-open');
    }
}

// Function to close amount validation error dialog
function closeAmountValidationErrorDialog() {
    const errorModal = document.getElementById('amount-validation-error-modal');
    if (errorModal) {
        errorModal.style.display = 'none';
        document.body.classList.remove('flash-error-open');
    }
    
    // Reset Mark as Completed button state if it was changed to PROCESSING
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        const submitButton = itemRequestCompleteForm.querySelector('button[type="submit"]');
        if (submitButton && submitButton.innerHTML.includes('Processing')) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-check"></i> Mark as Completed';
        }
    }
}

// Function to show rejection reason error dialog (assigned procurement)
function showAssignedRejectionReasonErrorDialog(message) {
    let errorModal = document.getElementById('assigned-rejection-error-modal');
    if (!errorModal) {
        errorModal = document.createElement('div');
        errorModal.id = 'assigned-rejection-error-modal';
        errorModal.className = 'flash-error-modal';
        errorModal.style.display = 'flex';
        errorModal.innerHTML = `
            <div class="flash-error-backdrop"></div>
            <div class="flash-error-dialog">
                <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
                <div class="flash-error-body">
                    ${message || 'Please provide a reason for rejecting the item(s) with quantity set to 0.'}
                </div>
                <div class="flash-error-actions">
                    <button type="button" class="flash-error-ok-btn" onclick="closeAssignedRejectionReasonErrorDialog()">OK</button>
                </div>
            </div>
        `;
        document.body.appendChild(errorModal);
        document.body.classList.add('flash-error-open');
    } else {
        const body = errorModal.querySelector('.flash-error-body');
        if (body) {
            body.innerHTML = message || 'Please provide a reason for rejecting the item(s) with quantity set to 0.';
        }
        errorModal.style.display = 'flex';
        document.body.classList.add('flash-error-open');
    }
}

function closeAssignedRejectionReasonErrorDialog() {
    const errorModal = document.getElementById('assigned-rejection-error-modal');
    if (errorModal) {
        errorModal.style.display = 'none';
        document.body.classList.remove('flash-error-open');
    }
}

// Unified validation error modal for Mark as Completed
function showMarkCompleteValidationErrorDialog(message) {
    // Remove any existing modal to avoid duplicates
    const existing = document.getElementById('mark-complete-error-modal');
    if (existing) {
        existing.remove();
    }

    const errorModal = document.createElement('div');
    errorModal.id = 'mark-complete-error-modal';
    errorModal.className = 'flash-error-modal';
    errorModal.style.display = 'flex';
    errorModal.innerHTML = `
        <div class="flash-error-backdrop"></div>
        <div class="flash-error-dialog">
            <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
            <div class="flash-error-body">
                ${message || 'Please fix the highlighted issues before completing the request.'}
            </div>
            <div class="flash-error-actions">
                <button type="button" class="flash-error-ok-btn" onclick="closeMarkCompleteValidationErrorDialog()">OK</button>
            </div>
        </div>
    `;
    document.body.appendChild(errorModal);
    document.body.classList.add('flash-error-open');
}

function closeMarkCompleteValidationErrorDialog() {
    const errorModal = document.getElementById('mark-complete-error-modal');
    if (errorModal) {
        errorModal.style.display = 'none';
        document.body.classList.remove('flash-error-open');
    }
}

// Function to show receipt upload error dialog (matches server-side flash error modal exactly)
function showReceiptUploadErrorDialog(message) {
    // Remove any existing receipt upload error modal
    const existingModal = document.getElementById('receipt-upload-error-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create new error modal matching the EXACT structure of server-side flash-error-modal from base.html
    const errorModal = document.createElement('div');
    errorModal.id = 'receipt-upload-error-modal';
    errorModal.className = 'flash-error-modal';
    errorModal.style.display = 'flex';
    
    // Match the exact HTML structure from base.html line 272-282
    errorModal.innerHTML = `
        <div class="flash-error-backdrop"></div>
        <div class="flash-error-dialog">
            <h3 class="flash-error-title"><i class="fas fa-exclamation-circle"></i> Error</h3>
            <div class="flash-error-body">
                ${message}
            </div>
            <div class="flash-error-actions">
                <button type="button" class="flash-error-ok-btn" onclick="closeReceiptUploadErrorDialog()">OK</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(errorModal);
    document.body.classList.add('flash-error-open');
}

// Function to close receipt upload error dialog
function closeReceiptUploadErrorDialog() {
    const errorModal = document.getElementById('receipt-upload-error-modal');
    if (errorModal) {
        errorModal.style.display = 'none';
        document.body.classList.remove('flash-error-open');
    }
    
    // Reset Mark as Completed button state if it was changed to PROCESSING
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        const submitButton = itemRequestCompleteForm.querySelector('button[type="submit"]');
        if (submitButton && submitButton.innerHTML.includes('Processing')) {
            submitButton.disabled = false;
            submitButton.innerHTML = '<i class="fas fa-check"></i> Mark as Completed';
        }
    }
}

// Function to show success modal (matching error modal style but green)
function showSuccessDialog(message) {
    // Remove any existing success modal
    const existingModal = document.getElementById('success-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Create new success modal matching the error modal structure
    const successModal = document.createElement('div');
    successModal.id = 'success-modal';
    successModal.className = 'flash-success-modal';
    successModal.style.display = 'flex';
    
    successModal.innerHTML = `
        <div class="flash-success-backdrop"></div>
        <div class="flash-success-dialog">
            <h3 class="flash-success-title"><i class="fas fa-check-circle"></i> Success</h3>
            <div class="flash-success-body">
                ${message}
            </div>
            <div class="flash-success-actions">
                <button type="button" class="flash-success-ok-btn" onclick="closeSuccessDialog()">OK</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(successModal);
    document.body.classList.add('flash-success-open');
}

// Function to close success modal
function closeSuccessDialog() {
    const successModal = document.getElementById('success-modal');
    if (successModal) {
        successModal.style.display = 'none';
        document.body.classList.remove('flash-success-open');
    }
}

// Function to check if there are unsaved quantity edits
function hasUnsavedQuantityEdits() {
    // Ensure original values are stored before checking
    ensureOriginalValuesStored();
    
    // Check manager quantity form
    const managerForm = document.querySelector('form[action*="update_quantities_manager"]');
    if (managerForm) {
        const quantityInputs = managerForm.querySelectorAll('input[name="quantities[]"]');
        for (let input of quantityInputs) {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            const currentValue = parseInt(input.value || '0', 10);
            const originalValue = originalQuantityValues['manager_' + index];
            if (originalValue !== undefined && currentValue !== originalValue) {
                return true;
            }
        }
    }
    
    // Check procurement manager quantity form
    const procurementManagerForm = document.querySelector('form[action*="update_quantities_procurement_manager"]');
    if (procurementManagerForm) {
        const quantityInputs = procurementManagerForm.querySelectorAll('input[name="quantities[]"]');
        for (let input of quantityInputs) {
            const index = input.getAttribute('data-index') || input.id.replace('procurement_cart_qty_', '');
            const currentValue = parseInt(input.value || '0', 10);
            const originalValue = originalQuantityValues['procurement_manager_' + index];
            if (originalValue !== undefined && currentValue !== originalValue) {
                return true;
            }
        }
    }
    
    // Check assigned procurement quantity form (for assigned procurement staff)
    // This form has action containing "update_quantities" but NOT "manager" or "procurement_manager"
    const allForms = document.querySelectorAll('form[action*="update_quantities"]');
    for (let form of allForms) {
        const action = form.getAttribute('action') || '';
        // Skip manager and procurement manager forms
        if (action.includes('update_quantities_manager') || 
            action.includes('update_quantities_procurement_manager')) {
            continue;
        }
        // This is the assigned procurement form
        // Check ALL inputs (including those in editable wrappers that might be hidden)
        const quantityInputs = form.querySelectorAll('input[name="quantities[]"]');
        for (let input of quantityInputs) {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            const currentValue = parseInt(input.value || '0', 10);
            const originalValue = originalQuantityValues['assigned_' + index];
            // Check if value has changed from original
            if (originalValue !== undefined && currentValue !== originalValue) {
                return true;
            }
        }
    }
    
    // Also check inputs directly by ID pattern (fallback if form not found)
    // This handles cases where form might not be found or inputs are outside form context
    let index = 0;
    while (true) {
        const input = document.getElementById('cart_qty_' + index);
        if (!input) break;
        // Make sure it's not in a manager or procurement manager form
        const form = input.closest('form');
        if (form) {
            const action = form.getAttribute('action') || '';
            if (action.includes('update_quantities_manager') || 
                action.includes('update_quantities_procurement_manager')) {
                index++;
                continue;
            }
        }
        // Check if this input is for assigned procurement (has name="quantities[]" and is in assigned procurement form)
        if (input.name === 'quantities[]') {
            const currentValue = parseInt(input.value || '0', 10);
            const originalValue = originalQuantityValues['assigned_' + index];
            if (originalValue !== undefined && currentValue !== originalValue) {
                return true;
            }
        }
        index++;
    }
    
    return false;
}

// Handle Edited badge click for quantity edits and form validation
document.addEventListener('DOMContentLoaded', function() {
    // Store original quantity values on page load
    // Manager quantities
    const managerForm = document.querySelector('form[action*="update_quantities_manager"]');
    if (managerForm) {
        const quantityInputs = managerForm.querySelectorAll('input[name="quantities[]"]');
        const managerSubmitButton = managerForm.querySelector('button[type="submit"]');
        if (managerSubmitButton && !managerSubmitButton.dataset.originalLabel) {
            managerSubmitButton.dataset.originalLabel = managerSubmitButton.innerHTML;
        }
        quantityInputs.forEach(input => {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            originalQuantityValues['manager_' + index] = parseInt(input.value || '0', 10);
            updateCartQuantityState(index); // initialize row state (color/notes/rejection toggle)
        });
        
        managerForm.addEventListener('submit', function(e) {
            // Force return to Manager tab after post-back
            try {
                const actionUrl = new URL(this.action, window.location.origin);
                actionUrl.searchParams.set('tab', 'manager');
                this.action = actionUrl.toString();
            } catch (err) {
                // no-op if URL construction fails
            }
            // Check if any quantity is 0
            const quantityInputs = this.querySelectorAll('input[name="quantities[]"]');
            let hasZero = false;
            const resetSubmitButton = () => {
                if (managerSubmitButton) {
                    managerSubmitButton.disabled = false;
                    managerSubmitButton.innerHTML = managerSubmitButton.dataset.originalLabel || managerSubmitButton.innerHTML;
                }
            };
            quantityInputs.forEach(input => {
                const qty = parseInt(input.value || '0', 10);
                if (qty === 0) {
                    hasZero = true;
                }
            });
            
            if (hasZero) {
                const rejectionField = this.querySelector('textarea[name="quantity_rejection_reason"]');
                if (rejectionField && !rejectionField.value.trim()) {
                    e.preventDefault();
                    resetSubmitButton();
                    alert('Please provide a reason for rejecting the item(s) with quantity set to 0.');
                    rejectionField.focus();
                    return false;
                }
            }
            
            // Update original values after successful save
            quantityInputs.forEach(input => {
                const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
                originalQuantityValues['manager_' + index] = parseInt(input.value || '0', 10);
            });
        });
    }
    
    // Procurement manager quantity form validation
    const procurementManagerForm = document.querySelector('form[action*="update_quantities_procurement_manager"]');
    if (procurementManagerForm) {
        const quantityInputs = procurementManagerForm.querySelectorAll('input[name="quantities[]"]');
        const procurementManagerSubmitButton = procurementManagerForm.querySelector('button[type="submit"]');
        if (procurementManagerSubmitButton && !procurementManagerSubmitButton.dataset.originalLabel) {
            procurementManagerSubmitButton.dataset.originalLabel = procurementManagerSubmitButton.innerHTML;
        }
        quantityInputs.forEach(input => {
            const index = input.getAttribute('data-index') || input.id.replace('procurement_cart_qty_', '');
            originalQuantityValues['procurement_manager_' + index] = parseInt(input.value || '0', 10);
        });
        
        procurementManagerForm.addEventListener('submit', function(e) {
            // Check if any quantity is 0
            const quantityInputs = this.querySelectorAll('input[name="quantities[]"]');
            let hasZero = false;
            const resetSubmitButton = () => {
                if (procurementManagerSubmitButton) {
                    procurementManagerSubmitButton.disabled = false;
                    procurementManagerSubmitButton.innerHTML = procurementManagerSubmitButton.dataset.originalLabel || procurementManagerSubmitButton.innerHTML;
                }
            };
            quantityInputs.forEach(input => {
                const qty = parseInt(input.value || '0', 10);
                if (qty === 0) {
                    hasZero = true;
                }
            });
            
            if (hasZero) {
                const rejectionField = this.querySelector('textarea[name="quantity_rejection_reason"]');
                if (rejectionField && !rejectionField.value.trim()) {
                    e.preventDefault();
                    resetSubmitButton();
                    alert('Please provide a reason for rejecting the item(s) with quantity set to 0.');
                    rejectionField.focus();
                    return false;
                }
            }
            
            // Update original values after successful save
            quantityInputs.forEach(input => {
                const index = input.getAttribute('data-index') || input.id.replace('procurement_cart_qty_', '');
                originalQuantityValues['procurement_manager_' + index] = parseInt(input.value || '0', 10);
            });
        });
    }
    
    // Store original values for assigned procurement quantities
    // Find the form that has "update_quantities" but NOT "manager" or "procurement_manager"
    const allQuantityForms = document.querySelectorAll('form[action*="update_quantities"]');
    for (let form of allQuantityForms) {
        const action = form.getAttribute('action') || '';
        // Skip manager and procurement manager forms
        if (action.includes('update_quantities_manager') || 
            action.includes('update_quantities_procurement_manager')) {
            continue;
        }
        // This is the assigned procurement form
        // Get all quantity inputs, including those in editable wrappers
        const quantityInputs = form.querySelectorAll('input[name="quantities[]"]');
        quantityInputs.forEach(input => {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            const value = parseInt(input.value || '0', 10);
            // Store original value (only if not already stored)
            if (originalQuantityValues['assigned_' + index] === undefined) {
                originalQuantityValues['assigned_' + index] = value;
            }
        });
        // Track amount inputs for total calculation
        const amountInputs = form.querySelectorAll('input[name="amounts[]"]');
        amountInputs.forEach(input => {
            input.addEventListener('input', calculateAssignedProcurementTotal);
            input.addEventListener('change', calculateAssignedProcurementTotal);
        });
        calculateAssignedProcurementTotal();
        
        // Validation function that can be called from both form submit and button click
        const validateAndSubmit = function(formElement) {
            const quantityInputs = formElement.querySelectorAll('input[name="quantities[]"]');
            let hasZero = false;
            quantityInputs.forEach(input => {
                const qty = parseInt(input.value || '0', 10);
                if (qty === 0) {
                    hasZero = true;
                }
            });

            if (hasZero) {
                const rejectionField = formElement.querySelector('#assigned_quantity_rejection_reason') ||
                                        formElement.querySelector('#assigned_quantity_rejection_reason_single') ||
                                        formElement.querySelector('textarea[name="quantity_rejection_reason"]');
                if (rejectionField && !rejectionField.value.trim()) {
                    checkAssignedProcurementRejectionReasonRequired();
                    showAssignedRejectionReasonErrorDialog('Please provide a reason for rejecting the item(s) with quantity set to 0.');
                    rejectionField.focus();
                    return false;
                }
            }

            // For Save Quantities & Amounts: allow blank/zero amounts; only update originals after submit
            quantityInputs.forEach(input => {
                const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
                originalQuantityValues['assigned_' + index] = parseInt(input.value || '0', 10);
            });
            
            return true; // Validation passed
        };
        
        // Form submit handler - ALWAYS validates before submission
        const submitHandler = function(e) {
            // Prevent the default submit so we control validation
            if (e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
            }
            
            // Run validation - MUST pass before submission
            if (!validateAndSubmit(this)) {
                return false; // Validation failed, STOP - don't submit
            }
            
            // Validation passed - temporarily remove handler to avoid recursion then submit
            this.removeEventListener('submit', submitHandler, true);
            this.submit();
            return false;
        };
        
        // Attach form submit handler with capture phase to run first
        form.addEventListener('submit', submitHandler, true);
        
        // ALSO attach button click handler(s) - buttons are type="button" so they won't auto-submit
        const submitButtons = form.querySelectorAll('button.save-quantities-amounts-btn');
        submitButtons.forEach(btn => {
            // Avoid double-binding if the script runs multiple times
            if (btn.dataset.amountHandlerBound === 'true') {
                return;
            }
            btn.dataset.amountHandlerBound = 'true';
            
            btn.addEventListener('click', function(e) {
                // Prevent default button behavior
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Validate amounts
                if (!validateAndSubmit(form)) {
                    return false; // show modal already handled inside validation
                }
                
                // Submit normally (submit event will fire and be handled)
                form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                return false;
            }, true); // Use capture phase to run first
        });
        
        // Initialize quantity state on page load (to show red item names for zero quantities)
        const qtyInputs = form.querySelectorAll('input[name="quantities[]"]');
        qtyInputs.forEach(input => {
            const index = input.getAttribute('data-index') || input.id.replace('cart_qty_', '');
            updateCartQuantityState(index);
        });
    }
    
    // Also store values by checking inputs directly (fallback)
    let index = 0;
    while (true) {
        const input = document.getElementById('cart_qty_' + index);
        if (!input) break;
        // Make sure it's not in a manager or procurement manager form
        const form = input.closest('form');
        if (form) {
            const action = form.getAttribute('action') || '';
            if (action.includes('update_quantities_manager') || 
                action.includes('update_quantities_procurement_manager')) {
                index++;
                continue;
            }
        }
        // Store original value if not already stored
        if (originalQuantityValues['assigned_' + index] === undefined) {
            originalQuantityValues['assigned_' + index] = parseInt(input.value || '0', 10);
        }
        index++;
    }

    // Initialize visibility for assigned procurement rejection reason on load
    checkAssignedProcurementRejectionReasonRequired();
    
    // Validate manager decision form
    const managerDecisionForm = document.querySelector('form[action*="item_request_manager_decision"]');
    if (managerDecisionForm) {
        managerDecisionForm.addEventListener('submit', function(e) {
            if (hasUnsavedQuantityEdits()) {
                e.preventDefault();
                showQuantityEditErrorDialog();
                return false;
            }
        });
    }
    
    // Validate procurement manager decision form
    const procurementManagerDecisionForm = document.querySelector('form[action*="item_request_procurement_manager_decision"]');
    if (procurementManagerDecisionForm) {
        procurementManagerDecisionForm.addEventListener('submit', function(e) {
            if (hasUnsavedQuantityEdits()) {
                e.preventDefault();
                showQuantityEditErrorDialog();
                return false;
            }
        });
    }
    
    // Validate complete form
    const itemRequestCompleteForm = document.getElementById('item-request-complete-form');
    if (itemRequestCompleteForm) {
        const originalSubmitHandler = itemRequestCompleteForm.onsubmit;
        itemRequestCompleteForm.addEventListener('submit', function(e) {
            if (hasUnsavedQuantityEdits()) {
                e.preventDefault();
                showQuantityEditErrorDialog();
                return false;
            }
        });
    }
    
    // Initialize rejection reason fields on page load
    initializeProcurementManagerReasonFields();
    checkManagerRejectionReasonRequired();
    checkProcurementManagerRejectionReasonRequired();
    
    // Edited badge click -> fetch quantity history
    document.addEventListener('click', function(e) {
        const badge = e.target.closest('.edited-badge');
        if (!badge) return;
        const field = badge.getAttribute('data-field');
        if (field !== 'quantities') return;
        
        const requestId = {{ item_request.id }};
        fetch(`/api/item-request/${requestId}/quantity-history`)
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert(data.error || 'Failed to load history');
                    return;
                }
                openFieldHistoryModal('quantities', data.history || []);
            })
            .catch(() => alert('Failed to load history'));
    });

    // Ensure all tooltip icons (including item rows) get positioned on hover
    const positionTooltipWrapper = (tooltipWrapper) => {
        if (!tooltipWrapper) return;
        const icon = tooltipWrapper.querySelector('.tooltip-icon');
        const tooltip = tooltipWrapper.querySelector('.tooltip-text');
        if (!icon || !tooltip) return;
        const rect = icon.getBoundingClientRect();
        const tipHeight = tooltip.offsetHeight || 40;
        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
        tooltip.style.top = (rect.top - tipHeight - 8) + 'px';
    };

    const bindTooltipPositioning = (wrapper) => {
        if (!wrapper || wrapper.dataset.tooltipBound === 'true') return;
        wrapper.dataset.tooltipBound = 'true';
        ['mouseenter', 'touchstart'].forEach(evt => {
            wrapper.addEventListener(evt, () => positionTooltipWrapper(wrapper), { passive: true });
        });
        // Re-position on scroll/resize while visible
        ['scroll', 'resize'].forEach(evt => {
            window.addEventListener(evt, () => {
                const tooltip = wrapper.querySelector('.tooltip-text');
                if (tooltip && tooltip.style.visibility === 'visible') {
                    positionTooltipWrapper(wrapper);
                }
            });
        });
    };

    document.querySelectorAll('.tooltip-wrapper').forEach(bindTooltipPositioning);
});

function openFieldHistoryModal(field, history) {
    const modal = document.getElementById('fieldHistoryModal');
    const title = document.getElementById('fieldHistoryTitle');
    const body = document.getElementById('fieldHistoryBody');
    title.textContent = 'Edit History — Item Quantities';
    if (!history.length) {
        body.innerHTML = '<p style="margin:0; color:#666;">No edits recorded for quantities.</p>';
    } else {
        body.innerHTML = history.map(h => {
            // Parse old and new values to find changed items
            const oldLines = (h.old_value || '').split('\n');
            const newLines = (h.new_value || '').split('\n');
            
            // Create a map of item name to quantities for comparison
            const oldMap = {};
            const newMap = {};
            
            oldLines.forEach(line => {
                if (line.trim()) {
                    const match = line.match(/^(.+?):\s*(.+)$/);
                    if (match) {
                        oldMap[match[1].trim()] = match[2].trim();
                    }
                }
            });
            
            newLines.forEach(line => {
                if (line.trim()) {
                    const match = line.match(/^(.+?):\s*(.+)$/);
                    if (match) {
                        newMap[match[1].trim()] = match[2].trim();
                    }
                }
            });
            
            // Format old value with red highlighting for changed items
            const oldValueFormatted = oldLines.map(line => {
                if (!line.trim()) return '<br>';
                const match = line.match(/^(.+?):\s*(.+)$/);
                if (match) {
                    const itemName = match[1].trim();
                    const qty = match[2].trim();
                    // Check if this item changed
                    if (newMap[itemName] && newMap[itemName] !== qty) {
                        return `<span style="color: #dc3545; font-weight: 600;">${escapeHtml(line)}</span><br>`;
                    }
                }
                return escapeHtml(line) + '<br>';
            }).join('');
            
            // Format new value with red highlighting for changed items
            const newValueFormatted = newLines.map(line => {
                if (!line.trim()) return '<br>';
                const match = line.match(/^(.+?):\s*(.+)$/);
                if (match) {
                    const itemName = match[1].trim();
                    const qty = match[2].trim();
                    // Check if this item changed
                    if (oldMap[itemName] && oldMap[itemName] !== qty) {
                        return `<span style="color: #dc3545; font-weight: 600;">${escapeHtml(line)}</span><br>`;
                    }
                }
                return escapeHtml(line) + '<br>';
            }).join('');
            
            return `
                <div class="history-row">
                    <div class="history-meta">
                        <span class="history-user">${escapeHtml(h.edited_by || 'Unknown')}</span>
                        <span class="history-time">${escapeHtml(h.edited_at || '')}</span>
                    </div>
                    <div class="history-values">
                        <div><strong>From:</strong><br>${oldValueFormatted}</div>
                        <div><strong>To:</strong><br>${newValueFormatted}</div>
                    </div>
                </div>
            `;
        }).join('');
    }
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeFieldHistoryModal() {
    const modal = document.getElementById('fieldHistoryModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
}

function escapeHtml(s) {
    return String(s).replace(/[&<>"]/g, function(c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
    });
}

// Go back to the previous page (item requests list, reports, etc.) with all parameters preserved
document.addEventListener('DOMContentLoaded', function() {
    const backButton = document.getElementById('back-to-item-requests-btn');
    if (backButton) {
        const urlParams = new URLSearchParams(window.location.search);
        const returnUrl = urlParams.get('return_url');
        const currentUrl = new URL(window.location.href);
        const currentPathname = currentUrl.pathname;
        
        // First check sessionStorage for stored return URL
        let storedReturnUrl = sessionStorage.getItem('procurement_item_requests_return_url');
        
        // Validate stored URL - make sure it's not the same page
        if (storedReturnUrl) {
            try {
                const storedUrl = new URL(storedReturnUrl);
                if (storedUrl.pathname === currentPathname) {
                    // Same page - clear it and don't use it
                    sessionStorage.removeItem('procurement_item_requests_return_url');
                    storedReturnUrl = null;
                }
            } catch (e) {
                // Invalid URL - clear it
                sessionStorage.removeItem('procurement_item_requests_return_url');
                storedReturnUrl = null;
            }
        }
        
        if (storedReturnUrl) {
            backButton.href = storedReturnUrl;
        } else if (returnUrl) {
            // Use return_url from URL parameter
            try {
                const decodedUrl = decodeURIComponent(returnUrl);
                const decodedUrlObj = new URL(decodedUrl, window.location.origin);
                // Validate it's not the same page
                if (decodedUrlObj.pathname !== currentPathname) {
                    backButton.href = decodedUrl;
                }
            } catch (e) {
                console.log('Could not decode return_url');
            }
        } else if (document.referrer) {
            // Use referrer as fallback, but exclude action URLs
            try {
                const referrerUrl = new URL(document.referrer);
                
                if (referrerUrl.origin === currentUrl.origin &&
                    !referrerUrl.pathname.includes('/approve') &&
                    !referrerUrl.pathname.includes('/reject') &&
                    !referrerUrl.pathname.includes('/complete') &&
                    !referrerUrl.pathname.includes('/assign') &&
                    !referrerUrl.pathname.includes('/edit') &&
                    referrerUrl.pathname !== currentPathname) {
                    backButton.href = document.referrer;
                }
            } catch (e) {
                console.log('Could not parse referrer URL');
            }
        }
        // If no return URL found, the button will use the default procurement_item_requests URL
    }
});

</script>
{% endblock %}

