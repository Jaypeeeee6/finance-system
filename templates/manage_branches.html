{% extends "base.html" %}

{% block title %}Manage Branches{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-building"></i> Manage Branches</h1>
        <p>Manage company branch locations</p>
    </div>

    <div class="dashboard-actions">
        <a href="{{ url_for('add_branch') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Branch
        </a>
        <a href="{{ url_for('it_dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to IT Dashboard
        </a>
    </div>

    <!-- Bulk Actions -->
    <div id="bulkActions" class="bulk-actions" style="display: none;">
        <div class="bulk-actions-content">
            <div class="bulk-actions-info">
                <span id="selectedCount">0</span> branch(es) selected
            </div>
            <div class="bulk-actions-buttons">
                <button type="button" class="btn btn-sm btn-outline" onclick="selectAll()">
                    <i class="fas fa-check-square"></i> Select All
                </button>
                <button type="button" class="btn btn-sm btn-outline" onclick="selectNone()">
                    <i class="fas fa-square"></i> Select None
                </button>
                <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
                    <i class="fas fa-trash"></i> Delete Selected
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div class="header-top">
                <div class="filter-controls">
                    <input type="text" id="searchInput" placeholder="Search..." class="form-control" value="{{ search_query }}">
                    <select id="restaurantFilter" class="form-select">
                        <option value="">All Locations</option>
                        <option value="Kucu" {% if restaurant_filter == 'Kucu' %}selected{% endif %}>Kucu</option>
                        <option value="Boom" {% if restaurant_filter == 'Boom' %}selected{% endif %}>Boom</option>
                        <option value="Thoum" {% if restaurant_filter == 'Thoum' %}selected{% endif %}>Thoum</option>
                        <option value="Kitchen" {% if restaurant_filter == 'Kitchen' %}selected{% endif %}>Kitchen</option>
                        <option value="Office" {% if restaurant_filter == 'Office' %}selected{% endif %}>Office</option>
                    </select>
                    <button type="button" class="btn btn-primary" onclick="filterBranchesTable()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <h2><i class="fas fa-building"></i> Branches</h2>
            </div>
            <div class="card-header-actions">
                {% if search_query or restaurant_filter %}
                <div class="filter-indicator">
                    {% if search_query %}
                    <span class="badge" style="background: #f57c00; color: white;">
                        <i class="fas fa-search"></i> Search: {{ search_query }}
                    </span>
                    {% endif %}
                    {% if restaurant_filter %}
                    <span class="badge" style="background: #17a2b8; color: white;">
                        <i class="fas fa-map-marker-alt"></i> Location: {{ restaurant_filter }}
                    </span>
                    {% endif %}
                    <a href="{{ url_for('manage_branches') }}" class="btn btn-sm btn-outline">
                        <i class="fas fa-times"></i> Clear All
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            {% if branches %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                                </th>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Status</th>
                                <th>Created By</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for branch in branches %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="row-checkbox" value="{{ branch.id }}" onchange="updateBulkActions()">
                                </td>
                                <td>{{ branch.id }}</td>
                                <td><strong>{{ branch.name }}</strong></td>
                                <td>
                                    <span class="badge badge-info">
                                        <i class="fas fa-map-marker-alt"></i> {{ branch.restaurant }}
                                    </span>
                                </td>
                                <td>
                                    {% if branch.is_active %}
                                        <span class="badge badge-success">
                                            <i class="fas fa-check-circle"></i> Active
                                        </span>
                                    {% else %}
                                        <span class="badge badge-danger">
                                            <i class="fas fa-times-circle"></i> Inactive
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ branch.created_by.name if branch.created_by else 'System' }}</td>
                                <td>{{ branch.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('edit_branch', branch_id=branch.id) }}" class="btn btn-sm btn-outline" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('toggle_branch', branch_id=branch.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to {{ 'deactivate' if branch.is_active else 'activate' }} this branch?')">
                                            <button type="submit" class="btn btn-sm btn-outline" title="{{ 'Deactivate' if branch.is_active else 'Activate' }}">
                                                <i class="fas fa-{{ 'pause' if branch.is_active else 'play' }}"></i>
                                            </button>
                                        </form>
                                        <form method="POST" action="{{ url_for('delete_branch', branch_id=branch.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this branch? This action cannot be undone.')">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <div class="pagination-container">
                    <div class="pagination-info">
                        Showing {{ pagination.page * pagination.per_page - pagination.per_page + 1 }} to 
                        {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
                        of {{ pagination.total }} branches
                    </div>
                    <div class="pagination">
                        {% if pagination.has_prev %}
                            <a href="{{ url_for('manage_branches', page=pagination.prev_num, search=search_query, restaurant=restaurant_filter) }}" class="btn btn-outline">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        {% endif %}
                        
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != pagination.page %}
                                    <a href="{{ url_for('manage_branches', page=page_num, search=search_query, restaurant=restaurant_filter) }}" class="btn btn-outline">{{ page_num }}</a>
                                {% else %}
                                    <span class="btn btn-primary">{{ page_num }}</span>
                                {% endif %}
                            {% else %}
                                <span class="btn btn-outline disabled">...</span>
                            {% endif %}
                        {% endfor %}
                        
                        {% if pagination.has_next %}
                            <a href="{{ url_for('manage_branches', page=pagination.next_num, search=search_query, restaurant=restaurant_filter) }}" class="btn btn-outline">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-building"></i>
                    <h3>No Branches Found</h3>
                    <p>No branches match your current search criteria.</p>
                    {% if search_query %}
                        <a href="{{ url_for('manage_branches') }}" class="btn btn-outline">
                            <i class="fas fa-times"></i> Clear Search
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bulk Delete Form -->
<form id="bulkDeleteForm" method="POST" action="{{ url_for('bulk_delete_branches') }}" style="display: none;">
    <input type="hidden" name="branch_ids" id="bulkDeleteIds">
</form>

<script>
let selectedBranches = new Set();

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.row-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (selectAllCheckbox.checked) {
            selectedBranches.add(checkbox.value);
        } else {
            selectedBranches.delete(checkbox.value);
        }
    });
    
    updateBulkActions();
}

function selectAll() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = true;
        selectedBranches.add(checkbox.value);
    });
    selectAllCheckbox.checked = true;
    
    updateBulkActions();
}

function selectNone() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = false;
        selectedBranches.delete(checkbox.value);
    });
    selectAllCheckbox.checked = false;
    
    updateBulkActions();
}

function updateBulkActions() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    
    selectedBranches.clear();
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            selectedBranches.add(checkbox.value);
        }
    });
    
    if (selectedBranches.size > 0) {
        bulkActions.style.display = 'block';
        selectedCount.textContent = selectedBranches.size;
        bulkDeleteBtn.disabled = false;
    } else {
        bulkActions.style.display = 'none';
        bulkDeleteBtn.disabled = true;
    }
    
    // Update select all checkbox state
    if (selectedBranches.size === checkboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedBranches.size > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

function bulkDelete() {
    if (selectedBranches.size === 0) {
        alert('Please select branches to delete.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedBranches.size} branch(es)? This action cannot be undone.`)) {
        document.getElementById('bulkDeleteIds').value = Array.from(selectedBranches).join(',');
        document.getElementById('bulkDeleteForm').submit();
    }
}

function filterBranchesTable() {
    console.log('filterBranchesTable called'); // Debug log
    const searchInput = document.getElementById('searchInput');
    const restaurantFilter = document.getElementById('restaurantFilter');
    
    if (!searchInput || !restaurantFilter) {
        console.error('Search input or restaurant filter not found');
        return;
    }
    
    const searchValue = searchInput.value.trim();
    const restaurantValue = restaurantFilter.value;
    
    console.log('Search value:', searchValue, 'Restaurant value:', restaurantValue); // Debug log
    
    let url = '{{ url_for("manage_branches") }}?';
    const params = [];
    
    if (searchValue) {
        params.push(`search=${encodeURIComponent(searchValue)}`);
    }
    
    if (restaurantValue) {
        params.push(`restaurant=${encodeURIComponent(restaurantValue)}`);
    }
    
    if (params.length > 0) {
        url += params.join('&');
    } else {
        url = '{{ url_for("manage_branches") }}';
    }
    
    console.log('Redirecting to:', url); // Debug log
    window.location.href = url;
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing manage branches page');
    
    // Handle search input - trigger on both Enter key and input change
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        console.log('Search input found');
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                console.log('Enter key pressed');
                filterBranchesTable();
            }
        });
        
        // Also trigger on input change with debounce
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                console.log('Search input changed');
                filterBranchesTable();
            }, 500); // 500ms delay
        });
    } else {
        console.error('Search input not found');
    }

    // Handle restaurant filter change
    const restaurantFilter = document.getElementById('restaurantFilter');
    if (restaurantFilter) {
        console.log('Restaurant filter found');
        restaurantFilter.addEventListener('change', function() {
            console.log('Restaurant filter changed');
            filterBranchesTable();
        });
    } else {
        console.error('Restaurant filter not found');
    }

    // Initialize bulk actions state
    updateBulkActions();
});
</script>
{% endblock %}
