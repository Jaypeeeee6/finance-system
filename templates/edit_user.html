{% extends "base.html" %}

{% block title %}Edit User{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-user-edit"></i> Edit User</h1>
        <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Users
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>Edit User: {{ user_to_edit.username }}</h2>
        </div>
        <div class="card-body">
            <div class="alert alert-info" style="margin-bottom: 1.5rem;">
                <strong>Note:</strong> Email address cannot be changed. Leave password field empty to keep current password.
            </div>

            <form method="POST" action="{{ url_for('edit_user', user_id=user_to_edit.user_id) }}">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">Full Name *</label>
                        <input type="text" name="name" id="name" value="{{ user_to_edit.name }}" required>
                        <small>User's full name as it will appear in the system</small>
                    </div>

                    <div class="form-group">
                        <label for="username">Email Address</label>
                        <input type="email" name="username" id="username" value="{{ user_to_edit.username }}" readonly>
                        <small>Email address cannot be changed</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="password">New Password (Optional)</label>
                        <input type="password" name="password" id="password" minlength="6">
                        <small>Leave empty to keep current password. Minimum 6 characters if changing.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select name="department" id="department" required>
                            <option value="">-- Select Department --</option>
                            <option value="HR" {% if user_to_edit.department == 'HR' %}selected{% endif %}>HR</option>
                            <option value="Finance" {% if user_to_edit.department == 'Finance' %}selected{% endif %}>Finance</option>
                            <option value="IT" {% if user_to_edit.department == 'IT' %}selected{% endif %}>IT</option>
                            <option value="Purchasing" {% if user_to_edit.department == 'Purchasing' %}selected{% endif %}>Purchasing</option>
                            <option value="PR" {% if user_to_edit.department == 'PR' %}selected{% endif %}>PR</option>
                            <option value="Auditing" {% if user_to_edit.department == 'Auditing' %}selected{% endif %}>Auditing</option>
                            <option value="Customer Service" {% if user_to_edit.department == 'Customer Service' %}selected{% endif %}>Customer Service</option>
                            <option value="Marketing" {% if user_to_edit.department == 'Marketing' %}selected{% endif %}>Marketing</option>
                            <option value="Operation" {% if user_to_edit.department == 'Operation' %}selected{% endif %}>Operation</option>
                            <option value="Quality Control" {% if user_to_edit.department == 'Quality Control' %}selected{% endif %}>Quality Control</option>
                            <option value="Project Department" {% if user_to_edit.department == 'Project Department' %}selected{% endif %}>Project Department</option>
                            <option value="Research and Development" {% if user_to_edit.department == 'Research and Development' %}selected{% endif %}>Research and Development</option>
                            <option value="Office" {% if user_to_edit.department == 'Office' %}selected{% endif %}>Office</option>
                            <option value="Maintenance" {% if user_to_edit.department == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                            <option value="Procurement" {% if user_to_edit.department == 'Procurement' %}selected{% endif %}>Procurement</option>
                            <option value="Logistic" {% if user_to_edit.department == 'Logistic' %}selected{% endif %}>Logistic</option>
                        </select>
                        <small>Multiple accounts can be created for the same department</small>
                    </div>

                    <div class="form-group">
                        <label for="role">Role *</label>
                        <select name="role" id="role" required>
                            <option value="">-- Select Role --</option>
                            <!-- Management Roles -->
                            <option value="GM" {% if user_to_edit.role == 'GM' %}selected{% endif %}>General Manager</option>
                            <option value="Finance Admin" {% if user_to_edit.role == 'Finance Admin' %}selected{% endif %}>Finance Admin</option>
                            <option value="Operation Manager" {% if user_to_edit.role == 'Operation Manager' %}selected{% endif %}>Operation Manager</option>
                            <option value="Department Manager" {% if user_to_edit.role == 'Department Manager' %}selected{% endif %}>Department Manager</option>
                            <!-- Staff Roles -->
                            <option value="Finance Staff" {% if user_to_edit.role == 'Finance Staff' %}selected{% endif %}>Finance Staff</option>
                            <option value="IT Staff" {% if user_to_edit.role == 'IT Staff' %}selected{% endif %}>IT Staff</option>
                            <option value="Project Staff" {% if user_to_edit.role == 'Project Staff' %}selected{% endif %}>Project Staff</option>
                            <option value="HR Staff" {% if user_to_edit.role == 'HR Staff' %}selected{% endif %}>HR Staff</option>
                            <option value="Purchasing Staff" {% if user_to_edit.role == 'Purchasing Staff' %}selected{% endif %}>Purchasing Staff</option>
                            <option value="PR Staff" {% if user_to_edit.role == 'PR Staff' %}selected{% endif %}>PR Staff</option>
                            <option value="Auditing Staff" {% if user_to_edit.role == 'Auditing Staff' %}selected{% endif %}>Auditing Staff</option>
                            <option value="Customer Service Staff" {% if user_to_edit.role == 'Customer Service Staff' %}selected{% endif %}>Customer Service Staff</option>
                            <option value="Marketing Staff" {% if user_to_edit.role == 'Marketing Staff' %}selected{% endif %}>Marketing Staff</option>
                            <option value="Operation Staff" {% if user_to_edit.role == 'Operation Staff' %}selected{% endif %}>Operation Staff</option>
                            <option value="Quality Control Staff" {% if user_to_edit.role == 'Quality Control Staff' %}selected{% endif %}>Quality Control Staff</option>
                            <option value="Research and Development Staff" {% if user_to_edit.role == 'Research and Development Staff' %}selected{% endif %}>Research and Development Staff</option>
                            <option value="Office Staff" {% if user_to_edit.role == 'Office Staff' %}selected{% endif %}>Office Staff</option>
                            <option value="Maintenance Staff" {% if user_to_edit.role == 'Maintenance Staff' %}selected{% endif %}>Maintenance Staff</option>
                            <option value="Procurement Staff" {% if user_to_edit.role == 'Procurement Staff' %}selected{% endif %}>Procurement Staff</option>
                            <option value="Logistic Staff" {% if user_to_edit.role == 'Logistic Staff' %}selected{% endif %}>Logistic Staff</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="manager_display">Manager</label>
                    <div id="manager_display" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background-color: #f8f9fa; min-height: 38px; display: flex; align-items: center;">
                        <span id="manager-text">Select a department to see assigned manager</span>
                    </div>
                    <input type="hidden" name="manager_id" id="manager_id" value="">
                    <small id="manager-info">Manager will be automatically assigned based on department</small>
                </div>


                <div class="details-grid" style="margin: 1.5rem 0;">
                    <div class="detail-item">
                        <label><i class="fas fa-calendar"></i> Account Created:</label>
                        <span>{{ user_to_edit.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                    </div>
                    <div class="detail-item">
                        <label><i class="fas fa-hashtag"></i> User ID:</label>
                        <span>#{{ user_to_edit.user_id }}</span>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update User
                    </button>
                    <a href="{{ url_for('manage_users') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Build users list from server for manager lookup
const users = [
    {% for user in all_users %}
    { id: {{ user.user_id }}, name: {{ user.name|tojson }}, department: {{ user.department|tojson }}, role: {{ user.role|tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
];

const departmentSelect = document.getElementById('department');
const roleSelect = document.getElementById('role');
const managerDisplay = document.getElementById('manager_display');
const managerText = document.getElementById('manager-text');
const managerIdInput = document.getElementById('manager_id');
const managerInfo = document.getElementById('manager-info');

function setDisplay(text, bg, border, infoText, infoColor) {
    managerText.textContent = text;
    managerDisplay.style.backgroundColor = bg;
    managerDisplay.style.borderColor = border;
    managerInfo.textContent = infoText;
    managerInfo.style.color = infoColor;
}

function updateManagerDisplay() {
    const department = departmentSelect.value;
    const role = roleSelect.value;

    if (!department) {
        managerIdInput.value = '';
        setDisplay('Select a department to see assigned manager', '#f8f9fa', '#ddd', 'Manager will be automatically assigned based on department', '#6c757d');
        return;
    }

    if (role === 'Department Manager' || (role === 'GM' && department === 'Office') || (role === 'Operation Manager' && department === 'Operation') || (role === 'Finance Admin' && department === 'Finance' && document.getElementById('name').value.trim() === 'Abdalaziz Al-Brashdi')) {
        managerIdInput.value = '';
        if (role === 'Department Manager') {
            setDisplay('General Manager will be your assigned manager', '#d4edda', '#c3e6cb', 'As a Department Manager, the General Manager will approve your requests', '#28a745');
        } else if (role === 'GM') {
            setDisplay('Abdalaziz Al-Brashdi will be your assigned manager', '#d4edda', '#c3e6cb', 'As a General Manager, Abdalaziz will approve your requests', '#28a745');
        } else {
            setDisplay('You will be the assigned manager for this department', '#d4edda', '#c3e6cb', 'As a Manager, you will manage this department', '#28a745');
        }
        return;
    }

    // Manager selection: Special cases first, then Department Manager fallback
    let managerUser = null;
    
    // Special cases take priority
    if (department === 'Office') {
        managerUser = users.find(u => u.role === 'GM');
    } else if (department === 'Operation') {
        managerUser = users.find(u => u.role === 'Operation Manager');
    } else if (department === 'Project Department') {
        managerUser = users.find(u => u.role === 'Operation Manager');
    } else if (department === 'Finance') {
        managerUser = users.find(u => u.department === 'Finance' && u.name === 'Abdalaziz Al-Brashdi');
    } else {
        // Fallback: Department Manager of same department
        managerUser = users.find(u => u.department === department && u.role === 'Department Manager');
    }
    if (managerUser) {
        managerIdInput.value = managerUser.id;
        setDisplay(`${managerUser.name}`, '#d4edda', '#c3e6cb', `${managerUser.name} is the assigned manager for the ${department} department`, '#28a745');
    } else {
        managerIdInput.value = '';
        setDisplay(`There is no assigned manager for the ${department} department yet`, '#fff3cd', '#ffeaa7', `There is no assigned manager for the ${department} department yet`, '#ffc107');
    }
}

departmentSelect.addEventListener('change', updateManagerDisplay);
roleSelect.addEventListener('change', updateManagerDisplay);

// Initialize on load in case defaults are pre-selected
updateManagerDisplay();
</script>
{% endblock %}



